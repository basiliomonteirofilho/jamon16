<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" href="data:,">
  <meta charset="UTF-8" />
  <title>Jam On - Celular Otimizado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.98);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --record-color: #d50000;
      --grid-bg: #000;
      --cell-bg: #151515;
      --cell-border: #333;
      /* Ajustes para celular */
      --label-width: 60px;
      --cell-size: 24px;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* TELA DE CARREGAMENTO - Otimizada para celular */
    #loadingOverlay {
      position: fixed; 
      inset: 0; 
      background: #000; 
      z-index: 50000;
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center;
      color: var(--highlight-color); 
      font-weight: bold;
      padding: 20px;
    }
    #loadingText { 
      margin-bottom: 20px; 
      font-family: monospace; 
      font-size: 1.1rem;
      text-align: center;
    }
    #loadingBarContainer {
      width: 80%;
      max-width: 300px;
      height: 6px; 
      background: #333; 
      border-radius: 3px; 
      overflow: hidden;
    }
    #loadingBar {
      height: 100%; 
      background: var(--highlight-color); 
      width: 0%; 
      transition: width 0.1s linear;
    }

    #orientationOverlay {
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.95); 
      color: #fff;
      display: none; 
      flex-direction: column;
      justify-content: center; 
      align-items: center; 
      z-index: 10000;
      text-align: center;
      padding: 20px;
    }
    #orientationOverlay h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
    }
    #orientationOverlay p {
      font-size: 1rem;
    }

    .appRoot {
      width: 100vw; 
      height: 100vh; 
      display: flex; 
      flex-direction: column;
      background: radial-gradient(circle at top, #222 0%, #000 80%);
    }

    /* √ÅREA SUPERIOR - Redimensionada para celular */
    #topArea {
      flex: 1 0 40vh;
      min-height: 300px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      position: relative; 
      overflow: hidden;
      padding: 10px;
    }

    #animacaoStageWrapper {
      position: relative; 
      width: 100%; 
      height: 100%;
      display: flex; 
      align-items: center; 
      justify-content: center;
      transform-origin: center;
    }

    /* =========================================
       BATERISTA - Ajustado para celular
       ========================================= */
    #bateristaStage {
      position: absolute;
      width: 400px; /* Reduzido para celular */
      height: 400px;
      transform-origin: center center;
      z-index: 1; 
      /* Posi√ß√£o ajustada para celular */
      transform: scale(0.3) translate(180px, -250px);
      pointer-events: none;
    }
    
    #bateristaStage img {
      position: absolute;
      image-rendering: pixelated;
      will-change: transform, src; 
    }

    /* ORDEM DE CAMADAS */
    #bat_PernaEsq     { top: 0; left: 0; z-index: 2; }
    #bat_Tronco       { top: 0; left: 0; z-index: 3; }
    #bat_Cabeca       { top: 0; left: 0; z-index: 4; }
    #bat_BracoEsq     { top: 0; left: 0; z-index: 10; transition: z-index 0.05s; }
    #bat_BracoDir     { top: 0; left: 0; z-index: 11; }
    #bat_Bateria      { top: 0; left: 0; z-index: 20; } 
    #bat_Conducao     { top: 0; left: 0; z-index: 21; } 
    #bat_Ataque       { top: 0; left: 0; z-index: 22; }

    /* =========================================
       BAIXISTA - Ajustado para celular
       ========================================= */
    #baixistaStage {
      position: relative; 
      width: 400px; /* Reduzido para celular */
      height: 400px;
      transform-origin: center center;
      z-index: 100; 
    }

    #pernasLayer { 
      position: absolute; 
      top: 250px; /* Ajustado */
      left: 48px; /* Ajustado */
      z-index: 1; 
      width: 100%;
      height: auto;
    }
    
    #bodyWrapperPendulo {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 5;
      transform-origin: 50% 80%; 
      will-change: transform;
    }
    #bodyWrapperPendulo img { 
      position: absolute; 
      image-rendering: pixelated;
      width: 100%;
      height: auto;
    }

    /* Posi√ß√µes ajustadas para celular */
    #cabecaTrasLayer   { top: 45px;   left: 75px;  z-index: 1; }
    #troncoBaixoLayer  { top: 100px;  left: 0px;   z-index: 3; }
    #antebracoLayer    { top: 135px;  left: -1px;  z-index: 2; }
    #bracoDireitoLayer { top: 190px;  left: -3px;  z-index: 4; }
    #cabecaLayer       { top: 28px;   left: 52px;  z-index: 5; }

    /* CANVAS DE GRAVA√á√ÉO - AUMENTADO PARA AMBOS OS M√öSICOS */
    #recordingCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      visibility: hidden;
      pointer-events: none;
      z-index: -1000;
    }

    /* √ÅREA INFERIOR - Otimizada para celular */
    #bottomArea {
      flex: 0 0 55vh;
      max-height: 400px;
      min-height: 280px;
      display: flex; 
      flex-direction: column; 
      background: var(--panel-bg);
      border-top: 1px solid #333; 
      padding: 8px; 
      z-index: 200;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
      overflow: hidden;
    }

    /* CONTROLES - Adaptados para celular */
    #playerControlsRow { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
      gap: 6px;
      margin-bottom: 10px;
      padding: 4px;
    }
    
    button {
      padding: 8px 6px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
      min-height: 36px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    button:hover, button:active { 
      background: #333; 
      border-color: #777; 
    }
    
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    /* Bot√µes principais maiores */
    #playBtn, #recordVideoBtn, #playAleatorioBtn {
      font-size: 0.8rem;
      font-weight: bold;
      padding: 10px 8px;
    }
    
    #playBtn { 
      background: var(--accent-color); 
      border-color: var(--highlight-color); 
      font-weight: bold; 
      color: #fff; 
      grid-column: span 2;
    }
    
    #recordVideoBtn {
      grid-column: span 2;
    }
    
    #recordVideoBtn.recording {
        background: var(--record-color); 
        color: white; 
        border-color: #ff0000;
        animation: pulse 1.5s infinite; 
        font-weight: bold;
    }
    
    @keyframes pulse { 
      0% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0.7); } 
      70% { box-shadow: 0 0 0 8px rgba(213, 0, 0, 0); } 
    }

    /* Informa√ß√µes e controles de volume */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    
    #generationInfo {
        font-size: 0.7rem; 
        color: var(--highlight-color);
        background: rgba(0,230,118, 0.1); 
        padding: 4px 8px; 
        border-radius: 4px;
        border: 1px solid var(--accent-color); 
        display: none;
        white-space: nowrap;
    }

    .sliderGroup { 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      background: rgba(255,255,255,0.05); 
      padding: 6px 10px; 
      border-radius: 6px;
      min-width: 80px;
    }
    
    .sliderGroup label { 
      font-size: 0.75rem; 
      color: #ccc; 
      min-width: 25px;
    }
    
    input[type="range"] { 
      width: 60px; 
      cursor: pointer; 
      accent-color: var(--highlight-color);
    }
    
    #bpmDisplay { 
      font-family: monospace; 
      font-weight: bold; 
      min-width: 70px; 
      text-align: center; 
      font-size: 0.8rem;
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      border-radius: 6px;
    }

    /* Barra de progresso */
    #progressContainer { 
      width: 100%; 
      height: 4px; 
      background: #333; 
      margin-bottom: 8px; 
      border-radius: 2px;
      overflow: hidden;
    }
    
    #progressBar { 
      height: 100%; 
      width: 0%; 
      background: var(--highlight-color); 
      transition: width 0.1s linear;
    }

    /* √Årea das grids - Otimizada para celular */
    #gridsArea { 
      flex: 1; 
      overflow: auto; 
      border: 1px solid #333; 
      background: var(--grid-bg); 
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    .rowContainer { 
      display: flex; 
      align-items: center; 
      margin-bottom: 1px; 
      width: max-content; 
      min-width: 100%; 
      position: relative;
    }
    
    .gridLabel {
      position: sticky; 
      left: 0; 
      z-index: 10; 
      width: var(--label-width); 
      min-width: var(--label-width);
      font-size: 0.7rem; 
      text-align: right; 
      padding-right: 8px; 
      color: #aaa; 
      background: #000;
      border-right: 1px solid #333; 
      height: var(--cell-size); 
      display: flex; 
      align-items: center; 
      justify-content: flex-end;
    }
    
    .trackGrid { 
      display: grid; 
      grid-auto-flow: column; 
      grid-auto-columns: var(--cell-size); 
      grid-template-rows: var(--cell-size); 
      gap: 1px; 
      padding-left: 1px; 
    }
    
    .delete-btn { 
      width: var(--cell-size); 
      height: 20px; 
      font-size: 12px; 
      background: #b71c1c; 
      border: none; 
      color: white; 
      cursor: pointer; 
      border-radius: 2px;
    }
    
    .cell { 
      background: var(--cell-bg); 
      border: 1px solid var(--cell-border); 
      border-radius: 3px; 
      color: #fff; 
      font-size: 0.7rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      width: var(--cell-size); 
      height: var(--cell-size);
      -webkit-tap-highlight-color: transparent;
    }
    
    .cell.active { 
      background: var(--accent-color); 
      border-color: var(--highlight-color); 
    }
    
    .cell.active-ghost { 
      background: #880e4f; 
      border-color: #f50057; 
    }
    
    .cell.playing-step { 
      background-color: #333 !important; 
      border-color: #fff !important; 
    }
    
    .cell.active.playing-step { 
      background-color: #00e676 !important; 
      color: #000; 
      box-shadow: 0 0 8px #00e676; 
      z-index: 2; 
    }

    /* Overlay de sele√ß√£o - Otimizado para celular */
    #selectionOverlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.9); 
      z-index: 20000; 
      display: none; 
      align-items: center; 
      justify-content: center; 
      padding: 20px;
    }
    
    #selectionOverlay.visible { display: flex; }
    
    #selectionPanel { 
      background: #1a1a1a; 
      border: 1px solid #444; 
      padding: 15px; 
      border-radius: 10px; 
      width: 95%; 
      max-width: 500px; 
      max-height: 80vh; 
      overflow-y: auto;
    }
    
    #selectionTitle { 
      margin-bottom: 15px; 
      font-weight: bold; 
      color: #fff; 
      text-align: center; 
      font-size: 1.1rem;
    }
    
    #selectionOptions { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
      gap: 8px;
    }
    
    .selection-option { 
      padding: 12px 0; 
      background: #2c2c2c; 
      text-align: center; 
      border-radius: 6px; 
      font-size: 0.85rem; 
      cursor: pointer; 
      border: 1px solid transparent;
      -webkit-tap-highlight-color: transparent;
    }
    
    .selection-option.active { 
      background: var(--accent-color); 
      border-color: var(--highlight-color); 
    }
    
    .selection-option.ghost { 
      color: #ff80ab; 
      border-color: #880e4f; 
    }

    /* Countdown overlay */
    .countdownOverlay { 
      position: absolute; 
      inset: 0; 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 50; 
      background: rgba(0,0,0,0.8); 
      font-size: 4rem; 
      font-weight: 900; 
      color: var(--highlight-color); 
      border-radius: 10px;
    }
    
    #loadingStatusMini { 
      position: absolute; 
      bottom: 15px; 
      font-size: 0.9rem; 
      color: #fff; 
      font-weight: normal;
      text-align: center;
      width: 100%;
    }

    /* Scrollbar para mobile */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    /* Media queries espec√≠ficas */
    @media (max-width: 480px) {
      :root { 
        --label-width: 50px; 
        --cell-size: 22px; 
      }
      
      #topArea {
        flex: 1 0 35vh;
        min-height: 250px;
      }
      
      #bottomArea {
        flex: 0 0 60vh;
      }
      
      #playerControlsRow {
        grid-template-columns: repeat(3, 1fr);
      }
      
      #playBtn, #recordVideoBtn {
        grid-column: span 3;
      }
      
      button {
        font-size: 0.7rem;
        padding: 6px 4px;
      }
      
      .sliderGroup {
        min-width: 70px;
      }
      
      input[type="range"] {
        width: 50px;
      }
    }

    @media (max-width: 360px) {
      :root { 
        --label-width: 45px; 
        --cell-size: 20px; 
      }
      
      #topArea {
        flex: 1 0 30vh;
      }
    }

    /* Para desktop - ajuste especial da grava√ß√£o */
    @media (min-width: 768px) {
      #topArea {
        flex: 1 0 45vh;
      }
      
      #bottomArea {
        flex: 0 0 45vh;
        max-height: 450px;
      }
      
      #recordingCanvas {
        /* Para desktop, mant√©m propor√ß√µes originais mas posiciona para capturar ambos */
        width: 1000px;
        height: 600px;
        left: 50%;
        transform: translateX(-50%);
      }
      
      #bateristaStage {
        transform: scale(0.35) translate(250px, -300px);
      }
      
      #baixistaStage {
        width: 520px;
        height: 520px;
      }
      
      #pernasLayer {
        top: 332px;
        left: 64px;
      }
      
      #cabecaTrasLayer   { top: 60px;   left: 100px; }
      #troncoBaixoLayer  { top: 132px;  left: 0px;   }
      #antebracoLayer    { top: 179px;  left: -2px;  }
      #bracoDireitoLayer { top: 250px;  left: -5px;  }
      #cabecaLayer       { top: 37px;   left: 70px;  }
    }

    /* Para telas muito largas */
    @media (min-width: 1200px) {
      #animacaoStageWrapper {
        transform: scale(1.1);
      }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div id="loadingText">Carregando Est√∫dio...</div>
    <div id="loadingBarContainer"><div id="loadingBar"></div></div>
  </div>

  <div id="orientationOverlay">
    <div>
      <h1>üéµ Melhor Experi√™ncia üé∏</h1>
      <p>Gire o dispositivo para modo paisagem.</p>
    </div>
  </div>
  
  <!-- Canvas de grava√ß√£o expandido -->
  <canvas id="recordingCanvas" width="1000" height="600"></canvas>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        
        <div id="bateristaStage">
            <img id="bat_Conducao" src="" />
            <img id="bat_PernaEsq" src="" />
            <img id="bat_Tronco"   src="" />
            <img id="bat_Cabeca"   src="" />
            <img id="bat_Bateria"  src="" />
            <img id="bat_BracoDir" src="" />
            <img id="bat_BracoEsq" src="" />
            <img id="bat_Ataque"   src="" />
        </div>

        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" />
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" />
                <img id="troncoBaixoLayer" src="" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" />
            </div>
            <div id="countdownOverlay" class="countdownOverlay">
                <span id="countdownText">3</span>
                <div id="loadingStatusMini"></div>
            </div>
        </div>

      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn" disabled>‚è≥ Carregando...</button>
        <button id="playAleatorioBtn" disabled>üé≤ Aleat√≥rio</button>
        <button id="recordVideoBtn">üî¥ Gravar (Auto)</button>
        <span id="generationInfo"></span>
        <div class="sliderGroup">
          <label>BPM</label>
          <span id="bpmDisplay">120</span>
        </div>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        <div class="sliderGroup"><label>Bx</label><input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <div class="sliderGroup"><label>Dr</label><input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <button id="playExportadoBtn">üìÅ</button>
        <button id="exportWavBtn">üíæ WAV</button>
        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="duplicateSeq">x2</button>
        <button id="clearAll">Limpar</button>
      </div>
      <div id="progressContainer"><div id="progressBar"></div></div>
      <div id="gridsArea">
        <div class="rowContainer"><div class="gridLabel" style="background:transparent;border:none"></div><div id="deleteGrid" class="trackGrid"></div></div>
        <div class="rowContainer"><div class="gridLabel" style="color:var(--highlight-color)">BAIXO</div><div id="baixoGrid" class="trackGrid"></div></div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay"><div id="selectionPanel"><div id="selectionTitle">Nota</div><div id="selectionOptions"></div></div></div>

  <script>
    // =========================================================
    // DADOS & CAMINHOS (ASSETS) - MESMOS RECURSOS
    // =========================================================
    const PASTA_BAT = "animacao/Baterista/";
    const imgCache = new Map();
    
    // CONFIGURA√á√ÉO DE SINCRONIA
    const DRUM_FPS = 40; 
    const DRUM_IMPACT_FRAME = 2;
    const DRUM_MS_PER_FRAME = 1000 / DRUM_FPS;
    const DRUM_PREROLL_MS = DRUM_IMPACT_FRAME * DRUM_MS_PER_FRAME;
    
    // COMPENSACAO DE LATENCIA
    const VISUAL_OFFSET_MS = 25; 

    // NOVO: Configura√ß√£o do canvas de grava√ß√£o
    const RECORDING_CANVAS_WIDTH = 1000;
    const RECORDING_CANVAS_HEIGHT = 600;
    
    // C√°lculo das posi√ß√µes para o canvas de grava√ß√£o
    const BAT_SCALE = 0.45;
    const BAT_X_OFFSET = 350;
    const BAT_Y_OFFSET = -180;
    
    const BX_X_OFFSET = 260;
    const BX_Y_OFFSET = 416;

    // Configura√ß√µes mobile
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let isPortrait = window.innerHeight > window.innerWidth;

    // Restante das constantes mantidas...
    const CABECA_ANIMATIONS = {
        virada_direita: Array.from({length:10}, (_,i) => PASTA_BAT + `Cabeca/Virada_para_direita/cabeca${String(i+51).padStart(4,'0')}.png`),
        virada_esquerda: Array.from({length:8}, (_,i) => PASTA_BAT + `Cabeca/Virada_para_esquerda/cabeca${String(i+39).padStart(4,'0')}.png`),
        voltando_direita: Array.from({length:3}, (_,i) => PASTA_BAT + `Cabeca/Voltando_Virada_da_direita/cabeca${String(i+61).padStart(4,'0')}.png`),
        voltando_esquerda: Array.from({length:4}, (_,i) => PASTA_BAT + `Cabeca/Voltando_Virada_da_esquerda/cabeca${String(i+48).padStart(4,'0')}.png`),
        cabeca_estavel: Array.from({length:26}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel/cabeca${String(i+1).padStart(4,'0')}.png`),
        cabeca_estavel2: Array.from({length:19}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel_2/cabeca${String(i+20).padStart(4,'0')}.png`)
    };

    // DRUM_ASSETS, pastaMap, etc... (mantido igual)
    const DRUM_ASSETS = {
        idle: {
            ataque: PASTA_BAT + "Ataque/Ataque0001.png",
            bracoDir: PASTA_BAT + "Braco_direito/Caixa/braco_direito0003.png",
            bracoEsq: PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0001.png",
            cabeca: PASTA_BAT + "Cabeca/Cabeca_estavel/cabeca0024.png",
            conducao: PASTA_BAT + "Conducao/Conducao0001.png",
            pernaEsq: PASTA_BAT + "Perna_esquerda/Pedal_chimbal/Baterista0001.png",
            tronco: PASTA_BAT + "Tronco_Perna_direita/Parado/Tronco0001.png",
            bateria: PASTA_BAT + "Bateria_Chimbal/Bateria.png"
        },
        anim: {
            // ... mantido igual ao original
            troncoTocando: Array.from({length:39}, (_,i) => PASTA_BAT + `Tronco_Perna_direita/Tocando/Tronco${String(i+2).padStart(4,'0')}.png`),
            // ... resto das anima√ß√µes mantidas
        }
    };

    const pastaMap = { 1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"], /* ... */ };
    const pastaFolderNames = { 1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D", 11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B", 20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E" };
    const notasValidas = ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"];
    
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" }, 
      { id: "caixa", label: "Caixa", file: "caixa.mp3" },
      // ... resto mantido
    ];

    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
    const STYLE_PROGRESSIONS = {
        Rock: [[1,4,5,1], [1,5,6,4]], Rock2: [[4,5,1,5], [5,4,1,4]], Rock3: [[1,4,5,1], [1,3,4,5]], Rock4: [[6,4,1,5], [1,4,5,1]], Rock5: [[1,5,7,4]], Rock6: [[1,5,6,4]], Rock7: [[2,3,5,1]], Rock_Progressivo: [[4,5,1,1]], Blues: [[1,4,5,4]], Forr√≥: [[1,5,1,5]], Samba: [[2,5,1,1]], Metal: [[1,3,5,6]], Jazz: [[1,2,5,1]]
    };
    
    const ALL_GROOVES = [
        { name: "Rock", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        // ... resto mantido
    ];

    let isPlaying = false, playbackInterval = null, bpmAtual = 120, atualPasso = 0;
    let baixoSeq = Array(16).fill(""), bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    let baixoVolumeGlobal = 0.9, bateriaVolumeGlobal = 0.9, audioBaixoAtual = null;

    let posicaoAtualPasta = 1, ultimaCordaUsada = "E", ultimaNotaReal = "1E";
    let headLoopTimer = null, headFrameIndex = 0, headFrames = [];

    // Animation Controllers
    let activeAnimations = {}; 
    let lastDrumStep = {}; 
    let lastArmUsed = {};  
    let pendulumStartTime = 0;
    
    // Controle de cabe√ßa
    let lastHeadAnimation = null;
    let headAnimationTimeout = null;
    let currentHeadStyle = 'estavel';
    
    // Controle de bra√ßos
    let armAnimationTimers = {};
    let lastRightArmFrame = null;
    let lastRightArmFrames = null;
    
    const canvas = document.getElementById("recordingCanvas");
    const ctx = canvas.getContext("2d");
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    const mediaStreamDestination = audioContext.createMediaStreamDestination();
    let mediaRecorder = null, recordedChunks = [], isRecording = false;

    const domImages = {
        bx_pernas: document.getElementById("pernasLayer"),
        bx_cabecaTras: document.getElementById("cabecaTrasLayer"),
        bx_tronco: document.getElementById("troncoBaixoLayer"),
        bx_antebraco: document.getElementById("antebracoLayer"),
        bx_bracoDir: document.getElementById("bracoDireitoLayer"),
        bx_cabeca: document.getElementById("cabecaLayer"),
        
        bt_ataque: document.getElementById("bat_Ataque"),
        bt_bracoDir: document.getElementById("bat_BracoDir"),
        bt_bracoEsq: document.getElementById("bat_BracoEsq"),
        bt_cabeca: document.getElementById("bat_Cabeca"),
        bt_conducao: document.getElementById("bat_Conducao"),
        bt_pernaEsq: document.getElementById("bat_PernaEsq"),
        bt_tronco: document.getElementById("bat_Tronco"),
        bt_kit: document.getElementById("bat_Bateria")
    };

    // FUN√á√ÉO DE RENDERIZA√á√ÉO DO CANVAS MODIFICADA
    function canvasRenderLoop() {
        // Limpa o canvas com o tamanho expandido
        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, RECORDING_CANVAS_WIDTH, RECORDING_CANVAS_HEIGHT);
        
        // ============================================
        // DESENHA O BATERISTA (esquerda)
        // ============================================
        ctx.save();
        ctx.scale(BAT_SCALE, BAT_SCALE);
        ctx.translate(BAT_X_OFFSET, BAT_Y_OFFSET);
        
        const drawImg = (el) => { 
            if (el && el.complete && el.naturalWidth > 0) {
                ctx.drawImage(el, 0, 0);
            }
        };
        
        // Ordem de desenho do baterista
        drawImg(domImages.bt_conducao);
        drawImg(domImages.bt_pernaEsq);
        drawImg(domImages.bt_tronco);
        drawImg(domImages.bt_cabeca);
        
        const zEsq = parseInt(domImages.bt_bracoEsq.style.zIndex || 10);
        if (zEsq > 11) { 
            drawImg(domImages.bt_bracoDir); 
            drawImg(domImages.bt_bracoEsq); 
        } else { 
            drawImg(domImages.bt_bracoEsq); 
            drawImg(domImages.bt_bracoDir); 
        }
        
        drawImg(domImages.bt_kit);
        drawImg(domImages.bt_ataque);
        ctx.restore();
        
        // ============================================
        // DESENHA O BAIXISTA (direita)
        // ============================================
        ctx.save();
        
        // Posiciona o baixista ao lado do baterista
        const baixistaX = RECORDING_CANVAS_WIDTH * 0.55; // 55% da largura
        const baixistaY = RECORDING_CANVAS_HEIGHT * 0.5;
        
        // Desenha as pernas
        if (domImages.bx_pernas.complete) {
            ctx.drawImage(
                domImages.bx_pernas, 
                baixistaX - 200, // Ajuste de posi√ß√£o
                baixistaY + 100  // Ajuste de posi√ß√£o
            );
        }
        
        // Aplica anima√ß√£o de p√™ndulo
        ctx.translate(baixistaX, baixistaY + 150);
        let angle = 0;
        if (isPlaying && pendulumStartTime > 0) {
            const now = performance.now();
            const elapsed = now - pendulumStartTime;
            const speed = 0.003 * (bpmAtual / 120);
            angle = Math.sin(elapsed * speed) * 2.3;
        }
        ctx.rotate(angle * Math.PI / 180);
        
        // Atualiza a transforma√ß√£o CSS para a visualiza√ß√£o
        document.getElementById("bodyWrapperPendulo").style.transform = `rotate(${angle}deg)`;
        
        ctx.translate(-baixistaX, -(baixistaY + 150));
        
        // Desenha as partes do baixista
        if (domImages.bx_cabecaTras.complete) 
            ctx.drawImage(domImages.bx_cabecaTras, baixistaX - 160, baixistaY - 80);
        if (domImages.bx_tronco.complete) 
            ctx.drawImage(domImages.bx_tronco, baixistaX - 260, baixistaY - 20);
        if (domImages.bx_antebraco.complete) 
            ctx.drawImage(domImages.bx_antebraco, baixistaX - 262, baixistaY + 27);
        if (domImages.bx_bracoDir.complete) 
            ctx.drawImage(domImages.bx_bracoDir, baixistaX - 265, baixistaY + 98);
        if (domImages.bx_cabeca.complete) 
            ctx.drawImage(domImages.bx_cabeca, baixistaX - 190, baixistaY - 115);
        
        ctx.restore();
        
        // Continua o loop
        requestAnimationFrame(canvasRenderLoop);
    }

    // MODIFICA√á√ÉO NA FUN√á√ÉO DE GRAVA√á√ÉO PARA USAR O CANVAS EXPANDIDO
    async function toggleRecording() {
        const btn = document.getElementById("recordVideoBtn");
        if (isRecording) {
            mediaRecorder.stop(); 
            isRecording = false; 
            btn.innerText = "üî¥ Gravar (Auto)"; 
            btn.classList.remove("recording");
        } else {
            try {
                if (audioContext.state === 'suspended') await audioContext.resume();
                
                // Captura o stream do canvas expandido
                const canvasStream = canvas.captureStream(30);
                const videoTrack = canvasStream.getVideoTracks()[0];
                const audioTrack = mediaStreamDestination.stream.getAudioTracks()[0];
                const combinedStream = new MediaStream([videoTrack, audioTrack]);
                
                let mimeType = 'video/webm';
                if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) {
                    mimeType = 'video/webm; codecs=vp9';
                } else if (MediaRecorder.isTypeSupported('video/mp4')) {
                    mimeType = 'video/mp4';
                }
                
                mediaRecorder = new MediaRecorder(combinedStream, { 
                    mimeType: mimeType, 
                    videoBitsPerSecond: 2500000 
                });
                
                recordedChunks = [];
                mediaRecorder.ondataavailable = (e) => { 
                    if (e.data.size > 0) recordedChunks.push(e.data); 
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); 
                    a.style.display = 'none'; 
                    a.href = url; 
                    a.download = `jam_session_${new Date().getTime()}.${mimeType.includes('mp4') ? 'mp4' : 'webm'}`;
                    document.body.appendChild(a); 
                    a.click(); 
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                };
                
                mediaRecorder.start(); 
                isRecording = true; 
                btn.innerText = "‚èπ Parar"; 
                btn.classList.add("recording");
                
                if (!isPlaying) togglePlay();
            } catch (err) { 
                console.error("Erro na grava√ß√£o:", err);
                alert("Erro ao iniciar grava√ß√£o: " + err.message); 
            }
        }
    }

    // FUN√á√ÉO PARA AJUSTAR O LAYOUT PARA CELULAR
    function adjustForMobile() {
        const topArea = document.getElementById("topArea");
        const bottomArea = document.getElementById("bottomArea");
        const bateristaStage = document.getElementById("bateristaStage");
        const baixistaStage = document.getElementById("baixistaStage");
        
        if (isMobile && isPortrait) {
            // Para celular em retrato
            topArea.style.flex = "1 0 35vh";
            bottomArea.style.flex = "0 0 60vh";
            
            // Ajusta tamanhos dos stages
            bateristaStage.style.width = "320px";
            bateristaStage.style.height = "320px";
            bateristaStage.style.transform = "scale(0.25) translate(120px, -200px)";
            
            baixistaStage.style.width = "320px";
            baixistaStage.style.height = "320px";
            
            // Ajusta posi√ß√µes do baixista
            document.getElementById("pernasLayer").style.top = "200px";
            document.getElementById("pernasLayer").style.left = "38px";
            document.getElementById("cabecaTrasLayer").style.top = "36px";
            document.getElementById("cabecaTrasLayer").style.left = "60px";
            document.getElementById("troncoBaixoLayer").style.top = "80px";
            document.getElementById("troncoBaixoLayer").style.left = "0px";
            document.getElementById("antebracoLayer").style.top = "108px";
            document.getElementById("antebracoLayer").style.left = "-1px";
            document.getElementById("bracoDireitoLayer").style.top = "152px";
            document.getElementById("bracoDireitoLayer").style.left = "-2px";
            document.getElementById("cabecaLayer").style.top = "22px";
            document.getElementById("cabecaLayer").style.left = "42px";
            
        } else if (isMobile && !isPortrait) {
            // Para celular em paisagem
            topArea.style.flex = "1 0 45vh";
            bottomArea.style.flex = "0 0 50vh";
            
            // Ajusta tamanhos
            bateristaStage.style.width = "400px";
            bateristaStage.style.height = "400px";
            bateristaStage.style.transform = "scale(0.3) translate(150px, -200px)";
            
            baixistaStage.style.width = "400px";
            baixistaStage.style.height = "400px";
            
            // Posi√ß√µes intermedi√°rias
            document.getElementById("pernasLayer").style.top = "250px";
            document.getElementById("pernasLayer").style.left = "48px";
            document.getElementById("cabecaTrasLayer").style.top = "45px";
            document.getElementById("cabecaTrasLayer").style.left = "75px";
            document.getElementById("troncoBaixoLayer").style.top = "100px";
            document.getElementById("troncoBaixoLayer").style.left = "0px";
            document.getElementById("antebracoLayer").style.top = "135px";
            document.getElementById("antebracoLayer").style.left = "-1px";
            document.getElementById("bracoDireitoLayer").style.top = "190px";
            document.getElementById("bracoDireitoLayer").style.left = "-3px";
            document.getElementById("cabecaLayer").style.top = "28px";
            document.getElementById("cabecaLayer").style.left = "52px";
            
        } else {
            // Para desktop
            topArea.style.flex = "1 0 45vh";
            bottomArea.style.flex = "0 0 45vh";
            
            // Tamanhos originais
            bateristaStage.style.width = "520px";
            bateristaStage.style.height = "520px";
            bateristaStage.style.transform = "scale(0.35) translate(250px, -300px)";
            
            baixistaStage.style.width = "520px";
            baixistaStage.style.height = "520px";
            
            // Posi√ß√µes originais
            document.getElementById("pernasLayer").style.top = "332px";
            document.getElementById("pernasLayer").style.left = "64px";
            document.getElementById("cabecaTrasLayer").style.top = "60px";
            document.getElementById("cabecaTrasLayer").style.left = "100px";
            document.getElementById("troncoBaixoLayer").style.top = "132px";
            document.getElementById("troncoBaixoLayer").style.left = "0px";
            document.getElementById("antebracoLayer").style.top = "179px";
            document.getElementById("antebracoLayer").style.left = "-2px";
            document.getElementById("bracoDireitoLayer").style.top = "250px";
            document.getElementById("bracoDireitoLayer").style.left = "-5px";
            document.getElementById("cabecaLayer").style.top = "37px";
            document.getElementById("cabecaLayer").style.left = "70px";
        }
    }

    window.onload = async () => {
        // Detecta dispositivo
        isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        isPortrait = window.innerHeight > window.innerWidth;
        
        verificarOrientacao();
        window.addEventListener("resize", () => {
            isPortrait = window.innerHeight > window.innerWidth;
            verificarOrientacao();
            adjustForMobile();
        });
        
        // Ajusta layout inicial
        adjustForMobile();
        
        // Resto do carregamento...
        for (let i = 1; i <= 100; i++) headFrames.push(`animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`);
        await preloadBaseAssets();
        startHeadLoop();
        gerarAleatorio();
        
        // Inicializa imagens
        setCachedSrc(domImages.bt_kit, DRUM_ASSETS.idle.bateria);
        setCachedSrc(domImages.bt_tronco, DRUM_ASSETS.idle.tronco);
        setCachedSrc(domImages.bt_cabeca, DRUM_ASSETS.idle.cabeca);
        setCachedSrc(domImages.bt_bracoDir, DRUM_ASSETS.idle.bracoDir);
        setCachedSrc(domImages.bt_bracoEsq, DRUM_ASSETS.idle.bracoEsq);
        setCachedSrc(domImages.bt_pernaEsq, DRUM_ASSETS.idle.pernaEsq);
        setCachedSrc(domImages.bt_conducao, DRUM_ASSETS.idle.conducao);
        setCachedSrc(domImages.bt_ataque, DRUM_ASSETS.idle.ataque);
        setCachedSrc(domImages.bx_tronco, `animacao/tronco_baixo/Pasta_1F/1E.png`);
        
        renderGrids();
        setupListeners();
        requestAnimationFrame(canvasRenderLoop);
    };

    // Resto das fun√ß√µes mantidas (loadAndCache, setCachedSrc, preloadBaseAssets, etc.)
    // ... (todas as outras fun√ß√µes permanecem iguais)
    
    function loadAndCache(url) {
        if (imgCache.has(url)) return Promise.resolve(imgCache.get(url));
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => { imgCache.set(url, img); resolve(img); };
            img.onerror = () => { console.warn("Fail load", url); resolve(null); };
            img.src = url;
        });
    }

    function setCachedSrc(element, url) {
        if (!url) return;
        if (imgCache.has(url)) {
            const cached = imgCache.get(url);
            if(element.src !== cached.src) element.src = cached.src;
        } else {
            element.src = url;
        }
    }

    async function preloadBaseAssets() {
        const toLoad = Object.values(DRUM_ASSETS.idle);
        toLoad.push("animacao/pernas/Pernas.png");
        toLoad.push("animacao/cabeca_tras/cabeca-parte-de-tras.png");
        toLoad.push("animacao/antebraco/antebracoE.png");
        const total = toLoad.length;
        let loaded = 0;
        const progressBar = document.getElementById("loadingBar");
        await Promise.all(toLoad.map(src => loadAndCache(src).then(() => {
            loaded++;
            progressBar.style.width = (loaded/total)*100 + "%";
        })));
        document.getElementById("loadingOverlay").style.opacity = "0";
        setTimeout(() => { 
            document.getElementById("loadingOverlay").style.display = "none"; 
            document.getElementById("playBtn").disabled = false; 
            document.getElementById("playBtn").innerText = "‚ñ∂ Play";
            document.getElementById("playAleatorioBtn").disabled = false;
        }, 500);
    }

    // ... (restante do c√≥digo JavaScript mantido igual)

    // Apenas adicionando o event listener para redimensionamento
    window.addEventListener('resize', adjustForMobile);
    
    // Inicializa o ajuste
    adjustForMobile();

  </script>
</body>
</html>
