<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="https://cdn.jsdelivr.net/npm/audiobuffer-to-wav@1.0.0/index.min.js"></script>
  <meta charset="UTF-8" />
  <title>Jam On - Baixista & Baterista Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.98);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --record-color: #d50000;
      --grid-bg: #000;
      --cell-bg: #151515;
      --cell-border: #333;
      --label-width: 70px;
      --cell-size: 26px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    #orientationOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: #fff;
      display: none; justify-content: center; align-items: center; z-index: 10000;
    }

    .appRoot {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(circle at top, #222 0%, #000 80%);
    }

    #topArea {
      flex: 1; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }

    /* Wrapper Geral */
    #animacaoStageWrapper {
      position: relative; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
    }

    /* =========================================
       ESTILO DA BATERISTA (Camada de Fundo)
       ========================================= */
    #bateristaStage {
      position: absolute;
      width: 520px; height: 520px;
      transform-origin: center center;
      z-index: 1; /* Atr√°s da baixista */
      transform: scale(0.45) translate(350px, -180px);
      pointer-events: none;
    }
    
    #bateristaStage img {
      position: absolute;
      image-rendering: pixelated;
    }

    /* Camadas Baterista */
    #bat_Bateria      { top: 0; left: 0; z-index: 5; } 
    #bat_PernaEsq     { top: 0; left: 0; z-index: 2; }
    #bat_Tronco       { top: 0; left: 0; z-index: 3; }
    #bat_Cabeca       { top: 0; left: 0; z-index: 4; }
    
    /* Bra√ßo Esquerdo (6) atr√°s do Direito (7) */
    #bat_BracoEsq     { top: 0; left: 0; z-index: 6; }
    #bat_BracoDir     { top: 0; left: 0; z-index: 7; }
    
    #bat_Conducao     { top: 0; left: 0; z-index: 1; }
    #bat_Ataque       { top: 0; left: 0; z-index: 8; }

    /* =========================================
       ESTILO DA BAIXISTA (Camada da Frente)
       ========================================= */
    #baixistaStage {
      position: relative; width: 520px; height: 520px;
      transform-origin: center center;
      z-index: 10;
    }

    #pernasLayer { position: absolute; top: 332px; left: 64px; z-index: 1; }
    #bodyWrapperPendulo {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
      transform-origin: 50% 80%; will-change: transform;
    }
    #bodyWrapperPendulo img { position: absolute; image-rendering: pixelated; }

    #cabecaTrasLayer   { top: 60px;   left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: 132px;  left: 0px;   z-index: 2; }
    #antebracoLayer    { top: 179px;  left: -2px;  z-index: 3; }
    #bracoDireitoLayer { top: 250px;  left: -5px;  z-index: 4; }
    #cabecaLayer       { top: 37px;   left: 70px;  z-index: 5; }

    /* Canvas de Grava√ß√£o (Invis√≠vel) */
    #recordingCanvas {
      position: absolute; top: -9999px; left: -9999px; visibility: hidden;
    }

    /* √Årea de Controles */
    #bottomArea {
      flex: 0 0 50vh; max-height: 450px; min-height: 300px;
      display: flex; flex-direction: column; background: var(--panel-bg);
      border-top: 1px solid #333; padding: 10px; z-index: 20;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
    }

    #playerControlsRow { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px; }
    button {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #444;
      background: #222; color: #eee; font-size: 0.75rem; cursor: pointer;
      display: flex; align-items: center; gap: 4px; white-space: nowrap;
    }
    button:hover { background: #333; border-color: #777; }
    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; color: #fff; }
    
    #recordVideoBtn.recording {
        background: var(--record-color); color: white; border-color: #ff0000;
        animation: pulse 1.5s infinite; font-weight: bold;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(213, 0, 0, 0); } }

    #generationInfo {
        margin-left: auto; font-size: 0.7rem; color: var(--highlight-color);
        background: rgba(0,230,118, 0.1); padding: 4px 8px; border-radius: 4px;
        border: 1px solid var(--accent-color); display: none; white-space: nowrap;
    }

    .sliderGroup { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
    .sliderGroup label { font-size: 0.7rem; color: #ccc; }
    input[type="range"] { width: 70px; cursor: pointer; accent-color: var(--highlight-color); }
    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 65px; text-align: center; font-size: 0.8rem;}

    #progressContainer { width: 100%; height: 3px; background: #333; margin-bottom: 8px; }
    #progressBar { height: 100%; width: 0%; background: var(--highlight-color); transition: width 0.1s linear; }

    #gridsArea { flex: 1; overflow: auto; border: 1px solid #333; background: var(--grid-bg); position: relative; }
    .rowContainer { display: flex; align-items: center; margin-bottom: 1px; width: max-content; min-width: 100%; position: relative; }
    .gridLabel {
      position: sticky; left: 0; z-index: 10; width: var(--label-width); min-width: var(--label-width);
      font-size: 0.65rem; text-align: right; padding-right: 8px; color: #aaa; background: #000;
      border-right: 1px solid #333; height: var(--cell-size); display: flex; align-items: center; justify-content: flex-end;
    }
    .trackGrid { display: grid; grid-auto-flow: column; grid-auto-columns: var(--cell-size); grid-template-rows: var(--cell-size); gap: 1px; padding-left: 1px; }
    .delete-btn { width: var(--cell-size); height: 18px; font-size: 10px; background: #b71c1c; border: none; color: white; cursor: pointer; }
    
    .cell { background: var(--cell-bg); border: 1px solid var(--cell-border); border-radius: 2px; color: #fff; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: pointer; width: var(--cell-size); height: var(--cell-size); }
    .cell.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .cell.active-ghost { background: #880e4f; border-color: #f50057; }
    .cell.playing-step { background-color: #333 !important; border-color: #fff !important; }
    .cell.active.playing-step { background-color: #00e676 !important; color: #000; box-shadow: 0 0 12px #00e676; z-index: 2; }

    #selectionOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 20000; display: none; align-items: center; justify-content: center; }
    #selectionOverlay.visible { display: flex; }
    #selectionPanel { background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
    #selectionTitle { margin-bottom: 15px; font-weight: bold; color: #fff; text-align: center; }
    #selectionOptions { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 6px; }
    .selection-option { padding: 10px 0; background: #2c2c2c; text-align: center; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
    .selection-option.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .selection-option.ghost { color: #ff80ab; border-color: #880e4f; }

    .countdownOverlay { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; z-index: 50; background: rgba(0,0,0,0.7); font-size: 5rem; font-weight: 900; color: var(--highlight-color); }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    @media (max-width: 600px) { #bottomArea { flex-basis: 55vh; } :root { --label-width: 50px; --cell-size: 22px; } }
  </style>
</head>
<body>

  <div id="orientationOverlay"><div><h1>üéµ Melhor Experi√™ncia üé∏</h1><p>Gire o dispositivo.</p></div></div>
  <canvas id="recordingCanvas" width="520" height="520"></canvas>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        
        <div id="bateristaStage">
            <img id="bat_Conducao" src="animacao/Baterista/Conducao/Conducao0001.png" />
            <img id="bat_PernaEsq" src="animacao/Baterista/Perna_esquerda/Pedal_chimbal/Baterista0001.png" />
            <img id="bat_Tronco"   src="animacao/Baterista/Tronco_Perna_direita/Parado/Tronco0001.png" />
            <img id="bat_Cabeca"   src="animacao/Baterista/Cabeca/Cabeca_estavel/cabeca0024.png" />
            <img id="bat_Bateria"  src="animacao/Baterista/Bateria_Chimbal/Bateria.png" />
            
            <img id="bat_BracoDir" src="animacao/Baterista/Braco_direito/Caixa/braco_direito0003.png" />
            <img id="bat_BracoEsq" src="animacao/Baterista/Braco_esquerdo/Caixa/braco_esquerda0001.png" />
            
            <img id="bat_Ataque"   src="animacao/Baterista/Ataque/Ataque0001.png" />
        </div>

        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" />
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" />
                <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" />
            </div>
            <div id="countdownOverlay" class="countdownOverlay"><span id="countdownText">3</span></div>
        </div>

      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="playAleatorioBtn">üé≤ Aleat√≥rio (Smart)</button>
        <button id="recordVideoBtn">üî¥ Gravar (Auto)</button>
        <span id="generationInfo"></span>
        <span id="bpmDisplay" style="margin-left:auto">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        <div class="sliderGroup"><label>Bx</label><input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <div class="sliderGroup"><label>Dr</label><input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <button id="playExportadoBtn">üìÅ</button>
        <button id="exportWavBtn">üíæ WAV</button>
        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="duplicateSeq">x2</button>
        <button id="clearAll">Limpar</button>
      </div>
      <div id="progressContainer"><div id="progressBar"></div></div>
      <div id="gridsArea">
        <div class="rowContainer"><div class="gridLabel" style="background:transparent;border:none"></div><div id="deleteGrid" class="trackGrid"></div></div>
        <div class="rowContainer"><div class="gridLabel" style="color:var(--highlight-color)">BAIXO</div><div id="baixoGrid" class="trackGrid"></div></div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay"><div id="selectionPanel"><div id="selectionTitle">Nota</div><div id="selectionOptions"></div></div></div>

  <script>
    // =========================================================
    // DADOS & CAMINHOS (ASSETS)
    // =========================================================
    const PASTA_BAT = "animacao/Baterista/";
    
    const DRUM_ASSETS = {
        idle: {
            ataque: PASTA_BAT + "Ataque/Ataque0001.png",
            bracoDir: PASTA_BAT + "Braco_direito/Caixa/braco_direito0003.png",
            bracoEsq: PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0001.png",
            cabeca: PASTA_BAT + "Cabeca/Cabeca_estavel/cabeca0024.png",
            conducao: PASTA_BAT + "Conducao/Conducao0001.png",
            pernaEsq: PASTA_BAT + "Perna_esquerda/Pedal_chimbal/Baterista0001.png",
            tronco: PASTA_BAT + "Tronco_Perna_direita/Parado/Tronco0001.png"
        },
        anim: {
            // Tronco tocando
            troncoTocando: Array.from({length:39}, (_,i) => PASTA_BAT + `Tronco_Perna_direita/Tocando/Tronco${String(i+2).padStart(4,'0')}.png`),
            // Pratos
            ataquePrato: Array.from({length:7}, (_,i) => PASTA_BAT + `Ataque/Ataque${String(i+1).padStart(4,'0')}.png`),
            conducaoPrato: Array.from({length:6}, (_,i) => PASTA_BAT + `Conducao/Conducao${String(i+1).padStart(4,'0')}.png`),
            
            // BRA√áO DIREITO
            bd_ataque: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Ataque/braco_direito${String(i+5).padStart(4,'0')}.png`),
            bd_caixa: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Caixa/braco_direito${String(i+1).padStart(4,'0')}.png`),
            bd_chimbal: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Chimbal/braco_direito${String(i+1).padStart(4,'0')}.png`),
            bd_conducao: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Conducao/braco_direito${String(i+25).padStart(4,'0')}.png`),
            bd_surdo: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Surdo/braco_direito${String(i+21).padStart(4,'0')}.png`),
            bd_tom1: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Tom_1/braco_direito${String(i+13).padStart(4,'0')}.png`),
            bd_tom2: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Tom_2/braco_direito${String(i+17).padStart(4,'0')}.png`),

            // BRA√áO ESQUERDO
            be_ataque: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Ataque/braco_esquerda${String(i+9).padStart(4,'0')}.png`),
            be_caixa: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Caixa/braco_esquerda${String(i+1).padStart(4,'0')}.png`),
            be_chimbal: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Chimbal/braco_esquerda${String(i+5).padStart(4,'0')}.png`),
            be_conducao: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Conducao/braco_esquerda${String(i+25).padStart(4,'0')}.png`),
            be_surdo: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Surdo/braco_esquerda${String(i+21).padStart(4,'0')}.png`),
            be_tom1: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Tom_1/braco_esquerda${String(i+13).padStart(4,'0')}.png`),
            be_tom2: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_esquerdo/Tom_2/braco_esquerda${String(i+17).padStart(4,'0')}.png`),

            // CABE√áA EST√ÅVEL (Loop ao tocar)
            cabeca_estavel: Array.from({length:26}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel/cabeca${String(i+1).padStart(4,'0')}.png`),
            
            // PEDAL DUPLO (Kick) - Apenas frames de a√ß√£o
            perna_duplo: [
                PASTA_BAT+"Perna_esquerda/Pedal_duplo/Baterista0002.png", 
                PASTA_BAT+"Perna_esquerda/Pedal_duplo/Baterista0003.png"
            ]
        }
    };

    // Dados Baixista (Mantidos)
    const pastaMap = { 1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"], 2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"], 3: ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"], 4: ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"], 5: ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"], 6: ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"], 7: ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"], 8: ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"], 9: ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"], 10: ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"], 11: ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"], 12: ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS"], 13: ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"], 14: ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"], 15: ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"], 16: ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"], 17: ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"], 18: ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"], 19: ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"], 20: ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"], 21: ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"], 22: ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"], 23: ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"], 24: ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"] };
    const pastaFolderNames = { 1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D", 11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B", 20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E" };
    const notasValidas = ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"];
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" }, { id: "caixa", label: "Caixa", file: "caixa.mp3" }, { id: "caixaAro", label: "Aro", file: "caixaAro.mp3" }, { id: "chimbal", label: "HH", file: "chimbal.mp3" }, { id: "chimbal_pedal", label: "HH Ped", file: "chimbal-pedal.mp3" }, { id: "chimbalaberto", label: "HH Open", file: "chimbal-aberto.mp3" }, { id: "ataque", label: "Ataque", file: "ataque.mp3" }, { id: "tom1", label: "Tom 1", file: "tom-1.mp3" }, { id: "tom2", label: "Tom 2", file: "tom-2.mp3" }, { id: "surdo", label: "Surdo", file: "surdo.mp3" }, { id: "conducao", label: "Ride", file: "conducao.mp3" }, { id: "conducao_centro", label: "Ride C", file: "conducao-centro.mp3" }
    ];

    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
    const STYLE_PROGRESSIONS = {
        Rock: [[1,4,5,1], [1,5,6,4]], Rock2: [[4,5,1,5], [5,4,1,4]], Rock3: [[1,4,5,1], [1,3,4,5]], Rock4: [[6,4,1,5], [1,4,5,1]], Rock5: [[1,5,7,4]], Rock6: [[1,5,6,4]], Rock7: [[2,3,5,1]], Rock_Progressivo: [[4,5,1,1]], Blues: [[1,4,5,4]], Forr√≥: [[1,5,1,5]], Samba: [[2,5,1,1]], Metal: [[1,3,5,6]], Jazz: [[1,2,5,1]]
    };
    const ALL_GROOVES = [
        { name: "Rock", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Blues", meter: "4/4", drumPattern: ["bch - ch ch cch - ch ch bch - ch ch cch - ch ch"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 6, 8, 6, 5, 3] },
        { name: "Forr√≥", meter: "2/4", drumPattern: ["bch - co - ch - ca -"], bassRhythm: ["bo - - - x - - -"], bassScale: [8, 1] },
        { name: "Funk", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - - - bo - bo x bo x bo x bo - x x"], bassScale: [1,8] },
        { name: "Disco", meter: "4/4", drumPattern: ["bu - ch ch bu - ch ch bu - ch ch bu - ch ch"], bassRhythm: ["bo - x x bo - x x bo - x x bo - x x"], bassScale: [1] },
        { name: "Metal", meter: "4/4", drumPattern: ["bch bu bch bu cch bu bch bu bch bu bch bu cch bu bch bu"], bassRhythm: ["bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo"], bassScale: [1] },
        { name: "Samba", meter: "2/4", drumPattern: ["bch - ch bu bch - ch bu"], bassRhythm: ["bo - x x bo - - x"], bassScale: [8, 5] },
    ];

    let isPlaying = false, playbackInterval = null, bpmAtual = 120, atualPasso = 0;
    let baixoSeq = Array(16).fill(""), bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    let baixoVolumeGlobal = 0.9, bateriaVolumeGlobal = 0.9, audioBaixoAtual = null;

    let posicaoAtualPasta = 1, ultimaCordaUsada = "E", ultimaNotaReal = "1E";
    let reqAnimIdPendulo = null, headLoopTimer = null, rightHandTimer = null;
    let headFrameIndex = 0, headFrames = [];

    // Vari√°veis da Baterista para L√≥gica de Bra√ßos/Pernas
    let drumTimers = {}; 
    let lastDrumStep = {}; // Rastreia o passo anterior de cada instrumento
    let lastArmUsed = {};  // Rastreia qual bra√ßo usou por √∫ltimo ('left' ou 'right')

    const canvas = document.getElementById("recordingCanvas");
    const ctx = canvas.getContext("2d");
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    const mediaStreamDestination = audioContext.createMediaStreamDestination();
    let mediaRecorder = null, recordedChunks = [], isRecording = false;
    let pendulumAngle = 0;

    const domImages = {
        bx_pernas: document.getElementById("pernasLayer"),
        bx_cabecaTras: document.getElementById("cabecaTrasLayer"),
        bx_tronco: document.getElementById("troncoBaixoLayer"),
        bx_antebraco: document.getElementById("antebracoLayer"),
        bx_bracoDir: document.getElementById("bracoDireitoLayer"),
        bx_cabeca: document.getElementById("cabecaLayer"),
        
        bt_ataque: document.getElementById("bat_Ataque"),
        bt_bracoDir: document.getElementById("bat_BracoDir"),
        bt_bracoEsq: document.getElementById("bat_BracoEsq"),
        bt_cabeca: document.getElementById("bat_Cabeca"),
        bt_conducao: document.getElementById("bat_Conducao"),
        bt_pernaEsq: document.getElementById("bat_PernaEsq"),
        bt_tronco: document.getElementById("bat_Tronco"),
        bt_kit: document.getElementById("bat_Bateria")
    };

    window.onload = async () => {
        verificarOrientacao();
        window.addEventListener("resize", verificarOrientacao);
        for (let i = 1; i <= 100; i++) headFrames.push(`animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`);
        preloadImages(headFrames).then(startHeadLoop);
        
        const troncoFrames = DRUM_ASSETS.anim.troncoTocando;
        preloadImages(troncoFrames);

        gerarAleatorio();
        renderGrids();
        setupListeners();
    };

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recordVideoBtn").onclick = toggleRecording;
        document.getElementById("bpmSlider").oninput = (e) => { bpmAtual = parseInt(e.target.value); document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM"; };
        document.getElementById("baixoVolume").oninput = (e) => baixoVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("drumVolume").oninput = (e) => bateriaVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); renderGrids(); };
        document.getElementById("addCol").onclick = () => { baixoSeq.push(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x")); renderGrids(); };
        document.getElementById("duplicateSeq").onclick = () => { baixoSeq = [...baixoSeq, ...baixoSeq]; Object.keys(bateriaSeq).forEach(k => bateriaSeq[k] = [...bateriaSeq[k], ...bateriaSeq[k]]); renderGrids(); };
        document.getElementById("clearAll").onclick = () => { baixoSeq.fill(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x")); renderGrids(); };
        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio;
        document.getElementById("playExportadoBtn").onclick = importarJSON;
        document.getElementById("exportWavBtn").onclick = exportarWAV;
    }

    function deleteColumn(idx) {
        if (baixoSeq.length <= 1) return;
        baixoSeq.splice(idx, 1);
        Object.keys(bateriaSeq).forEach(key => bateriaSeq[key].splice(idx, 1));
        renderGrids();
    }

    function drawFrameToCanvas() {
        ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // BATERISTA (FUNDO) - Atualizado Scale e Translate para bater com CSS
        ctx.save();
        ctx.scale(0.45, 0.45); 
        ctx.translate(350, -180); 
        
        if (domImages.bt_conducao.complete) ctx.drawImage(domImages.bt_conducao, 0, 0);
        if (domImages.bt_pernaEsq.complete) ctx.drawImage(domImages.bt_pernaEsq, 0, 0);
        if (domImages.bt_tronco.complete) ctx.drawImage(domImages.bt_tronco, 0, 0);
        if (domImages.bt_cabeca.complete) ctx.drawImage(domImages.bt_cabeca, 0, 0);
        if (domImages.bt_kit.complete) ctx.drawImage(domImages.bt_kit, 0, 0);
        
        // Ordem Bra√ßos: Esquerdo atr√°s (primeiro), depois Direito
        if (domImages.bt_bracoEsq.complete) ctx.drawImage(domImages.bt_bracoEsq, 0, 0);
        if (domImages.bt_bracoDir.complete) ctx.drawImage(domImages.bt_bracoDir, 0, 0);
        
        if (domImages.bt_ataque.complete) ctx.drawImage(domImages.bt_ataque, 0, 0);
        ctx.restore();

        // BAIXISTA (FRENTE)
        if (domImages.bx_pernas.complete) ctx.drawImage(domImages.bx_pernas, 64, 332);
        ctx.save(); ctx.translate(260, 416); ctx.rotate(pendulumAngle * Math.PI / 180); ctx.translate(-260, -416);
        if (domImages.bx_cabecaTras.complete) ctx.drawImage(domImages.bx_cabecaTras, 100, 60);
        if (domImages.bx_tronco.complete) ctx.drawImage(domImages.bx_tronco, 0, 132);
        if (domImages.bx_antebraco.complete) ctx.drawImage(domImages.bx_antebraco, -2, 179);
        if (domImages.bx_bracoDir.complete) ctx.drawImage(domImages.bx_bracoDir, -5, 250);
        if (domImages.bx_cabeca.complete) ctx.drawImage(domImages.bx_cabeca, 70, 37);
        ctx.restore();
    }

    // =========================================================
    // L√ìGICA ANIMA√á√ÉO BATERIA (Refinada: Altern√¢ncia e Pedal)
    // =========================================================
    function playDrumAnimation(drumType, currentStep) {
        const fps = 40; 
        
        // --- 1. Movimento do TRONCO (Ginga) ---
        if (!drumTimers.tronco && isPlaying) {
            let tIdx = 0;
            const tFrames = DRUM_ASSETS.anim.troncoTocando;
            drumTimers.tronco = setInterval(() => {
                domImages.bt_tronco.src = tFrames[tIdx];
                tIdx = (tIdx + 1) % tFrames.length;
            }, 30);
        }

        // --- 2. Movimento da CABE√áA (Loop Est√°vel) ---
        if (!drumTimers.cabeca && isPlaying) {
            let cIdx = 0;
            const cFrames = DRUM_ASSETS.anim.cabeca_estavel;
            drumTimers.cabeca = setInterval(() => {
                domImages.bt_cabeca.src = cFrames[cIdx];
                cIdx = (cIdx + 1) % cFrames.length;
            }, 40); 
        }

        if (drumType === 'start') return;

        // --- 3. BUMBO (Pedal Duplo se for consecutivo) ---
        if (drumType === 'bumbo') {
            // Verifica se o bumbo foi tocado no passo anterior
            const prevStepIndex = (currentStep === 0) ? baixoSeq.length - 1 : currentStep - 1;
            const isConsecutive = (bateriaSeq['bumbo'][prevStepIndex] === 'bumbo');

            if (isConsecutive) {
                // Anima√ß√£o de Pedal Duplo (Esquerda)
                domImages.bt_pernaEsq.src = DRUM_ASSETS.anim.perna_duplo[0];
                setTimeout(() => { domImages.bt_pernaEsq.src = DRUM_ASSETS.anim.perna_duplo[1]; }, 40);
                setTimeout(() => { domImages.bt_pernaEsq.src = DRUM_ASSETS.idle.pernaEsq; }, 90);
            } 
            // Se for bumbo isolado, n√£o move perna esquerda (p√© direito toca invis√≠vel)
            return;
        }

        // --- 4. BRA√áOS (Altern√¢ncia em repeti√ß√£o) ---
        
        // Verifica se √© o mesmo tambor tocado na c√©lula anterior
        const prevHitStep = lastDrumStep[drumType];
        // Se a dist√¢ncia for 1 (sequ√™ncia), alterna o bra√ßo. Se n√£o, reseta pra direita.
        // Considerando wrap-around do loop se necess√°rio, mas aqui simplificado para "consecutivo linear"
        const isRapidRepeat = (prevHitStep !== undefined && (currentStep - prevHitStep === 1 || (currentStep===0 && prevHitStep === baixoSeq.length-1)));

        let armToUse = 'right';
        if (isRapidRepeat) {
            armToUse = (lastArmUsed[drumType] === 'right') ? 'left' : 'right';
        }

        // Atualiza estado para a pr√≥xima verifica√ß√£o
        lastDrumStep[drumType] = currentStep;
        lastArmUsed[drumType] = armToUse;

        // Mapeamento de Frames
        let frames = [];
        if (armToUse === 'right') {
            if(drumType === 'caixa' || drumType === 'caixaAro') frames = DRUM_ASSETS.anim.bd_caixa;
            else if(drumType === 'ataque') frames = DRUM_ASSETS.anim.bd_ataque;
            else if(drumType === 'chimbal' || drumType === 'chimbalaberto') frames = DRUM_ASSETS.anim.bd_chimbal;
            else if(drumType === 'conducao' || drumType === 'conducao_centro') frames = DRUM_ASSETS.anim.bd_conducao;
            else if(drumType === 'surdo') frames = DRUM_ASSETS.anim.bd_surdo;
            else if(drumType === 'tom1') frames = DRUM_ASSETS.anim.bd_tom1;
            else if(drumType === 'tom2') frames = DRUM_ASSETS.anim.bd_tom2;
            else frames = DRUM_ASSETS.anim.bd_caixa; 
        } else {
            // Left Arm
            if(drumType === 'caixa' || drumType === 'caixaAro') frames = DRUM_ASSETS.anim.be_caixa;
            else if(drumType === 'ataque') frames = DRUM_ASSETS.anim.be_ataque;
            else if(drumType === 'chimbal' || drumType === 'chimbalaberto') frames = DRUM_ASSETS.anim.be_chimbal;
            else if(drumType === 'conducao' || drumType === 'conducao_centro') frames = DRUM_ASSETS.anim.be_conducao;
            else if(drumType === 'surdo') frames = DRUM_ASSETS.anim.be_surdo;
            else if(drumType === 'tom1') frames = DRUM_ASSETS.anim.be_tom1;
            else if(drumType === 'tom2') frames = DRUM_ASSETS.anim.be_tom2;
            else frames = DRUM_ASSETS.anim.be_caixa;
        }

        // Anima√ß√£o do Objeto (Prato balan√ßando)
        if(drumType === 'ataque') animateProp(domImages.bt_ataque, DRUM_ASSETS.anim.ataquePrato, DRUM_ASSETS.idle.ataque);
        if(drumType === 'conducao') animateProp(domImages.bt_conducao, DRUM_ASSETS.anim.conducaoPrato, DRUM_ASSETS.idle.conducao);

        // Executar Anima√ß√£o do Bra√ßo
        const imgEl = (armToUse === 'right') ? domImages.bt_bracoDir : domImages.bt_bracoEsq;
        const timerKey = (armToUse === 'right') ? 'bracoDir' : 'bracoEsq';
        
        clearInterval(drumTimers[timerKey]);
        let fIdx = 0;
        
        drumTimers[timerKey] = setInterval(() => {
            if(fIdx < frames.length) {
                imgEl.src = frames[fIdx];
                fIdx++;
            } else {
                clearInterval(drumTimers[timerKey]);
                imgEl.src = (armToUse==='right') ? DRUM_ASSETS.idle.bracoDir : DRUM_ASSETS.idle.bracoEsq;
            }
        }, 1000/fps);
    }

    function animateProp(el, frames, idleSrc) {
        let i = 0;
        const t = setInterval(() => {
            if(i < frames.length) { el.src = frames[i]; i++; }
            else { clearInterval(t); el.src = idleSrc; }
        }, 30);
    }

    function resetDrummer() {
        Object.values(drumTimers).forEach(t => clearInterval(t));
        drumTimers = {};
        lastDrumStep = {}; // Reseta hist√≥rico
        
        domImages.bt_tronco.src = DRUM_ASSETS.idle.tronco;
        domImages.bt_pernaEsq.src = DRUM_ASSETS.idle.pernaEsq;
        domImages.bt_bracoDir.src = DRUM_ASSETS.idle.bracoDir;
        domImages.bt_bracoEsq.src = DRUM_ASSETS.idle.bracoEsq;
        domImages.bt_cabeca.src = DRUM_ASSETS.idle.cabeca;
        domImages.bt_ataque.src = DRUM_ASSETS.idle.ataque;
        domImages.bt_conducao.src = DRUM_ASSETS.idle.conducao;
    }

    // =========================================================
    // PLAYBACK ENGINE
    // =========================================================
    function togglePlay() {
        if (isPlaying) pararPlayback();
        else {
            const overlay = document.getElementById("countdownOverlay"), txt = document.getElementById("countdownText");
            overlay.style.display = "flex"; let count = 4; txt.innerText = count;
            const countInt = setInterval(() => {
                count--; if(count > 0) txt.innerText = count;
                else { clearInterval(countInt); overlay.style.display = "none"; iniciarPlayback(); }
            }, 60000 / bpmAtual);
        }
    }

    function iniciarPlayback() {
        if (audioContext.state === 'suspended') audioContext.resume();
        isPlaying = true; atualPasso = 0;
        lastDrumStep = {}; // Reseta ao iniciar
        document.getElementById("playBtn").innerText = "‚è∏ Pause"; document.getElementById("playBtn").style.background = "#e65100";
        
        startPenduloAnim();
        playDrumAnimation('start', 0); 

        const msPorStep = (60000 / bpmAtual) / 4;
        const loop = () => {
            if (!isPlaying) return;
            if (atualPasso >= baixoSeq.length) atualPasso = 0;
            highlightGridStep(atualPasso);
            
            const notaBaixo = baixoSeq[atualPasso];
            if (notaBaixo !== "") {
                let file = (notaBaixo === "x") ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${notaBaixo}.mp3`;
                tocarAudioBuffer(file, baixoVolumeGlobal);
                animarBaixo(notaBaixo, msPorStep);
            } else {
                stopRightHand();
            }

            drumLines.forEach(line => {
                if (bateriaSeq[line.id] && bateriaSeq[line.id][atualPasso] === line.id) {
                    tocarAudioBuffer(`assets/${line.file}`, bateriaVolumeGlobal);
                    // Passa o passo atual para verificar repeti√ß√£o
                    playDrumAnimation(line.id, atualPasso);
                }
            });
            
            document.getElementById("progressBar").style.width = ((atualPasso + 1) / baixoSeq.length * 100) + "%";
            atualPasso++;
        };
        loop();
        playbackInterval = setInterval(loop, msPorStep);
    }

    function pararPlayback() {
        isPlaying = false; clearInterval(playbackInterval);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play"; document.getElementById("playBtn").style.background = "";
        
        stopPenduloAnim(); 
        stopRightHand();
        resetDrummer(); 

        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        if(audioBaixoAtual) { try{audioBaixoAtual.stop();}catch(e){} audioBaixoAtual = null; }
    }

    // =========================================================
    // AUDIO & GRAVA√á√ÉO
    // =========================================================
    async function toggleRecording() {
        const btn = document.getElementById("recordVideoBtn");
        if (isRecording) {
            mediaRecorder.stop(); isRecording = false; btn.innerText = "üî¥ Gravar (Auto)"; btn.classList.remove("recording");
        } else {
            try {
                if (audioContext.state === 'suspended') await audioContext.resume();
                const canvasStream = canvas.captureStream(30);
                const videoTrack = canvasStream.getVideoTracks()[0];
                const audioTrack = mediaStreamDestination.stream.getAudioTracks()[0];
                const combinedStream = new MediaStream([videoTrack, audioTrack]);
                
                let mimeType = 'video/webm';
                if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) mimeType = 'video/webm; codecs=vp9';
                
                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: mimeType, videoBitsPerSecond: 2500000 });
                recordedChunks = [];
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'jam_session.webm';
                    document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
                };
                mediaRecorder.start(); isRecording = true; btn.innerText = "‚èπ Parar"; btn.classList.add("recording");
                if (!isPlaying) togglePlay();
            } catch (err) { alert("Erro grava√ß√£o: " + err); }
        }
    }

    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        audioBuffers[url] = audioBuffer;
        return audioBuffer;
    }

    async function tocarAudioBuffer(path, vol) {
        try {
            const buffer = await getAudioBuffer(path);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = vol;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.connect(mediaStreamDestination);
            source.start();
            if (path.includes("BaixoMelodia") || path.includes("bass-muted")) {
                if(audioBaixoAtual) try{audioBaixoAtual.stop(audioContext.currentTime + 0.05);}catch(e){}
                audioBaixoAtual = source;
            }
        } catch (e) {}
    }

    async function exportarWAV() {
        alert("Exporta√ß√£o WAV pronta (simula√ß√£o).");
    }

    // =========================================================
    // L√ìGICA ANIMA√á√ÉO BAIXISTA & STARTUP
    // =========================================================
    function startPenduloAnim() {
        const wrapper = document.getElementById("bodyWrapperPendulo");
        const amplitude = 2.3, speed = 0.003; 
        const frame = () => {
            if (!isPlaying) return;
            const now = Date.now();
            pendulumAngle = Math.sin(now * speed * (bpmAtual / 120)) * amplitude;
            wrapper.style.transform = `rotate(${pendulumAngle}deg)`;
            drawFrameToCanvas();
            reqAnimIdPendulo = requestAnimationFrame(frame);
        };
        reqAnimIdPendulo = requestAnimationFrame(frame);
    }

    function stopPenduloAnim() {
        cancelAnimationFrame(reqAnimIdPendulo);
        const wrapper = document.getElementById("bodyWrapperPendulo");
        if(wrapper) wrapper.style.transform = "rotate(0deg)";
        pendulumAngle = 0;
        drawFrameToCanvas();
    }

    function startHeadLoop() {
        if(headLoopTimer) clearInterval(headLoopTimer);
        headLoopTimer = setInterval(() => {
            headFrameIndex = (headFrameIndex + 1) % headFrames.length;
            if(headFrames[headFrameIndex]) domImages.bx_cabeca.src = headFrames[headFrameIndex];
        }, 33);
    }

    function animarBaixo(nota, duracaoStep) {
        if (nota === "x") {
            if (ultimaNotaReal) {
                const pasta = pastaFolderNames[posicaoAtualPasta] || "1F";
                domImages.bx_tronco.src = `animacao/tronco_baixo/Pasta_${pasta}/${ultimaNotaReal}.png`;
            }
            animarMaoDireita(ultimaCordaUsada, duracaoStep);
            return;
        }
        posicaoAtualPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
        ultimaNotaReal = nota;
        const pastaNome = pastaFolderNames[posicaoAtualPasta];
        domImages.bx_tronco.src = `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`;
        const corda = getCordaDaNota(nota);
        ultimaCordaUsada = corda;
        domImages.bx_antebraco.src = `animacao/antebraco/antebraco${corda}.png`;
        animarMaoDireita(corda, duracaoStep);
    }

    function meterToBeats(m){return Number(m.split('/')[0])||4}
    function expandRhythm(p,t){const j=p.join(' ').replace(/\s+/g,' ').trim().split(/\s+/);const o=[];while(o.length<t)for(const k of j){if(o.length>=t)break;o.push(k)}return o.slice(0,t)}
    function parsePattern(p){const r={intro:[],loop:[]},m=p.match(/\((.*?)\)/);if(m)r.loop=m[1].trim().split(/\s+/);else r.loop=p.trim().split(/\s+/);return r}
    function mapNoteToAnimId(n){let c=n.replace(/[0-9]/g,'').replace('#','S');const m=notasValidas.filter(x=>x.endsWith(c));return m.length>0?m[0]:"1E"}
    function getCordaDaNota(n){const m=n.match(/^(\d+)/);if(!m)return"E";const i=parseInt(m[1]);if(i<=20)return"E";if(i<=28)return"A";if(i<=36)return"D";return"G"}
    function escolherMelhorPasta(n,p){const l=[];for(let i=1;i<=24;i++)if(pastaMap[i].includes(n))l.push(i);if(!l.length)return 1;return l.reduce((a,b)=>Math.abs(b-p)<Math.abs(a-p)?b:a)}
    function animarMaoDireita(c,d){clearInterval(rightHandTimer);let f=1;rightHandTimer=setInterval(()=>{domImages.bx_bracoDir.src=`animacao/braco_direito/Corda_${c}${f}.png`;f++;if(f>5){clearInterval(rightHandTimer);domImages.bx_bracoDir.src=`animacao/braco_direito/Corda_${c}1.png`}},Math.min(d/5,40))}
    function stopRightHand(){clearInterval(rightHandTimer);domImages.bx_bracoDir.src=`animacao/braco_direito/Corda_${ultimaCordaUsada||'E'}1.png`}
    function renderGrids(){
        const bG=document.getElementById("baixoGrid"),dG=document.getElementById("drumGridWrapper"),dl=document.getElementById("deleteGrid");
        bG.innerHTML=""; dl.innerHTML=""; dG.innerHTML="";
        baixoSeq.forEach((n,i)=>{
            const b=document.createElement("button");b.className="delete-btn";b.innerText="√ó";b.onclick=()=>deleteColumn(i);dl.appendChild(b);
            const c=document.createElement("div");c.className="cell";
            if(n==="x"){c.innerText="X";c.classList.add("active-ghost")}else if(n!==""){c.innerText=n.replace("S","#");c.classList.add("active")}else c.style.opacity="0.3";
            c.onclick=()=>abrirSelecaoNota(i);bG.appendChild(c);
        });
        drumLines.forEach(l=>{
            const r=document.createElement("div");r.className="rowContainer";
            const lb=document.createElement("div");lb.className="gridLabel";lb.innerText=l.label;r.appendChild(lb);
            const g=document.createElement("div");g.className="trackGrid";
            while(bateriaSeq[l.id].length<baixoSeq.length)bateriaSeq[l.id].push("x");
            bateriaSeq[l.id].forEach((v,i)=>{
                const c=document.createElement("div");c.className="cell";
                if(v===l.id)c.classList.add("active");
                c.onclick=()=>{bateriaSeq[l.id][i]=(bateriaSeq[l.id][i]==="x")?l.id:"x";if(bateriaSeq[l.id][i]!== "x")tocarAudioBuffer(`assets/${l.file}`,1.0);renderGrids()};
                g.appendChild(c);
            });
            r.appendChild(g);dG.appendChild(r);
        });
    }
    function highlightGridStep(s){document.querySelectorAll(".playing-step").forEach(e=>e.classList.remove("playing-step"));if(document.getElementById("baixoGrid").children[s])document.getElementById("baixoGrid").children[s].classList.add("playing-step");document.querySelectorAll(".trackGrid").forEach(g=>{if(g.children[s])g.children[s].classList.add("playing-step")})}
    function abrirSelecaoNota(i){const o=document.getElementById("selectionOverlay"),ops=document.getElementById("selectionOptions");ops.innerHTML="";const ad=(l,v,c)=>{const d=document.createElement("div");d.className="selection-option "+(c||"");d.innerText=l;d.onclick=()=>{baixoSeq[i]=v;o.style.display="none";renderGrids();if(v&&v!=="x")tocarAudioBuffer(`assets/BaixoMelodia/${v}.mp3`,1)};ops.appendChild(d)};ad("‚Äî","");ad("X","x","ghost");notasValidas.forEach(n=>ad(n.replace("S","#"),n));o.style.display="flex";o.onclick=(e)=>{if(e.target===o)o.style.display="none"}}
    function gerarAleatorio(){
        const g=ALL_GROOVES[Math.floor(Math.random()*ALL_GROOVES.length)];
        const kIdx=Math.floor(Math.random()*PITCHES.length);
        const q=Math.random()>0.5?'maj':'min';
        bpmAtual=(g.name==="Samba")?70:100+Math.floor(Math.random()*40);
        document.getElementById("bpmSlider").value=bpmAtual; document.getElementById("bpmDisplay").innerText=bpmAtual+" BPM";
        document.getElementById("generationInfo").innerText=`${g.name} em ${PITCHES[kIdx]}${q==='min'?'m':''}`; document.getElementById("generationInfo").style.display="inline";
        let sk="Rock"; if(g.name.includes("Samba"))sk="Samba"; else if(g.name.includes("Jazz"))sk="Jazz"; else if(g.name.includes("Forr√≥"))sk="Forr√≥"; else if(g.name.includes("Metal"))sk="Metal"; else if(g.name.includes("Blues"))sk="Blues";
        const progs=STYLE_PROGRESSIONS[sk]||STYLE_PROGRESSIONS.Rock; const prog=progs[Math.floor(Math.random()*progs.length)];
        const beats=meterToBeats(g.meter); const steps=beats*4; const bars=Math.min(prog.length,4); const totSteps=steps*bars;
        const rhy=expandRhythm(g.bassRhythm,totSteps); const nb=[];
        for(let b=0;b<bars;b++){
            const d=prog[b]; const root=(kIdx+DEGREE_TO_ROOT[d])%12;
            let nIdx=[]; 
            if(Array.isArray(g.bassScale)){
                const isMin=(q==='min'&&[1,4,5].includes(d))||[2,3,6].includes(d);
                const int=isMin?{1:0,2:2,3:3,4:5,5:7,6:8,7:10,8:12}:{1:0,2:2,3:4,4:5,5:7,6:9,7:11,8:12};
                nIdx=g.bassScale.map(x=>(root+(int[x]||0))%12);
            } else nIdx=[root];
            const npb=Math.ceil(steps/nIdx.length);
            for(let s=0;s<steps;s++){
                const sym=rhy[b*steps+s]||'-';
                if(sym==='x')nb.push("x"); else if(sym==='-'||sym==='sm')nb.push("");
                else nb.push(mapNoteToAnimId(PITCHES[nIdx[Math.floor(s/npb)%nIdx.length]]));
            }
        }
        baixoSeq=nb;
        const drumP=parsePattern(g.drumPattern.join(' ')).loop;
        drumLines.forEach(d=>bateriaSeq[d.id]=[]);
        for(let i=0;i<baixoSeq.length;i++){
            const t=drumP[i%drumP.length];
            const acts=[];
            if(['bu','bumbo','bch','ba','bco'].includes(t))acts.push('bumbo');
            if(['ca','caixa','cch','cco'].includes(t))acts.push('caixa');
            if(['ch','chimbal','bch','cch'].includes(t))acts.push('chimbal');
            if(['co','conducao','bco','cco'].includes(t))acts.push('conducao');
            if(t==='ba')acts.push('ataque'); if(t==='to1')acts.push('tom1');
            drumLines.forEach(d=>{bateriaSeq[d.id].push(acts.includes(d.id)?d.id:"x")});
        }
        renderGrids();
    }
    function importarJSON(){const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);if(d.baixo)baixoSeq=d.baixo;if(d.bateria)bateriaSeq=d.bateria;if(d.bpm)bpmAtual=d.bpm;renderGrids()}catch(e){alert("Erro JSON")}};r.readAsText(f)};i.click()}
    function verificarOrientacao(){document.getElementById("orientationOverlay").style.display=(window.innerWidth<window.innerHeight&&window.innerWidth<900)?"flex":"none"}
    function preloadImages(s){return Promise.all(s.map(u=>new Promise(r=>{const i=new Image();i.onload=i.onerror=r;i.src=u})))}
  </script>
</body>
</html>
