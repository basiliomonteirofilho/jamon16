<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" href="data:,">
  
  <meta charset="UTF-8" />
  <title>Jam On - Mobile Performance (480p Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.98);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --record-color: #d50000;
      --grid-bg: #000;
      --cell-bg: #151515;
      --cell-border: #333;
      --label-width: 70px;
      --cell-size: 26px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    /* TELA DE CARREGAMENTO */
    #loadingOverlay {
      position: fixed; inset: 0; background: #000; z-index: 50000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: var(--highlight-color); font-weight: bold;
      transition: opacity 0.5s;
    }
    #loadingText { margin-bottom: 10px; font-family: monospace; font-size: 1.2rem; }
    #loadingBarContainer {
      width: 300px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;
    }
    #loadingBar {
      height: 100%; background: var(--highlight-color); width: 0%; transition: width 0.1s linear;
    }

    #orientationOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: #fff;
      display: none; justify-content: center; align-items: center; z-index: 10000;
    }

    .appRoot {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(circle at top, #222 0%, #000 80%);
    }

    #topArea {
      flex: 1; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }

    #animacaoStageWrapper {
      position: relative; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      transform-origin: center center;
    }

    /* =========================================
       ESTILO DA BATERISTA (TELA)
       ========================================= */
    #bateristaStage {
      position: absolute;
      width: 520px; height: 520px;
      transform-origin: center center;
      z-index: 1; 
      transform: scale(0.35) translate(250px, -300px);
      pointer-events: none;
    }
    
    #bateristaStage img {
      position: absolute;
      image-rendering: pixelated;
      will-change: transform, src; 
    }

    /* ORDEM DE CAMADAS (Z-INDEX) */
    #bat_PernaEsq     { top: 0; left: 0; z-index: 2; }
    #bat_Tronco       { top: 0; left: 0; z-index: 3; }
    #bat_Cabeca       { top: 0; left: 0; z-index: 4; }
    #bat_BracoEsq     { top: 0; left: 0; z-index: 10; transition: z-index 0.05s; }
    #bat_BracoDir     { top: 0; left: 0; z-index: 11; }
    #bat_Bateria      { top: 0; left: 0; z-index: 20; } 
    #bat_Conducao     { top: 0; left: 0; z-index: 21; } 
    #bat_Ataque       { top: 0; left: 0; z-index: 22; }

    /* =========================================
       ESTILO DA BAIXISTA (TELA)
       ========================================= */
    #baixistaStage {
      position: relative; width: 520px; height: 520px;
      transform-origin: center center;
      z-index: 100; 
    }

    #pernasLayer { position: absolute; top: 332px; left: 64px; z-index: 1; }
    #bodyWrapperPendulo {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
      transform-origin: 50% 80%; will-change: transform;
    }
    #bodyWrapperPendulo img { position: absolute; image-rendering: pixelated; }

    #cabecaTrasLayer   { top: 60px;   left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: 132px;  left: 0px;   z-index: 3; }
    #antebracoLayer    { top: 179px;  left: -2px;  z-index: 2; }
    #bracoDireitoLayer { top: 250px;  left: -5px;  z-index: 4; }
    #cabecaLayer       { top: 37px;   left: 70px;  z-index: 5; }

    /* CANVAS OCULTO OTIMIZADO (854x480 - 480p Wide) */
    #recordingCanvas {
      position: absolute; top: -9999px; left: -9999px; visibility: hidden;
    }

    #bottomArea {
      flex: 0 0 50vh; max-height: 450px; min-height: 300px;
      display: flex; flex-direction: column; background: var(--panel-bg);
      border-top: 1px solid #333; padding: 10px; z-index: 200;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
    }

    #playerControlsRow { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px; }
    button {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #444;
      background: #222; color: #eee; font-size: 0.75rem; cursor: pointer;
      display: flex; align-items: center; gap: 4px; white-space: nowrap;
    }
    button:hover { background: #333; border-color: #777; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; color: #fff; }
    
    #recordVideoBtn.recording {
        background: var(--record-color); color: white; border-color: #ff0000;
        animation: pulse 1.5s infinite; font-weight: bold;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(213, 0, 0, 0); } }

    #generationInfo {
        margin-left: auto; font-size: 0.7rem; color: var(--highlight-color);
        background: rgba(0,230,118, 0.1); padding: 4px 8px; border-radius: 4px;
        border: 1px solid var(--accent-color); display: none; white-space: nowrap;
    }

    .sliderGroup { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
    .sliderGroup label { font-size: 0.7rem; color: #ccc; }
    input[type="range"] { width: 70px; cursor: pointer; accent-color: var(--highlight-color); }
    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 65px; text-align: center; font-size: 0.8rem;}

    #progressContainer { width: 100%; height: 3px; background: #333; margin-bottom: 8px; }
    #progressBar { height: 100%; width: 0%; background: var(--highlight-color); transition: width 0.1s linear; }

    #gridsArea { flex: 1; overflow: auto; border: 1px solid #333; background: var(--grid-bg); position: relative; }
    .rowContainer { display: flex; align-items: center; margin-bottom: 1px; width: max-content; min-width: 100%; position: relative; }
    .gridLabel {
      position: sticky; left: 0; z-index: 10; width: var(--label-width); min-width: var(--label-width);
      font-size: 0.65rem; text-align: right; padding-right: 8px; color: #aaa; background: #000;
      border-right: 1px solid #333; height: var(--cell-size); display: flex; align-items: center; justify-content: flex-end;
    }
    .trackGrid { display: grid; grid-auto-flow: column; grid-auto-columns: var(--cell-size); grid-template-rows: var(--cell-size); gap: 1px; padding-left: 1px; }
    .delete-btn { width: var(--cell-size); height: 18px; font-size: 10px; background: #b71c1c; border: none; color: white; cursor: pointer; }
    
    .cell { background: var(--cell-bg); border: 1px solid var(--cell-border); border-radius: 2px; color: #fff; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: pointer; width: var(--cell-size); height: var(--cell-size); }
    .cell.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .cell.active-ghost { background: #880e4f; border-color: #f50057; }
    .cell.playing-step { background-color: #333 !important; border-color: #fff !important; }
    .cell.active.playing-step { background-color: #00e676 !important; color: #000; box-shadow: 0 0 12px #00e676; z-index: 2; }

    #selectionOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 20000; display: none; align-items: center; justify-content: center; }
    #selectionOverlay.visible { display: flex; }
    #selectionPanel { background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
    #selectionTitle { margin-bottom: 15px; font-weight: bold; color: #fff; text-align: center; }
    #selectionOptions { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 6px; }
    .selection-option { padding: 10px 0; background: #2c2c2c; text-align: center; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
    .selection-option.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .selection-option.ghost { color: #ff80ab; border-color: #880e4f; }

    .countdownOverlay { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; z-index: 50; background: rgba(0,0,0,0.7); font-size: 5rem; font-weight: 900; color: var(--highlight-color); }
    #loadingStatusMini { position: absolute; bottom: 20px; font-size: 1rem; color: #fff; font-weight: normal; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    
    @media (max-width: 800px) {
        #animacaoStageWrapper { transform: scale(0.65); }
        #topArea { overflow: visible; }
    }
    @media (max-width: 600px) { 
        #bottomArea { flex-basis: 60vh; } 
        :root { --label-width: 50px; --cell-size: 22px; } 
        #animacaoStageWrapper { transform: scale(0.55); }
        #playerControlsRow { justify-content: space-between; }
        button { flex-grow: 1; justify-content: center; }
        .sliderGroup { flex-grow: 1; justify-content: center; }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div id="loadingText">Carregando Est√∫dio...</div>
    <div id="loadingBarContainer"><div id="loadingBar"></div></div>
  </div>

  <div id="orientationOverlay"><div><h1>üéµ Melhor Experi√™ncia üé∏</h1><p>Gire o dispositivo.</p></div></div>
  
  <canvas id="recordingCanvas" width="854" height="480"></canvas>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="bateristaStage">
            <img id="bat_Conducao" src="" />
            <img id="bat_PernaEsq" src="" />
            <img id="bat_Tronco"   src="" />
            <img id="bat_Cabeca"   src="" />
            <img id="bat_Bateria"  src="" />
            <img id="bat_BracoDir" src="" />
            <img id="bat_BracoEsq" src="" />
            <img id="bat_Ataque"   src="" />
        </div>
        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" />
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" />
                <img id="troncoBaixoLayer" src="" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" />
            </div>
            <div id="countdownOverlay" class="countdownOverlay">
                <span id="countdownText">3</span>
                <div id="loadingStatusMini"></div>
            </div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn" disabled>‚è≥ Carregando...</button>
        <button id="playAleatorioBtn" disabled>üé≤ Smart</button>
        <button id="recordVideoBtn">üî¥ Gravar V√≠deo</button>
        <span id="generationInfo"></span>
        <span id="bpmDisplay" style="margin-left:auto">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        <div class="sliderGroup"><label>Bx</label><input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <div class="sliderGroup"><label>Dr</label><input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <button id="playExportadoBtn">üìÅ</button>
        <button id="exportWavBtn">üíæ WAV</button>
        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="duplicateSeq">x2</button>
        <button id="clearAll">Limpar</button>
      </div>
      <div id="progressContainer"><div id="progressBar"></div></div>
      <div id="gridsArea">
        <div class="rowContainer"><div class="gridLabel" style="background:transparent;border:none"></div><div id="deleteGrid" class="trackGrid"></div></div>
        <div class="rowContainer"><div class="gridLabel" style="color:var(--highlight-color)">BAIXO</div><div id="baixoGrid" class="trackGrid"></div></div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay"><div id="selectionPanel"><div id="selectionTitle">Nota</div><div id="selectionOptions"></div></div></div>

  <script>
    const PASTA_BAT = "animacao/Baterista/";
    const imgCache = new Map();
    const DRUM_FPS = 40; 
    const DRUM_IMPACT_FRAME = 2; 
    const DRUM_MS_PER_FRAME = 1000 / DRUM_FPS;
    const DRUM_PREROLL_MS = DRUM_IMPACT_FRAME * DRUM_MS_PER_FRAME; 
    const VISUAL_OFFSET_MS = 25; 

    // VARIAVEL GLOBAL REINSERIDA CORRETAMENTE
    const pastaFolderNames = { 1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D", 11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B", 20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E" };

    const CABECA_ANIMATIONS = {
        virada_direita: Array.from({length:10}, (_,i) => PASTA_BAT + `Cabeca/Virada_para_direita/cabeca${String(i+51).padStart(4,'0')}.png`),
        virada_esquerda: Array.from({length:8}, (_,i) => PASTA_BAT + `Cabeca/Virada_para_esquerda/cabeca${String(i+39).padStart(4,'0')}.png`),
        voltando_direita: Array.from({length:3}, (_,i) => PASTA_BAT + `Cabeca/Voltando_Virada_da_direita/cabeca${String(i+61).padStart(4,'0')}.png`),
        voltando_esquerda: Array.from({length:4}, (_,i) => PASTA_BAT + `Cabeca/Voltando_Virada_da_esquerda/cabeca${String(i+48).padStart(4,'0')}.png`),
        cabeca_estavel: Array.from({length:26}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel/cabeca${String(i+1).padStart(4,'0')}.png`),
        cabeca_estavel2: Array.from({length:19}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel_2/cabeca${String(i+20).padStart(4,'0')}.png`)
    };

    const DRUM_ASSETS = {
        idle: {
            ataque: PASTA_BAT + "Ataque/Ataque0001.png",
            bracoDir: PASTA_BAT + "Braco_direito/Caixa/braco_direito0003.png",
            bracoEsq: PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0001.png",
            cabeca: PASTA_BAT + "Cabeca/Cabeca_estavel/cabeca0024.png",
            conducao: PASTA_BAT + "Conducao/Conducao0001.png",
            pernaEsq: PASTA_BAT + "Perna_esquerda/Pedal_chimbal/Baterista0001.png",
            tronco: PASTA_BAT + "Tronco_Perna_direita/Parado/Tronco0001.png",
            bateria: PASTA_BAT + "Bateria_Chimbal/Bateria.png"
        },
        anim: {
            troncoTocando: Array.from({length:39}, (_,i) => PASTA_BAT + `Tronco_Perna_direita/Tocando/Tronco${String(i+2).padStart(4,'0')}.png`),
            ataquePrato: Array.from({length:7}, (_,i) => PASTA_BAT + `Ataque/Ataque${String(i+1).padStart(4,'0')}.png`),
            conducaoPrato: Array.from({length:6}, (_,i) => PASTA_BAT + `Conducao/Conducao${String(i+1).padStart(4,'0')}.png`),
            
            bd_ataque: [PASTA_BAT + "Braco_direito/Ataque/braco_direito0005.png", PASTA_BAT + "Braco_direito/Ataque/braco_direito0006.png", PASTA_BAT + "Braco_direito/Ataque/braco_direito0007.png", PASTA_BAT + "Braco_direito/Ataque/braco_direito0008.png"],
            bd_caixa: [PASTA_BAT + "Braco_direito/Caixa/braco_direito0001.png", PASTA_BAT + "Braco_direito/Caixa/braco_direito0002.png", PASTA_BAT + "Braco_direito/Caixa/braco_direito0003.png", PASTA_BAT + "Braco_direito/Caixa/braco_direito0004.png"],
            bd_chimbal: [PASTA_BAT + "Braco_direito/Chimbal/braco_direito0001.png", PASTA_BAT + "Braco_direito/Chimbal/braco_direito0002.png", PASTA_BAT + "Braco_direito/Chimbal/braco_direito0003.png", PASTA_BAT + "Braco_direito/Chimbal/braco_direito0004.png"],
            bd_conducao: [PASTA_BAT + "Braco_direito/Conducao/braco_direito0025.png", PASTA_BAT + "Braco_direito/Conducao/braco_direito0026.png", PASTA_BAT + "Braco_direito/Conducao/braco_direito0027.png", PASTA_BAT + "Braco_direito/Conducao/braco_direito0028.png"],
            bd_surdo: [PASTA_BAT + "Braco_direito/Surdo/braco_direito0021.png", PASTA_BAT + "Braco_direito/Surdo/braco_direito0022.png", PASTA_BAT + "Braco_direito/Surdo/braco_direito0023.png", PASTA_BAT + "Braco_direito/Surdo/braco_direito0024.png"],
            bd_tom1: [PASTA_BAT + "Braco_direito/Tom_1/braco_direito0013.png", PASTA_BAT + "Braco_direito/Tom_1/braco_direito0014.png", PASTA_BAT + "Braco_direito/Tom_1/braco_direito0015.png", PASTA_BAT + "Braco_direito/Tom_1/braco_direito0016.png"],
            bd_tom2: [PASTA_BAT + "Braco_direito/Tom_2/braco_direito0017.png", PASTA_BAT + "Braco_direito/Tom_2/braco_direito0018.png", PASTA_BAT + "Braco_direito/Tom_2/braco_direito0019.png", PASTA_BAT + "Braco_direito/Tom_2/braco_direito0020.png"],

            be_ataque: [PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0009.png", PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0010.png", PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0011.png", PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0012.png"],
            be_caixa: [PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0001.png", PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0002.png", PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0003.png", PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0004.png"],
            be_chimbal: [PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0005.png", PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0006.png", PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0007.png", PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0008.png"],
            be_conducao: [PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0025.png", PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0026.png", PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0027.png", PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0028.png"],
            be_surdo: [PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0021.png", PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0022.png", PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0023.png", PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0024.png"],
            be_tom1: [PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0013.png", PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0014.png", PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0015.png", PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0016.png"],
            be_tom2: [PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0017.png", PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0018.png", PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0019.png", PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0020.png"],

            perna_duplo: [ PASTA_BAT+"Perna_esquerda/Pedal_duplo/Baterista0002.png", PASTA_BAT+"Perna_esquerda/Pedal_duplo/Baterista0003.png" ]
        }
    };

    const pastaMap = { 1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"], 2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"], 3: ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"], 4: ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"], 5: ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"], 6: ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"], 7: ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"], 8: ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"], 9: ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"], 10: ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"], 11: ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"], 12: ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS"], 13: ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"], 14: ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"], 15: ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"], 16: ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"], 17: ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"], 18: ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"], 19: ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"], 20: ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"], 21: ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"], 22: ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"], 23: ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"], 24: ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"] };
    const notasValidas = ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"];
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" }, { id: "caixa", label: "Caixa", file: "caixa.mp3" }, { id: "caixaAro", label: "Aro", file: "caixaAro.mp3" }, { id: "chimbal", label: "HH", file: "chimbal.mp3" }, { id: "chimbal_pedal", label: "HH Ped", file: "chimbal-pedal.mp3" }, { id: "chimbalaberto", label: "HH Open", file: "chimbal-aberto.mp3" }, { id: "ataque", label: "Ataque", file: "ataque.mp3" }, { id: "tom1", label: "Tom 1", file: "tom-1.mp3" }, { id: "tom2", label: "Tom 2", file: "tom-2.mp3" }, { id: "surdo", label: "Surdo", file: "surdo.mp3" }, { id: "conducao", label: "Ride", file: "conducao.mp3" }, { id: "conducao_centro", label: "Ride C", file: "conducao-centro.mp3" }
    ];

    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
    const STYLE_PROGRESSIONS = {
        Rock: [[1,4,5,1], [1,5,6,4]], Rock2: [[4,5,1,5], [5,4,1,4]], Rock3: [[1,4,5,1], [1,3,4,5]], Rock4: [[6,4,1,5], [1,4,5,1]], Rock5: [[1,5,7,4]], Rock6: [[1,5,6,4]], Rock7: [[2,3,5,1]], Rock_Progressivo: [[4,5,1,1]], Blues: [[1,4,5,4]], Forr√≥: [[1,5,1,5]], Samba: [[2,5,1,1]], Metal: [[1,3,5,6]], Jazz: [[1,2,5,1]]
    };
    const ALL_GROOVES = [
        { name: "Rock", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Blues", meter: "4/4", drumPattern: ["bch - ch ch cch - ch ch bch - ch ch cch - ch ch"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 6, 8, 6, 5, 3] },
        { name: "Forr√≥", meter: "2/4", drumPattern: ["bch - co - ch - ca -"], bassRhythm: ["bo - - - x - - -"], bassScale: [8, 1] },
        { name: "Funk", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - - - bo - bo x bo x bo x bo - x x"], bassScale: [1,8] },
        { name: "Disco", meter: "4/4", drumPattern: ["bu - ch ch bu - ch ch bu - ch ch bu - ch ch"], bassRhythm: ["bo - x x bo - x x bo - x x bo - x x"], bassScale: [1] },
        { name: "Metal", meter: "4/4", drumPattern: ["bch bu bch bu cch bu bch bu bch bu bch bu cch bu bch bu"], bassRhythm: ["bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo"], bassScale: [1] },
        { name: "Samba", meter: "2/4", drumPattern: ["bch - ch bu bch - ch bu"], bassRhythm: ["bo - x x bo - - x"], bassScale: [8, 5] },
    ];

    let isPlaying = false, playbackInterval = null, bpmAtual = 120, atualPasso = 0;
    let baixoSeq = Array(16).fill(""), bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    let baixoVolumeGlobal = 0.9, bateriaVolumeGlobal = 0.9, audioBaixoAtual = null;

    let posicaoAtualPasta = 1, ultimaCordaUsada = "E", ultimaNotaReal = "1E";
    let headLoopTimer = null, headFrameIndex = 0, headFrames = [];

    let activeAnimations = {}; 
    let lastDrumStep = {}; 
    let lastArmUsed = {};  
    let pendulumStartTime = 0;
    
    let lastHeadAnimation = null;
    let headAnimationTimeout = null;
    let currentHeadStyle = 'estavel'; 
    let armAnimationTimers = {};
    let lastRightArmFrame = null;
    let lastRightArmFrames = null;
    
    const canvas = document.getElementById("recordingCanvas");
    const ctx = canvas.getContext("2d");
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    const mediaStreamDestination = audioContext.createMediaStreamDestination();
    let mediaRecorder = null, recordedChunks = [], isRecording = false;

    const domImages = {
        bx_pernas: document.getElementById("pernasLayer"),
        bx_cabecaTras: document.getElementById("cabecaTrasLayer"),
        bx_tronco: document.getElementById("troncoBaixoLayer"),
        bx_antebraco: document.getElementById("antebracoLayer"),
        bx_bracoDir: document.getElementById("bracoDireitoLayer"),
        bx_cabeca: document.getElementById("cabecaLayer"),
        
        bt_ataque: document.getElementById("bat_Ataque"),
        bt_bracoDir: document.getElementById("bat_BracoDir"),
        bt_bracoEsq: document.getElementById("bat_BracoEsq"),
        bt_cabeca: document.getElementById("bat_Cabeca"),
        bt_conducao: document.getElementById("bat_Conducao"),
        bt_pernaEsq: document.getElementById("bat_PernaEsq"),
        bt_tronco: document.getElementById("bat_Tronco"),
        bt_kit: document.getElementById("bat_Bateria")
    };

    window.onload = async () => {
        verificarOrientacao();
        window.addEventListener("resize", verificarOrientacao);
        
        for (let i = 1; i <= 100; i++) {
            headFrames.push(`animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`);
        }

        await preloadBaseAssets();
        
        startHeadLoop();
        gerarAleatorio();
        
        setCachedSrc(domImages.bt_kit, DRUM_ASSETS.idle.bateria);
        setCachedSrc(domImages.bt_tronco, DRUM_ASSETS.idle.tronco);
        setCachedSrc(domImages.bt_cabeca, DRUM_ASSETS.idle.cabeca);
        setCachedSrc(domImages.bt_bracoDir, DRUM_ASSETS.idle.bracoDir);
        setCachedSrc(domImages.bt_bracoEsq, DRUM_ASSETS.idle.bracoEsq);
        setCachedSrc(domImages.bt_pernaEsq, DRUM_ASSETS.idle.pernaEsq);
        setCachedSrc(domImages.bt_conducao, DRUM_ASSETS.idle.conducao);
        setCachedSrc(domImages.bt_ataque, DRUM_ASSETS.idle.ataque);
        setCachedSrc(domImages.bx_tronco, `animacao/tronco_baixo/Pasta_1F/1E.png`);
        
        renderGrids();
        setupListeners();
        requestAnimationFrame(canvasRenderLoop);
    };

    function loadAndCache(url) {
        if (imgCache.has(url)) return Promise.resolve(imgCache.get(url));
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => { imgCache.set(url, img); resolve(img); };
            img.onerror = () => { console.warn("Fail load", url); resolve(null); };
            img.src = url;
        });
    }

    function setCachedSrc(element, url) {
        if (!url) return;
        if (imgCache.has(url)) {
            const cached = imgCache.get(url);
            if(element.src !== cached.src) element.src = cached.src;
        } else {
            element.src = url;
        }
    }

    async function preloadBaseAssets() {
        const progressBar = document.getElementById("loadingBar");
        const statusText = document.getElementById("loadingText");
        statusText.innerText = "Carregando Anima√ß√µes...";

        const toLoad = Object.values(DRUM_ASSETS.idle);
        toLoad.push("animacao/pernas/Pernas.png");
        toLoad.push("animacao/cabeca_tras/cabeca-parte-de-tras.png");
        toLoad.push("animacao/antebraco/antebracoE.png");
        headFrames.forEach(frame => toLoad.push(frame));

        const total = toLoad.length;
        let loaded = 0;
        
        await Promise.all(toLoad.map(src => loadAndCache(src).then(() => {
            loaded++;
            progressBar.style.width = (loaded/total)*100 + "%";
        })));
        
        document.getElementById("loadingOverlay").style.opacity = "0";
        setTimeout(() => { 
            document.getElementById("loadingOverlay").style.display = "none"; 
            document.getElementById("playBtn").disabled = false; document.getElementById("playBtn").innerText = "‚ñ∂ Play";
            document.getElementById("playAleatorioBtn").disabled = false;
        }, 500);
    }

    async function prepararAssetsDaSequencia() {
        const miniStatus = document.getElementById("loadingStatusMini");
        miniStatus.innerText = "Preparando Anima√ß√£o...";
        const assetsNecessarios = new Set();
        let pastaCalc = 1;
        for (let i = 0; i < baixoSeq.length; i++) {
            const nota = baixoSeq[i];
            if (nota !== "" && nota !== "x") {
                pastaCalc = escolherMelhorPasta(nota, pastaCalc);
                const pastaNome = pastaFolderNames[pastaCalc];
                assetsNecessarios.add(`animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`);
                assetsNecessarios.add(`animacao/antebraco/antebraco${getCordaDaNota(nota)}.png`);
                const c = getCordaDaNota(nota);
                for(let f=1; f<=5; f++) assetsNecessarios.add(`animacao/braco_direito/Corda_${c}${f}.png`);
            }
        }
        const allDrumKeys = Object.keys(bateriaSeq);
        for (let k of allDrumKeys) {
            const line = bateriaSeq[k];
            if (line.some(x => x !== "x")) {
                if(k === 'bumbo') DRUM_ASSETS.anim.perna_duplo.forEach(u => assetsNecessarios.add(u));
                else {
                    if(DRUM_ASSETS.anim['bd_'+k]) DRUM_ASSETS.anim['bd_'+k].forEach(u => assetsNecessarios.add(u));
                    if(DRUM_ASSETS.anim['be_'+k]) DRUM_ASSETS.anim['be_'+k].forEach(u => assetsNecessarios.add(u));
                }
            }
        }
        DRUM_ASSETS.anim.troncoTocando.forEach(u => assetsNecessarios.add(u));
        Object.values(CABECA_ANIMATIONS).forEach(animSet => {
            animSet.forEach(u => assetsNecessarios.add(u));
        });
        const lista = Array.from(assetsNecessarios);
        await Promise.all(lista.map(u => loadAndCache(u)));
        miniStatus.innerText = "";
    }

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recordVideoBtn").onclick = toggleRecording;
        document.getElementById("bpmSlider").oninput = (e) => { bpmAtual = parseInt(e.target.value); document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM"; };
        document.getElementById("baixoVolume").oninput = (e) => baixoVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("drumVolume").oninput = (e) => bateriaVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); renderGrids(); };
        document.getElementById("addCol").onclick = () => { baixoSeq.push(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x")); renderGrids(); };
        document.getElementById("duplicateSeq").onclick = () => { baixoSeq = [...baixoSeq, ...baixoSeq]; Object.keys(bateriaSeq).forEach(k => bateriaSeq[k] = [...bateriaSeq[k], ...bateriaSeq[k]]); renderGrids(); };
        document.getElementById("clearAll").onclick = () => { baixoSeq.fill(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x")); renderGrids(); };
        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio;
        document.getElementById("playExportadoBtn").onclick = importarJSON;
        document.getElementById("exportWavBtn").onclick = exportarWAV;
    }

    function deleteColumn(idx) {
        if (baixoSeq.length <= 1) return;
        baixoSeq.splice(idx, 1);
        Object.keys(bateriaSeq).forEach(key => bateriaSeq[key].splice(idx, 1));
        renderGrids();
    }

    // ========================================================
    // WARM-UP (PREPARA√á√ÉO) DO CANVAS 480P
    // ========================================================
    function desenharCenaEstatica() {
        ctx.fillStyle = "#111"; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Gradiente de Fundo
        const gradient = ctx.createRadialGradient(427, 240, 50, 427, 240, 400);
        gradient.addColorStop(0, "#222");
        gradient.addColorStop(1, "#000");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // --- BATERISTA (AJUSTADO PARA 480p - FUNDO ESQUERDA) ---
        ctx.save();
        ctx.translate(180, 80); 
        ctx.scale(0.45, 0.45);
        
        const draw = (img) => { if(img && img.complete) ctx.drawImage(img, 0, 0); };
        draw(domImages.bt_conducao);
        draw(domImages.bt_pernaEsq);
        draw(domImages.bt_tronco);
        draw(domImages.bt_cabeca);
        draw(domImages.bt_bracoEsq);
        draw(domImages.bt_bracoDir);
        draw(domImages.bt_kit);
        draw(domImages.bt_ataque);
        ctx.restore();

        // --- BAIXISTA (AJUSTADO PARA 480p - FRENTE DIREITA) ---
        ctx.save();
        ctx.translate(400, 50); 
        ctx.scale(0.7, 0.7);

        if (domImages.bx_pernas.complete) ctx.drawImage(domImages.bx_pernas, 64, 332);
        
        ctx.save();
        ctx.translate(260, 416); // Pivot
        ctx.translate(-260, -416); // Retorna
        
        if (domImages.bx_cabecaTras.complete) ctx.drawImage(domImages.bx_cabecaTras, 100, 60);
        if (domImages.bx_tronco.src && domImages.bx_tronco.complete) {
            ctx.drawImage(domImages.bx_tronco, 0, 132);
        } else {
             const img = new Image(); img.src = `animacao/tronco_baixo/Pasta_1F/1E.png`;
             if(img.complete) ctx.drawImage(img, 0, 132);
        }
        if (domImages.bx_antebraco.complete) ctx.drawImage(domImages.bx_antebraco, -2, 179);
        if (domImages.bx_bracoDir.complete) ctx.drawImage(domImages.bx_bracoDir, -5, 250);
        if (domImages.bx_cabeca.complete) ctx.drawImage(domImages.bx_cabeca, 70, 37);
        
        ctx.restore();
        ctx.restore();
    }

    // ========================================================
    // RENDER LOOP OTIMIZADO (LIMITADO A 30 FPS)
    // ========================================================
    let lastDrawTime = 0;
    const FRAME_INTERVAL = 1000 / 30; // 30 FPS

    function canvasRenderLoop(timestamp) {
        requestAnimationFrame(canvasRenderLoop);
        
        // THROTTLE: Se n√£o estiver gravando, ou se for muito cedo, n√£o desenha
        if (!isRecording) return;
        if (timestamp - lastDrawTime < FRAME_INTERVAL) return;
        lastDrawTime = timestamp;

        ctx.fillStyle = "#111"; 
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const gradient = ctx.createRadialGradient(427, 240, 50, 427, 240, 400);
        gradient.addColorStop(0, "#222");
        gradient.addColorStop(1, "#000");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // --- CAMADA 1: BATERISTA ---
        ctx.save();
        ctx.translate(180, 80); 
        ctx.scale(0.45, 0.45);   

        const drawImg = (el) => { if (el && el.complete && el.naturalWidth > 0) ctx.drawImage(el, 0, 0); };
        
        drawImg(domImages.bt_conducao);
        drawImg(domImages.bt_pernaEsq);
        drawImg(domImages.bt_tronco);
        drawImg(domImages.bt_cabeca);
        
        const zEsq = parseInt(domImages.bt_bracoEsq.style.zIndex || 10);
        if (zEsq > 11) { 
            drawImg(domImages.bt_bracoDir); 
            drawImg(domImages.bt_bracoEsq); 
        } else { 
            drawImg(domImages.bt_bracoEsq); 
            drawImg(domImages.bt_bracoDir); 
        }
        
        drawImg(domImages.bt_kit);
        drawImg(domImages.bt_ataque);
        ctx.restore();

        // --- CAMADA 2: BAIXISTA ---
        ctx.save();
        ctx.translate(400, 50); 
        ctx.scale(0.7, 0.7); 

        if (domImages.bx_pernas.complete) ctx.drawImage(domImages.bx_pernas, 64, 332);

        ctx.save(); 
        ctx.translate(260, 416); 
        
        let angle = 0;
        if (isPlaying && pendulumStartTime > 0) {
            const now = performance.now();
            const elapsed = now - pendulumStartTime;
            const speed = 0.003 * (bpmAtual / 120);
            angle = Math.sin(elapsed * speed) * 2.3;
        }
        ctx.rotate(angle * Math.PI / 180);
        
        document.getElementById("bodyWrapperPendulo").style.transform = `rotate(${angle}deg)`;
        
        ctx.translate(-260, -416); 
        
        if (domImages.bx_cabecaTras.complete) ctx.drawImage(domImages.bx_cabecaTras, 100, 60);
        if (domImages.bx_tronco.complete && domImages.bx_tronco.src) {
            ctx.drawImage(domImages.bx_tronco, 0, 132);
        }
        
        if (domImages.bx_antebraco.complete) ctx.drawImage(domImages.bx_antebraco, -2, 179);
        if (domImages.bx_bracoDir.complete) ctx.drawImage(domImages.bx_bracoDir, -5, 250);
        if (domImages.bx_cabeca.complete) ctx.drawImage(domImages.bx_cabeca, 70, 37);
        
        ctx.restore(); 
        ctx.restore(); 
    }

    function runFrameAnimation(elementId, frames, idleFrame, fps = 30, loop = false, startFrame = 0, keepLastFrame = false) {
        const el = typeof elementId === 'string' ? document.getElementById(elementId) : elementId;
        const frameDuration = 1000 / fps;
        
        if (activeAnimations[el.id]) {
            cancelAnimationFrame(activeAnimations[el.id]);
            delete activeAnimations[el.id];
        }
        
        if (armAnimationTimers[el.id]) {
            clearTimeout(armAnimationTimers[el.id]);
            delete armAnimationTimers[el.id];
        }
        
        if (startFrame > 0 && startFrame < frames.length) {
            setCachedSrc(el, frames[startFrame]);
        }
        
        const start = performance.now() - (startFrame * frameDuration); 
        const animate = (now) => {
            const elapsed = now - start;
            let index = Math.floor(elapsed / frameDuration);
            
            if (loop) {
                index = index % frames.length;
                setCachedSrc(el, frames[index]);
                activeAnimations[el.id] = requestAnimationFrame(animate);
            } else {
                if (index < frames.length) {
                    setCachedSrc(el, frames[index]);
                    activeAnimations[el.id] = requestAnimationFrame(animate);
                } else {
                    if (keepLastFrame && el.id === 'bat_BracoDir') {
                        setCachedSrc(el, frames[frames.length - 1]);
                        lastRightArmFrame = frames[frames.length - 1];
                        lastRightArmFrames = frames;
                    } else if (idleFrame !== null) {
                        setCachedSrc(el, idleFrame);
                    }
                    delete activeAnimations[el.id];
                    if(el.id === 'bat_BracoEsq') {
                        el.style.zIndex = 10;
                    }
                }
            }
        };
        
        activeAnimations[el.id] = requestAnimationFrame(animate);
        
        if (!loop) {
            const remainingFrames = frames.length - startFrame;
            const totalDuration = remainingFrames * frameDuration;
            armAnimationTimers[el.id] = setTimeout(() => {
                if (activeAnimations[el.id]) {
                    cancelAnimationFrame(activeAnimations[el.id]);
                    delete activeAnimations[el.id];
                }
                if (keepLastFrame && el.id === 'bat_BracoDir') {
                    setCachedSrc(el, frames[frames.length - 1]);
                    lastRightArmFrame = frames[frames.length - 1];
                    lastRightArmFrames = frames;
                } else if (idleFrame !== null && !keepLastFrame) {
                    setCachedSrc(el, idleFrame);
                }
                if(el.id === 'bat_BracoEsq') {
                    el.style.zIndex = 10;
                }
                delete armAnimationTimers[el.id];
            }, totalDuration + 50); 
        }
    }

    function playCaixaAnimation(imgEl, isLeft, currentStep) {
        const frames = isLeft ? DRUM_ASSETS.anim.be_caixa : DRUM_ASSETS.anim.bd_caixa;
        const idleSrc = isLeft ? DRUM_ASSETS.idle.bracoEsq : DRUM_ASSETS.idle.bracoDir;
        const keepLastFrame = !isLeft; 
        runFrameAnimation(imgEl, frames, idleSrc, DRUM_FPS, false, 2, keepLastFrame);
        if (isLeft) {
            imgEl.style.zIndex = 10;
        }
    }

    function playRightArmAnimation(frames, idleFrame, startFrame = 0) {
        runFrameAnimation(domImages.bt_bracoDir, frames, idleFrame, DRUM_FPS, false, startFrame, true);
    }

    function playRandomHeadAnimation() {
        if (!isPlaying || activeAnimations['bat_Cabeca']) return;
        const shouldSwitch = Math.random() > 0.7; 
        if (shouldSwitch) {
            currentHeadStyle = currentHeadStyle === 'estavel' ? 'estavel2' : 'estavel';
        }
        const frames = currentHeadStyle === 'estavel' ? CABECA_ANIMATIONS.cabeca_estavel : CABECA_ANIMATIONS.cabeca_estavel2;
        runFrameAnimation(domImages.bt_cabeca, frames, null, 25, true);
        if (headAnimationTimeout) clearTimeout(headAnimationTimeout);
        headAnimationTimeout = setTimeout(() => {
            if (isPlaying) playRandomHeadAnimation();
        }, 2000 + Math.random() * 3000); 
    }

    function playHeadTurnAnimation(direction = 'right') {
        if (!isPlaying) return;
        if (activeAnimations['bat_Cabeca']) {
            cancelAnimationFrame(activeAnimations['bat_Cabeca']);
            delete activeAnimations['bat_Cabeca'];
        }
        const turnFrames = direction === 'right' ? CABECA_ANIMATIONS.virada_direita : CABECA_ANIMATIONS.virada_esquerda;
        const returnFrames = direction === 'right' ? CABECA_ANIMATIONS.voltando_direita : CABECA_ANIMATIONS.voltando_esquerda;
        let step = 0;
        const animateTurn = () => {
            if (step < turnFrames.length) {
                setCachedSrc(domImages.bt_cabeca, turnFrames[step]);
                step++;
                setTimeout(animateTurn, 50);
            } else {
                setTimeout(() => {
                    let returnStep = 0;
                    const animateReturn = () => {
                        if (returnStep < returnFrames.length) {
                            setCachedSrc(domImages.bt_cabeca, returnFrames[returnStep]);
                            returnStep++;
                            setTimeout(animateReturn, 50);
                        } else {
                            setTimeout(() => playRandomHeadAnimation(), 500);
                        }
                    };
                    animateReturn();
                }, 800); 
            }
        };
        animateTurn();
    }

    function playDrumAnimation(drumType, currentStep) {
        if (!activeAnimations['bat_Tronco'] && isPlaying) {
            runFrameAnimation(domImages.bt_tronco, DRUM_ASSETS.anim.troncoTocando, null, 30, true);
        }
        if (!activeAnimations['bat_Cabeca'] && isPlaying) {
            playRandomHeadAnimation();
        }
        if (drumType === 'start') return;
        if (drumType === 'bumbo') {
            const prevStepIndex = (currentStep === 0) ? baixoSeq.length - 1 : currentStep - 1;
            const isConsecutive = (bateriaSeq['bumbo'][prevStepIndex] === 'bumbo');
            if (isConsecutive) {
                 runFrameAnimation(domImages.bt_pernaEsq, DRUM_ASSETS.anim.perna_duplo, DRUM_ASSETS.idle.pernaEsq, DRUM_FPS);
            }
            return;
        }
        const prevHitStep = lastDrumStep[drumType];
        const isRapidRepeat = (prevHitStep !== undefined && (currentStep - prevHitStep === 1 || (currentStep===0 && prevHitStep === baixoSeq.length-1)));
        let armToUse = 'right';
        if (['caixa', 'caixaAro'].includes(drumType)) armToUse = 'left';
        if (isRapidRepeat && lastArmUsed[drumType]) {
            armToUse = (lastArmUsed[drumType] === 'right') ? 'left' : 'right';
        }
        lastDrumStep[drumType] = currentStep;
        lastArmUsed[drumType] = armToUse;
        const shouldTurnHead = (drumType === 'tom2' || drumType === 'surdo' || drumType === 'conducao' || drumType === 'conducao_centro') && isRapidRepeat && Math.random() > 0.5; 
        if (shouldTurnHead) {
            playHeadTurnAnimation(armToUse === 'right' ? 'right' : 'left');
        }
        const isLeft = (armToUse === 'left');
        const imgEl = isLeft ? domImages.bt_bracoEsq : domImages.bt_bracoDir;
        let idleSrc = null;
        if (isLeft) {
            idleSrc = DRUM_ASSETS.idle.bracoEsq;
            if (['ataque', 'tom1', 'tom2', 'surdo', 'conducao', 'conducao_centro'].includes(drumType)) {
                imgEl.style.zIndex = 12;
            } else {
                imgEl.style.zIndex = 10;
            }
        } else {
            idleSrc = DRUM_ASSETS.idle.bracoDir;
        }
        if (drumType === 'caixa' || drumType === 'caixaAro') {
            playCaixaAnimation(imgEl, isLeft, currentStep);
        } else {
            let frames = [];
            const mapName = isLeft ? 'be_' : 'bd_';
            let key = drumType;
            if(drumType === 'chimbalaberto') key = 'chimbal';
            if(drumType === 'caixaAro') key = 'caixa';
            if(drumType === 'conducao_centro') key = 'conducao';
            if (DRUM_ASSETS.anim[mapName + key]) {
                frames = DRUM_ASSETS.anim[mapName + key];
            } else {
                frames = isLeft ? DRUM_ASSETS.anim.be_caixa : DRUM_ASSETS.anim.bd_caixa;
            }
            if (!isLeft) {
                playRightArmAnimation(frames, idleSrc);
            } else {
                runFrameAnimation(imgEl, frames, idleSrc, DRUM_FPS);
            }
        }
        if(drumType === 'ataque') runFrameAnimation(domImages.bt_ataque, DRUM_ASSETS.anim.ataquePrato, DRUM_ASSETS.idle.ataque, 30);
        if(drumType.includes('conducao')) runFrameAnimation(domImages.bt_conducao, DRUM_ASSETS.anim.conducaoPrato, DRUM_ASSETS.idle.conducao, 30);
    }

    function animarBaixo(nota, msPorStep) {
        if (nota === "x") {
            if (ultimaNotaReal) {
                const pasta = pastaFolderNames[posicaoAtualPasta] || "1F";
                setCachedSrc(domImages.bx_tronco, `animacao/tronco_baixo/Pasta_${pasta}/${ultimaNotaReal}.png`);
            }
            animarMaoDireitaBaixo(ultimaCordaUsada, msPorStep);
            return;
        }
        posicaoAtualPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
        ultimaNotaReal = nota;
        const pastaNome = pastaFolderNames[posicaoAtualPasta];
        setCachedSrc(domImages.bx_tronco, `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`);
        const corda = getCordaDaNota(nota);
        ultimaCordaUsada = corda;
        setCachedSrc(domImages.bx_antebraco, `animacao/antebraco/antebraco${corda}.png`);
        animarMaoDireitaBaixo(corda, msPorStep);
    }

    function animarMaoDireitaBaixo(corda, duracaoStepMs) {
        const frames = [];
        for(let i=2; i<=5; i++) frames.push(`animacao/braco_direito/Corda_${corda}${i}.png`);
        const idle = `animacao/braco_direito/Corda_${corda}1.png`;
        let fps = 1000 / (duracaoStepMs / 5); 
        if (fps < 20) fps = 20; 
        if (fps > 60) fps = 60;
        runFrameAnimation(domImages.bx_bracoDir, frames, idle, fps);
    }

    function stopRightHand() {
        if(activeAnimations['bracoDireitoLayer']) cancelAnimationFrame(activeAnimations['bracoDireitoLayer']);
        setCachedSrc(domImages.bx_bracoDir, `animacao/braco_direito/Corda_${ultimaCordaUsada||'E'}1.png`);
    }

    function resetDrummer() {
        Object.keys(activeAnimations).forEach(k => cancelAnimationFrame(activeAnimations[k]));
        activeAnimations = {};
        lastDrumStep = {};
        if (headAnimationTimeout) {
            clearTimeout(headAnimationTimeout);
            headAnimationTimeout = null;
        }
        Object.keys(armAnimationTimers).forEach(timerId => {
            clearTimeout(armAnimationTimers[timerId]);
        });
        armAnimationTimers = {};
        setCachedSrc(domImages.bt_tronco, DRUM_ASSETS.idle.tronco);
        setCachedSrc(domImages.bt_pernaEsq, DRUM_ASSETS.idle.pernaEsq);
        setCachedSrc(domImages.bt_bracoDir, DRUM_ASSETS.idle.bracoDir);
        lastRightArmFrame = null;
        lastRightArmFrames = null;
        setCachedSrc(domImages.bt_bracoEsq, DRUM_ASSETS.idle.bracoEsq);
        domImages.bt_bracoEsq.style.zIndex = 10;
        setCachedSrc(domImages.bt_cabeca, DRUM_ASSETS.idle.cabeca);
        setCachedSrc(domImages.bt_ataque, DRUM_ASSETS.idle.ataque);
        setCachedSrc(domImages.bt_conducao, DRUM_ASSETS.idle.conducao);
        currentHeadStyle = 'estavel'; 
    }

    // NOVA L√ìGICA DE PLAYBACK E GRAVA√á√ÉO
    function togglePlay() {
        if (isRecording) {
            toggleRecording(); 
            return;
        }

        if (isPlaying) {
            pararPlayback();
        } else {
            iniciarContagemEPlay();
        }
    }

    function iniciarContagemEPlay(callback) {
        const overlay = document.getElementById("countdownOverlay");
        const txt = document.getElementById("countdownText");
        overlay.style.display = "flex"; 
        
        prepararAssetsDaSequencia().then(() => {
            let count = 4; 
            txt.innerText = count;
            const ms = 60000 / bpmAtual; 
            
            const countInt = setInterval(() => {
                count--; 
                if(count > 0) {
                    txt.innerText = count;
                } else { 
                    clearInterval(countInt); 
                    overlay.style.display = "none"; 
                    if(callback) callback(); 
                    iniciarPlayback(); 
                }
            }, ms);
        });
    }

    function iniciarPlayback() {
        if (audioContext.state === 'suspended') audioContext.resume();
        isPlaying = true; 
        atualPasso = 0;
        lastDrumStep = {};
        document.getElementById("playBtn").innerText = "‚è∏ Pause"; document.getElementById("playBtn").style.background = "#e65100";
        pendulumStartTime = performance.now(); 
        playDrumAnimation('start', 0); 
        let nextStepTime = audioContext.currentTime;
        const secondsPerStep = (60 / bpmAtual) / 4;
        const scheduler = () => {
            if (!isPlaying) return;
            while (nextStepTime < audioContext.currentTime + 0.15) {
                runStep(atualPasso, nextStepTime);
                nextStepTime += secondsPerStep;
                atualPasso++;
                if (atualPasso >= baixoSeq.length) atualPasso = 0;
            }
            playbackInterval = requestAnimationFrame(scheduler); 
        };
        scheduler();
    }

    function runStep(stepIndex, timeToPlay) {
        const now = audioContext.currentTime;
        const delayVisualBase = Math.max(0, (timeToPlay - now) * 1000 - VISUAL_OFFSET_MS);
        let delayDrumVisual = (timeToPlay - now) * 1000 - DRUM_PREROLL_MS - VISUAL_OFFSET_MS;
        if (delayDrumVisual < 0) delayDrumVisual = 0;

        setTimeout(() => {
            if(!isPlaying) return;
            drumLines.forEach(line => {
                if (bateriaSeq[line.id] && bateriaSeq[line.id][stepIndex] === line.id) {
                    playDrumAnimation(line.id, stepIndex);
                }
            });
        }, delayDrumVisual);

        setTimeout(() => {
            if(!isPlaying) return;
            highlightGridStep(stepIndex);
            document.getElementById("progressBar").style.width = ((stepIndex + 1) / baixoSeq.length * 100) + "%";
            const notaBaixo = baixoSeq[stepIndex];
            const msPorStep = (60000/bpmAtual)/4;
            if (notaBaixo !== "") {
                animarBaixo(notaBaixo, msPorStep);
            } else {
                stopRightHand();
            }
        }, delayVisualBase);

        const notaBaixo = baixoSeq[stepIndex];
        if (notaBaixo !== "") {
            let file = (notaBaixo === "x") ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${notaBaixo}.mp3`;
            tocarAudioBufferAgendado(file, baixoVolumeGlobal, timeToPlay);
        }
        drumLines.forEach(line => {
            if (bateriaSeq[line.id] && bateriaSeq[line.id][stepIndex] === line.id) {
                tocarAudioBufferAgendado(`assets/${line.file}`, bateriaVolumeGlobal, timeToPlay);
            }
        });
    }

    function pararPlayback() {
        isPlaying = false; 
        cancelAnimationFrame(playbackInterval);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play"; document.getElementById("playBtn").style.background = "";
        pendulumStartTime = 0;
        stopRightHand();
        resetDrummer(); 
        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        if(audioBaixoAtual) { try{audioBaixoAtual.stop();}catch(e){} audioBaixoAtual = null; }
    }

    async function tocarAudioBufferAgendado(path, vol, time) {
        try {
            const buffer = await getAudioBuffer(path); 
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = vol;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.connect(mediaStreamDestination);
            source.start(time); 
            if (path.includes("BaixoMelodia") || path.includes("bass-muted")) {
                if(audioBaixoAtual) try{audioBaixoAtual.stop(time + 0.1);}catch(e){}
                audioBaixoAtual = source;
            }
        } catch (e) {}
    }

    async function tocarAudioBuffer(path, vol) { tocarAudioBufferAgendado(path, vol, audioContext.currentTime); }

    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        audioBuffers[url] = audioBuffer;
        return audioBuffer;
    }

    // NOVA L√ìGICA DE GRAVA√á√ÉO OTIMIZADA
    async function toggleRecording() {
        const btn = document.getElementById("recordVideoBtn");
        
        if (isRecording) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop(); 
            }
            isRecording = false; 
            btn.innerText = "üî¥ Gravar V√≠deo"; 
            btn.classList.remove("recording");
            
            if (isPlaying) pararPlayback();

        } else {
            if (isPlaying) pararPlayback();
            
            try {
                if (audioContext.state === 'suspended') await audioContext.resume();
                
                desenharCenaEstatica();

                const canvasStream = canvas.captureStream(30);
                const videoTrack = canvasStream.getVideoTracks()[0];
                const audioTrack = mediaStreamDestination.stream.getAudioTracks()[0];
                const combinedStream = new MediaStream([videoTrack, audioTrack]);
                
                let options = { mimeType: 'video/webm; codecs=vp8', videoBitsPerSecond: 1500000 };
                if (!MediaRecorder.isTypeSupported('video/webm; codecs=vp8')) {
                    options = { mimeType: 'video/webm', videoBitsPerSecond: 1500000 };
                }
                
                mediaRecorder = new MediaRecorder(combinedStream, options);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'jam_session.webm';
                    document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
                };

                mediaRecorder.start(); 
                isRecording = true; 
                btn.innerText = "‚èπ Parar"; 
                btn.classList.add("recording");

                setTimeout(() => {
                    iniciarContagemEPlay();
                }, 500);

            } catch (err) { 
                alert("Erro grava√ß√£o: " + err); 
                isRecording = false;
                btn.innerText = "üî¥ Gravar V√≠deo";
            }
        }
    }
    
    async function exportarWAV() { alert("Exporta√ß√£o WAV pronta (simula√ß√£o)."); }

    function meterToBeats(m){return Number(m.split('/')[0])||4}
    function expandRhythm(p,t){const j=p.join(' ').replace(/\s+/g,' ').trim().split(/\s+/);const o=[];while(o.length<t)for(const k of j){if(o.length>=t)break;o.push(k)}return o.slice(0,t)}
    function parsePattern(p){const r={intro:[],loop:[]},m=p.match(/\((.*?)\)/);if(m)r.loop=m[1].trim().split(/\s+/);else r.loop=p.trim().split(/\s+/);return r}
    function mapNoteToAnimId(n){let c=n.replace(/[0-9]/g,'').replace('#','S');const m=notasValidas.filter(x=>x.endsWith(c));return m.length>0?m[0]:"1E"}
    function getCordaDaNota(n){const m=n.match(/^(\d+)/);if(!m)return"E";const i=parseInt(m[1]);if(i<=20)return"E";if(i<=28)return"A";if(i<=36)return"D";return"G"}
    function escolherMelhorPasta(n,p){const l=[];for(let i=1;i<=24;i++)if(pastaMap[i].includes(n))l.push(i);if(!l.length)return 1;return l.reduce((a,b)=>Math.abs(b-p)<Math.abs(a-p)?b:a)}
    function startHeadLoop(){if(headLoopTimer)clearInterval(headLoopTimer);headLoopTimer=setInterval(()=>{headFrameIndex=(headFrameIndex+1)%headFrames.length;if(headFrames[headFrameIndex])setCachedSrc(domImages.bx_cabeca, headFrames[headFrameIndex]);},33);}
    
    function renderGrids(){
        const bG=document.getElementById("baixoGrid"),dG=document.getElementById("drumGridWrapper"),dl=document.getElementById("deleteGrid");
        bG.innerHTML=""; dl.innerHTML=""; dG.innerHTML="";
        baixoSeq.forEach((n,i)=>{
            const b=document.createElement("button");b.className="delete-btn";b.innerText="√ó";b.onclick=()=>deleteColumn(i);dl.appendChild(b);
            const c=document.createElement("div");c.className="cell";
            if(n==="x"){c.innerText="X";c.classList.add("active-ghost")}else if(n!==""){c.innerText=n.replace("S","#");c.classList.add("active")}else c.style.opacity="0.3";
            c.onclick=()=>abrirSelecaoNota(i);bG.appendChild(c);
        });
        drumLines.forEach(l=>{
            const r=document.createElement("div");r.className="rowContainer";
            const lb=document.createElement("div");lb.className="gridLabel";lb.innerText=l.label;r.appendChild(lb);
            const g=document.createElement("div");g.className="trackGrid";
            while(bateriaSeq[l.id].length<baixoSeq.length)bateriaSeq[l.id].push("x");
            bateriaSeq[l.id].forEach((v,i)=>{
                const c=document.createElement("div");c.className="cell";
                if(v===l.id)c.classList.add("active");
                c.onclick=()=>{bateriaSeq[l.id][i]=(bateriaSeq[l.id][i]==="x")?l.id:"x";if(bateriaSeq[l.id][i]!== "x")tocarAudioBuffer(`assets/${l.file}`,1.0);renderGrids()};
                g.appendChild(c);
            });
            r.appendChild(g);dG.appendChild(r);
        });
    }
    function highlightGridStep(s){document.querySelectorAll(".playing-step").forEach(e=>e.classList.remove("playing-step"));if(document.getElementById("baixoGrid").children[s])document.getElementById("baixoGrid").children[s].classList.add("playing-step");document.querySelectorAll(".trackGrid").forEach(g=>{if(g.children[s])g.children[s].classList.add("playing-step")})}
    function abrirSelecaoNota(i){const o=document.getElementById("selectionOverlay"),ops=document.getElementById("selectionOptions");ops.innerHTML="";const ad=(l,v,c)=>{const d=document.createElement("div");d.className="selection-option "+(c||"");d.innerText=l;d.onclick=()=>{baixoSeq[i]=v;o.style.display="none";renderGrids();if(v&&v!=="x")tocarAudioBuffer(`assets/BaixoMelodia/${v}.mp3`,1)};ops.appendChild(d)};ad("‚Äî","");ad("X","x","ghost");notasValidas.forEach(n=>ad(n.replace("S","#"),n));o.style.display="flex";o.onclick=(e)=>{if(e.target===o)o.style.display="none"}}
    function gerarAleatorio(){
        const g=ALL_GROOVES[Math.floor(Math.random()*ALL_GROOVES.length)];
        const kIdx=Math.floor(Math.random()*PITCHES.length);
        const q=Math.random()>0.5?'maj':'min';
        bpmAtual=(g.name==="Samba")?70:100+Math.floor(Math.random()*40);
        document.getElementById("bpmSlider").value=bpmAtual; document.getElementById("bpmDisplay").innerText=bpmAtual+" BPM";
        document.getElementById("generationInfo").innerText=`${g.name} em ${PITCHES[kIdx]}${q==='min'?'m':''}`; document.getElementById("generationInfo").style.display="inline";
        let sk="Rock"; if(g.name.includes("Samba"))sk="Samba"; else if(g.name.includes("Jazz"))sk="Jazz"; else if(g.name.includes("Forr√≥"))sk="Forr√≥"; else if(g.name.includes("Metal"))sk="Metal"; else if(g.name.includes("Blues"))sk="Blues";
        const progs=STYLE_PROGRESSIONS[sk]||STYLE_PROGRESSIONS.Rock; const prog=progs[Math.floor(Math.random()*progs.length)];
        const beats=meterToBeats(g.meter); const steps=beats*4; const bars=Math.min(prog.length,4); const totSteps=steps*bars;
        const rhy=expandRhythm(g.bassRhythm,totSteps); const nb=[];
        for(let b=0;b<bars;b++){
            const d=prog[b]; const root=(kIdx+DEGREE_TO_ROOT[d])%12;
            let nIdx=[]; 
            if(Array.isArray(g.bassScale)){
                const isMin=(q==='min'&&[1,4,5].includes(d))||[2,3,6].includes(d);
                const int=isMin?{1:0,2:2,3:3,4:5,5:7,6:8,7:10,8:12}:{1:0,2:2,3:4,4:5,5:7,6:9,7:11,8:12};
                nIdx=g.bassScale.map(x=>(root+(int[x]||0))%12);
            } else nIdx=[root];
            const npb=Math.ceil(steps/nIdx.length);
            for(let s=0;s<steps;s++){
                const sym=rhy[b*steps+s]||'-';
                if(sym==='x')nb.push("x"); else if(sym==='-'||sym==='sm')nb.push("");
                else nb.push(mapNoteToAnimId(PITCHES[nIdx[Math.floor(s/npb)%nIdx.length]]));
            }
        }
        baixoSeq=nb;
        const drumP=parsePattern(g.drumPattern.join(' ')).loop;
        drumLines.forEach(d=>bateriaSeq[d.id]=[]);
        for(let i=0;i<baixoSeq.length;i++){
            const t=drumP[i%drumP.length];
            const acts=[];
            if(['bu','bumbo','bch','ba','bco'].includes(t))acts.push('bumbo');
            if(['ca','caixa','cch','cco'].includes(t))acts.push('caixa');
            if(['ch','chimbal','bch','cch'].includes(t))acts.push('chimbal');
            if(['co','conducao','bco','cco'].includes(t))acts.push('conducao');
            if(t==='ba')acts.push('ataque'); if(t==='to1')acts.push('tom1');
            drumLines.forEach(d=>{bateriaSeq[d.id].push(acts.includes(d.id)?d.id:"x")});
        }
        renderGrids();
    }
    function importarJSON(){const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);if(d.baixo)baixoSeq=d.baixo;if(d.bateria)bateriaSeq=d.bateria;if(d.bpm)bpmAtual=d.bpm;renderGrids()}catch(e){alert("Erro JSON")}};r.readAsText(f)};i.click()}
    function verificarOrientacao(){document.getElementById("orientationOverlay").style.display=(window.innerWidth<window.innerHeight&&window.innerWidth<900)?"flex":"none"}
  </script>
</body>
</html>
