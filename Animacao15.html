<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="UTF-8" />
  <title>Jam On Sync Otimizado (Sem Erros) - Baixista + Baterista</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    #orientationOverlay {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 999999;
      font-size: 18px;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 20px;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: flex-start;
      justify-content: center;
    }
    .panel {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 10px;
      flex: 1;
      min-width: 280px;
      box-sizing: border-box;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .panel h2 {
      margin-top: 0;
      font-size: 16px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #333;
      padding: 2px 4px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    th {
      background: #333;
    }
    td.active {
      background: #4caf50;
    }
    td.chosen {
      background: #1976d2;
    }
    td.disabled {
      background: #555;
      color: #aaa;
      cursor: default;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .controls label {
      font-size: 13px;
    }
    .controls input[type=number] {
      width: 70px;
    }
    .btn {
      background: #1976d2;
      border: none;
      color: #fff;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
    }
    .btn:hover {
      background: #2196f3;
    }
    .btn-small {
      font-size: 11px;
      padding: 4px 8px;
    }
    .btn-danger {
      background: #d32f2f;
    }
    .btn-danger:hover {
      background: #f44336;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .slider-container input[type=range] {
      flex: 1;
    }
    .mini-status {
      font-size: 11px;
      color: #ccc;
      margin-top: 4px;
      text-align: center;
    }
    #countdownOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #fff;
      font-size: 40px;
      font-weight: bold;
    }
    #countdownText {
      font-size: 60px;
      margin-bottom: 10px;
    }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      color: #fff;
      flex-direction: column;
      font-size: 14px;
    }
    #loadingText {
      margin-top: 8px;
    }
    .hidden {
      display: none;
    }
    #recordWrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }
    #recordingCanvas {
      background: #000;
      border-radius: 8px;
    }
    .small-label {
      font-size: 11px;
      color: #ccc;
    }
    #bodyWrapperPendulo {
      position: absolute;
      left: 0;
      top: 0;
      width: 0;
      height: 0;
      transform-origin: 260px 416px;
      pointer-events: none;
    }
    #spriteWrapper {
      position: relative;
      width: 512px;
      height: 512px;
      margin: 0 auto;
      image-rendering: pixelated;
    }
    #spriteWrapper img {
      position: absolute;
      top: 0;
      left: 0;
      image-rendering: pixelated;
      transform-origin: center center;
    }
    #gridWrapper {
      overflow-x: auto;
    }
    .bpm-display {
      font-size: 13px;
      text-align: center;
      margin-top: 4px;
    }
    .penduloContainer {
      position: relative;
      width: 260px;
      height: 30px;
      margin: 0 auto 4px auto;
      border-top: 1px solid #555;
    }
    .penduloMark {
      position: absolute;
      top: -6px;
      width: 2px;
      height: 12px;
      background: #f5f5f5;
    }
    .stepIndicatorRow {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      margin: 0 20px 4px 20px;
      color: #aaa;
    }
    #mobileWarning {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #b71c1c;
      color: #fff;
      text-align: center;
      padding: 4px 8px;
      font-size: 11px;
      z-index: 10000;
    }
  </style>
</head>
<body>
<div id="orientationOverlay">
  <div>
    <h2>Gire o aparelho para o modo paisagem (horizontal)</h2>
    <p>Para ver a animação completa da baixista + baterista, use o celular de lado ou utilize um computador.</p>
  </div>
</div>
<div class="container">
  <h1>Jam On - Baixista + Baterista (Sync Otimizado)</h1>

  <div class="flex-row">
    <div class="panel" style="max-width: 520px;">
      <h2>Visual da Baixista + Baterista</h2>
      <div id="spriteWrapper">
        <canvas id="recordingCanvas" width="512" height="512" style="position:absolute; left:0; top:0; z-index:1;"></canvas>

        <div id="bodyWrapperPendulo">
          <img id="cabecaTrasLayer" src="" alt="" style="z-index:2;">
          <img id="troncoBaixoLayer" src="" alt="" style="z-index:3;">
          <img id="antebracoLayer" src="" alt="" style="z-index:4;">
          <img id="bracoDireitoLayer" src="" alt="" style="z-index:5;">
          <img id="cabecaLayer" src="" alt="" style="z-index:6;">
          <img id="pernasLayer" src="" alt="" style="z-index:1; top:332px; left:64px;">
        </div>

        <img id="bat_Bateria" src="" alt="" style="z-index:10;">
        <img id="bat_Tronco" src="" alt="" style="z-index:11;">
        <img id="bat_PernaEsq" src="" alt="" style="z-index:9;">
        <img id="bat_Cabeca" src="" alt="" style="z-index:12;">
        <img id="bat_BracoDir" src="" alt="" style="z-index:13;">
        <img id="bat_BracoEsq" src="" alt="" style="z-index:14;">
        <img id="bat_Ataque" src="" alt="" style="z-index:15;">
        <img id="bat_Conducao" src="" alt="" style="z-index:16;">
      </div>

      <div class="penduloContainer">
        <div class="penduloMark" style="left:0%;"></div>
        <div class="penduloMark" style="left:25%;"></div>
        <div class="penduloMark" style="left:50%;"></div>
        <div class="penduloMark" style="left:75%;"></div>
        <div class="penduloMark" style="left:100%;"></div>
      </div>
      <div class="stepIndicatorRow">
        <span>1</span><span>5</span><span>9</span><span>13</span><span>16</span>
      </div>
      <div id="recordWrapper">
        <div class="small-label">Exportar vídeo (MP4) - animação + áudio</div>
        <button id="recordBtn" class="btn btn-small">● Gravar 1 loop</button>
        <span id="recordStatus" class="mini-status"></span>
      </div>
    </div>

    <div class="panel" style="flex:1.2;">
      <h2>Sequenciador de Baixo e Bateria</h2>
      <div class="controls">
        <label>BPM:
          <input type="number" id="bpmInput" value="120" min="40" max="240" />
        </label>
        <button class="btn" id="playBtn">▶ Play</button>
        <button class="btn btn-small" id="randomBtn">Baixo + Bateria aleatórios</button>
        <button class="btn btn-small btn-danger" id="clearBtn">Limpar tudo</button>
      </div>

      <div class="controls">
        <div class="slider-container">
          <span>Baixo</span>
          <input type="range" id="baixoVol" min="0" max="100" value="90" />
          <span id="baixoVolVal">90%</span>
        </div>
        <div class="slider-container">
          <span>Bateria</span>
          <input type="range" id="bateriaVol" min="0" max="100" value="90" />
          <span id="bateriaVolVal">90%</span>
        </div>
      </div>

      <div class="bpm-display">
        Cada linha tem 16 steps (1 compasso em 4/4 dividido em semicolcheias).
      </div>

      <div id="gridWrapper">
        <table id="mainGrid">
          <thead>
            <tr>
              <th>Instrumento</th>
              <th>1</th><th>2</th><th>3</th><th>4</th>
              <th>5</th><th>6</th><th>7</th><th>8</th>
              <th>9</th><th>10</th><th>11</th><th>12</th>
              <th>13</th><th>14</th><th>15</th><th>16</th>
            </tr>
          </thead>
          <tbody id="gridBody">
          </tbody>
        </table>
      </div>
      <div class="mini-status" id="loadingStatusMini"></div>
    </div>
  </div>

  <div class="panel">
    <h2>Ajuda rápida</h2>
    <p style="font-size:13px; line-height:1.4;">
      Clique nas células para ligar/desligar notas de baixo e bateria.
      O terceiro frame dos braços (direito/esquerdo) é o frame de impacto na peça.
      Em viradas intercaladas entre Tom 2, Surdo e Condução, a cabeça da baterista usa
      a animação de <strong>Virada para a Direita</strong>. Em momentos de groove contínuo,
      a cabeça alterna aleatoriamente entre <em>Cabeca_estavel</em> e <em>Cabeca_estavel_2</em>.
    </p>
  </div>
</div>

<div id="countdownOverlay">
  <div id="countdownText">4</div>
  <div style="font-size:18px;">Preparando tudo para começar no tempo certo...</div>
</div>

<div id="loadingOverlay">
  <div style="font-size:24px;" id="loadingTitle">Carregando...</div>
  <div id="loadingText">Pré-carregando imagens e sons...</div>
</div>

<div id="mobileWarning" class="hidden">
  Melhor experiência em tela deitada (landscape) ou em um computador.
</div>

<script>
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  const PASTA_BX = "animacao/";
  const PASTA_BAT = "animacao/Baterista/";

  const DRUM_FPS = 40;
  const DRUM_MS_PER_FRAME = 1000 / DRUM_FPS;
  const DRUM_IMPACT_FRAME = 2;
  const DRUM_PREROLL_MS = DRUM_IMPACT_FRAME * DRUM_MS_PER_FRAME;
  const VISUAL_OFFSET_MS = 25;

  const DRUM_ASSETS = {
        idle: {
            ataque: PASTA_BAT + "Ataque/Ataque0001.png",
            bracoDir: PASTA_BAT + "Braco_direito/Caixa/braco_direito0003.png",
            bracoEsq: PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0001.png",
            cabeca: PASTA_BAT + "Cabeca/Cabeca_estavel/cabeca0024.png",
            conducao: PASTA_BAT + "Conducao/Conducao0001.png",
            pernaEsq: PASTA_BAT + "Perna_esquerda/Pedal_chimbal/Baterista0001.png",
            tronco: PASTA_BAT + "Tronco_Perna_direita/Parado/Tronco0001.png",
            bateria: PASTA_BAT + "Bateria_Chimbal/Bateria.png"
        },
        anim: {
            troncoTocando: Array.from({length:39}, (_,i) => PASTA_BAT + `Tronco_Perna_direita/Tocando/Tronco${String(i+2).padStart(4,'0')}.png`),
            ataquePrato: Array.from({length:7}, (_,i) => PASTA_BAT + `Ataque/Ataque${String(i+1).padStart(4,'0')}.png`),
            conducaoPrato: Array.from({length:6}, (_,i) => PASTA_BAT + `Conducao/Conducao${String(i+1).padStart(4,'0')}.png`),
            
            // BRAÇO DIREITO
            bd_ataque: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Ataque/braco_direito${String(i+5).padStart(4,'0')}.png`),
            bd_caixa: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Caixa/braco_direito${String(i+1).padStart(4,'0')}.png`),
            bd_chimbal: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Chimbal/braco_direito${String(i+1).padStart(4,'0')}.png`),
            bd_conducao: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Conducao/braco_direito${String(i+25).padStart(4,'0')}.png`),
            bd_surdo: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Surdo/braco_direito${String(i+21).padStart(4,'0')}.png`),
            bd_tom1: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Tom_1/braco_direito${String(i+13).padStart(4,'0')}.png`),
            bd_tom2: Array.from({length:4}, (_,i) => PASTA_BAT + `Braco_direito/Tom_2/braco_direito${String(i+17).padStart(4,'0')}.png`),

            // BRAÇO ESQUERDO
            be_ataque: [
                PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0009.png",
                PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0010.png",
                PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0011.png",
                PASTA_BAT + "Braco_esquerdo/Ataque/braco_esquerda0012.png"
            ],
            be_caixa: [
                PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0001.png",
                PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0002.png",
                PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0003.png",
                PASTA_BAT + "Braco_esquerdo/Caixa/braco_esquerda0004.png"
            ],
            be_chimbal: [
                PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0005.png",
                PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0006.png",
                PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0007.png",
                PASTA_BAT + "Braco_esquerdo/Chimbal/braco_esquerda0008.png"
            ],
            be_conducao: [
                PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0025.png",
                PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0026.png",
                PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0027.png",
                PASTA_BAT + "Braco_esquerdo/Conducao/braco_esquerda0028.png"
            ],
            be_surdo: [
                PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0021.png",
                PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0022.png",
                PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0023.png",
                PASTA_BAT + "Braco_esquerdo/Surdo/braco_esquerda0024.png"
            ],
            be_tom1: [
                PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0013.png",
                PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0014.png",
                PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0015.png",
                PASTA_BAT + "Braco_esquerdo/Tom_1/braco_esquerda0016.png"
            ],
            be_tom2: [
                PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0017.png",
                PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0018.png",
                PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0019.png",
                PASTA_BAT + "Braco_esquerdo/Tom_2/braco_esquerda0020.png"
            ],

            cabeca_estavel: Array.from({length:26}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel/cabeca${String(i+1).padStart(4,'0')}.png`),
            cabeca_estavel_2: Array.from({length:19}, (_,i) => PASTA_BAT + `Cabeca/Cabeca_estavel_2/cabeca${String(i+20).padStart(4,'0')}.png`),
            cabeca_virada_dir: Array.from({length:10}, (_,i) => PASTA_BAT + `Cabeca/Virada_para_direita/cabeca${String(i+51).padStart(4,'0')}.png`),
            perna_duplo: [ PASTA_BAT+"Perna_esquerda/Pedal_duplo/Baterista0002.png", PASTA_BAT+"Perna_esquerda/Pedal_duplo/Baterista0003.png" ]
        }
    };

    const pastaMap = { 1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"], 2: ["3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS"], 3: ["6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS"], 4: ["8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A"], 5: ["11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C"], 6: ["13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","35D","36DS"], 7: ["16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","35D","36DS","37E","38F","39FS"], 8: ["18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","35D","36DS","37E","38F","39FS","40G","41GS"], 9: ["21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"], 10: ["23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"] };
    const pastaFolderNames = { 1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D", 11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B", 20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E" };
    const notasValidas = ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"];
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" },
      { id: "caixa", label: "Caixa", file: "caixa.mp3" },
      { id: "caixaAro", label: "Caixa (Aro)", file: "caixaAro.mp3" },
      { id: "chimbal", label: "Chimbal", file: "chimbal.mp3" },
      { id: "chimbalaberto", label: "Chimbal Aberto", file: "chimbal-aberto.mp3" },
      { id: "chimbalpedal", label: "Chimbal (Pedal)", file: "chimbal-pedal.mp3" },
      { id: "tom1", label: "Tom 1", file: "tom-1.mp3" },
      { id: "tom2", label: "Tom 2", file: "tom-2.mp3" },
      { id: "surdo", label: "Surdo", file: "surdo.mp3" },
      { id: "ataque", label: "Ataque", file: "ataque.mp3" },
      { id: "conducao", label: "Condução", file: "conducao.mp3" },
      { id: "conducao_centro", label: "Condução Centro", file: "conducao-centro.mp3" }
    ];

    let bpmAtual = 120;
    let isPlaying = false;
    let atualPasso = 0;
    let playbackInterval = null;

    let baixoSeq = Array(16).fill(""), bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    let baixoVolumeGlobal = 0.9, bateriaVolumeGlobal = 0.9, audioBaixoAtual = null;

    let posicaoAtualPasta = 1, ultimaCordaUsada = "E", ultimaNotaReal = "1E";
    let headLoopTimer = null, headFrameIndex = 0, headFrames = [];

    // Animation Controllers (RAF)
    let activeAnimations = {}; 
    let lastDrumStep = {}; 
    let lastArmUsed = {};  
    let lastFillHit = null;  // para detectar viradas intercaladas (Tom_2 / Surdo / Condução)
    let pendulumStartTime = 0;
    
    const canvas = document.getElementById("recordingCanvas");
    const ctx = canvas.getContext("2d");
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    const mediaStreamDestination = audioContext.createMediaStreamDestination();
    let mediaRecorder = null, recordedChunks = [], isRecording = false;

    const domImages = {
        bx_pernas: document.getElementById("pernasLayer"),
        bx_cabecaTras: document.getElementById("cabecaTrasLayer"),
        bx_tronco: document.getElementById("troncoBaixoLayer"),
        bx_antebraco: document.getElementById("antebracoLayer"),
        bx_bracoDir: document.getElementById("bracoDireitoLayer"),
        bx_cabeca: document.getElementById("cabecaLayer"),
        
        bt_ataque: document.getElementById("bat_Ataque"),
        bt_bracoDir: document.getElementById("bat_BracoDir"),
        bt_bracoEsq: document.getElementById("bat_BracoEsq"),
        bt_cabeca: document.getElementById("bat_Cabeca"),
        bt_conducao: document.getElementById("bat_Conducao"),
        bt_pernaEsq: document.getElementById("bat_PernaEsq"),
        bt_tronco: document.getElementById("bat_Tronco"),
        bt_kit: document.getElementById("bat_Bateria")
    };

    window.onload = async () => {
        verificarOrientacao();
        window.addEventListener("resize", verificarOrientacao);
        for (let i = 1; i <= 100; i++) headFrames.push(`animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`);
        await preloadBaseAssets();
        startHeadLoop();
        gerarAleatorio();
        setCachedSrc(domImages.bt_kit, DRUM_ASSETS.idle.bateria);
        setCachedSrc(domImages.bt_tronco, DRUM_ASSETS.idle.tronco);
        setCachedSrc(domImages.bt_cabeca, DRUM_ASSETS.idle.cabeca);
        setCachedSrc(domImages.bt_bracoDir, DRUM_ASSETS.idle.bracoDir);
        setCachedSrc(domImages.bt_bracoEsq, DRUM_ASSETS.idle.bracoEsq);
        setCachedSrc(domImages.bt_pernaEsq, DRUM_ASSETS.idle.pernaEsq);
        setCachedSrc(domImages.bt_conducao, DRUM_ASSETS.idle.conducao);
        setCachedSrc(domImages.bt_ataque, DRUM_ASSETS.idle.ataque);
        setCachedSrc(domImages.bx_tronco, "animacao/tronco_baixo/Pasta_1F/1E.png");
        setCachedSrc(domImages.bx_antebraco, "animacao/antebraco/antebracoE.png");
        setCachedSrc(domImages.bx_bracoDir, "animacao/braco_direito/Corda_E1.png");
        setCachedSrc(domImages.bx_cabecaTras, "animacao/cabeca/cabeca0001.png");
        setCachedSrc(domImages.bx_cabeca, "animacao/cabeca/cabeca0001.png");
        setCachedSrc(domImages.bx_pernas, "animacao/pernas/pernas0001.png");

        initGrid();
        initControls();
        canvasRenderLoop();
        if (isMobile) {
          document.getElementById("mobileWarning").classList.remove("hidden");
        }
    };

    function verificarOrientacao(){
      if(window.innerWidth < window.innerHeight){
        document.getElementById("orientationOverlay").style.display = "flex";
      } else {
        document.getElementById("orientationOverlay").style.display = "none";
      }
    }

    function startHeadLoop() {
        if (headLoopTimer) cancelAnimationFrame(headLoopTimer);
        headFrameIndex = 0;
        const animate = () => {
            headFrameIndex = (headFrameIndex + 1) % headFrames.length;
            setCachedSrc(domImages.bx_cabeca, headFrames[headFrameIndex]);
            headLoopTimer = requestAnimationFrame(animate);
        };
        headLoopTimer = requestAnimationFrame(animate);
    }

    function setCachedSrc(img, src) {
        if (!img) return;
        if (img.dataset.currentSrc === src) return;
        img.src = src;
        img.dataset.currentSrc = src;
    }

    async function preloadBaseAssets() {
        const lista = [
            DRUM_ASSETS.idle.ataque,
            DRUM_ASSETS.idle.bracoDir,
            DRUM_ASSETS.idle.bracoEsq,
            DRUM_ASSETS.idle.cabeca,
            DRUM_ASSETS.idle.conducao,
            DRUM_ASSETS.idle.pernaEsq,
            DRUM_ASSETS.idle.tronco,
            DRUM_ASSETS.idle.bateria,
            "animacao/pernas/pernas0001.png",
            "animacao/cabeca/cabeca0001.png",
            "animacao/tronco_baixo/Pasta_1F/1E.png",
            "animacao/antebraco/antebracoE.png",
            "animacao/braco_direito/Corda_E1.png"
        ];
        await Promise.all(lista.map(u => loadAndCache(u)));
    }

    function loadAndCache(src) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = src;
        });
    }

    async function prepararAssetsDaSequencia() {
        const miniStatus = document.getElementById("loadingStatusMini");
        miniStatus.innerText = "Preparando Animação...";
        const assetsNecessarios = new Set();
        let pastaCalc = 1;
        for (let i = 0; i < baixoSeq.length; i++) {
            const nota = baixoSeq[i];
            if (nota !== "" && nota !== "x") {
                pastaCalc = escolherMelhorPasta(nota, pastaCalc);
                const pastaNome = pastaFolderNames[pastaCalc];
                assetsNecessarios.add(`animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`);
                assetsNecessarios.add(`animacao/antebraco/antebraco${getCordaDaNota(nota)}.png`);
                const c = getCordaDaNota(nota);
                for(let f=1; f<=5; f++) assetsNecessarios.add(`animacao/braco_direito/Corda_${c}${f}.png`);
            }
        }
        const allDrumKeys = Object.keys(bateriaSeq);
        for (let k of allDrumKeys) {
            const line = bateriaSeq[k];
            if (line.some(x => x !== "x")) {
                if(k === 'bumbo') DRUM_ASSETS.anim.perna_duplo.forEach(u => assetsNecessarios.add(u));
                else {
                    if(DRUM_ASSETS.anim['bd_'+k]) DRUM_ASSETS.anim['bd_'+k].forEach(u => assetsNecessarios.add(u));
                    if(DRUM_ASSETS.anim['be_'+k]) DRUM_ASSETS.anim['be_'+k].forEach(u => assetsNecessarios.add(u));
                }
            }
        }
        DRUM_ASSETS.anim.troncoTocando.forEach(u => assetsNecessarios.add(u));
        DRUM_ASSETS.anim.cabeca_estavel.forEach(u => assetsNecessarios.add(u));
        DRUM_ASSETS.anim.cabeca_estavel_2.forEach(u => assetsNecessarios.add(u));
        DRUM_ASSETS.anim.cabeca_virada_dir.forEach(u => assetsNecessarios.add(u));
        const lista = Array.from(assetsNecessarios);
        await Promise.all(lista.map(u => loadAndCache(u)));
        miniStatus.innerText = "Pré-carregamento de imagens da animação concluído.";
    }

    function escolherMelhorPasta(nota, pastaAtual) {
        const idx = notasValidas.indexOf(nota);
        if (idx === -1) return pastaAtual;
        let melhor = pastaAtual;
        let melhorDist = Infinity;
        for (let p in pastaMap) {
            const arr = pastaMap[p];
            const localIdx = arr.indexOf(nota);
            if (localIdx !== -1) {
                const dist = Math.abs(parseInt(p) - pastaAtual);
                if (dist < melhorDist) {
                    melhorDist = dist;
                    melhor = parseInt(p);
                }
            }
        }
        return melhor;
    }

    function getCordaDaNota(nota) {
        const num = parseInt(nota);
        if (num <= 8) return "E";
        if (num <= 16) return "A";
        if (num <= 24) return "D";
        return "G";
    }

    function initGrid() {
        const tbody = document.getElementById("gridBody");
        tbody.innerHTML = "";

        const trBaixo = document.createElement("tr");
        const thBx = document.createElement("th");
        thBx.textContent = "Baixo (nota)";
        trBaixo.appendChild(thBx);
        for (let i = 0; i < 16; i++) {
            const td = document.createElement("td");
            td.dataset.step = i;
            td.textContent = "";
            td.addEventListener("click", () => editarNotaBaixo(i, td));
            trBaixo.appendChild(td);
        }
        tbody.appendChild(trBaixo);

        drumLines.forEach(line => {
            const tr = document.createElement("tr");
            const th = document.createElement("th");
            th.textContent = line.label;
            tr.appendChild(th);
            for (let i = 0; i < 16; i++) {
                const td = document.createElement("td");
                td.dataset.step = i;
                td.dataset.drum = line.id;
                td.addEventListener("click", () => toggleDrum(line.id, i, td));
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });

        renderGrid();
    }

    function renderGrid() {
        const tbody = document.getElementById("gridBody");
        const rows = tbody.querySelectorAll("tr");

        const baixoRow = rows[0];
        for (let i = 1; i < baixoRow.children.length; i++) {
            const td = baixoRow.children[i];
            const step = i - 1;
            const val = baixoSeq[step];
            td.textContent = val || "";
            td.classList.toggle("chosen", !!val && val !== "x");
        }

        drumLines.forEach((line, idx) => {
            const tr = rows[idx + 1];
            for (let i = 1; i < tr.children.length; i++) {
                const td = tr.children[i];
                const step = i - 1;
                const val = bateriaSeq[line.id][step];
                td.classList.toggle("active", val !== "x");
            }
        });
    }

    function editarNotaBaixo(stepIndex, td) {
        const atual = baixoSeq[stepIndex];
        if (!atual || atual === "x") {
            baixoSeq[stepIndex] = "1E";
        } else {
            const idx = notasValidas.indexOf(atual);
            const prox = (idx + 1) % notasValidas.length;
            baixoSeq[stepIndex] = notasValidas[prox];
        }
        renderGrid();
    }

    function toggleDrum(drumId, stepIndex, td) {
        const atual = bateriaSeq[drumId][stepIndex];
        if (atual === "x") bateriaSeq[drumId][stepIndex] = drumId;
        else bateriaSeq[drumId][stepIndex] = "x";
        renderGrid();
    }

    function initControls() {
        const bpmInput = document.getElementById("bpmInput");
        bpmInput.addEventListener("change", () => {
            const val = parseInt(bpmInput.value) || 120;
            bpmAtual = Math.min(240, Math.max(40, val));
            bpmInput.value = bpmAtual;
        });

        document.getElementById("playBtn").addEventListener("click", togglePlay);
        document.getElementById("randomBtn").addEventListener("click", () => {
            gerarAleatorio();
            renderGrid();
        });
        document.getElementById("clearBtn").addEventListener("click", () => {
            baixoSeq = Array(16).fill("");
            drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
            renderGrid();
        });

        const baixoSlider = document.getElementById("baixoVol");
        const baixoVal = document.getElementById("baixoVolVal");
        baixoSlider.addEventListener("input", () => {
            baixoVolumeGlobal = baixoSlider.value / 100;
            baixoVal.textContent = baixoSlider.value + "%";
        });

        const batSlider = document.getElementById("bateriaVol");
        const batVal = document.getElementById("bateriaVolVal");
        batSlider.addEventListener("input", () => {
            bateriaVolumeGlobal = batSlider.value / 100;
            batVal.textContent = batSlider.value + "%";
        });

        document.getElementById("recordBtn").addEventListener("click", startRecordingOneLoop);
    }

    function gerarAleatorio() {
        baixoSeq = Array(16).fill("");
        for (let i = 0; i < 16; i++) {
            if (Math.random() < 0.6) {
                const idx = Math.floor(Math.random() * notasValidas.length);
                baixoSeq[i] = notasValidas[idx];
            }
        }

        drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));

        for (let i = 0; i < 16; i++) {
            if (i % 4 === 0) {
                bateriaSeq["bumbo"][i] = "bumbo";
                bateriaSeq["caixa"][ (i+2) % 16 ] = "caixa";
            }
            if (Math.random() < 0.7) bateriaSeq["chimbal"][i] = "chimbal";

            if (Math.random() < 0.3) bateriaSeq["tom1"][ (i+1) % 16 ] = "tom1";
            if (Math.random() < 0.3) bateriaSeq["tom2"][ (i+2) % 16 ] = "tom2";
            if (Math.random() < 0.3) bateriaSeq["surdo"][ (i+3) % 16 ] = "surdo";
            if (Math.random() < 0.2) bateriaSeq["ataque"][i] = "ataque";
            if (Math.random() < 0.2) bateriaSeq["conducao"][i] = "conducao";
        }

        renderGrid();
    }

    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        const resp = await fetch(url);
        const arrayBuf = await resp.arrayBuffer();
        const decoded = await audioContext.decodeAudioData(arrayBuf);
        audioBuffers[url] = decoded;
        return decoded;
    }

    function playSample(url, time, volume=1.0) {
        getAudioBuffer(url).then(buffer => {
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;
            source.connect(gainNode).connect(audioContext.destination);
            source.connect(gainNode).connect(mediaStreamDestination);
            source.start(time);
        }).catch(() => {});
    }

    function canvasRenderLoop() {
        ctx.clearRect(0,0,512,512);
        ctx.save();
        const drawImg = (img) => {
            if (!img || !img.complete || !img.naturalWidth) return;
            ctx.drawImage(img, 0, 0);
        };
        drawImg(domImages.bt_kit);
        drawImg(domImages.bt_tronco);
        drawImg(domImages.bt_pernaEsq);
        drawImg(domImages.bt_cabeca);
        const zEsq = parseInt(domImages.bt_bracoEsq.style.zIndex || 10);
        if (zEsq > 11) { drawImg(domImages.bt_bracoDir); drawImg(domImages.bt_bracoEsq); } else { drawImg(domImages.bt_bracoEsq); drawImg(domImages.bt_bracoDir); }
        drawImg(domImages.bt_kit);
        drawImg(domImages.bt_ataque);
        ctx.restore();
        if (domImages.bx_pernas.complete) ctx.drawImage(domImages.bx_pernas, 64, 332);
        ctx.save(); 
        ctx.translate(260, 416); 
        let angle = 0;
        if (isPlaying && pendulumStartTime > 0) {
            const now = performance.now();
            const elapsed = now - pendulumStartTime;
            const speed = 0.003 * (bpmAtual / 120);
            angle = Math.sin(elapsed * speed) * 2.3;
        }
        ctx.rotate(angle * Math.PI / 180); 
        document.getElementById("bodyWrapperPendulo").style.transform = `rotate(${angle}deg)`;
        ctx.translate(-260, -416);
        if (domImages.bx_cabecaTras.complete) ctx.drawImage(domImages.bx_cabecaTras, 100, 60);
        if (domImages.bx_tronco.complete) ctx.drawImage(domImages.bx_tronco, 0, 132);
        if (domImages.bx_antebraco.complete) ctx.drawImage(domImages.bx_antebraco, -2, 179);
        if (domImages.bx_bracoDir.complete) ctx.drawImage(domImages.bx_bracoDir, -5, 250);
        if (domImages.bx_cabeca.complete) ctx.drawImage(domImages.bx_cabeca, 70, 37);
        ctx.restore();
        requestAnimationFrame(canvasRenderLoop);
    }

    function runFrameAnimation(elementId, frames, idleFrame, fps = 30, loop = false) {
        const el = typeof elementId === 'string' ? document.getElementById(elementId) : elementId;
        const start = performance.now();
        const frameDuration = 1000 / fps;
        if (activeAnimations[el.id]) cancelAnimationFrame(activeAnimations[el.id]);
        const animate = (now) => {
            const elapsed = now - start;
            let index = Math.floor(elapsed / frameDuration);
            if (loop) {
                index = index % frames.length;
                setCachedSrc(el, frames[index]);
                activeAnimations[el.id] = requestAnimationFrame(animate);
            } else {
                if (index < frames.length) {
                    setCachedSrc(el, frames[index]);
                    activeAnimations[el.id] = requestAnimationFrame(animate);
                } else {
                    if (idleFrame) {
                        setCachedSrc(el, idleFrame);
                        if(el.id === 'bat_BracoEsq') el.style.zIndex = 10;
                    }
                    delete activeAnimations[el.id];
                }
            }
        };
        activeAnimations[el.id] = requestAnimationFrame(animate);
    }

    function playDrumAnimation(drumType, currentStep) {
        if (!activeAnimations['bat_Tronco'] && isPlaying) {
            runFrameAnimation(domImages.bt_tronco, DRUM_ASSETS.anim.troncoTocando, null, 30, true);
        }
        if (!activeAnimations['bat_Cabeca'] && isPlaying) {
            const useAltHead = Math.random() < 0.5;
            const headFramesSet = useAltHead ? DRUM_ASSETS.anim.cabeca_estavel_2 : DRUM_ASSETS.anim.cabeca_estavel;
            runFrameAnimation(domImages.bt_cabeca, headFramesSet, null, 25, true);
        }
        if (drumType === 'start') return;
        if (drumType === 'bumbo') {
            const prevStepIndex = (currentStep === 0) ? baixoSeq.length - 1 : currentStep - 1;
            const isConsecutive = (bateriaSeq['bumbo'][prevStepIndex] === 'bumbo');
            if (isConsecutive) {
                 runFrameAnimation(domImages.bt_pernaEsq, DRUM_ASSETS.anim.perna_duplo, DRUM_ASSETS.idle.pernaEsq, DRUM_FPS);
            }
            return;
        }
        const prevHitStep = lastDrumStep[drumType];
        const isRapidRepeat = (prevHitStep !== undefined && (currentStep - prevHitStep === 1 || (currentStep===0 && prevHitStep === baixoSeq.length-1)));
        let armToUse = 'right';
        if (['caixa', 'caixaAro'].includes(drumType)) armToUse = 'left';
        if (isRapidRepeat && lastArmUsed[drumType]) {
            armToUse = (lastArmUsed[drumType] === 'right') ? 'left' : 'right';
        }

        // Detecta viradas intercaladas entre braços em Tom_2, Surdo e Condução
        const isFillDrum = ['tom2', 'surdo', 'conducao', 'conducao_centro'].includes(drumType);
        if (isFillDrum) {
            if (lastFillHit && lastFillHit.arm !== armToUse) {
                const totalSteps = baixoSeq.length;
                const diffSteps = (currentStep - lastFillHit.step + totalSteps) % totalSteps;
                if (diffSteps <= 2) {
                    // Animação de virada de cabeça para a direita
                    runFrameAnimation(domImages.bt_cabeca, DRUM_ASSETS.anim.cabeca_virada_dir, DRUM_ASSETS.idle.cabeca, 25, false);
                    lastFillHit = null;
                } else {
                    lastFillHit = { step: currentStep, arm: armToUse };
                }
            } else {
                lastFillHit = { step: currentStep, arm: armToUse };
            }
        }

        lastDrumStep[drumType] = currentStep;
        lastArmUsed[drumType] = armToUse;
        const isLeft = (armToUse === 'left');
        const imgEl = isLeft ? domImages.bt_bracoEsq : domImages.bt_bracoDir;
        
        // IDLE é null para manter a mão congelada no último frame
        const idleSrc = null; 
        
        if (isLeft) {
            if (['ataque', 'tom1', 'tom2', 'surdo', 'conducao', 'conducao_centro'].includes(drumType)) {
                domImages.bt_bracoEsq.style.zIndex = 12;
            } else {
                domImages.bt_bracoEsq.style.zIndex = 10;
            }
        }
        let frames = [];
        const mapName = isLeft ? 'be_' : 'bd_';
        let key = drumType;
        if(drumType === 'chimbalaberto') key = 'chimbal';
        if(drumType === 'caixaAro') key = 'caixa';
        if(drumType === 'conducao_centro') key = 'conducao';
        
        if (DRUM_ASSETS.anim[mapName + key]) {
            frames = DRUM_ASSETS.anim[mapName + key];
        } else {
            frames = isLeft ? DRUM_ASSETS.anim.be_caixa : DRUM_ASSETS.anim.bd_caixa;
        }
        runFrameAnimation(imgEl, frames, idleSrc, DRUM_FPS);
        if(drumType === 'ataque') runFrameAnimation(domImages.bt_ataque, DRUM_ASSETS.anim.ataquePrato, DRUM_ASSETS.idle.ataque, 30);
        if(drumType.includes('conducao')) runFrameAnimation(domImages.bt_conducao, DRUM_ASSETS.anim.conducaoPrato, DRUM_ASSETS.idle.conducao, 30);
    }

    function animarBaixo(nota, msPorStep) {
        if (nota === "x") {
            if (ultimaNotaReal) {
                const pasta = pastaFolderNames[posicaoAtualPasta] || "1F";
                setCachedSrc(domImages.bx_tronco, `animacao/tronco_baixo/Pasta_${pasta}/${ultimaNotaReal}.png`);
            }
            animarMaoDireitaBaixo(ultimaCordaUsada, msPorStep);
            return;
        }
        posicaoAtualPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
        ultimaNotaReal = nota;
        const pastaNome = pastaFolderNames[posicaoAtualPasta];
        setCachedSrc(domImages.bx_tronco, `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`);
        const corda = getCordaDaNota(nota);
        ultimaCordaUsada = corda;
        setCachedSrc(domImages.bx_antebraco, `animacao/antebraco/antebraco${corda}.png`);
        animarMaoDireitaBaixo(corda, msPorStep);
    }

    function animarMaoDireitaBaixo(corda, duracaoStepMs) {
        const frames = [];
        for(let i=2; i<=5; i++) frames.push(`animacao/braco_direito/Corda_${corda}${i}.png`);
        const idle = `animacao/braco_direito/Corda_${corda}1.png`;
        let fps = 1000 / (duracaoStepMs / 5); 
        if (fps < 20) fps = 20; 
        if (fps > 60) fps = 60;
        runFrameAnimation(domImages.bx_bracoDir, frames, idle, fps);
    }

    function stopRightHand() {
        if(activeAnimations['bracoDireitoLayer']) cancelAnimationFrame(activeAnimations['bracoDireitoLayer']);
        setCachedSrc(domImages.bx_bracoDir, `animacao/braco_direito/Corda_${ultimaCordaUsada||'E'}1.png`);
    }

    function resetDrummer() {
        Object.keys(activeAnimations).forEach(k => cancelAnimationFrame(activeAnimations[k]));
        activeAnimations = {};
        lastDrumStep = {};
        setCachedSrc(domImages.bt_tronco, DRUM_ASSETS.idle.tronco);
        setCachedSrc(domImages.bt_pernaEsq, DRUM_ASSETS.idle.pernaEsq);
        setCachedSrc(domImages.bt_bracoDir, DRUM_ASSETS.idle.bracoDir);
        setCachedSrc(domImages.bt_bracoEsq, DRUM_ASSETS.idle.bracoEsq);
        domImages.bt_bracoEsq.style.zIndex = 10;
        setCachedSrc(domImages.bt_cabeca, DRUM_ASSETS.idle.cabeca);
        setCachedSrc(domImages.bt_ataque, DRUM_ASSETS.idle.ataque);
        setCachedSrc(domImages.bt_conducao, DRUM_ASSETS.idle.conducao);
    }

    function togglePlay() {
        if (isPlaying) {
            pararPlayback();
        } else {
            const overlay = document.getElementById("countdownOverlay");
            const txt = document.getElementById("countdownText");
            overlay.style.display = "flex"; 
            prepararAssetsDaSequencia().then(() => {
                let count = 4; 
                txt.innerText = count;
                const ms = 60000 / bpmAtual;
                const countInt = setInterval(() => {
                    count--; 
                    if(count > 0) {
                        txt.innerText = count;
                    } else { 
                        clearInterval(countInt); 
                        overlay.style.display = "none"; 
                        iniciarPlayback(); 
                    }
                }, ms);
            });
        }
    }

    function iniciarPlayback() {
        if (audioContext.state === 'suspended') audioContext.resume();
        isPlaying = true; 
        atualPasso = 0;
        lastDrumStep = {};
        
        document.getElementById("playBtn").innerText = "⏸ Pause"; document.getElementById("playBtn").style.background = "#e65100";
        pendulumStartTime = performance.now(); 
        playDrumAnimation('start', 0); 

        let nextStepTime = audioContext.currentTime;
        const secondsPerStep = (60 / bpmAtual) / 4;

        const scheduler = () => {
            if (!isPlaying) return;
            while (nextStepTime < audioContext.currentTime + 0.15) {
                runStep(atualPasso, nextStepTime);
                nextStepTime += secondsPerStep;
                atualPasso++;
                if (atualPasso >= baixoSeq.length) atualPasso = 0;
            }
            playbackInterval = requestAnimationFrame(scheduler); 
        };
        scheduler();
    }

    function runStep(stepIndex, timeToPlay) {
        const now = audioContext.currentTime;
        const delayVisualBase = Math.max(0, (timeToPlay - now)*1000 - VISUAL_OFFSET_MS);
        const msPorStep = (60 / bpmAtual / 4) * 1000;

        const notaBaixo = baixoSeq[stepIndex] || "x";
        setTimeout(() => {
            animarBaixo(notaBaixo, msPorStep);
        }, delayVisualBase);

        if (notaBaixo !== "x") {
            const url = `assets/bass-notes/${notaBaixo}.mp3`;
            playSample(url, timeToPlay, baixoVolumeGlobal);
        }

        drumLines.forEach(d => {
            const val = bateriaSeq[d.id][stepIndex];
            if (val !== "x") {
                const url = `assets/${d.file}`;
                const delayVisual = Math.max(0, (timeToPlay - now)*1000 - DRUM_PREROLL_MS - VISUAL_OFFSET_MS);
                setTimeout(() => {
                    playDrumAnimation(d.id, stepIndex);
                }, delayVisual);
                playSample(url, timeToPlay, bateriaVolumeGlobal);
            }
        });

        destacarColuna(stepIndex);
    }

    function destacarColuna(stepIndex) {
        const tbody = document.getElementById("gridBody");
        const rows = tbody.querySelectorAll("tr");
        for (let r = 0; r < rows.length; r++) {
            const tr = rows[r];
            for (let c = 1; c < tr.children.length; c++) {
                const td = tr.children[c];
                td.style.outline = (c-1 === stepIndex) ? "2px solid #ffeb3b" : "none";
            }
        }
    }

    function pararPlayback() {
        isPlaying = false;
        cancelAnimationFrame(playbackInterval);
        playbackInterval = null;
        document.getElementById("playBtn").innerText = "▶ Play";
        document.getElementById("playBtn").style.background = "#1976d2";
        pendulumStartTime = 0;
        resetDrummer();
    }

    async function startRecordingOneLoop() {
        if (isRecording) return;
        if (!navigator.mediaDevices || !window.MediaRecorder) {
            alert("Gravação não suportada neste navegador.");
            return;
        }
        const recordStatus = document.getElementById("recordStatus");
        recordStatus.textContent = "Preparando gravação...";
        recordedChunks = [];
        
        const destStream = mediaStreamDestination.stream;
        const stream = new MediaStream();
        destStream.getAudioTracks().forEach(t => stream.addTrack(t));
        try {
            const displayStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            displayStream.getVideoTracks().forEach(t => stream.addTrack(t));
        } catch(e) {
            recordStatus.textContent = "Captura de tela cancelada.";
            return;
        }

        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm;codecs=vp9,opus" });
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: "video/webm" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "jamon-banda.webm";
            a.click();
            URL.revokeObjectURL(url);
            isRecording = false;
            recordStatus.textContent = "Gravação concluída! Arquivo salvo.";
        };

        isRecording = true;
        mediaRecorder.start();
        recordStatus.textContent = "Gravando 1 loop...";

        const secondsPerStep = (60 / bpmAtual) / 4;
        const duracaoLoop = secondsPerStep * 16 * 1000;
        if (!isPlaying) iniciarPlayback();
        setTimeout(() => {
            mediaRecorder.stop();
        }, duracaoLoop + 1000);
    }
</script>
</body>
</html>
