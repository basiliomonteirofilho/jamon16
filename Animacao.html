<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="jamon-engine.js"></script>
  <meta charset="UTF-8" />
  <title>Baixista + Bateria - Animação Corrigida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-bar {
      background: #1f2933;
      padding: 10px 16px;
      border-bottom: 1px solid #374151;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .top-bar-left,
    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .top-bar h1 {
      font-size: 16px;
      font-weight: 600;
      margin-right: 12px;
    }

    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn:hover {
      background: #1f2937;
    }
    .btn-primary {
      border-color: #10b981;
      background: #065f46;
    }
    .btn-primary:hover {
      background: #047857;
    }

    .status-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #10b981;
      color: #a7f3d0;
      background: rgba(5, 150, 105, 0.15);
    }

    .main-layout {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .left-panel {
      flex: 1.1;
      border-right: 1px solid #374151;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    .right-panel {
      flex: 0.9;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 280px;
      max-width: 480px;
      background: #020617;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }
    .panel-title span {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 400;
    }

    .stage-wrapper {
      border-radius: 12px;
      background: radial-gradient(circle at top, #1f2937, #020617 55%);
      border: 1px solid #374151;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 260px;
    }

    .stage {
      flex: 1;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      background: linear-gradient(to bottom, #020617 0%, #020617 40%, #0b1120 100%);
    }

    .stage-floor {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 26%;
      background: radial-gradient(circle at top, #111827, #020617 70%);
      border-top: 1px solid rgba(55, 65, 81, 0.7);
      box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.9);
    }

    .light-cone {
      position: absolute;
      top: -5%;
      left: 50%;
      width: 120%;
      height: 90%;
      transform: translateX(-50%);
      background: radial-gradient(ellipse at top, rgba(59, 130, 246, 0.25), transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .character-container {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      height: 260px;
      pointer-events: none;
    }

    /* Containers da baixista */
    .layer {
      position: absolute;
      transform-origin: center;
      image-rendering: auto;
    }

    #cabeca {
      width: 120px;
      height: 120px;
      left: 80px;
      top: 0px;
    }

    #tronco_baixo {
      width: 260px;
      height: 260px;
      left: 10px;
      top: 40px;
    }

    #braco_direito {
      width: 120px;
      height: 120px;
      left: 140px;
      top: 80px;
    }

    /* Futuro: mão / antebraço direito em layer separado, se quiser */
    #mao_direita {
      width: 90px;
      height: 90px;
      left: 170px;
      top: 130px;
      display: none;
    }

    /* Controles de teste */
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      color: #d1d5db;
    }

    .controls-row label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .controls-row input[type="number"],
    .controls-row input[type="text"] {
      background: #020617;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      border-radius: 6px;
      padding: 3px 6px;
      font-size: 11px;
      width: 70px;
    }

    .controls-row input[type="checkbox"] {
      accent-color: #10b981;
    }

    .test-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .note-btn {
      min-width: 34px;
      text-align: center;
      padding-inline: 2px;
    }

    .ghost-label {
      font-size: 11px;
      color: #a1a1aa;
      margin-left: 4px;
    }

    /* Painel de mapeamento / debug */
    .debug-card {
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 10px;
      font-size: 11px;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .debug-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .debug-row strong {
      color: #fbbf24;
    }

    .debug-log {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #111827;
      padding: 6px;
      height: 100px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 10px;
      color: #9ca3af;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #4b5563;
      color: #d1d5db;
      background: #020617;
    }

    .chip span {
      font-size: 9px;
      color: #9ca3af;
    }

    .chip-green {
      border-color: #10b981;
      color: #a7f3d0;
      background: rgba(5, 150, 105, 0.15);
    }

    .chip-red {
      border-color: #f97316;
      color: #fed7aa;
      background: rgba(124, 45, 18, 0.25);
    }

    .chip-blue {
      border-color: #3b82f6;
      color: #bfdbfe;
      background: rgba(30, 64, 175, 0.3);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .field-group label {
      font-size: 11px;
      color: #9ca3af;
    }

    .field-group input[type="text"] {
      width: 100%;
    }

    /* ----- Ferramenta de ajuste de CSS (setinha) ----- */
    .css-editor {
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 8px;
      font-size: 11px;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .css-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .css-editor-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
      margin-top: 4px;
    }

    .css-editor-grid button {
      font-size: 11px;
      padding: 4px 0;
    }

    .css-code {
      margin-top: 4px;
      padding: 4px;
      border-radius: 6px;
      background: #020617;
      border: 1px solid #111827;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      color: #9ca3af;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 110px;
      overflow: auto;
    }

    .css-editor select {
      background: #020617;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      border-radius: 6px;
      padding: 3px 6px;
      font-size: 11px;
    }

    .css-editor small {
      font-size: 10px;
      color: #9ca3af;
    }

    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }
      .right-panel {
        max-width: 100%;
      }
      .character-container {
        width: 220px;
        height: 220px;
      }
      #tronco_baixo {
        width: 230px;
        height: 230px;
        left: 5px;
        top: 32px;
      }
      #cabeca {
        width: 100px;
        height: 100px;
        left: 70px;
        top: 0px;
      }
      #braco_direito {
        width: 100px;
        height: 100px;
        left: 130px;
        top: 70px;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-bar-left">
      <h1>Jam On – Baixista & Baterista (Animação)</h1>
      <span class="status-badge">Beta – sincronizado com a composição</span>
    </div>
    <div class="top-bar-right">
      <button class="btn" id="btnRecarregar">Recarregar imagens</button>
      <button class="btn" id="btnLimparLog">Limpar log</button>
    </div>
  </div>

  <div class="main-layout">
    <section class="left-panel">
      <div class="panel-title">
        Palco da Baixista
        <span>(usa PNGs de <code>animacao/cabeca</code>, <code>animacao/tronco_baixo</code> e
          <code>animacao/braco_direito</code>)</span>
      </div>

      <div class="stage-wrapper">
        <div class="stage">
          <div class="light-cone"></div>
          <div class="stage-floor"></div>

          <div class="character-container">
            <img id="cabeca" class="layer" src="" alt="Cabeça da baixista" />
            <img id="tronco_baixo" class="layer" src="" alt="Tronco + Baixo" />
            <img id="braco_direito" class="layer" src="" alt="Braço direito" />
            <img id="mao_direita" class="layer" src="" alt="Mão direita (futuro)" />
          </div>
        </div>

        <div class="controls-row">
          <label>
            Nota manual:
            <input type="text" id="inputNotaManual" placeholder="Ex: 1E, 2F, 4G, x" />
          </label>
          <button class="btn btn-primary" id="btnTocarNotaManual">Tocar nota + animar</button>
          <span class="ghost-label">Use <strong>x</strong> para ghost note (notas abafadas)</span>
        </div>

        <div class="test-buttons">
          <button class="btn note-btn" data-nota="1E">1E</button>
          <button class="btn note-btn" data-nota="2F">2F</button>
          <button class="btn note-btn" data-nota="3FS">3FS</button>
          <button class="btn note-btn" data-nota="4G">4G</button>
          <button class="btn note-btn" data-nota="5GS">5GS</button>
          <button class="btn note-btn" data-nota="6A">6A</button>
          <button class="btn note-btn" data-nota="7AS">7AS</button>
          <button class="btn note-btn" data-nota="8B">8B</button>
          <button class="btn note-btn" data-nota="x">X</button>
        </div>
      </div>
    </section>

    <aside class="right-panel">
      <div class="panel-title">
        Mapeamento / Estado
        <span>(debug rápido da lógica de “economia de movimentos”)</span>
      </div>

      <div class="debug-card">
        <div class="debug-row">
          <span class="chip chip-blue">
            Posição atual:
            <span id="lblPosicaoAtual">–</span>
          </span>
          <span class="chip chip-green">
            Última nota real:
            <span id="lblUltimaNotaReal">–</span>
          </span>
          <span class="chip">
            Pasta atual:
            <span id="lblPastaAtual">–</span>
          </span>
        </div>

        <div class="debug-row">
          <span class="chip">
            Nota recebida:
            <span id="lblNotaRecebida">–</span>
          </span>
          <span class="chip">
            Tipo:
            <span id="lblTipoNota">–</span>
          </span>
          <span class="chip chip-red">
            Fantasma?
            <span id="lblGhost">–</span>
          </span>
        </div>

        <div class="debug-row">
          <span class="chip">
            Pasta escolhida:
            <span id="lblPastaEscolhida">–</span>
          </span>
          <span class="chip">
            PNG:
            <span id="lblPngEscolhido">–</span>
          </span>
        </div>

        <div class="field-group">
          <label>Log de eventos</label>
          <div id="debugLog" class="debug-log"></div>
        </div>
      </div>

      <div class="panel-title">
        Ferramenta para ajustar posição dos PNGs
        <span>(setinhas + copia CSS para colar no código)</span>
      </div>

      <div class="css-editor">
        <div class="css-editor-header">
          <div class="debug-row" style="gap: 4px">
            <span class="chip chip-blue">
              Selecionado:
              <span id="lblLayerSelecionada">tronco_baixo</span>
            </span>
            <span class="chip">
              X:
              <span id="lblPosX">10</span> / Y:
              <span id="lblPosY">40</span>
            </span>
          </div>
          <select id="selectLayer">
            <option value="cabeca">Cabeça</option>
            <option value="tronco_baixo" selected>Tronco + Baixo</option>
            <option value="braco_direito">Braço direito</option>
            <option value="mao_direita">Mão direita (futuro)</option>
          </select>
        </div>

        <div class="css-editor-grid">
          <button class="btn" id="btnUp">▲</button>
          <button class="btn" id="btnCenter">Reset</button>
          <button class="btn" id="btnDown">▼</button>
          <button class="btn" id="btnLeft">◄</button>
          <button class="btn" id="btnCopyCss">Copiar CSS</button>
          <button class="btn" id="btnRight">►</button>
        </div>

        <small>
          Use as setas para ajustar a posição absoluta do container selecionado.
          Depois clique em <strong>Copiar CSS</strong> e cole no arquivo HTML/CSS
          principal para fixar a posição.
        </small>

        <div id="cssCode" class="css-code"></div>
      </div>
    </aside>
  </div>

  <script>
    // =====================  CONFIGURAÇÃO DE PATHS ===========================
    const BASE_ANIM_PATH = "animacao"; // raiz das imagens da animação
    const CABECA_PATH = `${BASE_ANIM_PATH}/cabeca`;
    const TRONCO_PATH = `${BASE_ANIM_PATH}/tronco_baixo`;
    const BRACO_DIR_PATH = `${BASE_ANIM_PATH}/braco_direito`;

    // Áudios da bateria (mesmo esquema do Jam On)
    const DRUM_SAMPLES = {
      ataque: "assets/ataque.mp3",
      bumbo: "assets/bumbo.mp3",
      caixa: "assets/caixa.mp3",
      caixaAro: "assets/caixaAro.mp3",
      chimbal: "assets/chimbal.mp3",
      chimbalAberto: "assets/chimbal-aberto.mp3",
      chimbalPedal: "assets/chimbal-pedal.mp3",
      conducao: "assets/conducao.mp3",
      conducaoCentro: "assets/conducao-centro.mp3",
      surdo: "assets/surdo.mp3",
      tom1: "assets/tom-1.mp3",
      tom2: "assets/tom-2.mp3",
    };

    // =====================  ESTADO GLOBAL DA ANIMAÇÃO =======================
    const cabecaEl = document.getElementById("cabeca");
    const troncoEl = document.getElementById("tronco_baixo");
    const bracoDirEl = document.getElementById("braco_direito");
    const maoDirEl = document.getElementById("mao_direita");

    // Label de debug
    const lblPosicaoAtual = document.getElementById("lblPosicaoAtual");
    const lblUltimaNotaReal = document.getElementById("lblUltimaNotaReal");
    const lblPastaAtual = document.getElementById("lblPastaAtual");
    const lblNotaRecebida = document.getElementById("lblNotaRecebida");
    const lblTipoNota = document.getElementById("lblTipoNota");
    const lblGhost = document.getElementById("lblGhost");
    const lblPastaEscolhida = document.getElementById("lblPastaEscolhida");
    const lblPngEscolhido = document.getElementById("lblPngEscolhido");
    const debugLogEl = document.getElementById("debugLog");

    const btnRecarregar = document.getElementById("btnRecarregar");
    const btnLimparLog = document.getElementById("btnLimparLog");
    const btnTocarNotaManual = document.getElementById("btnTocarNotaManual");
    const inputNotaManual = document.getElementById("inputNotaManual");

    // Editor CSS
    const selectLayer = document.getElementById("selectLayer");
    const btnUp = document.getElementById("btnUp");
    const btnDown = document.getElementById("btnDown");
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");
    const btnCenter = document.getElementById("btnCenter");
    const btnCopyCss = document.getElementById("btnCopyCss");
    const cssCodeEl = document.getElementById("cssCode");
    const lblLayerSelecionada = document.getElementById("lblLayerSelecionada");
    const lblPosX = document.getElementById("lblPosX");
    const lblPosY = document.getElementById("lblPosY");

    // Estado de posição atual da "mão" no braço
    let posicaoAtualPasta = 1; // 1..24
    let ultimaNotaReal = null; // última nota diferente de X ou sustain
    let imagensCarregadas = false;

    // =====================  MAPA DE PASTAS DO BAIXO =========================
    // Mapa corrigido baseado na lista de pastas/PNGs que você enviou
    // (economia de movimentos: cada pasta representa uma posição de mão).

    const pastaMap = {
      1: { nome: "Pasta_1F", notas: ["1E", "2F", "3FS", "4G", "5GS", "6A", "7AS", "8B", "9C", "10CS", "11D", "12DS", "13E", "14F", "15FS", "16G", "17GS", "18A", "19AS", "20B"] },
      2: { nome: "Pasta_2FS", notas: ["3FS", "4G", "5GS", "6A", "8B", "9C", "10CS", "11D", "13E", "14F", "15FS", "16G", "18A", "19AS", "20B", "21C"] },
      3: { nome: "Pasta_3G", notas: ["4G", "5GS", "6A", "7AS", "9C", "10CS", "11D", "12DS", "14F", "15FS", "16G", "17GS", "19AS", "20B", "21C", "22CS"] },
      4: { nome: "Pasta_4GS", notas: ["5GS", "6A", "7AS", "8B", "10CS", "11D", "12DS", "13E", "15FS", "16G", "17GS", "18A", "20B", "21C", "22CS", "23D"] },
      5: { nome: "Pasta_5A", notas: ["6A", "7AS", "8B", "9C", "11D", "12DS", "13E", "14F", "16G", "17GS", "18A", "19AS", "21C", "22CS", "23D", "24DS"] },
      6: { nome: "Pasta_6AS", notas: ["7AS", "8B", "9C", "10CS", "12DS", "13E", "14F", "15FS", "17GS", "18A", "19AS", "20B", "22CS", "23D", "24DS", "25E"] },
      7: { nome: "Pasta_7B", notas: ["8B", "9C", "10CS", "11D", "13E", "14F", "15FS", "16G", "18A", "19AS", "20B", "21C", "23D", "24DS", "25E", "26F"] },
      8: { nome: "Pasta_8C", notas: ["9C", "10CS", "11D", "12DS", "14F", "15FS", "16G", "17GS", "19AS", "20B", "21C", "22CS", "24DS", "25E", "26F", "27FS"] },
      9: { nome: "Pasta_9CS", notas: ["10CS", "11D", "12DS", "13E", "15FS", "16G", "17GS", "18A", "20B", "21C", "22CS", "23D", "25E", "26F", "27FS", "28G"] },
      10: { nome: "Pasta_10D", notas: ["11D", "12DS", "13E", "14F", "16G", "17GS", "18A", "19AS", "21C", "22CS", "23D", "24DS", "26F", "27FS", "28G", "29GS"] },
      11: { nome: "Pasta_11DS", notas: ["12DS", "13E", "14F", "15FS", "17GS", "18A", "19AS", "20B", "22CS", "23D", "24DS", "25E", "27FS", "28G", "29GS", "30A"] },
      12: { nome: "Pasta_12E", notas: ["13E", "14F", "15FS", "16G", "18A", "19AS", "20B", "21C", "23D", "24DS", "25E", "26F", "28G", "29GS", "30A", "31B"] }, // <-- corrigido 31B
      13: { nome: "Pasta_13F", notas: ["14F", "15FS", "16G", "17GS", "19AS", "20B", "21C", "22CS", "24DS", "25E", "26F", "27FS", "29GS", "30A", "31AS", "32B"] },
      14: { nome: "Pasta_14FS", notas: ["15FS", "16G", "17GS", "18A", "20B", "21C", "22CS", "23D", "25E", "26F", "27FS", "28G", "30A", "31AS", "32B", "33C"] },
      15: { nome: "Pasta_15G", notas: ["16G", "17GS", "18A", "19AS", "21C", "22CS", "23D", "24DS", "26F", "27FS", "28G", "29GS", "31AS", "32B", "33C", "34CS"] },
      16: { nome: "Pasta_16GS", notas: ["17GS", "18A", "19AS", "20B", "22CS", "23D", "24DS", "25E", "27FS", "28G", "29GS", "30A", "32B", "33C", "34CS", "35D"] },
      17: { nome: "Pasta_17A", notas: ["18A", "19AS", "20B", "21C", "23D", "24DS", "25E", "26F", "28G", "29GS", "30A", "31AS", "33C", "34CS", "35D", "36DS"] },
      18: { nome: "Pasta_18AS", notas: ["19AS", "20B", "21C", "22CS", "24DS", "25E", "26F", "27FS", "29GS", "30A", "31AS", "32B", "34CS", "35D", "36DS", "37E"] },
      19: { nome: "Pasta_19B", notas: ["20B", "21C", "22CS", "23D", "25E", "26F", "27FS", "28G", "30A", "31AS", "32B", "33C", "35D", "36DS", "37E", "38F"] },
      20: { nome: "Pasta_20C", notas: ["21C", "22CS", "23D", "24DS", "26F", "27FS", "28G", "29GS", "31AS", "32B", "33C", "34CS", "36DS", "37E", "38F", "39FS"] },
      21: { nome: "Pasta_21CS", notas: ["22CS", "23D", "24DS", "25E", "27FS", "28G", "29GS", "30A", "32B", "33C", "34CS", "35D", "37E", "38F", "39FS", "40G"] },
      22: { nome: "Pasta_22D", notas: ["23D", "24DS", "25E", "26F", "28G", "29GS", "30A", "31AS", "33C", "34CS", "35D", "36DS", "38F", "39FS", "40G", "41GS"] },
      23: { nome: "Pasta_23DS", notas: ["24DS", "25E", "26F", "27FS", "29GS", "30A", "31AS", "32B", "34CS", "35D", "36DS", "37E", "39FS", "40G", "41GS", "42A"] },
      24: { nome: "Pasta_24E", notas: ["25E", "26F", "27FS", "28G", "30A", "31AS", "32B", "33C", "35D", "36DS", "37E", "38F", "40G", "41GS", "42A", "43AS"] },
    };

    const totalPastas = 24;

    // Mapa de cordas -> range de notas (para debug; pode ser refinado)
    const pastasPorCordas = {
      E: [1, 12],
      A: [5, 16],
      D: [9, 20],
      G: [13, 24],
    };

    function logDebug(msg) {
      const ts = new Date().toLocaleTimeString("pt-BR", { hour12: false });
      const line = `[${ts}] ${msg}\n`;
      debugLogEl.textContent = line + debugLogEl.textContent;
    }

    function atualizarLabelsEstado(extra = {}) {
      lblPosicaoAtual.textContent = posicaoAtualPasta ?? "–";
      lblUltimaNotaReal.textContent = ultimaNotaReal ?? "–";
      lblPastaAtual.textContent = posicaoAtualPasta ? pastaMap[posicaoAtualPasta].nome : "–";

      if (extra.nota != null) lblNotaRecebida.textContent = extra.nota;
      if (extra.tipo != null) lblTipoNota.textContent = extra.tipo;
      if (extra.ghost != null) lblGhost.textContent = extra.ghost ? "Sim" : "Não";
      if (extra.pastaEscolhida != null) lblPastaEscolhida.textContent = extra.pastaEscolhida;
      if (extra.png != null) lblPngEscolhido.textContent = extra.png;
    }

    function obterNotasDaPasta(idx) {
      const p = pastaMap[idx];
      return p ? p.notas : [];
    }

    function encontrarPastas(nota) {
      const indices = [];
      for (let i = 1; i <= totalPastas; i++) {
        const notas = obterNotasDaPasta(i);
        if (notas.includes(nota)) indices.push(i);
      }
      return indices;
    }

    function escolherMelhorPasta(nota, pastaAnteriorIndex) {
      const candidatas = encontrarPastas(nota);
      if (!candidatas.length) return null;
      if (!pastaAnteriorIndex || !pastaMap[pastaAnteriorIndex]) return candidatas[0];

      let melhor = candidatas[0];
      let menorDist = Math.abs(candidatas[0] - pastaAnteriorIndex);
      for (let i = 1; i < candidatas.length; i++) {
        const dist = Math.abs(candidatas[i] - pastaAnteriorIndex);
        if (dist < menorDist) {
          menorDist = dist;
          melhor = candidatas[i];
        }
      }
      return melhor;
    }

    // =====================  AUDIO DO BAIXO (INTEGRÁVEL COM JAM ON) ========
    const baixistaAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const baixoBufferCache = new Map();

    const BAIXO_SAMPLES = {};

    function precacheBaixoSamples() {
      for (let n = 1; n <= 24; n++) {
        const noteName = mapBassNoteToFile(n); // mapeamento original 1E..24E
        const path = `assets/BaixoMelodia/${noteName}.mp3`;
        BAIXO_SAMPLES[n] = path;
      }
      // Ghost note usa áudio abafado dedicado (arquivo que você informou)
      BAIXO_SAMPLES["x"] = "assets/bass-muted.mp3";
    }

    function mapBassNoteToFile(n) {
      // 1..24 => 1E..24E (mesmo padrão do Jam On)
      return `${n}E`;
    }

    async function loadAudioBuffer(src) {
      if (baixoBufferCache.has(src)) return baixoBufferCache.get(src);
      const res = await fetch(src);
      const arrBuf = await res.arrayBuffer();
      const audioBuf = await baixistaAudioCtx.decodeAudioData(arrBuf);
      baixoBufferCache.set(src, audioBuf);
      return audioBuf;
    }

    async function tocarNotaAudioBaixo(nota) {
      // nota pode vir como "1E".."24E" ou "x" (ghost) ou vazia
      if (!nota || nota === "-") return;

      try {
        await baixistaAudioCtx.resume();
      } catch (e) {}

      let src;
      if (nota === "x") {
        // sempre usa o arquivo de nota abafada
        src = BAIXO_SAMPLES["x"];
      } else {
        // extrai apenas o número da nota (1..24) se vier no formato "4G", "3FS", etc.
        const match = String(nota).match(/^(\d+)/);
        if (!match) return;
        const idx = Number(match[1]);
        src = BAIXO_SAMPLES[idx];
      }
      if (!src) return;

      try {
        const buf = await loadAudioBuffer(src);
        const node = baixistaAudioCtx.createBufferSource();
        node.buffer = buf;
        node.connect(baixistaAudioCtx.destination);
        node.start();
      } catch (err) {
        console.warn("Erro ao tocar áudio do baixo:", nota, err);
      }
    }

    // =====================  ANIMAÇÃO DO TRONCO (POSIÇÃO DA MÃO) ============
    function trocarFrameTronco(nota) {
      logDebug(`Recebida nota: ${nota}`);
      atualizarLabelsEstado({
        nota,
        tipo: !nota ? "Sustain" : nota === "x" ? "Ghost" : "Nota real",
        ghost: nota === "x",
      });

      if (!troncoEl) return;

      if (!troncoEl.dataset.x) {
        troncoEl.dataset.x = "10";
        troncoEl.dataset.y = "40";
        troncoEl.dataset.width = troncoEl.style.width || "260px";
        troncoEl.dataset.height = troncoEl.style.height || "260px";
        troncoEl.style.left = troncoEl.dataset.x + "px";
        troncoEl.style.top = troncoEl.dataset.y + "px";
      }

      // 1) Ghost note (X) -> usa última nota real mas com pasta de menor movimento
      if (nota === "x") {
        if (ultimaNotaReal) {
          const indicePastaGhost = escolherMelhorPasta(ultimaNotaReal, posicaoAtualPasta);
          if (indicePastaGhost != null) {
            posicaoAtualPasta = indicePastaGhost;
            const nomePastaGhost = pastaMap[indicePastaGhost].nome;
            const pathGhost = `${TRONCO_PATH}/${nomePastaGhost}/${ultimaNotaReal}.png`;
            troncoEl.src = pathGhost;
            logDebug(`Ghost note usando: ${pathGhost}`);
            atualizarLabelsEstado({
              pastaEscolhida: nomePastaGhost,
              png: `${ultimaNotaReal}.png (ghost)`,
            });
          }
        }
        return;
      }

      // 2) Sustain (nota vazia) -> mantém o frame atual
      if (!nota || nota === "-") {
        logDebug("Sustain: mantendo frame atual.");
        return;
      }

      // 3) Nota real
      ultimaNotaReal = nota;

      const novaPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
      if (novaPasta == null) {
        logDebug(`Nenhuma pasta encontrada contendo a nota ${nota}.`);
        return;
      }

      posicaoAtualPasta = novaPasta;
      const nomePasta = pastaMap[posicaoAtualPasta].nome;
      const novoSrc = `${TRONCO_PATH}/${nomePasta}/${nota}.png`;

      troncoEl.src = novoSrc;
      logDebug(`Nova posição: ${nomePasta} -> ${novoSrc}`);
      atualizarLabelsEstado({
        pastaEscolhida: nomePasta,
        png: `${nota}.png`,
      });
    }

    // =====================  ANIMAÇÃO CABEÇA / BRAÇO (SIMPLES) =============
    let frameCabeca = 1;
    const TOTAL_FRAMES_CABECA = 809;

    function atualizarCabeca() {
      frameCabeca++;
      if (frameCabeca > TOTAL_FRAMES_CABECA) frameCabeca = 1;
      const frameStr = String(frameCabeca).padStart(4, "0");
      cabecaEl.src = `${CABECA_PATH}/cabeca${frameStr}.png`;
    }

    let animCabecaInterval = null;
    function iniciarAnimacaoCabeca() {
      if (animCabecaInterval) clearInterval(animCabecaInterval);
      animCabecaInterval = setInterval(atualizarCabeca, 80);
    }

    function animarBracoDireitoPequenoGolpe() {
      if (!bracoDirEl) return;
      bracoDirEl.style.transform = "translateY(4px) rotate(2deg)";
      setTimeout(() => {
        bracoDirEl.style.transform = "translateY(0) rotate(0deg)";
      }, 120);
    }

    // =====================  TESTE LOCAL (botões / input) ===================
    function tocarNotaComAnimacao(nota) {
      // Áudio (inclui ghost com bass-muted)
      tocarNotaAudioBaixo(nota);

      // Tronco / mão
      trocarFrameTronco(nota);

      // Cabeça balançando sempre
      if (!animCabecaInterval) iniciarAnimacaoCabeca();

      // Pequeno movimento no braço
      if (nota && nota !== "-" && nota !== "x") {
        animarBracoDireitoPequenoGolpe();
      }
    }

    // Botões de teste
    document.querySelectorAll(".note-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const nota = btn.dataset.nota;
        tocarNotaComAnimacao(nota);
      });
    });

    if (btnTocarNotaManual) {
      btnTocarNotaManual.addEventListener("click", () => {
        const nota = inputNotaManual.value.trim().toUpperCase();
        inputNotaManual.value = nota;
        tocarNotaComAnimacao(nota);
      });
    }

    // =====================  PRELOAD IMAGENS / DRUM AUDIO ===================
    const imagemCache = new Map();

    function preloadImage(src) {
      return new Promise((resolve, reject) => {
        if (imagemCache.has(src)) return resolve(imagemCache.get(src));
        const img = new Image();
        img.onload = () => {
          imagemCache.set(src, true);
          resolve(true);
        };
        img.onerror = (e) => {
          console.warn("Falha ao carregar imagem:", src, e);
          resolve(false); // não rejeita pra não travar tudo
        };
        img.src = src;
      });
    }

    async function precarregarImagensAnimacao() {
      const promessas = [];

      promessas.push(preloadImage(`${CABECA_PATH}/cabeca0001.png`));

      for (let i = 1; i <= totalPastas; i++) {
        const pasta = pastaMap[i];
        if (!pasta) continue;
        for (const nota of pasta.notas) {
          const src = `${TRONCO_PATH}/${pasta.nome}/${nota}.png`;
          promessas.push(preloadImage(src));
        }
      }

      // Braço direito: se você tiver sprites específicos, pode pré-carregar aqui
      // Exemplo: 21 frames
      for (let i = 1; i <= 21; i++) {
        const frameStr = String(i).padStart(2, "0");
        const src = `${BRACO_DIR_PATH}/braco_direito_${frameStr}.png`;
        promessas.push(preloadImage(src));
      }

      await Promise.all(promessas);
      imagensCarregadas = true;
      logDebug("Todas as imagens principais foram pré-carregadas (dentro do possível).");
    }

    async function preloadDrums() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const cache = {};
      const urls = Object.values(DRUM_SAMPLES);
      await Promise.all(
        urls.map(async (u) => {
          try {
            const res = await fetch(u);
            const buf = await res.arrayBuffer();
            const audioBuf = await ctx.decodeAudioData(buf);
            cache[u] = audioBuf;
          } catch (e) {
            console.warn("Falha ao pré-carregar som de bateria:", u, e);
          }
        })
      );
      logDebug("Pré-carreguei o essencial da bateria.");
      ctx.close();
    }

    // =====================  BOTÕES DA BARRA SUPERIOR =======================
    if (btnRecarregar) {
      btnRecarregar.addEventListener("click", () => {
        imagensCarregadas = false;
        imagemCache.clear();
        precarregarImagensAnimacao().then(() => {
          logDebug("Recarregamento de imagens concluído.");
        });
      });
    }

    if (btnLimparLog) {
      btnLimparLog.addEventListener("click", () => {
        debugLogEl.textContent = "";
      });
    }

    // =====================  EDITOR DE POSIÇÃO (CSS) ========================
    function getLayerElementById(id) {
      switch (id) {
        case "cabeca":
          return cabecaEl;
        case "tronco_baixo":
          return troncoEl;
        case "braco_direito":
          return bracoDirEl;
        case "mao_direita":
          return maoDirEl;
        default:
          return null;
      }
    }

    function atualizarCssCode() {
      const layerId = selectLayer.value;
      const el = getLayerElementById(layerId);
      if (!el) return;

      const left = el.style.left || "0px";
      const top = el.style.top || "0px";
      const width = el.style.width || "";
      const height = el.style.height || "";

      lblLayerSelecionada.textContent = layerId;
      lblPosX.textContent = parseInt(left, 10) || 0;
      lblPosY.textContent = parseInt(top, 10) || 0;

      const css = [
        `#${layerId} {`,
        `  position: absolute;`,
        `  left: ${left};`,
        `  top: ${top};`,
        width ? `  width: ${width};` : "",
        height ? `  height: ${height};` : "",
        `}`,
      ]
        .filter(Boolean)
        .join("\n");

      cssCodeEl.textContent = css;
    }

    function moverSelecionado(dx, dy) {
      const layerId = selectLayer.value;
      const el = getLayerElementById(layerId);
      if (!el) return;

      const left = parseInt(el.style.left || "0", 10) || 0;
      const top = parseInt(el.style.top || "0", 10) || 0;
      el.style.left = left + dx + "px";
      el.style.top = top + dy + "px";
      atualizarCssCode();
    }

    function resetarPosicaoSelecionado() {
      const layerId = selectLayer.value;
      const el = getLayerElementById(layerId);
      if (!el) return;

      switch (layerId) {
        case "cabeca":
          el.style.left = "80px";
          el.style.top = "0px";
          el.style.width = "120px";
          el.style.height = "120px";
          break;
        case "tronco_baixo":
          el.style.left = "10px";
          el.style.top = "40px";
          el.style.width = "260px";
          el.style.height = "260px";
          break;
        case "braco_direito":
          el.style.left = "140px";
          el.style.top = "80px";
          el.style.width = "120px";
          el.style.height = "120px";
          break;
        case "mao_direita":
          el.style.left = "170px";
          el.style.top = "130px";
          el.style.width = "90px";
          el.style.height = "90px";
          break;
      }
      atualizarCssCode();
    }

    function copiarCss() {
      const css = cssCodeEl.textContent;
      if (!css) return;
      navigator.clipboard
        .writeText(css)
        .then(() => {
          logDebug("CSS copiado para a área de transferência.");
        })
        .catch((e) => {
          console.warn("Falha ao copiar CSS:", e);
        });
    }

    selectLayer.addEventListener("change", atualizarCssCode);

    window.addEventListener("load", () => {
      resetarPosicaoSelecionado();
      atualizarCssCode();
      precacheBaixoSamples();
      precarregarImagensAnimacao();
      preloadDrums();
      iniciarAnimacaoCabeca();
    });

    if (btnUp) btnUp.addEventListener("click", () => moverSelecionado(0, -1));
    if (btnDown) btnDown.addEventListener("click", () => moverSelecionado(0, 1));
    if (btnLeft) btnLeft.addEventListener("click", () => moverSelecionado(-1, 0));
    if (btnRight) btnRight.addEventListener("click", () => moverSelecionado(1, 0));
    if (btnCenter) btnCenter.addEventListener("click", resetarPosicaoSelecionado);
    if (btnCopyCss) btnCopyCss.addEventListener("click", copiarCss);
  </script>
</body>
</html>
