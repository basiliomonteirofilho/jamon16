<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="jamon-engine.js"></script>

  <meta charset="UTF-8" />
  <title>Jam On ‚Äì Baixista Animada com Playback Aleat√≥rio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #101010;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow: hidden;
    }
    h1, h2, h3 {
      font-weight: 600;
    }
    button {
      cursor: pointer;
    }

    /* Overlay de orienta√ß√£o (paisagem) */
    #orientationOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      text-align: center;
      padding: 2rem;
    }
    #orientationOverlay h2 {
      font-size: 1.7rem;
      margin-bottom: 0.8rem;
    }
    #orientationOverlay p {
      opacity: 0.85;
    }

    /* Overlay de contagem regressiva */
    #countdownOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }
    #countdownOverlay span {
      font-size: 5rem;
      font-weight: 800;
      color: #00e0ff;
      text-shadow: 0 0 18px #00e0ff;
    }

    /* Container raiz */
    .appRoot {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ============================
       TOPO: ANIMA√á√ÉO BAIXISTA
       ============================ */
    #animacaoArea {
      width: 100%;
      height: 60%;
      background: #151515;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      border-bottom: 1px solid #222;
      overflow: hidden;
    }
    #animacaoInner {
      position: relative;
      width: min(480px, 60vw);
      height: min(420px, 55vh);
    }
    #animacaoInner img {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      user-select: none;
      pointer-events: none;
      image-rendering: auto;
    }
    #pernasLayer {
      bottom: 0;
      width: 68%;
    }
    #troncoLayer {
      bottom: 0;
      width: 70%;
    }
    #cabecaLayer {
      bottom: 38%;
      width: 48%;
      transform-origin: 50% 85%;
    }
    #bracoDireitoLayer {
      bottom: 20%;
      width: 52%;
      transform-origin: 15% 10%;
    }
    #antebracoLayer {
      bottom: 24%;
      width: 52%;
      transform-origin: 15% 5%;
    }

    /* Suave balan√ßo lateral do grupo (tronco+pernas) */
    .grupoBalan√ßo {
      animation: sway 4s ease-in-out infinite;
    }
    @keyframes sway {
      0%   { transform: translateX(-50%) rotate(-1.5deg); }
      50%  { transform: translateX(-50%) rotate(1.5deg); }
      100% { transform: translateX(-50%) rotate(-1.5deg); }
    }

    /* ===== Editor de posi√ß√£o (modo ajuste) ===== */
    #posEditor {
      position: absolute;
      left: 8px;
      bottom: 8px;
      padding: 6px 8px;
      background: rgba(0,0,0,0.65);
      border-radius: 8px;
      font-size: 0.75rem;
      z-index: 5000;
      backdrop-filter: blur(4px);
    }
    #posEditor label {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    #posEditorControls {
      margin-top: 4px;
      display: none;
      flex-direction: column;
      gap: 4px;
    }
    #posEditorControls select {
      font-size: 0.75rem;
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
    }
    #posEditorButtons {
      display: grid;
      grid-template-columns: repeat(3, 20px);
      grid-template-rows: repeat(2, 20px);
      gap: 2px;
      justify-content: center;
    }
    #posEditorButtons button {
      font-size: 0.7rem;
      padding: 0;
      border-radius: 4px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
    }
    #posEditor textarea {
      width: 200px;
      height: 80px;
      resize: none;
      font-size: 0.7rem;
      background: #050505;
      color: #0f0;
      border-radius: 4px;
      border: 1px solid #333;
      padding: 3px 4px;
    }

    /* ============================
       BASE: CONTROLES E COMPOSI√á√ÉO
       ============================ */
    #painel {
      width: 100%;
      height: 40%;
      background: #111;
      display: flex;
      flex-direction: column;
      padding: 10px 12px 8px;
      gap: 8px;
      overflow: hidden;
    }

    #topControls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      border-radius: 8px;
      padding: 6px 10px;
      background: linear-gradient(90deg, #181818, #181822);
      box-shadow: 0 0 0 1px #222 inset;
      font-size: 0.9rem;
    }
    #topControls-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    #topControls-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .sliderGroup {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .sliderGroup label {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .sliderGroup input[type="range"] {
      width: 120px;
    }

    .btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 500;
      background: #00a8ff;
      color: #fff;
      box-shadow: 0 0 0 1px #0077b6 inset;
      transition: background 0.2s, transform 0.08s;
      white-space: nowrap;
    }
    .btn:hover {
      background: #00c4ff;
      transform: translateY(-1px);
    }
    .btn.secondary {
      background: #333;
      color: #eee;
      box-shadow: 0 0 0 1px #555 inset;
    }
    .btn.secondary:hover {
      background: #444;
    }
    .btn.danger {
      background: #bb2d3b;
      box-shadow: 0 0 0 1px #7a1c25 inset;
    }
    .btn.danger:hover {
      background: #d63348;
    }

    #descricaoModo {
      font-size: 0.75rem;
      opacity: 0.75;
    }

    /* Barra de progresso */
    #progressContainer {
      width: 100%;
      height: 5px;
      background: #222;
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 0 0 1px #000 inset;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #00e0ff, #00ff85);
      transition: width 0.08s linear;
    }

    /* √Årea de composi√ß√£o (baixo + bateria) */
    #composicaoSection {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #sequencerCard {
      flex: 1;
      min-height: 0;
      background: #151515;
      border-radius: 10px;
      box-shadow: 0 0 0 1px #222 inset;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: hidden;
    }

    #sequencerHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
    }
    #sequencerHeaderLeft span {
      font-weight: 500;
    }
    #sequencerHeaderRight {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    #sequencerInner {
      flex: 1;
      min-height: 0;
      overflow: auto; /* scroll √∫nico para baixo + todas as linhas da bateria */
      padding-top: 4px;
    }

    .gridTitulo {
      font-size: 0.78rem;
      margin-bottom: 2px;
      color: #ddd;
    }

    .baixoRowContainer {
      margin-bottom: 4px;
    }
    .baixoLabel {
      font-size: 0.75rem;
      opacity: 0.85;
      margin-bottom: 1px;
    }

    .drumRow {
      display: flex;
      align-items: center;
      margin: 1px 0;
    }
    .drumLabel {
      width: 90px;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .composicaoGrid {
      display: flex;
      flex-wrap: nowrap;
      /* sem overflow-x aqui: quem rola √© o sequencerInner */
      border-radius: 6px;
      background: #101010;
      box-shadow: 0 0 0 1px #222 inset;
      padding: 2px;
    }

    .cell {
      min-width: 24px;
      height: 22px;
      border-radius: 4px;
      margin: 1px;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #181818;
      color: #888;
      cursor: pointer;
      user-select: none;
      transition: background 0.1s, transform 0.06s, color 0.1s;
    }
    .cell.active {
      background: #0077ff;
      color: #fff;
      box-shadow: 0 0 0 1px #0050b3 inset;
    }
    .cell:hover {
      transform: translateY(-1px);
      background: #222;
      color: #fff;
    }

    /* Overlay de sele√ß√£o de nota / pe√ßa */
    #selectionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 6000;
    }
    #selectionOverlay.visible {
      display: flex;
    }
    #selectionPanel {
      background: #181818;
      border-radius: 10px;
      box-shadow: 0 0 0 1px #333 inset;
      padding: 10px 12px;
      max-width: 480px;
      width: 90vw;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #selectionTitle {
      font-size: 0.9rem;
      font-weight: 600;
    }
    #selectionOptions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .selection-option {
      padding: 4px 8px;
      border-radius: 6px;
      background: #222;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .selection-option.active {
      background: #0077ff;
    }
    .selection-option.x-option {
      background: #333;
      color: #ffb3b3;
    }

    @media (max-width: 900px) {
      #animacaoInner {
        width: min(420px, 90vw);
      }
      .cell {
        min-width: 22px;
        height: 20px;
      }
      .drumLabel {
        width: 70px;
      }
    }
  </style>
</head>
<body>
  <!-- Overlay para orientar a usar paisagem -->
  <div id="orientationOverlay">
    <div>
      <h2>Gire o aparelho</h2>
      <p>Use o modo paisagem (horizontal) para ver a baixista e o painel de edi√ß√£o.</p>
    </div>
  </div>

  <!-- Overlay de contagem regressiva -->
  <div id="countdownOverlay">
    <span id="countdownNumber">3</span>
  </div>

  <div class="appRoot">
    <!-- TOPO: ANIMA√á√ÉO -->
    <section id="animacaoArea">
      <div id="animacaoInner">
        <!-- Pernas est√°ticas -->
        <img id="pernasLayer" class="grupoBalan√ßo" src="animacao/pernas/Pernas.png" alt="Pernas" />
        <!-- Tronco + baixo (m√£o esquerda) -->
        <img id="troncoLayer" class="grupoBalan√ßo" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="Tronco e baixo" />
        <!-- Cabe√ßa -->
        <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" alt="Cabe√ßa" />
        <!-- Bra√ßo direito (ombro/b√≠ceps ‚Äì 4 cordas) -->
        <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" alt="Antebra√ßo/ombro" />
        <!-- M√£o direita / antebra√ßo (5 frames por corda) -->
        <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" alt="Bra√ßo direito" />
      </div>

      <!-- Painel de ajuste de posi√ß√£o -->
      <div id="posEditor">
        <label>
          <input type="checkbox" id="posEditorToggle">
          <span>Modo ajuste</span>
        </label>
        <div id="posEditorControls">
          <select id="posEditorLayer"></select>
          <div id="posEditorButtons">
            <div></div>
            <button id="posUp">‚ñ≤</button>
            <div></div>
            <button id="posLeft">‚óÄ</button>
            <button id="posDown">‚ñº</button>
            <button id="posRight">‚ñ∂</button>
          </div>
          <textarea id="posEditorCss" readonly></textarea>
        </div>
      </div>
    </section>

    <!-- BASE: CONTROLES + COMPOSI√á√ÉO -->
    <section id="painel">
      <div id="topControls">
        <div id="topControls-left">
          <strong>JamOn ‚Äì Baixista Animada (Animacao6)</strong>
          <span id="descricaoModo">Baixista toca composi√ß√£o manual e playback aleat√≥rio (baixo + bateria)</span>
        </div>
        <div id="topControls-right">
          <div class="sliderGroup">
            <label for="bpmSlider">BPM:</label>
            <input id="bpmSlider" type="range" min="60" max="180" value="110">
            <span id="bpmDisplay">110 BPM</span>
          </div>
          <div class="sliderGroup">
            <label for="baixoVolume">Baixo:</label>
            <input id="baixoVolume" type="range" min="0" max="1" step="0.01" value="0.9">
          </div>
          <div class="sliderGroup">
            <label for="drumVolume">Bateria:</label>
            <input id="drumVolume" type="range" min="0" max="1" step="0.01" value="0.8">
          </div>

          <button id="playComposicaoBtn" class="btn secondary">‚ñ∂ Tocar composi√ß√£o manual</button>
          <button id="playAleatorioBtn" class="btn secondary">üîÄ Playback aleat√≥rio (baixo+bateria)</button>
          <button id="playBtn" class="btn">‚ñ∂ Play / Pause</button>
          <button id="stopBtn" class="btn secondary">‚èπ Parar</button>
        </div>
      </div>

      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>

      <section id="composicaoSection">
        <div id="sequencerCard">
          <div id="sequencerHeader">
            <div id="sequencerHeaderLeft">
              <span>Baixo (clique para editar notas ‚Äì X = ghost / sil√™ncio)</span>
            </div>
            <div id="sequencerHeaderRight">
              <button id="addCol" class="btn secondary">+ Coluna</button>
              <button id="duplicateSeq" class="btn secondary">√ó2 Duplicar √∫ltimas 16</button>
              <button id="clearBaixo" class="btn secondary">Limpar Baixo</button>
              <button id="clearAll" class="btn danger">Limpar Tudo</button>
            </div>
          </div>
          <div id="sequencerInner">
            <!-- Baixo -->
            <div class="baixoRowContainer">
              <div class="baixoLabel">Baixo</div>
              <div id="baixoGrid" class="composicaoGrid"></div>
            </div>
            <!-- Bateria -->
            <div class="gridTitulo">Bateria (clique para ativar/desativar pe√ßas)</div>
            <div id="drumGrid"></div>
          </div>
        </div>
      </section>
    </section>
  </div>

  <!-- Painel de sele√ß√£o (nota / pe√ßa de bateria) -->
  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div id="selectionTitle">Selecione</div>
      <div id="selectionOptions"></div>
      <div style="text-align:right;margin-top:6px;">
        <button class="btn secondary" onclick="fecharPainelSelecao()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    /* ======================================================
       CONFIG - para desativar o editor depois, troque para false
       ====================================================== */
    const ENABLE_POSITION_EDITOR = true;

    /* ===========================================
       CONSTANTES / ESTADO GLOBAL
       =========================================== */
    const BASS_SAMPLES = {
      '1E': 'assets/BaixoMelodia/1E.mp3',
      '2F': 'assets/BaixoMelodia/2F.mp3',
      '3FS': 'assets/BaixoMelodia/3FS.mp3',
      '4G': 'assets/BaixoMelodia/4G.mp3',
      '5GS': 'assets/BaixoMelodia/5GS.mp3',
      '6A': 'assets/BaixoMelodia/6A.mp3',
      '7AS': 'assets/BaixoMelodia/7AS.mp3',
      '8B': 'assets/BaixoMelodia/8B.mp3',
      '9C': 'assets/BaixoMelodia/9C.mp3',
      '10CS': 'assets/BaixoMelodia/10CS.mp3',
      '11D': 'assets/BaixoMelodia/11D.mp3',
      '12DS': 'assets/BaixoMelodia/12DS.mp3',
      '13E': 'assets/BaixoMelodia/13E.mp3',
      '14F': 'assets/BaixoMelodia/14F.mp3',
      '15FS': 'assets/BaixoMelodia/15FS.mp3',
      '16G': 'assets/BaixoMelodia/16G.mp3',
      '17GS': 'assets/BaixoMelodia/17GS.mp3',
      '18A': 'assets/BaixoMelodia/18A.mp3',
      '19AS': 'assets/BaixoMelodia/19AS.mp3',
      '20B': 'assets/BaixoMelodia/20B.mp3',
      '21C': 'assets/BaixoMelodia/21C.mp3',
      '22CS': 'assets/BaixoMelodia/22CS.mp3',
      '23D': 'assets/BaixoMelodia/23D.mp3',
      '24DS': 'assets/BaixoMelodia/24DS.mp3',
      '25E': 'assets/BaixoMelodia/25E.mp3',
      '26F': 'assets/BaixoMelodia/26F.mp3',
      '27FS': 'assets/BaixoMelodia/27FS.mp3',
      '28G': 'assets/BaixoMelodia/28G.mp3',
      '29GS': 'assets/BaixoMelodia/29GS.mp3',
      '30A': 'assets/BaixoMelodia/30A.mp3',
      '31AS': 'assets/BaixoMelodia/31AS.mp3',
      '32B': 'assets/BaixoMelodia/32B.mp3',
      '33C': 'assets/BaixoMelodia/33C.mp3',
      '34CS': 'assets/BaixoMelodia/34CS.mp3',
      '35D': 'assets/BaixoMelodia/35D.mp3',
      '36DS': 'assets/BaixoMelodia/36DS.mp3',
      '37E': 'assets/BaixoMelodia/37E.mp3',
      '38F': 'assets/BaixoMelodia/38F.mp3',
      '39FS': 'assets/BaixoMelodia/39FS.mp3',
      '40G': 'assets/BaixoMelodia/40G.mp3',
      '41GS': 'assets/BaixoMelodia/41GS.mp3',
      '42A': 'assets/BaixoMelodia/42A.mp3',
      '43AS': 'assets/BaixoMelodia/43AS.mp3',
      'x': 'assets/bass-muted.mp3'
    };

    /*  Todas as pe√ßas pedidas.
        Ajuste os caminhos "file" conforme os nomes reais dos seus √°udios. */
    const drumLines = [
      { id: "bumbo",       label: "Bumbo",        file: "Bateria/bumbo.mp3" },
      { id: "caixa",       label: "Caixa",        file: "Bateria/caixa.mp3" },
      { id: "chimbalF",    label: "Chimbal F.",   file: "Bateria/chimbal_fechado.mp3" },
      { id: "chimbalA",    label: "Chimbal A.",   file: "Bateria/chimbal_aberto.mp3" },
      { id: "ataque",      label: "Ataque",       file: "Bateria/ataque.mp3" },
      { id: "tom1",        label: "Tom 1",        file: "Bateria/tom1.mp3" },
      { id: "tom2",        label: "Tom 2",        file: "Bateria/tom2.mp3" },
      { id: "surdo",       label: "Surdo",        file: "Bateria/surdo.mp3" },
      { id: "conducaoC",   label: "Cond. centro", file: "Bateria/conducao_centro.mp3" },
      { id: "conducaoE",   label: "Cond. ext.",   file: "Bateria/conducao_extremo.mp3" }
    ];

    const notasValidas = [
      "1E","2F","3FS","4G","5GS",
      "6A","7AS","8B","9C","10CS",
      "11D","12DS","13E","14F","15FS",
      "16G","17GS","18A","19AS","20B",
      "21C","22CS","23D","24DS","25E","26F",
      "27FS","28G","29GS","30A","31AS","32B",
      "33C","34CS","35D","36DS","37E","38F","39FS",
      "40G","41GS","42A","43AS"
    ];

    let baixoSeq = [];
    let bateriaSeq = {};

    let bpmAtual = 110;
    let isPlaying = false;
    let playbackInterval = null;
    let atualPasso = 0;

    let baixoVolumeGlobal = 0.9;
    let bateriaVolumeGlobal = 0.8;

    let audioBaixoAtual = null;
    let audioBaixoTimer = null;

    let headFrames = [];
    let headFrameIndex = 0;
    let headInterval = null;
    let headTiltInterval = null;
    let troncoBpmInterval = null;
    let lateralInterval = null;

    let ultimaCordaUsada = "E";

    /* ===========================================
       FUN√á√ïES DE AJUDA
       =========================================== */

    function generateHeadFramePaths() {
      const arr = [];
      for (let i = 1; i <= 100; i++) {
        const num = i.toString().padStart(4, "0");
        arr.push(`animacao/cabeca/cabeca${num}.png`);
      }
      return arr;
    }

    function preloadImages(urls) {
      return Promise.all(urls.map(url => {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(url);
          img.onerror = () => {
            console.warn("Falha ao carregar:", url);
            resolve(url);
          };
          img.src = url;
        });
      }));
    }

    /* Anima√ß√£o da cabe√ßa ‚Äì la√ßo longo */
    function startHeadLoop() {
      const cabeca = document.getElementById("cabecaLayer");
      if (headInterval) clearInterval(headInterval);
      headInterval = setInterval(() => {
        headFrameIndex = (headFrameIndex + 1) % headFrames.length;
        cabeca.src = headFrames[headFrameIndex];
      }, 80);
    }

    function startHeadTiltBpm(bpm) {
      const cabeca = document.getElementById("cabecaLayer");
      if (headTiltInterval) clearInterval(headTiltInterval);
      const msBeat = 60000 / bpm;
      let toggle = false;
      headTiltInterval = setInterval(() => {
        toggle = !toggle;
        const deg = toggle ? -6 : 6;
        cabeca.style.transform = `translateX(-50%) rotate(${deg}deg)`;
      }, msBeat * 4);
    }

    function startTroncoBpm(bpm) {
      const tronco = document.getElementById("troncoLayer");
      if (troncoBpmInterval) clearInterval(troncoBpmInterval);
      const msBeat = 60000 / bpm;
      let toggle = false;
      troncoBpmInterval = setInterval(() => {
        toggle = !toggle;
        const scale = toggle ? 1.01 : 1;
        tronco.style.transform = `translateX(-50%) scale(${scale})`;
      }, msBeat * 4);
    }

    function startLateralMovement() {
      const inner = document.getElementById("animacaoInner");
      if (lateralInterval) clearInterval(lateralInterval);
      let dir = 1;
      let pos = 0;
      lateralInterval = setInterval(() => {
        pos += dir * 0.15;
        if (pos > 1.2) dir = -1;
        if (pos < -1.2) dir = 1;
        inner.style.transform = `translateX(${pos}%)`;
      }, 40);
    }

    function resetAnimTimers() {
      if (headInterval) clearInterval(headInterval);
      if (headTiltInterval) clearInterval(headTiltInterval);
      if (troncoBpmInterval) clearInterval(troncoBpmInterval);
      if (lateralInterval) clearInterval(lateralInterval);
    }

    /* ===========================================
       TRONCO / M√ÉO ESQUERDA ‚Äì TRANSI√á√ïES
       =========================================== */

    const transicoesPasta = {
      "1F": ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"],
      "2FS": ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"],
      "3G": ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"],
      "4GS": ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"],
      "5A": ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"],
      "6AS": ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"],
      "7B": ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"],
      "8C": ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"],
      "9CS": ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"],
      "10D": ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"],
      "11DS": ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"],
      "12E": ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31B"],
      "13F": ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"],
      "14FS": ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"],
      "15G": ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"],
      "16GS": ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"],
      "17A": ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"],
      "18AS": ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"],
      "19B": ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"],
      "20C": ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"],
      "21CS": ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"],
      "22D": ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"],
      "23DS": ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"],
      "24E": ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"]
    };

    function escolherPastaTransicao(notaAnterior, notaAtual) {
      if (!notaAnterior) return "1F";

      const idxAnt = notasValidas.indexOf(notaAnterior);
      const idxAtual = notasValidas.indexOf(notaAtual);
      if (idxAnt === -1 || idxAtual === -1) return "1F";

      if (idxAtual < idxAnt - 1) return "1F";

      // aqui voc√™ pode refinar a l√≥gica se quiser usar o mapa transicoesPasta
      return "1F";
    }

    function trocarFrameTronco(nota) {
      const tronco = document.getElementById("troncoLayer");

      const notaAnterior = tronco.dataset.notaAtual || "1E";
      const pasta = escolherPastaTransicao(notaAnterior, nota);

      tronco.dataset.notaAtual = nota;

      const src = `animacao/tronco_baixo/Pasta_${pasta}/${nota}.png`;
      tronco.src = src;
    }

    /* ===========================================
       CORDA / BRA√áO DIREITO / ANTEBRA√áO
       =========================================== */

    function getCordaDaNota(nota) {
      if (!nota || nota === "x") return "E";

      const numMatch = nota.match(/^(\d+)/);
      if (!numMatch) return "E";

      const n = parseInt(numMatch[1], 10);
      if (isNaN(n)) return "E";

      if (n <= 5) return "E";
      if (n <= 10) return "A";
      if (n <= 15) return "D";
      return "G";
    }

    function trocarAntebraco(corda) {
      const ante = document.getElementById("antebracoLayer");
      let nome = "antebracoE";
      if (corda === "A") nome = "antebracoA";
      else if (corda === "D") nome = "antebracoD";
      else if (corda === "G") nome = "antebracoG";
      ante.src = `animacao/antebraco/${nome}.png`;
    }

    function animarBracoDireito(corda, duracaoMs) {
      const braco = document.getElementById("bracoDireitoLayer");
      const totalFrames = 5;
      const frameDuration = Math.max(30, duracaoMs / totalFrames);

      let frame = 1;
      let contador = 0;

      braco.dataset.cordaAtual = corda;

      const id = setInterval(() => {
        frame++;
        if (frame > totalFrames) frame = totalFrames;
        braco.src = `animacao/braco_direito/Corda_${corda}${frame}.png`;
        contador += frameDuration;
        if (contador >= duracaoMs) {
          clearInterval(id);
          braco.src = `animacao/braco_direito/Corda_${corda}1.png`;
        }
      }, frameDuration);
    }

    /* ===========================================
       √ÅUDIO ‚Äì BAIXO E BATERIA
       =========================================== */

    function tocarNotaAudioBaixo(nota, volume) {
      // corta a nota anterior ‚Äì nova nota ou "x" encerram a anterior
      if (audioBaixoAtual) {
        audioBaixoAtual.pause();
        audioBaixoAtual = null;
      }
      if (audioBaixoTimer) {
        clearTimeout(audioBaixoTimer);
        audioBaixoTimer = null;
      }

      const arquivo = BASS_SAMPLES[nota] || BASS_SAMPLES['x'];
      const audio = new Audio(arquivo);
      audio.volume = volume;
      audioBaixoAtual = audio;

      audio.play().catch(err => {
        console.error("Erro ao tocar √°udio do baixo:", nota, err);
      });
    }

    function pararAudioBaixo() {
      if (audioBaixoAtual) {
        audioBaixoAtual.pause();
        audioBaixoAtual.currentTime = 0;
        audioBaixoAtual = null;
      }
      if (audioBaixoTimer) {
        clearTimeout(audioBaixoTimer);
        audioBaixoTimer = null;
      }
    }

    function tocarBateriaNoStep(step, volume) {
      drumLines.forEach(line => {
        const seq = bateriaSeq[line.id];
        if (!seq || step >= seq.length) return;
        const val = seq[step];
        if (val === line.id) {
          const a = new Audio("assets/" + line.file);
          a.volume = volume;
          a.play().catch(e => console.log("Erro ao tocar bateria:", e));
        }
      });
    }

    /* ===========================================
       NOTA + ANIMA√á√ÉO COMPLETA
       =========================================== */

    function tocarNotaComAnimacao(nota, duracaoMs, volume) {
      tocarNotaAudioBaixo(nota, volume);

      if (nota === "x") {
        const cordaGhost = ultimaCordaUsada || "E";
        animarBracoDireito(cordaGhost, duracaoMs);
        return;
      }

      trocarFrameTronco(nota);

      const corda = getCordaDaNota(nota);
      ultimaCordaUsada = corda;

      trocarAntebraco(corda);
      animarBracoDireito(corda, duracaoMs);
    }

    /* ===========================================
       PLAYBACK EM LOOP
       =========================================== */

    function atualizarBarraProgresso(perc) {
      document.getElementById("progressBar").style.width = perc + "%";
    }

    function totalPassos() {
      const bateriasLen = drumLines.map(line =>
        bateriaSeq[line.id] ? bateriaSeq[line.id].length : 0
      );
      return Math.max(baixoSeq.length || 0, ...bateriasLen, 0);
    }

    function tocarPasso(passo) {
      const nota = (passo < baixoSeq.length) ? baixoSeq[passo] : "x";
      const stepTime = (60000 / bpmAtual) / 4;
      tocarNotaComAnimacao(nota, stepTime, baixoVolumeGlobal);
      tocarBateriaNoStep(passo, bateriaVolumeGlobal);

      const total = totalPassos();
      if (total > 0) {
        atualizarBarraProgresso((passo / total) * 100);
      }
    }

    function iniciarPlayback() {
      const total = totalPassos();
      if (total === 0) return;
      if (isPlaying) return;

      isPlaying = true;
      atualPasso = 0;
      const stepTime = (60000 / bpmAtual) / 4;
      playbackInterval = setInterval(() => {
        const totalLocal = totalPassos();
        if (totalLocal === 0) return;
        tocarPasso(atualPasso);
        atualPasso++;
        if (atualPasso >= totalLocal) atualPasso = 0;
      }, stepTime);
      document.getElementById("playBtn").innerText = "‚è∏ Pause";
    }

    function pararPlayback() {
      if (!isPlaying) return;
      isPlaying = false;
      clearInterval(playbackInterval);
      playbackInterval = null;
      pararAudioBaixo();
      document.getElementById("playBtn").innerText = "‚ñ∂ Play";
    }

    function togglePlay() {
      if (!isPlaying) iniciarPlayback();
      else pararPlayback();
    }

    function iniciarContagemRegressiva(callback) {
      const overlay = document.getElementById("countdownOverlay");
      const numero = document.getElementById("countdownNumber");

      let valor = 3;
      numero.textContent = valor.toString();
      overlay.style.display = "flex";

      const id = setInterval(async () => {
        valor--;
        if (valor <= 0) {
          clearInterval(id);
          overlay.style.display = "none";
          await callback();
        } else {
          numero.textContent = valor.toString();
        }
      }, 600);
    }

    async function preScanAnimacao() {
      const imagens = [];
      baixoSeq.forEach((nota, idx) => {
        if (nota === "x") return;
        const notaAnterior = idx > 0 ? baixoSeq[idx - 1] : null;
        const pasta = escolherPastaTransicao(notaAnterior, nota);
        imagens.push(`animacao/tronco_baixo/Pasta_${pasta}/${nota}.png`);
      });

      const cordasUsadas = new Set();
      baixoSeq.forEach(nota => {
        if (nota && nota !== "x") {
          cordasUsadas.add(getCordaDaNota(nota));
        }
      });
      ["E","A","D","G"].forEach(c => {
        if (cordasUsadas.has(c)) {
          for (let i = 1; i <= 5; i++) {
            imagens.push(`animacao/braco_direito/Corda_${c}${i}.png`);
          }
        }
      });

      await preloadImages(imagens);
      console.log("Pr√©-carregamento de imagens da anima√ß√£o conclu√≠do.");
    }

    function tocarPlaybackCompleto(bpm) {
      pararPlayback();
      resetAnimTimers();

      startTroncoBpm(bpm);
      startHeadTiltBpm(bpm);
      startLateralMovement();

      iniciarContagemRegressiva(async () => {
        try {
          await preScanAnimacao();
        } catch (e) {
          console.warn("Falha ao pr√©-carregar imagens da anima√ß√£o:", e);
        }
        iniciarPlayback();
      });
    }

    /* ===========================================
       GRID / UI ‚Äì BAIXO E BATERIA
       =========================================== */

    const selectionOverlay = document.getElementById("selectionOverlay");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionOptions = document.getElementById("selectionOptions");
    const painelSelecao = { tipo: null, seqRef: null, idx: null, cell: null, drumLine: null };

    function abrirPainelSelecaoBaixo(seqRef, idx, cellEl) {
      painelSelecao.tipo = "baixo";
      painelSelecao.seqRef = seqRef;
      painelSelecao.idx = idx;
      painelSelecao.cell = cellEl;
      const valorAtual = seqRef[idx];
      const opcoes = ["x", ...notasValidas];
      selectionTitle.textContent = "Selecione a nota do baixo";
      selectionOptions.innerHTML = "";
      opcoes.forEach(opt => {
        const div = document.createElement("div");
        div.className = "selection-option";
        let label = opt;
        if (opt === "x") {
          div.classList.add("x-option");
          label = "X";
        } else {
          label = opt.replace(/S/g,"#");
        }
        if (opt === valorAtual) div.classList.add("active");
        div.textContent = label;
        div.onclick = () => {
          painelSelecao.seqRef[painelSelecao.idx] = opt;
          const c = painelSelecao.cell;
          c.textContent = label;
          if (opt === "x") c.classList.remove("active");
          else c.classList.add("active");
          fecharPainelSelecao();
        };
        selectionOptions.appendChild(div);
      });
      selectionOverlay.classList.add("visible");
    }

    function fecharPainelSelecao() {
      selectionOverlay.classList.remove("visible");
      Object.keys(painelSelecao).forEach(k => painelSelecao[k] = null);
    }

    selectionOverlay.addEventListener("click", (ev) => {
      if (ev.target === selectionOverlay) fecharPainelSelecao();
    });

    function construirGridBaixo(container, seq) {
      container.innerHTML = "";
      seq.forEach((nota, idx) => {
        const div = document.createElement("div");
        div.className = "cell";
        if (nota === "x") {
          div.textContent = "X";
        } else {
          div.textContent = nota.replace(/S/g,"#");
          div.classList.add("active");
        }
        div.onclick = () => abrirPainelSelecaoBaixo(seq, idx, div);
        container.appendChild(div);
      });
    }

    function construirGridBateria(container, bateriaSeqObj) {
      container.innerHTML = "";
      drumLines.forEach(line => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "drumRow";
        const label = document.createElement("div");
        label.className = "drumLabel";
        label.textContent = line.label;
        rowDiv.appendChild(label);
        const rowGrid = document.createElement("div");
        rowGrid.className = "composicaoGrid";
        let seq = bateriaSeqObj[line.id];
        if (!Array.isArray(seq)) {
          seq = Array(baixoSeq.length || 16).fill("x");
          bateriaSeqObj[line.id] = seq;
        }
        seq.forEach((item, idx) => {
          const cell = document.createElement("div");
          cell.className = "cell";
          if (item === "x") {
            cell.textContent = "X";
          } else if (item === line.id) {
            cell.textContent = line.label.toUpperCase()[0];
            cell.classList.add("active");
          } else {
            cell.textContent = "?";
          }
          cell.onclick = () => {
            if (seq[idx] === "x") {
              seq[idx] = line.id;
              cell.classList.add("active");
              cell.textContent = line.label.toUpperCase()[0];
            } else {
              seq[idx] = "x";
              cell.classList.remove("active");
              cell.textContent = "X";
            }
          };
          rowGrid.appendChild(cell);
        });
        rowDiv.appendChild(rowGrid);
        container.appendChild(rowDiv);
      });
    }

    function gerarSequenciaAleatoriaBaixo(tam) {
      const seq = [];
      for (let i = 0; i < tam; i++) {
        if (Math.random() < 0.6) seq.push("x");
        else seq.push(notasValidas[Math.floor(Math.random() * notasValidas.length)]);
      }
      return seq;
    }

    function gerarSequenciasAleatoriasBateria(tam) {
      const obj = {};
      drumLines.forEach(line => {
        obj[line.id] = [];
        for (let i = 0; i < tam; i++) {
          obj[line.id].push(Math.random() < 0.75 ? "x" : line.id);
        }
      });
      return obj;
    }

    function configurarPlaybackExportado() {
      const btn = document.getElementById("playComposicaoBtn");
      btn.onclick = () => {
        tocarPlaybackCompleto(bpmAtual);
      };
    }

    function garantirPaisagem() {
      const overlay = document.getElementById("orientationOverlay");
      function checar() {
        overlay.style.display = (window.innerWidth < window.innerHeight) ? "flex" : "none";
      }
      checar();
      window.addEventListener("resize", checar);
    }

    function iniciarInterface() {
      const baixoGrid = document.getElementById("baixoGrid");
      const drumGrid = document.getElementById("drumGrid");
      const passosIniciais = 16;

      baixoSeq = gerarSequenciaAleatoriaBaixo(passosIniciais);
      bateriaSeq = gerarSequenciasAleatoriasBateria(passosIniciais);

      construirGridBaixo(baixoGrid, baixoSeq);
      construirGridBateria(drumGrid, bateriaSeq);

      document.getElementById("bpmSlider").oninput = () => {
        bpmAtual = parseInt(document.getElementById("bpmSlider").value, 10);
        document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
        startTroncoBpm(bpmAtual);
        startHeadTiltBpm(bpmAtual);
      };

      document.getElementById("baixoVolume").oninput = () => {
        baixoVolumeGlobal = parseFloat(document.getElementById("baixoVolume").value);
      };
      document.getElementById("drumVolume").oninput = () => {
        bateriaVolumeGlobal = parseFloat(document.getElementById("drumVolume").value);
      };

      document.getElementById("addCol").onclick = () => {
        baixoSeq.push("x");
        drumLines.forEach(line => {
          if (!Array.isArray(bateriaSeq[line.id])) bateriaSeq[line.id] = [];
          bateriaSeq[line.id].push("x");
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      document.getElementById("clearBaixo").onclick = () => {
        baixoSeq = baixoSeq.map(() => "x");
        construirGridBaixo(baixoGrid, baixoSeq);
      };

      document.getElementById("clearAll").onclick = () => {
        baixoSeq = baixoSeq.map(() => "x");
        drumLines.forEach(line => {
          if (Array.isArray(bateriaSeq[line.id])) {
            bateriaSeq[line.id] = bateriaSeq[line.id].map(() => "x");
          } else {
            bateriaSeq[line.id] = Array(baixoSeq.length).fill("x");
          }
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      document.getElementById("duplicateSeq").onclick = () => {
        const bloco = 16;
        if (baixoSeq.length >= bloco) {
          const ultimas = baixoSeq.slice(-bloco);
          baixoSeq = baixoSeq.concat(ultimas);
        }
        drumLines.forEach(line => {
          let arr = bateriaSeq[line.id] || [];
          if (arr.length >= bloco) {
            const ultimas = arr.slice(-bloco);
            bateriaSeq[line.id] = arr.concat(ultimas);
          } else if (arr.length === 0) {
            bateriaSeq[line.id] = Array(baixoSeq.length).fill("x");
          }
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      configurarPlaybackExportado();
    }

    /* ===========================================
       EDITOR DE POSI√á√ÉO (DEV MODE)
       =========================================== */
    function initPosEditor() {
      const panel = document.getElementById("posEditor");
      const controls = document.getElementById("posEditorControls");
      const toggle = document.getElementById("posEditorToggle");
      const select = document.getElementById("posEditorLayer");
      const cssOut = document.getElementById("posEditorCss");

      if (!ENABLE_POSITION_EDITOR) {
        panel.style.display = "none";
        return;
      }

      const layerIds = ["pernasLayer","troncoLayer","cabecaLayer","antebracoLayer","bracoDireitoLayer"];
      const posState = {};

      function labelFromId(id) {
        if (id === "pernasLayer") return "Pernas";
        if (id === "troncoLayer") return "Tronco/baixo";
        if (id === "cabecaLayer") return "Cabe√ßa";
        if (id === "antebracoLayer") return "Antebra√ßo";
        if (id === "bracoDireitoLayer") return "Bra√ßo direito";
        return id;
      }

      layerIds.forEach(id => {
        const el = document.getElementById(id);
        const cs = window.getComputedStyle(el);
        const left = parseFloat(cs.left) || 0;
        const bottom = parseFloat(cs.bottom) || 0;
        posState[id] = { left, bottom };
        el.style.left = left + "px";
        el.style.bottom = bottom + "px";

        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = labelFromId(id);
        select.appendChild(opt);
      });

      function applyPos(id) {
        const st = posState[id];
        const el = document.getElementById(id);
        el.style.left = st.left + "px";
        el.style.bottom = st.bottom + "px";
      }

      function refreshCss() {
        let out = "/* Copie para seu CSS */\n";
        layerIds.forEach(id => {
          const st = posState[id];
          out += `#${id} { left: ${st.left}px; bottom: ${st.bottom}px; }\n`;
        });
        cssOut.value = out;
      }

      function move(dx, dy) {
        if (!toggle.checked) return;
        const id = select.value;
        const st = posState[id];
        st.left += dx;
        st.bottom += dy;
        applyPos(id);
        refreshCss();
      }

      document.getElementById("posUp").onclick    = () => move(0,  -1);
      document.getElementById("posDown").onclick  = () => move(0,   1);
      document.getElementById("posLeft").onclick  = () => move(-1,  0);
      document.getElementById("posRight").onclick = () => move(1,   0);

      toggle.addEventListener("change", () => {
        controls.style.display = toggle.checked ? "flex" : "none";
        if (toggle.checked) refreshCss();
      });
    }

    /* ===========================================
       ONLOAD
       =========================================== */
    window.onload = async () => {
      garantirPaisagem();
      headFrames = generateHeadFramePaths();
      await preloadImages(headFrames);
      startHeadLoop();
      startTroncoBpm(bpmAtual);
      startHeadTiltBpm(bpmAtual);
      startLateralMovement();
      iniciarInterface();
      initPosEditor();

      document.getElementById("playAleatorioBtn").onclick = () => {
        try {
          const playback = JamOnEngine.generateRandomPlayback(bpmAtual, 16);
          // baixo
          baixoSeq = playback.baixo || playback.bassSeq || [];
          // bateria do engine (pode n√£o ter todas as pe√ßas)
          const bateriasEngine = playback.bateria || playback.bateriaSeq || {};
          bateriaSeq = {};
          drumLines.forEach(line => {
            if (Array.isArray(bateriasEngine[line.id])) {
              bateriaSeq[line.id] = bateriasEngine[line.id];
            } else {
              bateriaSeq[line.id] = Array(baixoSeq.length || 16).fill("x");
            }
          });

          construirGridBaixo(document.getElementById("baixoGrid"), baixoSeq);
          construirGridBateria(document.getElementById("drumGrid"), bateriaSeq);
          tocarPlaybackCompleto(bpmAtual);
        } catch (error) {
          console.error("Erro ao gerar playback aleat√≥rio:", error);
          alert("Erro ao gerar playback aleat√≥rio. Veja o console.");
        }
      };

      document.getElementById("playBtn").onclick = togglePlay;
      document.getElementById("stopBtn").onclick = () => {
        pararPlayback();
        atualizarBarraProgresso(0);
      };
    };
  </script>
</body>
</html>
