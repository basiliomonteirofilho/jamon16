<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>JamOn ‚Äì Anima√ß√£o Baixista (Animacao5)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      padding: 8px 16px;
      background: #181818;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    header h1 {
      font-size: 16px;
      margin: 0;
    }

    header .info {
      opacity: 0.8;
      font-size: 12px;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Lado esquerdo ‚Äì anima√ß√£o */
    #leftPanel {
      flex: 0 0 45%;
      background: radial-gradient(circle at top, #333 0, #111 55%, #000 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
      border-right: 1px solid #333;
    }

    #stage {
      position: relative;
      width: 360px;
      height: 480px;
      transform-origin: center bottom;
    }

    #stage img {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      image-rendering: auto;
      max-width: none;
      pointer-events: none;
    }

    #pernasLayer {
      bottom: 0;
      z-index: 1;
    }

    #troncoLayer {
      bottom: 80px;
      z-index: 2;
    }

    #antebracoLayer {
      bottom: 140px;
      z-index: 3;
      transform-origin: top left;
    }

    #bracoLayer {
      bottom: 150px;
      z-index: 4;
      transform-origin: top left;
    }

    #headLayer {
      bottom: 250px;
      z-index: 5;
      transform-origin: center bottom;
    }

    /* Contagem regressiva */
    #countdownOverlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      font-weight: 700;
      background: rgba(0,0,0,0.6);
      z-index: 10;
    }
    #countdownOverlay.visible {
      display: flex;
    }

    /* Right panel ‚Äì controles */
    #rightPanel {
      flex: 0 0 55%;
      display: flex;
      flex-direction: column;
      padding: 10px;
      box-sizing: border-box;
      gap: 8px;
    }

    .section {
      background: #181818;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #333;
    }

    .section h2 {
      margin: 0 0 6px 0;
      font-size: 14px;
    }

    .flexRow {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .labelSmall {
      font-size: 12px;
      opacity: 0.9;
    }

    input[type="range"] {
      width: 160px;
    }

    button {
      background: #2b7cff;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    button.secondary {
      background: #333;
    }
    button.danger {
      background: #aa2244;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    #progressContainer {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: #2b7cff;
      transition: width 0.08s linear;
    }

    #gridsWrapper {
      display: flex;
      gap: 8px;
      height: 100%;
      min-height: 0;
    }

    #baixoGrid,
    #drumGrid {
      flex: 1;
      background: #101010;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 6px;
      overflow: auto;
    }

    #baixoGridTitle,
    #drumGridTitle {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .composicaoGrid {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 24px;
      grid-template-rows: 24px;
      gap: 2px;
      width: max-content;
    }

    .cell {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 1px solid #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 11px;
      cursor: pointer;
      user-select: none;
      background: #181818;
      color: #aaa;
    }
    .cell.active {
      background: #2b7cff;
      color: #fff;
      border-color: #2b7cff;
    }
    .cell.xCell {
      color: #555;
    }

    .drumRow {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;
    }

    .drumLabel {
      width: 56px;
      font-size: 11px;
      text-align: right;
      opacity: 0.8;
    }

    /* Painel sele√ß√£o nota */
    #selectionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    #selectionOverlay.visible {
      display: flex;
    }
    #selectionPanel {
      background: #181818;
      border-radius: 8px;
      border: 1px solid #444;
      padding: 10px;
      max-width: 520px;
      max-height: 80vh;
      overflow: auto;
    }
    #selectionTitle {
      font-size: 13px;
      margin-bottom: 8px;
    }
    #selectionOptions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .selection-option {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #333;
      font-size: 11px;
      cursor: pointer;
      background: #101010;
    }
    .selection-option.active {
      background: #2b7cff;
      border-color: #2b7cff;
      color: #fff;
    }
    .selection-option.x-option {
      background: #222;
      color: #999;
    }

    /* Aviso orienta√ß√£o */
    #orientationOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
    }
    #orientationOverlay.visible {
      display: flex;
    }

    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      #leftPanel, #rightPanel {
        flex: 1 1 auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>JamOn ‚Äì Baixista Animada (Animacao5)</h1>
    <div class="info">Baixista toca composi√ß√£o manual e playback aleat√≥rio (baixo + bateria)</div>
  </header>

  <main>
    <div id="leftPanel">
      <div id="stage">
        <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />
        <img id="troncoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="Tronco" />
        <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" alt="Antebra√ßo" />
        <img id="bracoLayer" src="animacao/braco_direito/Corda_E1.png" alt="Bra√ßo direito" />
        <img id="headLayer" src="animacao/cabeca/cabeca0001.png" alt="Cabe√ßa" />
        <div id="countdownOverlay"></div>
      </div>
    </div>

    <div id="rightPanel">
      <div class="section">
        <div class="flexRow">
          <div class="labelSmall">BPM:</div>
          <input id="bpmSlider" type="range" min="40" max="220" value="110" />
          <span id="bpmDisplay" class="labelSmall">110 BPM</span>

          <div class="labelSmall">Baixo:</div>
          <input id="baixoVolume" type="range" min="0" max="1" step="0.01" value="0.9" />

          <div class="labelSmall">Bateria:</div>
          <input id="drumVolume" type="range" min="0" max="1" step="0.01" value="0.7" />
        </div>

        <div class="flexRow" style="margin-top:6px;">
          <button id="playManualBtn">‚ñ∂ Tocar composi√ß√£o manual</button>
          <button id="playAleatorioBtn" class="secondary">üé≤ Playback aleat√≥rio (baixo+bateria)</button>
          <button id="playBtn" class="secondary">‚ñ∂ Play / Pause</button>
          <button id="pauseBtn" class="secondary">‚è∏ Parar</button>
        </div>

        <div class="flexRow" style="margin-top:6px;">
          <button id="addCol" class="secondary">+ Coluna</button>
          <button id="duplicateSeq" class="secondary">√ó2 Duplicar √∫ltimas 16</button>
          <button id="clearBaixo" class="secondary">Limpar Baixo</button>
          <button id="clearAll" class="danger">Limpar Tudo</button>
        </div>

        <div id="progressContainer">
          <div id="progressBar"></div>
        </div>
      </div>

      <div id="gridsWrapper">
        <div id="baixoGrid">
          <div id="baixoGridTitle">Baixo (clique para editar notas ‚Äì X = ghost / sil√™ncio)</div>
        </div>
        <div id="drumGrid">
          <div id="drumGridTitle">Bateria (clique para ativar/desativar pe√ßas)</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Painel de sele√ß√£o de nota -->
  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div id="selectionTitle">Selecione a nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <!-- Overlay orienta√ß√£o -->
  <div id="orientationOverlay">
    <div>
      <h2>Gire o dispositivo</h2>
      <p>Para uma experi√™ncia melhor, use o aparelho na horizontal (paisagem).</p>
    </div>
  </div>

  <!-- Engine de playback (apenas baixo+bateria) -->
  <script src="jamon-engine.js"></script>

  <script>
    /* ===== ESTADO GLOBAL ===== */
    let bpmAtual = 110;
    let baixoSeq = [];
    let bateriaSeq = {};
    let isPlaying = false;
    let playbackInterval = null;
    let atualPasso = 0;

    let baixoVolumeGlobal = 0.9;
    let bateriaVolumeGlobal = 0.7;

    let audioBaixoAtual = null;
    let audioBaixoTimer = null;
    let ultimaCordaUsada = "E";
    let notaAnterior = null;

    let headFrames = [];
    let headFrameIndex = 0;
    let headLoopTimer = null;
    let headTiltTimer = null;
    let troncoBpmTimer = null;
    let lateralTimer = null;
    let countdownTimer = null;

    let animTimers = [];

    /* ===== ELEMENTOS DOM ===== */
    const headLayer = document.getElementById("headLayer");
    const troncoLayer = document.getElementById("troncoLayer");
    const antebracoLayer = document.getElementById("antebracoLayer");
    const bracoLayer = document.getElementById("bracoLayer");
    const pernasLayer = document.getElementById("pernasLayer");

    /* ===== NOTAS V√ÅLIDAS (BAIXO) ===== */
    const notasValidas = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C",
      "10CS","11D","12DS","13E","14F","15FS","16G","17GS",
      "18A","19AS","20B","21C","22CS","23D","24DS","25E",
      "26F","27FS","28G","29GS","30A","31AS","32B","33C",
      "34CS","35D","36DS","37E","38F","39FS","40G","41GS",
      "42A","43AS"
    ];

    /* ===== MAPEAMENTO PASTAS -> ARQUIVOS =====
       (copiado da sua l√≥gica: Pasta_1F ... Pasta_24E)
    */
    const pastaNotas = {
      "Pasta_1F": [
        "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C",
        "10CS","11D","12DS","13E","14F","15FS","16G","17GS",
        "18A","19AS","20B"
      ],
      "Pasta_2FS": [
        "3FS","4G","5GS","6A","8B","9C","10CS","11D",
        "13E","14F","15FS","16G","18A","19AS","20B","21C"
      ],
      "Pasta_3G": [
        "4G","5GS","6A","7AS","9C","10CS","11D","12DS",
        "14F","15FS","16G","17GS","19AS","20B","21C","22CS"
      ],
      "Pasta_4GS": [
        "5GS","6A","7AS","8B","10CS","11D","12DS","13E",
        "15FS","16G","17GS","18A","20B","21C","22CS","23D"
      ],
      "Pasta_5A": [
        "6A","7AS","8B","9C","11D","12DS","13E","14F",
        "16G","17GS","18A","19AS","21C","22CS","23D","24DS"
      ],
      "Pasta_6AS": [
        "7AS","8B","9C","10CS","12DS","13E","14F","15FS",
        "17GS","18A","19AS","20B","22CS","23D","24DS","25E"
      ],
      "Pasta_7B": [
        "8B","9C","10CS","11D","13E","14F","15FS","16G",
        "18A","19AS","20B","21C","23D","24DS","25E","26F"
      ],
      "Pasta_8C": [
        "9C","10CS","11D","12DS","14F","15FS","16G","17GS",
        "19AS","20B","21C","22CS","24DS","25E","26F","27FS"
      ],
      "Pasta_9CS": [
        "10CS","11D","12DS","13E","15FS","16G","17GS","18A",
        "20B","21C","22CS","23D","25E","26F","27FS","28G"
      ],
      "Pasta_10D": [
        "11D","12DS","13E","14F","16G","17GS","18A","19AS",
        "21C","22CS","23D","24DS","26F","27FS","28G","29GS"
      ],
      "Pasta_11DS": [
        "12DS","13E","14F","15FS","17GS","18A","19AS","20B",
        "22CS","23D","24DS","25E","27FS","28G","29GS","30A"
      ],
      "Pasta_12E": [
        "13E","14F","15FS","16G","18A","19AS","20B","21C",
        "23D","24DS","25E","26F","28G","29GS","30A","31B"
      ],
      "Pasta_13F": [
        "14F","15FS","16G","17GS","19AS","20B","21C","22CS",
        "24DS","25E","26F","27FS","29GS","30A","31AS","32B"
      ],
      "Pasta_14FS": [
        "15FS","16G","17GS","18A","20B","21C","22CS","23D",
        "25E","26F","27FS","28G","30A","31AS","32B","33C"
      ],
      "Pasta_15G": [
        "16G","17GS","18A","19AS","21C","22CS","23D","24DS",
        "26F","27FS","28G","29GS","31AS","32B","33C","34CS"
      ],
      "Pasta_16GS": [
        "17GS","18A","19AS","20B","22CS","23D","24DS","25E",
        "27FS","28G","29GS","30A","32B","33C","34CS","35D"
      ],
      "Pasta_17A": [
        "18A","19AS","20B","21C","23D","24DS","25E","26F",
        "28G","29GS","30A","31AS","33C","34CS","35D","36DS"
      ],
      "Pasta_18AS": [
        "19AS","20B","21C","22CS","24DS","25E","26F","27FS",
        "29GS","30A","31AS","32B","34CS","35D","36DS","37E"
      ],
      "Pasta_19B": [
        "20B","21C","22CS","23D","25E","26F","27FS","28G",
        "30A","31AS","32B","33C","35D","36DS","37E","38F"
      ],
      "Pasta_20C": [
        "21C","22CS","23D","24DS","26F","27FS","28G","29GS",
        "31AS","32B","33C","34CS","36DS","37E","38F","39FS"
      ],
      "Pasta_21CS": [
        "22CS","23D","24DS","25E","27FS","28G","29GS","30A",
        "32B","33C","34CS","35D","37E","38F","39FS","40G"
      ],
      "Pasta_22D": [
        "23D","24DS","25E","26F","28G","29GS","30A","31AS",
        "33C","34CS","35D","36DS","38F","39FS","40G","41GS"
      ],
      "Pasta_23DS": [
        "24DS","25E","26F","27FS","29GS","30A","31AS","32B",
        "34CS","35D","36DS","37E","39FS","40G","41GS","42A"
      ],
      "Pasta_24E": [
        "25E","26F","27FS","28G","30A","31AS","32B","33C",
        "35D","36DS","37E","38F","40G","41GS","42A","43AS"
      ]
    };

    const pastasOrdenadas = Object.keys(pastaNotas);

    /* ===== BASS SAMPLES ===== */
    const BASS_SAMPLES = {
      1: "assets/BaixoMelodia/1E.mp3",
      2: "assets/BaixoMelodia/2F.mp3",
      3: "assets/BaixoMelodia/3FS.mp3",
      4: "assets/BaixoMelodia/4G.mp3",
      5: "assets/BaixoMelodia/5GS.mp3",
      6: "assets/BaixoMelodia/6A.mp3",
      7: "assets/BaixoMelodia/7AS.mp3",
      8: "assets/BaixoMelodia/8B.mp3",
      9: "assets/BaixoMelodia/9C.mp3",
      10: "assets/BaixoMelodia/10CS.mp3",
      11: "assets/BaixoMelodia/11D.mp3",
      12: "assets/BaixoMelodia/12DS.mp3",
      13: "assets/BaixoMelodia/13E.mp3",
      14: "assets/BaixoMelodia/14F.mp3",
      15: "assets/BaixoMelodia/15FS.mp3",
      16: "assets/BaixoMelodia/16G.mp3",
      17: "assets/BaixoMelodia/17GS.mp3",
      18: "assets/BaixoMelodia/18A.mp3",
      19: "assets/BaixoMelodia/19AS.mp3",
      20: "assets/BaixoMelodia/20B.mp3",
      21: "assets/BaixoMelodia/21C.mp3",
      22: "assets/BaixoMelodia/22CS.mp3",
      23: "assets/BaixoMelodia/23D.mp3",
      24: "assets/BaixoMelodia/24DS.mp3",
      25: "assets/BaixoMelodia/25E.mp3",
      26: "assets/BaixoMelodia/26F.mp3",
      27: "assets/BaixoMelodia/27FS.mp3",
      28: "assets/BaixoMelodia/28G.mp3",
      29: "assets/BaixoMelodia/29GS.mp3",
      30: "assets/BaixoMelodia/30A.mp3",
      31: "assets/BaixoMelodia/31AS.mp3",
      32: "assets/BaixoMelodia/32B.mp3",
      33: "assets/BaixoMelodia/33C.mp3",
      34: "assets/BaixoMelodia/34CS.mp3",
      35: "assets/BaixoMelodia/35D.mp3",
      36: "assets/BaixoMelodia/36DS.mp3",
      37: "assets/BaixoMelodia/37E.mp3",
      38: "assets/BaixoMelodia/38F.mp3",
      39: "assets/BaixoMelodia/39FS.mp3",
      40: "assets/BaixoMelodia/40G.mp3",
      41: "assets/BaixoMelodia/41GS.mp3",
      42: "assets/BaixoMelodia/42A.mp3",
      43: "assets/BaixoMelodia/43AS.mp3",
      x: "assets/bass-muted.mp3"   // ghost-note
    };

    /* ===== BATERIA ‚Äì LINHAS ===== */
    const drumLines = [
      { id: "bumbo",   label: "Bumbo",    file: "bumbo.mp3" },
      { id: "caixa",   label: "Caixa",    file: "caixa.mp3" },
      { id: "chimbal", label: "Chimbal",  file: "chimbal.mp3" },
      { id: "conducao", label: "Condu√ß√£o", file: "conducao.mp3" },
      { id: "ataque",  label: "Ataque",   file: "ataque.mp3" }
    ];

    /* ===== FUN√á√ïES GERAIS ===== */
    function garantirPaisagem() {
      const overlay = document.getElementById("orientationOverlay");
      function checar() {
        if (window.innerWidth < window.innerHeight) {
          overlay.classList.add("visible");
        } else {
          overlay.classList.remove("visible");
        }
      }
      checar();
      window.addEventListener("resize", checar);
    }

    function generateHeadFramePaths() {
      const arr = [];
      // voc√™ tem 809 frames, mas podemos usar uma faixa menor para loop suave
      const TOTAL = 100;
      for (let i = 1; i <= TOTAL; i++) {
        const num = i.toString().padStart(4, "0");
        arr.push("animacao/cabeca/cabeca" + num + ".png");
      }
      return arr;
    }

    async function preloadImages(urls) {
      const uniq = Array.from(new Set(urls));
      const promises = uniq.map(url => new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => {
          console.warn("Falha ao carregar:", url);
          resolve(url); // n√£o rejeita, s√≥ segue
        };
        img.src = url;
      }));
      await Promise.all(promises);
      console.log("Pr√©-carregamento conclu√≠do.");
    }

    function startHeadLoop() {
      if (!headFrames.length) return;
      if (headLoopTimer) clearInterval(headLoopTimer);
      headLoopTimer = setInterval(() => {
        headFrameIndex = (headFrameIndex + 1) % headFrames.length;
        headLayer.src = headFrames[headFrameIndex];
      }, 80);
    }

    function startHeadTiltBpm(bpm) {
      if (headTiltTimer) clearInterval(headTiltTimer);
      const ms = (60000 / bpm) * 2;
      let dir = 1;
      headTiltTimer = setInterval(() => {
        const ang = dir * 5;
        headLayer.style.transform = `translateX(-50%) rotate(${ang}deg)`;
        dir *= -1;
      }, ms);
    }

    function startTroncoBpm(bpm) {
      if (troncoBpmTimer) clearInterval(troncoBpmTimer);
      const ms = (60000 / bpm) * 2;
      let dir = 1;
      troncoBpmTimer = setInterval(() => {
        const scale = 1 + dir * 0.02;
        troncoLayer.style.transform = `translateX(-50%) scale(${scale})`;
        dir *= -1;
      }, ms);
    }

    function startLateralMovement() {
      if (lateralTimer) clearInterval(lateralTimer);
      const stage = document.getElementById("stage");
      let t = 0;
      lateralTimer = setInterval(() => {
        t += 0.04;
        const dx = Math.sin(t) * 5;
        stage.style.transform = `translateX(${dx}px)`;
      }, 40);
    }

    function resetAnimTimers() {
      animTimers.forEach(id => clearInterval(id));
      animTimers = [];
    }

    /* ===== MAPEAMENTO NOTA -> CORDA ===== */
    function getCordaDaNota(nota) {
      if (!nota || nota === "x") return ultimaCordaUsada || "E";
      const num = parseInt(nota.match(/^(\d+)/)[1], 10);
      if (num <= 20) return "E";        // corda Mi
      if (num <= 26) return "A";        // corda L√°
      if (num <= 32) return "D";        // corda R√©
      return "G";                       // corda Sol
    }

    /* ===== ESCOLHA DE PASTA / FRAME (ECONOMIA) ===== */
    function determinarPastaPorNota(nota) {
      if (!nota || nota === "x") return "Pasta_1F";
      for (const pasta of pastasOrdenadas) {
        if (pastaNotas[pasta].includes(nota)) return pasta;
      }
      return "Pasta_1F";
    }

    function escolherPastaTransicao(notaAnt, notaAtual) {
      if (!notaAnt || !notaAtual || notaAnt === "x" || notaAtual === "x") return null;
      let melhorPasta = null;
      let menorSpan = Infinity;

      for (const pasta of pastasOrdenadas) {
        const lista = pastaNotas[pasta];
        const idx1 = lista.indexOf(notaAnt);
        const idx2 = lista.indexOf(notaAtual);
        if (idx1 === -1 || idx2 === -1) continue;
        const span = Math.abs(idx2 - idx1);
        if (span < menorSpan) {
          menorSpan = span;
          melhorPasta = pasta;
        }
      }
      return melhorPasta;
    }

    function escolherArquivoMaisProximo(pasta, nota) {
      const lista = pastaNotas[pasta];
      const alvoNum = parseInt(nota.match(/^(\d+)/)[1], 10);
      let melhor = lista[0];
      let menorDiff = Infinity;
      for (const n of lista) {
        const num = parseInt(n.match(/^(\d+)/)[1], 10);
        const diff = Math.abs(num - alvoNum);
        if (diff < menorDiff) {
          menorDiff = diff;
          melhor = n;
        }
      }
      return melhor;
    }

    function trocarFrameTronco(notaAtual) {
      if (!notaAtual || notaAtual === "x") return;

      let pastaTransicao = escolherPastaTransicao(notaAnterior, notaAtual);
      let pasta;
      if (pastaTransicao) {
        pasta = pastaTransicao;
      } else {
        pasta = determinarPastaPorNota(notaAtual);
      }
      const arquivo = escolherArquivoMaisProximo(pasta, notaAtual);
      const caminho = `animacao/tronco_baixo/${pasta}/${arquivo}.png`;

      const img = new Image();
      img.onload = () => {
        troncoLayer.src = caminho;
      };
      img.onerror = () => {
        console.warn("Falha ao carregar tronco:", caminho);
        troncoLayer.src = "animacao/tronco_baixo/Pasta_1F/1E.png";
      };
      img.src = caminho;

      notaAnterior = notaAtual;
    }

    function trocarAntebraco(corda) {
      const mapa = {
        "E": "animacao/antebraco/antebracoE.png",
        "A": "animacao/antebraco/antebracoA.png",
        "D": "animacao/antebraco/antebracoD.png",
        "G": "animacao/antebraco/antebracoG.png"
      };
      const caminho = mapa[corda] || mapa["E"];
      antebracoLayer.src = caminho;
    }

    function animarBracoDireito(corda, duracaoMs) {
      const prefix = {
        "E": "Corda_E",
        "A": "Corda_A",
        "D": "Corda_D",
        "G": "Corda_G"
      }[corda] || "Corda_E";

      const frames = [1,2,3,4,5].map(i => `animacao/braco_direito/${prefix}${i}.png`);
      const tempoPorFrame = duracaoMs / frames.length;
      let idx = 0;

      if (!frames.length) return;

      bracoLayer.src = frames[0];

      const id = setInterval(() => {
        idx++;
        if (idx >= frames.length) {
          clearInterval(id);
          // volta para frame 1 parado na corda
          bracoLayer.src = frames[0];
        } else {
          bracoLayer.src = frames[idx];
        }
      }, tempoPorFrame);

      animTimers.push(id);
    }

    /* ===== √ÅUDIO DO BAIXO ===== */
    function pararAudioBaixo() {
      if (audioBaixoAtual) {
        audioBaixoAtual.pause();
        audioBaixoAtual.currentTime = 0;
        audioBaixoAtual = null;
      }
      if (audioBaixoTimer) {
        clearTimeout(audioBaixoTimer);
        audioBaixoTimer = null;
      }
    }

    function tocarNotaAudioBaixo(nota, volume) {
      pararAudioBaixo();

      let src;
      if (nota === "x") {
        src = BASS_SAMPLES["x"];
      } else {
        const num = parseInt(nota.match(/^(\d+)/)[1], 10);
        src = BASS_SAMPLES[num] || BASS_SAMPLES["x"];
      }

      console.log("Tentando tocar √°udio do baixo:", src);
      const a = new Audio(src);
      a.volume = volume;
      audioBaixoAtual = a;

      a.play().catch(err => {
        console.error("Erro ao tocar √°udio do baixo:", nota, err);
      });
    }

    /* ===== TOCAR NOTA + ANIMA√á√ÉO COMPLETA ===== */
    function tocarNotaComAnimacao(nota, duracaoMs, volume) {
      // toca √°udio sempre (inclui ghost-note)
      tocarNotaAudioBaixo(nota, volume);

      if (nota === "x") {
        const cordaGhost = ultimaCordaUsada || "E";
        animarBracoDireito(cordaGhost, duracaoMs);
        // n√£o mexe na m√£o esquerda
        return;
      }

      console.log("Tocando nota:", nota);

      trocarFrameTronco(nota);

      const corda = getCordaDaNota(nota);
      ultimaCordaUsada = corda;

      trocarAntebraco(corda);
      animarBracoDireito(corda, duracaoMs);
    }

    /* ===== BATERIA ===== */
    function tocarBateriaNoStep(step, volume) {
      drumLines.forEach(line => {
        const seq = bateriaSeq[line.id];
        if (!seq || step >= seq.length) return;
        const val = seq[step];
        if (val === line.id) {
          const a = new Audio("assets/" + line.file);
          a.volume = volume;
          a.play().catch(e => console.log("Erro bateria:", e));
        }
      });
    }

    /* ===== PLAYBACK EM LOOP ===== */
    function atualizarBarraProgresso(perc) {
      document.getElementById("progressBar").style.width = perc + "%";
    }

    function tocarPasso(passo) {
      const stepTime = (60000 / bpmAtual) / 4;
      const nota = (passo < baixoSeq.length) ? baixoSeq[passo] : "x";
      tocarNotaComAnimacao(nota, stepTime, baixoVolumeGlobal);
      tocarBateriaNoStep(passo, bateriaVolumeGlobal);

      const totalSteps = Math.max(
        baixoSeq.length || 0,
        ...drumLines.map(line => (bateriaSeq[line.id] || []).length)
      ) || 1;
      atualizarBarraProgresso((passo / totalSteps) * 100);
    }

    function iniciarPlayback() {
      if (isPlaying) return;
      isPlaying = true;
      atualPasso = 0;
      const stepTime = (60000 / bpmAtual) / 4;

      playbackInterval = setInterval(() => {
        tocarPasso(atualPasso);
        atualPasso++;
        const totalSteps = Math.max(
          baixoSeq.length || 0,
          ...drumLines.map(line => (bateriaSeq[line.id] || []).length)
        ) || 1;
        if (atualPasso >= totalSteps) atualPasso = 0;
      }, stepTime);

      document.getElementById("playBtn").innerText = "‚è∏ Pause";
    }

    function pararPlayback() {
      if (!isPlaying) return;
      isPlaying = false;
      clearInterval(playbackInterval);
      playbackInterval = null;
      pararAudioBaixo();
      atualizarBarraProgresso(0);
      document.getElementById("playBtn").innerText = "‚ñ∂ Play / Pause";
    }

    function togglePlay() {
      if (isPlaying) pararPlayback();
      else iniciarPlayback();
    }

    /* ===== CONTAGEM REGRESSIVA + PR√â-SCAN ===== */
    function iniciarContagemRegressiva(callback) {
      const overlay = document.getElementById("countdownOverlay");
      let count = 4; // 4,3,2,1,VAI

      overlay.classList.add("visible");

      const update = () => {
        if (count > 1) {
          overlay.textContent = (count - 1).toString();
          count--;
        } else if (count === 1) {
          overlay.textContent = "VAI!";
          count--;
        } else {
          clearInterval(countdownTimer);
          overlay.classList.remove("visible");
          if (callback) callback();
        }
      };

      update();
      countdownTimer = setInterval(update, 1000);
    }

    async function preScanAnimacao() {
      const caminhos = [];
      const notas = baixoSeq.filter(n => n && n !== "x");
      if (!notas.length) return;

      notas.forEach(nota => {
        const pasta = determinarPastaPorNota(nota);
        const arquivo = escolherArquivoMaisProximo(pasta, nota);
        caminhos.push(`animacao/tronco_baixo/${pasta}/${arquivo}.png`);

        const corda = getCordaDaNota(nota);
        if (corda === "E") {
          caminhos.push("animacao/antebraco/antebracoE.png");
          for (let i=1;i<=5;i++) caminhos.push(`animacao/braco_direito/Corda_E${i}.png`);
        } else if (corda === "A") {
          caminhos.push("animacao/antebraco/antebracoA.png");
          for (let i=1;i<=5;i++) caminhos.push(`animacao/braco_direito/Corda_A${i}.png`);
        } else if (corda === "D") {
          caminhos.push("animacao/antebraco/antebracoD.png");
          for (let i=1;i<=5;i++) caminhos.push(`animacao/braco_direito/Corda_D${i}.png`);
        } else if (corda === "G") {
          caminhos.push("animacao/antebraco/antebracoG.png");
          for (let i=1;i<=5;i++) caminhos.push(`animacao/braco_direito/Corda_G${i}.png`);
        }
      });

      await preloadImages(caminhos);
    }

    function tocarPlaybackCompleto() {
      pararPlayback();
      resetAnimTimers();

      startTroncoBpm(bpmAtual);
      startHeadTiltBpm(bpmAtual);
      startLateralMovement();

      iniciarContagemRegressiva(async () => {
        try {
          await preScanAnimacao();
        } catch (e) {
          console.warn("Falha no pr√©-scan:", e);
        }
        iniciarPlayback();
      });
    }

    /* ===== PAINEL DE SELE√á√ÉO DE NOTA ===== */
    const selectionOverlay = document.getElementById("selectionOverlay");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionOptions = document.getElementById("selectionOptions");
    const painelSelecao = { tipo: null, seqRef: null, idx: null, cell: null };

    function abrirPainelSelecaoBaixo(seqRef, idx, cellEl) {
      painelSelecao.tipo = "baixo";
      painelSelecao.seqRef = seqRef;
      painelSelecao.idx = idx;
      painelSelecao.cell = cellEl;

      const valorAtual = seqRef[idx];
      const opcoes = ["x", ...notasValidas];

      selectionTitle.textContent = "Selecione a nota do baixo";
      selectionOptions.innerHTML = "";

      opcoes.forEach(opt => {
        const div = document.createElement("div");
        div.className = "selection-option";
        let label = opt;
        if (opt === "x") {
          div.classList.add("x-option");
          label = "X";
        } else {
          label = opt.replace(/S/g,"#");
        }
        if (opt === valorAtual) div.classList.add("active");
        div.textContent = label;
        div.onclick = () => {
          painelSelecao.seqRef[painelSelecao.idx] = opt;
          const c = painelSelecao.cell;
          c.textContent = label;
          if (opt === "x") {
            c.classList.remove("active");
            c.classList.add("xCell");
          } else {
            c.classList.add("active");
            c.classList.remove("xCell");
          }
          fecharPainelSelecao();
        };
        selectionOptions.appendChild(div);
      });

      selectionOverlay.classList.add("visible");
    }

    function fecharPainelSelecao() {
      selectionOverlay.classList.remove("visible");
      Object.keys(painelSelecao).forEach(k => painelSelecao[k] = null);
    }

    selectionOverlay.addEventListener("click", ev => {
      if (ev.target === selectionOverlay) fecharPainelSelecao();
    });

    /* ===== GRIDS ===== */
    function construirGridBaixo(container, seq) {
      container.innerHTML = '<div id="baixoGridTitle">Baixo (clique para editar notas ‚Äì X = ghost / sil√™ncio)</div>';
      const grid = document.createElement("div");
      grid.className = "composicaoGrid";

      seq.forEach((nota, idx) => {
        const div = document.createElement("div");
        div.className = "cell";
        if (nota === "x") {
          div.textContent = "X";
          div.classList.add("xCell");
        } else {
          div.textContent = nota.replace(/S/g,"#");
          div.classList.add("active");
        }
        div.onclick = () => abrirPainelSelecaoBaixo(seq, idx, div);
        grid.appendChild(div);
      });

      container.appendChild(grid);
    }

    function construirGridBateria(container, bateriaSeqLocal) {
      container.innerHTML = '<div id="drumGridTitle">Bateria (clique para ativar/desativar pe√ßas)</div>';

      drumLines.forEach(line => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "drumRow";

        const label = document.createElement("div");
        label.className = "drumLabel";
        label.textContent = line.label;
        rowDiv.appendChild(label);

        const rowGrid = document.createElement("div");
        rowGrid.className = "composicaoGrid";

        const seq = bateriaSeqLocal[line.id] || [];
        seq.forEach((item, idx) => {
          const cell = document.createElement("div");
          cell.className = "cell";
          if (item === "x") {
            cell.textContent = "X";
            cell.classList.add("xCell");
          } else if (item === line.id) {
            cell.textContent = line.label.toUpperCase()[0];
            cell.classList.add("active");
          } else {
            cell.textContent = "?";
          }

          cell.onclick = () => {
            if (seq[idx] === "x") {
              seq[idx] = line.id;
              cell.classList.add("active");
              cell.classList.remove("xCell");
              cell.textContent = line.label.toUpperCase()[0];
            } else {
              seq[idx] = "x";
              cell.classList.remove("active");
              cell.classList.add("xCell");
              cell.textContent = "X";
            }
          };

          rowGrid.appendChild(cell);
        });

        rowDiv.appendChild(rowGrid);
        container.appendChild(rowDiv);
      });
    }

    /* ===== GERADORES ALEAT√ìRIOS SIMPLES (fallback) ===== */
    function gerarSequenciaAleatoriaBaixo(tam) {
      const seq = [];
      for (let i = 0; i < tam; i++) {
        if (Math.random() < 0.6) seq.push("x");
        else seq.push(notasValidas[Math.floor(Math.random() * notasValidas.length)]);
      }
      return seq;
    }

    function gerarSequenciasAleatoriasBateria(tam) {
      const obj = {};
      drumLines.forEach(line => {
        obj[line.id] = [];
        for (let i = 0; i < tam; i++) {
          obj[line.id].push(Math.random() < 0.75 ? "x" : line.id);
        }
      });
      return obj;
    }

    /* ===== INTEGRA√á√ÉO COM jamon-engine.js ===== */
    async function gerarPlaybackAleatorioAvancado(tamanho, bpm) {
      if (window.JamOnEngine && typeof JamOnEngine.generateRandomPlayback === "function") {
        const res = JamOnEngine.generateRandomPlayback(tamanho, bpm);
        return {
          baixo: res.bassSeq || res.baixo || [],
          bateria: res.bateriaSeq || res.bateria || {}
        };
      } else {
        // fallback ‚Äì usa geradores simples
        const baixo = gerarSequenciaAleatoriaBaixo(tamanho);
        const bateria = gerarSequenciasAleatoriasBateria(tamanho);
        return { baixo, bateria };
      }
    }

    /* ===== INICIALIZA√á√ÉO / EVENTOS ===== */
    function iniciarInterface() {
      const baixoGrid = document.getElementById("baixoGrid");
      const drumGrid = document.getElementById("drumGrid");

      const passosIniciais = 16;
      baixoSeq = gerarSequenciaAleatoriaBaixo(passosIniciais);
      bateriaSeq = gerarSequenciasAleatoriasBateria(passosIniciais);

      construirGridBaixo(baixoGrid, baixoSeq);
      construirGridBateria(drumGrid, bateriaSeq);

      document.getElementById("bpmSlider").oninput = () => {
        bpmAtual = parseInt(document.getElementById("bpmSlider").value, 10);
        document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
        startTroncoBpm(bpmAtual);
        startHeadTiltBpm(bpmAtual);
      };

      document.getElementById("baixoVolume").oninput = () => {
        baixoVolumeGlobal = parseFloat(document.getElementById("baixoVolume").value);
      };
      document.getElementById("drumVolume").oninput = () => {
        bateriaVolumeGlobal = parseFloat(document.getElementById("drumVolume").value);
      };

      document.getElementById("addCol").onclick = () => {
        baixoSeq.push("x");
        drumLines.forEach(line => {
          bateriaSeq[line.id].push("x");
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      document.getElementById("duplicateSeq").onclick = () => {
        const bloco = 16;
        if (baixoSeq.length >= bloco) {
          const ult = baixoSeq.slice(-bloco);
          baixoSeq = baixoSeq.concat(ult);
        }
        drumLines.forEach(line => {
          const arr = bateriaSeq[line.id];
          if (arr.length >= bloco) {
            const ult = arr.slice(-bloco);
            bateriaSeq[line.id] = arr.concat(ult);
          }
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      document.getElementById("clearBaixo").onclick = () => {
        baixoSeq = baixoSeq.map(() => "x");
        construirGridBaixo(baixoGrid, baixoSeq);
      };

      document.getElementById("clearAll").onclick = () => {
        baixoSeq = baixoSeq.map(() => "x");
        drumLines.forEach(line => {
          bateriaSeq[line.id] = bateriaSeq[line.id].map(() => "x");
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      // Play / Pause geral (usa sequ√™ncia atual ‚Äì manual ou aleat√≥ria)
      document.getElementById("playBtn").onclick = () => {
        togglePlay();
      };

      // Tocar composi√ß√£o manual (usa baixoSeq/bateriaSeq atuais)
      document.getElementById("playManualBtn").onclick = () => {
        tocarPlaybackCompleto();
      };

      // Parar tudo
      document.getElementById("pauseBtn").onclick = () => {
        pararPlayback();
      };

      // Playback aleat√≥rio via jamon-engine (baixo + bateria)
      document.getElementById("playAleatorioBtn").onclick = async () => {
        try {
          const { baixo, bateria } = await gerarPlaybackAleatorioAvancado(16, bpmAtual);
          baixoSeq = baixo.length ? baixo : gerarSequenciaAleatoriaBaixo(16);

          const total = baixoSeq.length || 16;
          bateriaSeq = {};
          drumLines.forEach(line => {
            const arr = bateria[line.id] || [];
            if (!arr.length) {
              bateriaSeq[line.id] = Array(total).fill("x");
            } else if (arr.length >= total) {
              bateriaSeq[line.id] = arr.slice(0, total);
            } else {
              const tmp = arr.slice();
              while (tmp.length < total) tmp.push("x");
              bateriaSeq[line.id] = tmp;
            }
          });

          construirGridBaixo(baixoGrid, baixoSeq);
          construirGridBateria(drumGrid, bateriaSeq);

          tocarPlaybackCompleto();
        } catch (error) {
          console.error("Erro ao gerar playback aleat√≥rio:", error);
          alert("Erro ao gerar playback aleat√≥rio. Veja o console.");
        }
      };
    }

    window.onload = async () => {
      garantirPaisagem();
      headFrames = generateHeadFramePaths();
      await preloadImages(headFrames);
      startHeadLoop();
      startTroncoBpm(bpmAtual);
      startHeadTiltBpm(bpmAtual);
      startLateralMovement();
      iniciarInterface();
    };
  </script>
</body>
</html>
