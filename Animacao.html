<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jam On ‚Äì Composi√ß√£o Musical com Baixista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <style>
    /* ===== RESET ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #101010;
      color: #e0e0e0;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== OVERLAY ORIENTA√á√ÉO ===== */
    #orientationOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #101010;
      display: none;
      justify-content: center;
      align-items: center;
      color: #5eead4;
      text-align: center;
      padding: 20px;
      z-index: 99999;
    }
    #orientationOverlay h2 {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    #layout {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* ===== ESQUERDA: ANIMA√á√ÉO BAIXISTA ===== */
    #animacaoArea {
      width: 40%;
      height: 100%;
      background: #151515;
      border-right: 3px solid #222;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    #animacaoContainer {
      position: relative;
      width: 420px;
      height: 360px;
      left: 20px;
      top: 10px;
      transform-origin: bottom center;
    }

    .layer {
      position: absolute;
      width: 420px;
      height: auto;
      pointer-events: none;
    }

    #pernasLayer {
      z-index: 1;
      left: 0px;
      top: 160px;
    }

    #troncoLayer {
      z-index: 2;
      left: 0px;
      top: 60px;
      transform-origin: bottom center;
    }

    #antebracoLayer {
      z-index: 3;
      left: 0px;
      top: 80px;
      transform-origin: top left;
    }

    #bracoLayer {
      z-index: 4;
      left: 0px;
      top: 60px;
      transform-origin: top left;
    }

    #cabecaLayer {
      z-index: 5;
      left: 90px;
      top: -10px;
      transform-origin: bottom center;
    }

    /* ===== DIREITA: CONTROLES ===== */
    #painel {
      width: 60%;
      height: 100%;
      overflow-y: auto;
      padding: 16px;
      background: #181818;
    }

    header {
      margin-bottom: 10px;
    }
    header h1 {
      font-size: 1.2em;
      color: #5eead4;
    }
    header .pill {
      font-size: 0.8em;
      color: #aaa;
      background: #222;
      padding: 3px 8px;
      border-radius: 999px;
      display: inline-block;
      margin-top: 4px;
    }

    .card {
      background: #222;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 14px;
      border: 1px solid #333;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .card h3 {
      color: #5eead4;
      margin-bottom: 8px;
      font-size: 1em;
    }

    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      background: #5eead4;
      color: #111;
      margin-right: 6px;
      margin-top: 4px;
    }
    button.secondary {
      background: #333;
      color: #ddd;
    }
    button:hover {
      opacity: 0.9;
    }

    .bpm-display {
      font-size: 1.2em;
      font-weight: bold;
      color: #5eead4;
      text-align: center;
      margin-bottom: 8px;
    }
    #bpmSlider {
      width: 100%;
    }

    .progressContainer {
      width: 100%;
      height: 7px;
      background: #333;
      border-radius: 4px;
      margin-top: 10px;
    }
    .progressBar {
      height: 100%;
      width: 0%;
      background: #5eead4;
      border-radius: 4px;
      transition: width 0.1s linear;
    }

    /* ===== COMPOSI√á√ÉO ===== */
    .section {
      margin: 15px 0;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #222;
    }
    .section h3 {
      color: #5eead4;
      margin-top: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1.2em;
    }
    .add-btn {
      background: #4CAF50;
      color: white;
      font-size: 1.1em;
      padding: 5px 9px;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .instrument-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 10px 0;
    }
    .instrument-block {
      background: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      min-width: 200px;
      position: relative;
    }
    .bass-block { border-left: 4px solid #ffcc00; }
    .melody1-block { border-left: 4px solid #ff6b6b; }
    .melody2-block { border-left: 4px solid #4ecdc4; }
    .drum-block { border-left: 4px solid #8e44ad; }
    .harmony-block { border-left: 4px solid #9b59b6; }

    .columns-grid {
      display: flex;
      gap: 2px;
      align-items: flex-start;
      position: relative;
      overflow-x: auto;
      flex: 1;
    }
    .column {
      flex: 0 0 42px;
      margin-right: 2px;
    }
    .cell {
      width: 42px;
      height: 40px;
      margin: 0;
      border: 1px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65em;
      color: #ccc;
      background: #333;
      box-sizing: border-box;
    }
    .cell:hover {
      background: #444;
    }
    .cell.x {
      background: #555;
      color: #888;
      font-weight: bold;
    }
    .cell.active {
      background: #5eead4;
      color: #121212;
    }

    .drum-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 0;
      overflow-x: auto;
    }
    .drum-labels {
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: flex-start;
      justify-content: flex-start;
      padding-top: 5px;
      width: 53px;
      flex-shrink: 0;
    }
    .drum-volume-controls {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: flex-start;
      justify-content: flex-start;
      padding-top: 0px;
      width: 79px;
      flex-shrink: 0;
    }
    .drum-volume-item {
      width: 100%;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      box-sizing: border-box;
    }
    .drum-label-item {
      width: 42%;
      height: 37px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-right: none;
      border-radius: 4px 0 0 4px;
      display: flex;
      align-items: center;
      padding: 0 6px;
      text-align: left;
      font-size: 0.65em;
      color: #ccc;
      box-sizing: border-box;
    }
    .drum-cell {
      width: 42px;
      height: 40px;
      margin: 0;
      border: 1px solid #555;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65em;
      color: #ccc;
      background: #333;
      box-sizing: border-box;
    }
    .drum-cell.active {
      background: #5eead4;
      color: #121212;
    }
    .drum-cell:hover {
      background: #444;
    }

    .instrument-select, .chord-select {
      margin: 8px 0;
      padding: 6px;
      background: #333;
      border: 1px solid #555;
      border-radius: 4px;
      color: white;
      width: 100%;
      font-size: 0.9em;
    }

    .bpm-control {
      text-align: center;
      margin: 12px 0;
    }
    .bpm-slider {
      width: 85%;
      margin: 8px auto;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    button.primary {
      background: #5eead4;
      color: #121212;
    }
    button.danger {
      background: #f44336;
      color: white;
    }

    .loading, .status-indicator, .instructions, .countdown {
      text-align: center;
    }
    .status-indicator {
      padding: 8px;
      margin: 8px 0;
      border-radius: 6px;
    }
    .status-ready { background: #2a4d2a; color: #8eff8e; }
    .status-loading { background: #4d462a; color: #ffe08e; }
    .status-error { background: #4d2a2a; color: #ff8e8e; }

    .instructions {
      font-size: 0.8em;
      color: #aaa;
      margin-top: 6px;
    }
    .countdown {
      font-size: 1.8em;
      color: #ffcc00;
      margin: 15px 0;
      font-weight: bold;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .modal {
      background: #2a2a2a;
      border: 2px solid #5eead4;
      border-radius: 12px;
      padding: 18px;
      max-width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 0 30px rgba(94, 234, 212, 0.5);
    }
    .modal h2 {
      color: #5eead4;
      margin-top: 0;
      text-align: center;
      font-size: 1.3em;
    }
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
      gap: 6px;
      margin-top: 15px;
    }
    .modal-option {
      padding: 8px;
      background: #333;
      border: 1px solid #555;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.85em;
    }
    .modal-option:hover {
      background: #444;
    }
    .modal-option.x {
      background: #555;
      color: #888;
    }

    /* ===== PROGRESSO ===== */
    .progress-container {
      width: 90%;
      background: #333;
      border-radius: 4px;
      margin: 10px auto;
      height: 8px;
    }
    .progress-bar {
      height: 100%;
      background: #5eead4;
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .measure-divider {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(94, 234, 212, 0.6);
      z-index: 10;
      pointer-events: none;
    }

    .volume-control {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .volume-slider {
      width: 70px;
      height: 5px;
    }
    .volume-label {
      font-size: 0.75em;
      color: #aaa;
    }
    .drum-volume-slider {
      width: 50%;
      height: 4px;
      margin: 0;
    }

    /* ===== MAPA DE EDI√á√ÉO ===== */
    .edit-map-container {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 12px;
      max-height: 75vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      z-index: 1000;
      width: 160px;
      font-size: 0.85em;
    }
    .edit-map-title {
      color: #5eead4;
      font-size: 1em;
      margin: 0 0 10px 0;
      text-align: center;
    }
    .edit-map-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      padding: 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .edit-map-item:hover {
      background: #3a3a3a;
    }
    .edit-map-item.active {
      background: #5eead4;
      color: #121212;
      font-weight: bold;
    }
    .edit-map-number {
      font-weight: bold;
      width: 20px;
      text-align: center;
      margin-right: 8px;
      color: #5eead4;
    }
    .edit-map-cells {
      display: flex;
      gap: 1px;
    }
    .edit-map-cell {
      width: 10px;
      height: 10px;
      border: 1px solid #555;
      border-radius: 2px;
      background: #333;
    }
    .edit-map-cell.filled {
      background: #5eead4;
    }
    .edit-map-cell.x {
      background: #555;
    }

    @media (orientation: portrait) {
      #orientationOverlay { display: flex; }
      body { overflow: hidden; }
    }

    @media (max-width: 900px) {
      #animacaoArea {
        width: 100%;
      }
      #painel {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Overlay orienta√ß√£o -->
  <div id="orientationOverlay">
    <div>
      <h2>üì± Gire o celular</h2>
      <p>Use o modo paisagem para ver a baixista e editar o playback.</p>
    </div>
  </div>

  <div id="layout">
    <!-- ===== √ÅREA DA ANIMA√á√ÉO DA BAIXISTA ===== -->
    <div id="animacaoArea">
      <div id="animacaoContainer">
        <!-- Pernas (est√°ticas) -->
        <img id="pernasLayer" class="layer" src="./animacao/pernas/pernas.png" alt="pernas">

        <!-- Tronco + baixo + m√£o esquerda (1E como posi√ß√£o inicial) -->
        <img id="troncoLayer" class="layer" src="./animacao/tronco_baixo/Pasta_1F/1E.png" alt="tronco-baixo">

        <!-- Antebra√ßo direito (corda E inicial) -->
        <img id="antebracoLayer" class="layer" src="./animacao/antebraco/antebracoE.png" alt="antebraco">

        <!-- Bra√ßo direito (frame inicial corda E) -->
        <img id="bracoLayer" class="layer" src="./animacao/braco_direito/Corda_E1.png" alt="braco-direito">

        <!-- Cabe√ßa (frame inicial) -->
        <img id="cabecaLayer" class="layer" src="./animacao/cabeca/cabeca0001.png" alt="cabeca">
      </div>
    </div>

    <!-- ===== PAINEL DIREITO ‚Äì CONTROLES ===== -->
    <div id="painel">
      <header>
        <h1>Jam On ‚Äì Composi√ß√£o Musical com Baixista</h1>
        <div class="pill">Baixo + Bateria + Harmonia ‚Äì composi√ß√£o manual</div>
      </header>

      <!-- BPM -->
      <div class="card">
        <h3>üéö BPM</h3>
        <div class="bpm-display" id="bpmDisplay">100 BPM</div>
        <input id="bpmSlider" type="range" min="60" max="180" value="100">
      </div>

      <!-- Playback -->
      <div class="card">
        <h3>üéµ Playback</h3>
        <button id="playAleatorioBtn">Playback aleat√≥rio</button>
        <button id="playManualBtn" class="secondary">Tocar composi√ß√£o manual</button>
        <button id="playExportadoBtn" class="secondary">Carregar playback (.json)</button>

        <div class="progressContainer">
          <div class="progressBar" id="progressBar"></div>
        </div>
      </div>

      <!-- HARMONIA 1 -->
      <div class="section">
        <h3>üé∏ Harmonia 1</h3>
        <div id="harmonyContainer1" class="instrument-container"></div>
      </div>

      <!-- HARMONIA 2 -->
      <div class="section">
        <h3>üé∏ Harmonia 2</h3>
        <div id="harmonyContainer2" class="instrument-container"></div>
      </div>

      <!-- HARMONIA 3 -->
      <div class="section">
        <h3>üé∏ Harmonia 3</h3>
        <div id="harmonyContainer3" class="instrument-container"></div>
      </div>

      <!-- BAIXO -->
      <div class="section">
        <h3>üé∏ Baixo</h3>
        <div id="bassContainer" class="instrument-container"></div>
      </div>

      <!-- MELODIA 1 -->
      <div class="section">
        <h3>üéπ Melodia 1</h3>
        <div id="melody1Container" class="instrument-container"></div>
      </div>

      <!-- MELODIA 2 -->
      <div class="section">
        <h3>üé∑ Melodia 2</h3>
        <div id="melody2Container" class="instrument-container"></div>
      </div>

      <!-- BATERIA -->
      <div class="section">
        <h3>ü•Å Bateria</h3>
        <div id="drumContainer" class="instrument-container"></div>
      </div>

      <!-- BOT√ïES DE CONTROLE -->
      <div class="btn-row">
        <button id="btnPlay" class="primary" disabled>‚ñ∂ Play</button>
        <button id="btnStop" class="danger" disabled>‚èπ Stop</button>
        <button id="btnSaveWAV" class="primary" disabled>üíæ Salvar como WAV</button>
        <button id="btnDuplicate" class="primary">üîÅ Duplicar Edi√ß√£o</button>
        <button id="btnClearAll" class="danger">üóëÔ∏è Limpar Tudo</button>
        <button id="addCompassoBtn" class="add-btn">+</button>
      </div>

      <div class="instructions">
        Clique em uma c√©lula para escolher uma nota ou acorde.<br>
        Use "+" para adicionar uma coluna em todos os instrumentos.<br>
        <strong>Clique 8 vezes em qualquer c√©lula para preparar os sons.</strong>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="selectionModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h2 id="modalTitle">Selecione uma op√ß√£o</h2>
      <div id="modalGrid" class="modal-grid"></div>
    </div>
  </div>

  <!-- PROGRESSO -->
  <div id="progressContainer" style="display: none; text-align: center; margin: 15px 0;">
    <div>Renderizando...</div>
    <div class="progress-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    <div id="progressText">0%</div>
  </div>

  <!-- MAPA DE EDI√á√ÉO -->
  <div id="editMapContainer" class="edit-map-container">
    <div class="edit-map-title">Mapa de Edi√ß√£o</div>
    <div id="editMapContent"></div>
  </div>

  <script>
    // ===== ESTADO GLOBAL =====
    let headFrames = [];
    let headFrameIndex = 0;
    let headTimer = null;

    let bpmAtual = 100;
    let baixoVolumeGlobal = 0.8;
    let bateriaVolumeGlobal = 0.8;
    let animTimers = [];

    // Notas v√°lidas para o baixo
    const notasValidas = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS",
      "18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B",
      "33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS","44B","45C","46CS","47D",
      "48DS","49E"
    ];

    // Mapa de pastas para cada nota
    const pastaMap = {
      "1E": "Pasta_1F", "2F": "Pasta_1F", "3FS": "Pasta_1F", "4G": "Pasta_1F", "5GS": "Pasta_1F",
      "6A": "Pasta_1F", "7AS": "Pasta_1F", "8B": "Pasta_1F", "9C": "Pasta_1F", "10CS": "Pasta_1F",
      "11D": "Pasta_1F", "12DS": "Pasta_1F", "13E": "Pasta_1F", "14F": "Pasta_1F", "15FS": "Pasta_1F",
      "16G": "Pasta_1F", "17GS": "Pasta_1F", "18A": "Pasta_1F", "19AS": "Pasta_1F", "20B": "Pasta_1F",
      "21C": "Pasta_2F#", "22CS": "Pasta_3G", "23D": "Pasta_4G#", "24DS": "Pasta_5A", "25E": "Pasta_6A#",
      "26F": "Pasta_7B", "27FS": "Pasta_8C", "28G": "Pasta_9C#", "29GS": "Pasta_10D", "30A": "Pasta_11D#",
      "31AS": "Pasta_12E", "32B": "Pasta_13F", "33C": "Pasta_14F#", "34CS": "Pasta_15G", "35D": "Pasta_16G#",
      "36DS": "Pasta_17A", "37E": "Pasta_18A#", "38F": "Pasta_19B", "39FS": "Pasta_20C", "40G": "Pasta_21C#",
      "41GS": "Pasta_22D", "42A": "Pasta_23D#", "43AS": "Pasta_24E"
    };

    // ===== ESTADO DA COMPOSI√á√ÉO =====
    const state = {
      running: false,
      paused: false,
      bpm: 100,
      stepIndex: 0,
      totalSteps: 8,
      buffers: {
        drums: {},
        melodic: {},
        harmonic: {}
      },
      loadedSamples: new Set(),
      activeInput: null,
      schedulerTimer: null,
      harmonyBlocks: [[], [], []],
      bassBlocks: [],
      melody1Blocks: [],
      melody2Blocks: [],
      drumBlocks: [],
      lastNoteTime: 0,
      recordedChunks: [],
      audioCtx: null,
      isPlaying: false,
      isRendering: false,
      countdownActive: false,
      countdownValue: 4,
      currentlyPlaying: { 
        bass: null,
        melody1: null,
        melody2: null,
        harmony1: null,
        harmony2: null,
        harmony3: null
      },
      playbackPlan: null,
      modal: {
        targetCell: null,
        type: null,
        instrumentKey: null
      },
      scrollContainers: [],
      scrollHandler: null
    };

    // ===== ELEMENTOS DA INTERFACE =====
    const ui = {
      statusIndicator: document.getElementById('statusIndicator'),
      countdown: document.getElementById('countdown'),
      bpmSlider: document.getElementById('bpmSlider'),
      bpmDisplay: document.getElementById('bpmDisplay'),
      btnPlay: document.getElementById('btnPlay'),
      btnStop: document.getElementById('btnStop'),
      btnSaveWAV: document.getElementById('btnSaveWAV'),
      addCompassoBtn: document.getElementById('addCompassoBtn'),
      harmonyContainer1: document.getElementById('harmonyContainer1'),
      harmonyContainer2: document.getElementById('harmonyContainer2'),
      harmonyContainer3: document.getElementById('harmonyContainer3'),
      bassContainer: document.getElementById('bassContainer'),
      melody1Container: document.getElementById('melody1Container'),
      melody2Container: document.getElementById('melody2Container'),
      drumContainer: document.getElementById('drumContainer'),
      selectionModal: document.getElementById('selectionModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalGrid: document.getElementById('modalGrid'),
      progressContainer: document.getElementById('progressContainer'),
      progressBar: document.getElementById('progressBar'),
      progressText: document.getElementById('progressText')
    };

    // ===== ACORDES DISPON√çVEIS =====
    const AVAILABLE_CHORDS = [
      'X',
      'A','A11','A13','A4','A45+','A5','A5+','A6','A7','A75+','A9','A95+','Adim',
      'Am','Am5','Am5+','Am6','Am7','Am75+','Am9',
      'AS','AS11','AS13','AS4','AS45+','AS5','AS5+','AS6','AS7','AS75+','AS9','AS95+',
      'ASdim','ASm','ASm5','ASm5+','ASm6','ASm7','ASm75+','ASm9',
      'B','B11','B13','B4','B45+','B5','B5+','B6','B7','B75+','B9','B95+','Bdim',
      'Bm','Bm5','Bm5+','Bm6','Bm7','Bm75+','Bm9',
      'C','C11','C13','C4','C45+','C5','C5+','C6','C7','C75+','C9','C95+','Cdim',
      'Cm','Cm5','Cm5+','Cm6','Cm7','Cm75+','Cm9',
      'CS','CS11','CS13','CS4','CS45+','CS5','CS5+','CS6','CS7','CS75+','CS9','CS95+',
      'CSdim','CSm','CSm5','CSm5+','CSm6','CSm7','CSm75+','CSm9',
      'D','D11','D13','D4','D45+','D5','D5+','D6','D7','D75+','D9','D95+','Ddim',
      'Dm','Dm5','Dm5+','Dm6','Dm7','Dm75+','Dm9',
      'E','E11','E13','E4','E45+','E5','E5+','E6','E7','E75+','E9','E95+','Edim',
      'Em','Em5','Em5+','Em6','Em7','Em75+','Em9',
      'DS','DS11','DS13','DS4','DS45+','DS5','DS5+','DS6','DS7','DS75+','DS9','DS95+',
      'DSdim','DSm','DSm5','DSm5+','DSm6','DSm7','DSm75+','DSm9',
      'F','F11','F13','F4','F45+','F5','F5+','F6','F7','F75+','F9','F95+','Fdim',
      'Fm','Fm5','Fm5+','Fm6','Fm7','Fm75+','Fm9',
      'FS','FS11','FS13','FS4','FS45+','FS5','FS5+','FS6','FS7','FS75+','FS9','FS95+',
      'FSdim','FSm','FSm5','FSm5+','FSm6','FSm7','FSm75+','FSm9',
      'G','G11','G13','G4','G45+','G5','G5+','G6','G7','G75+','G9','G95+','Gdim',
      'Gm','Gm5','Gm5+','Gm6','Gm7','Gm75+','Gm9',
      'GS','GS11','GS13','GS4','GS45+','GS5','GS5+','GS6','GS7','GS75+','GS9','GS95+',
      'GSdim','GSm','GSm5','GSm5+','GSm6','GSm7','GSm75+','GSm9'
    ];

    // ===== INSTRUMENTOS =====
    const MELODIC_INSTRUMENTS = {
      'acordeon': 'assets/AcordeonMelodia/',
      'bass': 'assets/BaixoMelodia/',
      'strings': 'assets/Cordas/',
      'piano': 'assets/PianoString/',
      'sax': 'assets/SaxMelodia/',
      'sinos': 'assets/SinosMelodia/',
      'acoustic-guitar': 'assets/ViolaoAcoMelodia/',
      'nylon-guitar': 'assets/ViolaoNylonMelodia/',
      'distorted-guitar-melody': 'guitarraDistorcao/Melodia/'
    };

    const HARMONIC_INSTRUMENTS = {
      'distorted-guitar': 'guitarraDistorcao/',
      'clean-guitar': 'guitarraLimpa/',
      'piano-chord': 'assets/PianoStringChord/',
      'muted-distorted-guitar': 'guitarraDistorcao/abafadas/'
    };

    const DRUM_SAMPLES = [
      { key: 'ataque', label: 'Prato De Ataque', path: 'assets/ataque.mp3' },
      { key: 'bumbo', label: 'Bumbo', path: 'assets/bumbo.mp3' },
      { key: 'caixa', label: 'Caixa', path: 'assets/caixa.mp3' },
      { key: 'chimbal', label: 'Chimbal Fechado', path: 'assets/chimbal.mp3' },
      { key: 'chimbal-aberto', label: 'Chimbal Aberto', path: 'assets/chimbal-aberto.mp3' },
      { key: 'conducao', label: 'Condu√ß√£o', path: 'assets/conducao.mp3' },
      { key: 'conducao-centro', label: 'Condu√ß√£o Centro', path: 'assets/conducao-centro.mp3' },
      { key: 'surdo', label: 'Surdo', path: 'assets/surdo.mp3' },
      { key: 'tom-1', label: 'Tom 1', path: 'assets/tom-1.mp3' },
      { key: 'tom-2', label: 'Tom 2', path: 'assets/tom-2.mp3' }
    ];

    // ===== FUN√á√ïES DA ANIMA√á√ÉO =====
    function generateHeadFramePaths() {
      const frames = [];
      const base = "./animacao/cabeca/";
      for (let i = 1; i <= 100; i++) {
        const num = String(i).padStart(4, "0");
        frames.push(base + "cabeca" + num + ".png");
      }
      return frames;
    }

    function preloadImages(arr) {
      return new Promise((resolve) => {
        let loaded = 0;
        if (!arr.length) resolve();
        arr.forEach(src => {
          const img = new Image();
          img.onload = () => {
            loaded++;
            if (loaded === arr.length) resolve();
          };
          img.src = src;
        });
      });
    }

    function startHeadLoop() {
      const img = document.getElementById("cabecaLayer");
      if (headTimer) clearInterval(headTimer);
      headTimer = setInterval(() => {
        img.src = headFrames[headFrameIndex];
        headFrameIndex = (headFrameIndex + 1) % headFrames.length;
      }, 75);
      animTimers.push(headTimer);
    }

    function startTroncoBpm(bpm) {
      const tronco = document.getElementById("troncoLayer");
      let angle = 0;
      let dir = 1;
      const intervalo = 60000 / bpm / 4;
      const t = setInterval(() => {
        angle += dir * 1.2;
        if (angle > 7) dir = -1;
        if (angle < -7) dir = 1;
        tronco.style.transform = "rotate(" + angle + "deg)";
      }, intervalo);
      animTimers.push(t);
    }

    function startHeadTiltBpm(bpm) {
      const head = document.getElementById("cabecaLayer");
      let tilt = 0;
      let dir = 1;
      const intervalo = 60000 / bpm / 2;
      const t = setInterval(() => {
        tilt += dir * 1.4;
        if (tilt > 5) dir = -1;
        if (tilt < -5) dir = 1;
        head.style.transform = "rotate(" + tilt + "deg)";
      }, intervalo);
      animTimers.push(t);
    }

    function resetAnimTimers() {
      animTimers.forEach(t => clearInterval(t));
      animTimers = [];
    }

    function getPastaDaNota(nota) {
      return pastaMap[nota] || "Pasta_1F";
    }

    function getFrameDaNota(nota) {
      return nota + ".png";
    }

    function getCordaDaNota(nota) {
      const n = parseInt(nota);
      if (n <= 12) return "E";
      if (n <= 24) return "A";
      if (n <= 36) return "D";
      return "G";
    }

    function trocarFrameTronco(nota) {
      const tronco = document.getElementById("troncoLayer");
      const pasta = getPastaDaNota(nota);
      const frame = getFrameDaNota(nota);
      tronco.src = "./animacao/tronco_baixo/" + pasta + "/" + frame;
    }

    function trocarAntebraco(corda) {
      const ante = document.getElementById("antebracoLayer");
      ante.src = "./animacao/antebraco/antebraco" + corda + ".png";
    }

    function animarBracoDireito(corda, duracaoMs) {
      const braco = document.getElementById("bracoLayer");
      const frameTempo = duracaoMs / 5;
      let f = 1;
      const t = setInterval(() => {
        braco.src = "./animacao/braco_direito/Corda_" + corda + f + ".png";
        f++;
        if (f > 5) clearInterval(t);
      }, frameTempo);
      animTimers.push(t);
    }

    // ===== FUN√á√ïES DA COMPOSI√á√ÉO =====
    function createVolumeControl() {
      const container = document.createElement('div');
      container.className = 'volume-control';
      const label = document.createElement('div');
      label.textContent = 'Volume';
      label.style.fontSize = '0.8em';
      label.style.marginBottom = '5px';
      const slider = document.createElement('input');
      slider.type = 'range';
      slider.className = 'volume-slider';
      slider.min = '0';
      slider.max = '1';
      slider.step = '0.01';
      slider.value = '0.5';
      slider.style.transform = 'rotate(-90deg)';
      slider.style.width = '80px';
      container.appendChild(label);
      container.appendChild(slider);
      return container;
    }

    function createHarmonyColumn(grid, index, harmonyBlock) {
      const col = document.createElement('div');
      col.className = 'column';
      col.dataset.index = index;

      const cell = document.createElement('div');
      cell.className = 'cell x';
      cell.dataset.index = index;

      cell.addEventListener('click', function () {
        if (this.classList.contains('x')) {
          openModal('harmony', AVAILABLE_CHORDS, this, harmonyBlock.instrumentSelect.value);
        } else {
          this.classList.toggle('x');
          this.textContent = this.classList.contains('x') ? '' : this.textContent;
        }
      });

      col.appendChild(cell);
      grid.appendChild(col);
    }

    function createMelodicColumn(grid, index, instrumentKey) {
      const col = document.createElement('div');
      col.className = 'column';
      col.dataset.index = index;

      const cell = document.createElement('div');
      cell.className = 'cell x';
      cell.dataset.index = index;

      cell.addEventListener('click', function () {
        if (this.classList.contains('x')) {
          openModal('melody', notasValidas, this, instrumentKey);
        } else {
          this.classList.toggle('x');
          this.textContent = this.classList.contains('x') ? '' : this.textContent;
        }
      });

      col.appendChild(cell);
      grid.appendChild(col);
    }

    function createDrumColumn(grid, stepIndex, blockIndex) {
      const col = document.createElement('div');
      col.className = 'column';
      col.dataset.index = stepIndex;
      col.dataset.blockIndex = blockIndex;

      DRUM_SAMPLES.forEach(drum => {
        const cell = document.createElement('div');
        cell.className = 'drum-cell';
        cell.dataset.instr = drum.key;
        cell.dataset.index = stepIndex;
        cell.dataset.blockIndex = blockIndex;
        cell.title = drum.label;

        cell.addEventListener('click', function () {
          this.classList.toggle('active');
        });

        col.appendChild(cell);
      });

      grid.appendChild(col);
    }

    function addHarmonyBlock(containerIndex) {
      const blockIndex = state.harmonyBlocks[containerIndex].length;
      const wrapper = document.createElement('div');
      wrapper.className = 'instrument-wrapper';
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'flex-start';
      wrapper.dataset.blockIndex = blockIndex;
      wrapper.dataset.containerIndex = containerIndex;

      const instrumentSelect = document.createElement('select');
      instrumentSelect.className = 'instrument-select';
      instrumentSelect.style.width = '140px';
      instrumentSelect.style.marginRight = '10px';
      instrumentSelect.innerHTML = `
        <option value="distorted-guitar">Guitarra Distorcida</option>
        <option value="muted-distorted-guitar">Guitarra Abafada</option>
        <option value="clean-guitar">Guitarra Limpa</option>
        <option value="piano-chord">Piano</option>
      `;

      const block = document.createElement('div');
      block.className = 'instrument-block harmony-block';
      block.style.flex = '1';
      block.dataset.blockIndex = blockIndex;
      block.dataset.containerIndex = containerIndex;

      const grid = document.createElement('div');
      grid.className = 'columns-grid';
      grid.dataset.type = 'harmony';
      grid.dataset.blockIndex = blockIndex;
      grid.dataset.containerIndex = containerIndex;
      grid.style.position = 'relative';

      for (let i = 0; i < state.totalSteps; i++) {
        createHarmonyColumn(grid, i, { instrumentSelect, grid });
      }

      block.appendChild(grid);
      const volumeControl = createVolumeControl();
      block.appendChild(volumeControl);
      grid._volumeSlider = volumeControl.querySelector('.volume-slider');
      
      wrapper.appendChild(instrumentSelect);
      wrapper.appendChild(block);

      const containerId = `harmonyContainer${containerIndex + 1}`;
      document.getElementById(containerId).appendChild(wrapper);
      
      state.harmonyBlocks[containerIndex].push({ 
        wrapper, 
        instrumentSelect, 
        grid, 
        containerIndex 
      });
      
      return wrapper;
    }

    function addBassBlock() {
      const blockIndex = state.bassBlocks.length;
      const wrapper = document.createElement('div');
      wrapper.className = 'instrument-wrapper';
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'flex-start';
      wrapper.dataset.blockIndex = blockIndex;

      const instrumentSelect = document.createElement('select');
      instrumentSelect.className = 'instrument-select';
      instrumentSelect.style.width = '120px';
      instrumentSelect.style.marginRight = '10px';
      instrumentSelect.innerHTML = `
        <option value="bass">Baixo</option>
        <option value="acoustic-guitar">Viol√£o A√ßo</option>
        <option value="nylon-guitar">Viol√£o Nylon</option>
      `;

      const block = document.createElement('div');
      block.className = 'instrument-block bass-block';
      block.style.flex = '1';
      block.dataset.blockIndex = blockIndex;

      const grid = document.createElement('div');
      grid.className = 'columns-grid';
      grid.dataset.type = 'bass';
      grid.dataset.blockIndex = blockIndex;

      for (let i = 0; i < state.totalSteps; i++) {
        createMelodicColumn(grid, i, 'bass');
      }

      block.appendChild(grid);
      const volumeControl = createVolumeControl();
      block.appendChild(volumeControl);
      grid._volumeSlider = volumeControl.querySelector('.volume-slider');

      wrapper.appendChild(instrumentSelect);
      wrapper.appendChild(block);
      ui.bassContainer.appendChild(wrapper);
      state.bassBlocks.push(wrapper);

      return wrapper;
    }

    function addMelodyBlock(type, container, stateArray) {
      const blockIndex = stateArray.length;
      const wrapper = document.createElement('div');
      wrapper.className = 'instrument-wrapper';
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'flex-start';
      wrapper.dataset.blockIndex = blockIndex;
      
      const instrumentSelect = document.createElement('select');
      instrumentSelect.className = 'instrument-select';
      instrumentSelect.style.width = '120px';
      instrumentSelect.style.marginRight = '10px';
      instrumentSelect.innerHTML = `
        <option value="piano">Piano</option>
        <option value="sax">Saxofone</option>
        <option value="acordeon">Acordeon</option>
        <option value="strings">Cordas</option>
        <option value="sinos">Sinos</option>
        <option value="acoustic-guitar">Viol√£o A√ßo</option>
        <option value="nylon-guitar">Viol√£o Nylon</option>
      `;

      const block = document.createElement('div');
      block.className = `instrument-block ${type}-block`;
      block.style.flex = '1';
      block.dataset.blockIndex = blockIndex;

      const grid = document.createElement('div');
      grid.className = 'columns-grid';
      grid.dataset.type = type;
      grid.dataset.blockIndex = blockIndex;

      for (let i = 0; i < state.totalSteps; i++) {
        createMelodicColumn(grid, i, type);
      }

      block.appendChild(grid);
      const volumeControl = createVolumeControl();
      block.appendChild(volumeControl);
      grid._volumeSlider = volumeControl.querySelector('.volume-slider');
      
      wrapper.appendChild(instrumentSelect);
      wrapper.appendChild(block);
      container.appendChild(wrapper);
      stateArray.push(wrapper);
      
      return wrapper;
    }

    function addMelody1Block() {
      return addMelodyBlock('melody1', ui.melody1Container, state.melody1Blocks);
    }

    function addMelody2Block() {
      return addMelodyBlock('melody2', ui.melody2Container, state.melody2Blocks);
    }

    function addDrumBlock() {
      const blockIndex = state.drumBlocks.length;
      const block = document.createElement('div');
      block.className = 'instrument-block drum-block';
      block.dataset.blockIndex = blockIndex;
      block.style.display = 'flex';
      block.style.alignItems = 'flex-start';
      block.style.overflow = 'hidden';
      
      const drumWrapper = document.createElement('div');
      drumWrapper.className = 'drum-wrapper';
      drumWrapper.style.position = 'relative';
      drumWrapper.style.alignItems = 'flex-start';
      
      const labelsColumn = document.createElement('div');
      labelsColumn.className = 'drum-labels';
      
      const volumeColumn = document.createElement('div');
      volumeColumn.className = 'drum-volume-controls';
      
      DRUM_SAMPLES.forEach(drum => {
        // Label
        const labelItem = document.createElement('div');
        labelItem.className = 'drum-label-item';
        labelItem.textContent = drum.label;
        labelsColumn.appendChild(labelItem);
        
        // Volume control
        const volumeItem = document.createElement('div');
        volumeItem.className = 'drum-volume-item';
        
        const volumeSlider = document.createElement('input');
        volumeSlider.type = 'range';
        volumeSlider.className = 'volume-slider drum-volume-slider';
        volumeSlider.min = '0';
        volumeSlider.max = '1';
        volumeSlider.step = '0.01';
        volumeSlider.value = '1.0';
        volumeSlider.dataset.drumKey = drum.key;
        volumeSlider.style.width = '100%';
        
        if (!window.drumVolumeSliders) window.drumVolumeSliders = {};
        window.drumVolumeSliders[drum.key] = volumeSlider;
        volumeItem.appendChild(volumeSlider);
        volumeColumn.appendChild(volumeItem);
      });
      
      const grid = document.createElement('div');
      grid.className = 'columns-grid';
      grid.dataset.type = 'drum';
      grid.dataset.blockIndex = blockIndex;
      
      for (let step = 0; step < state.totalSteps; step++) {
        createDrumColumn(grid, step, blockIndex);
      }
      
      drumWrapper.appendChild(labelsColumn);
      drumWrapper.appendChild(volumeColumn);
      drumWrapper.appendChild(grid);
      block.appendChild(drumWrapper);
      ui.drumContainer.appendChild(block);
      state.drumBlocks.push(block);
      
      return block;
    }

    function addCompasso() {
      const newColumnIndex = state.totalSteps;
      
      for (let containerIndex = 0; containerIndex < 3; containerIndex++) {
        state.harmonyBlocks[containerIndex].forEach(harmonyBlock => {
          const grid = harmonyBlock.grid;
          if (!grid) return;
          createHarmonyColumn(grid, newColumnIndex, harmonyBlock);
        });
      }
      
      [state.bassBlocks, state.melody1Blocks, state.melody2Blocks].forEach(blocks => {
        blocks.forEach(wrapper => {
          const grid = wrapper.querySelector('.columns-grid');
          if (!grid) return;
          const type = grid.dataset.type;
          createMelodicColumn(grid, newColumnIndex, type);
        });
      });
      
      state.drumBlocks.forEach(block => {
        const grid = block.querySelector('.columns-grid');
        if (!grid) return;
        createDrumColumn(grid, newColumnIndex, block.dataset.blockIndex);
      });
      
      state.totalSteps += 1;
      updateStatus(`Compasso adicionado. Total: ${state.totalSteps} passos.`, 'ready');
      updateEditMap();
      
      // Atualiza divisores e sincroniza√ß√£o
      setTimeout(() => {
        updateMeasureDividers();
        setupScrollSync();
      }, 50);
    }

    function updateMeasureDividers() {
      requestAnimationFrame(() => {
        document.querySelectorAll('.measure-divider').forEach(el => el.remove());

        const allGrids = document.querySelectorAll(
          '#harmonyContainer1 .columns-grid, ' +
          '#harmonyContainer2 .columns-grid, ' +
          '#harmonyContainer3 .columns-grid, ' +
          '#bassContainer .columns-grid, ' +
          '#melody1Container .columns-grid, ' +
          '#melody2Container .columns-grid, ' +
          '#drumContainer .columns-grid'
        );

        const cellWidth = 42;
        const gap = 4;
        const measureSize = 8;

        allGrids.forEach(grid => {
          const totalCols = grid.querySelectorAll('.column').length;
          for (let m = 1; m * measureSize < totalCols; m++) {
            const divider = document.createElement('div');
            divider.className = 'measure-divider';
            divider.style.left = `${m * measureSize * (cellWidth + gap)}px`;
            grid.appendChild(divider);
          }
        });
      });
    }

    function setupScrollSync() {
      if (state.scrollHandler) {
        state.scrollContainers.forEach(container => {
          if (container && container.removeEventListener) {
            container.removeEventListener('scroll', state.scrollHandler);
          }
        });
      }

      const allGrids = [
        ...document.querySelectorAll('#harmonyContainer1 .columns-grid'),
        ...document.querySelectorAll('#harmonyContainer2 .columns-grid'),
        ...document.querySelectorAll('#harmonyContainer3 .columns-grid'),
        ...document.querySelectorAll('#bassContainer .columns-grid'),
        ...document.querySelectorAll('#melody1Container .columns-grid'),
        ...document.querySelectorAll('#melody2Container .columns-grid'),
        ...document.querySelectorAll('#drumContainer .columns-grid')
      ].filter(Boolean);

      state.scrollContainers = allGrids;
      let isSyncing = false;

      const handleScroll = (source) => {
        if (isSyncing) return;
        isSyncing = true;
        
        const left = source.scrollLeft;
        
        allGrids.forEach(grid => {
          if (grid !== source && Math.abs(grid.scrollLeft - left) > 1) {
            grid.scrollLeft = left;
          }
        });
        
        requestAnimationFrame(() => {
          isSyncing = false;
        });
      };

      state.scrollHandler = e => handleScroll(e.target);
      
      allGrids.forEach(grid => {
        grid.removeEventListener('scroll', state.scrollHandler);
        grid.addEventListener('scroll', state.scrollHandler);
        
        grid.scrollLeft = 0;
      });
    }

    function initializeState() {
      state.totalSteps = 8;
      state.harmonyBlocks = [[], [], []];
      state.bassBlocks = [];
      state.melody1Blocks = [];
      state.melody2Blocks = [];
      state.drumBlocks = [];
    }

    // ===== FUN√á√ïES DE PLAYBACK =====
    function onPlay() {
      if (!state.audioCtx) {
        updateStatus('Erro: Audio Context n√£o inicializado', 'error');
        return;
      }
      
      if (state.isPlaying) {
        // Pausar
        state.isPlaying = false;
        ui.btnPlay.textContent = '‚ñ∂ Play';
        ui.btnStop.disabled = true;
        resetAnimTimers();
        return;
      }
      
      // Iniciar reprodu√ß√£o
      try {
        if (state.audioCtx.state === 'suspended') {
          state.audioCtx.resume();
        }
        
        state.isPlaying = true;
        ui.btnPlay.textContent = '‚è∏ Pause';
        ui.btnStop.disabled = false;
        
        // Iniciar anima√ß√µes
        startTroncoBpm(state.bpm);
        startHeadTiltBpm(state.bpm);
        
        updateStatus('Reproduzindo...', 'ready');
        
      } catch (error) {
        console.error('Erro ao iniciar reprodu√ß√£o:', error);
        updateStatus('Erro ao iniciar: ' + error.message, 'error');
      }
    }

    function onStop() {
      state.isPlaying = false;
      state.stepIndex = 0;
      ui.btnPlay.textContent = '‚ñ∂ Play';
      ui.btnStop.disabled = true;
      resetAnimTimers();
      updateStatus('Reprodu√ß√£o parada', 'ready');
    }

    function duplicateComposition() {
      alert('Duplicar composi√ß√£o - funcionalidade em desenvolvimento');
    }

    function clearAllComposition() {
      if (!confirm('Tem certeza? Isso apagar√° toda a composi√ß√£o atual.')) return;
      
      state.totalSteps = 8;
      state.harmonyBlocks = [[], [], []];
      state.bassBlocks = [];
      state.melody1Blocks = [];
      state.melody2Blocks = [];
      state.drumBlocks = [];
      
      ui.harmonyContainer1.innerHTML = '';
      ui.harmonyContainer2.innerHTML = '';
      ui.harmonyContainer3.innerHTML = '';
      ui.bassContainer.innerHTML = '';
      ui.melody1Container.innerHTML = '';
      ui.melody2Container.innerHTML = '';
      ui.drumContainer.innerHTML = '';
      
      addHarmonyBlock(0);
      addHarmonyBlock(1);
      addHarmonyBlock(2);
      addBassBlock();
      addMelody1Block();
      addMelody2Block();
      addDrumBlock();
      
      updateEditMap();
      setTimeout(updateMeasureDividers, 0);
      updateStatus('Composi√ß√£o limpa. Pronto para come√ßar do zero.', 'ready');
    }

    function renderAndDownloadWAV() {
      alert('Salvar como WAV - funcionalidade em desenvolvimento');
    }

    // ===== FUN√á√ïES DO MODAL =====
    function openModal(type, options, targetCell, instrumentKey) {
      state.modal.type = type;
      state.modal.targetCell = targetCell;
      state.modal.instrumentKey = instrumentKey;
      ui.modalTitle.textContent = type === 'harmony' ? 'Selecione um Acorde' : 'Selecione uma Nota';
      ui.modalGrid.innerHTML = '';
      
      options.forEach(option => {
        const div = document.createElement('div');
        div.className = 'modal-option';
        if (option === 'X') {
          div.classList.add('x');
        }
        let displayText = option;
        if (option !== 'X') {
          displayText = option.replace(/S/g, '#');
        }
        div.textContent = displayText;
        div.dataset.originalValue = option;
        div.addEventListener('click', function() {
          const originalValue = this.dataset.originalValue;
          targetCell.textContent = displayText;
          if (originalValue === 'X') {
            targetCell.classList.add('x');
          } else {
            targetCell.classList.remove('x');
            targetCell.classList.add('active');
          }
          targetCell.dataset.originalValue = originalValue;
          closeModal();
        });
        ui.modalGrid.appendChild(div);
      });
      
      ui.selectionModal.style.display = 'flex';
    }

    function closeModal() {
      ui.selectionModal.style.display = 'none';
      state.modal = {
        targetCell: null,
        type: null,
        instrumentKey: null
      };
    }

    // ===== FUN√á√ïES AUXILIARES =====
    function updateEditMap() {
      // Implementa√ß√£o simplificada
      const mapContent = document.getElementById('editMapContent');
      mapContent.innerHTML = '<div class="edit-map-item"><span class="edit-map-number">1</span><div class="edit-map-cells"><span class="edit-map-cell filled"></span><span class="edit-map-cell filled"></span><span class="edit-map-cell"></span><span class="edit-map-cell"></span><span class="edit-map-cell filled"></span><span class="edit-map-cell"></span><span class="edit-map-cell"></span><span class="edit-map-cell filled"></span></div></div>';
    }

    function updateStatus(message, type) {
      console.log(`${type}: ${message}`);
      // Implementa√ß√£o b√°sica - voc√™ pode adicionar um elemento de status na UI
    }

    function updateBPMDisplay() {
      ui.bpmDisplay.textContent = `${state.bpm} BPM`;
    }

    function handleBPMChange() {
      state.bpm = parseInt(ui.bpmSlider.value);
      bpmAtual = state.bpm;
      updateBPMDisplay();
      resetAnimTimers();
      if (state.isPlaying) {
        startTroncoBpm(state.bpm);
        startHeadTiltBpm(state.bpm);
      }
    }

    function initializeApp() {
      initializeState();
      updateStatus('Pronto para compor. Clique nas c√©lulas para criar sua m√∫sica.', 'ready');
      try {
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        state.masterGain = state.audioCtx.createGain();
        state.drumGain = state.audioCtx.createGain();
        state.bassGain = state.audioCtx.createGain();
        state.melodyGain = state.audioCtx.createGain();
        state.harmonicGain = state.audioCtx.createGain();
        state.masterGain.connect(state.audioCtx.destination);
        state.drumGain.connect(state.masterGain);
        state.bassGain.connect(state.masterGain);
        state.melodyGain.connect(state.masterGain);
        state.harmonicGain.connect(state.masterGain);
        state.masterGain.gain.value = 0.8;
        state.drumGain.gain.value = 1.0;
        state.bassGain.gain.value = 0.5;
        state.melodyGain.gain.value = 0.5;
        state.harmonicGain.gain.value = 0.5;
        
        setupEventListeners();
        
        state.harmonyBlocks = [[], [], []];
        state.bassBlocks = [];
        state.melody1Blocks = [];
        state.melody2Blocks = [];
        state.drumBlocks = [];
        
        addHarmonyBlock(0);
        addHarmonyBlock(1);
        addHarmonyBlock(2);
        addBassBlock();
        addMelody1Block();
        addMelody2Block();
        addDrumBlock();
        
        ui.btnPlay.disabled = false;
        ui.btnSaveWAV.disabled = true;
        ui.btnStop.disabled = true;
        
        updateStatus('Componha sua m√∫sica. Clique em Play para iniciar com contagem de 4 compassos.', 'ready');
        updateEditMap();
        
        setTimeout(() => {
          updateMeasureDividers();
          setupScrollSync();
        }, 200);
        
      } catch (error) {
        console.error('Erro ao inicializar:', error);
        updateStatus('Erro ao inicializar: ' + error.message, 'error');
      }
    }

    function setupEventListeners() {
      updateBPMDisplay();
      ui.bpmSlider.addEventListener('input', handleBPMChange);
      ui.addCompassoBtn.addEventListener('click', addCompasso);
      ui.btnPlay.addEventListener('click', onPlay);
      ui.btnStop.addEventListener('click', onStop);
      ui.btnSaveWAV.addEventListener('click', () => renderAndDownloadWAV());
      document.getElementById('btnDuplicate').addEventListener('click', duplicateComposition);
      document.getElementById('btnClearAll').addEventListener('click', clearAllComposition);
      ui.selectionModal.addEventListener('click', function(e) {
        if (e.target === this) closeModal();
      });

      // Event listeners para anima√ß√£o
      document.getElementById('playAleatorioBtn').onclick = () => {
        alert('Playback aleat√≥rio ainda n√£o implementado');
      };

      document.getElementById('playManualBtn').onclick = () => {
        alert('Playback da composi√ß√£o manual ainda n√£o implementado');
      };

      document.getElementById('playExportadoBtn').onclick = () => {
        alert('Carregamento de playback ainda n√£o implementado');
      };
    }

    // ===== INICIALIZA√á√ÉO =====
    function garantirPaisagem() {
      function checar() {
        const overlay = document.getElementById("orientationOverlay");
        if (window.innerWidth < window.innerHeight) {
          overlay.style.display = "flex";
        } else {
          overlay.style.display = "none";
        }
      }
      checar();
      window.addEventListener("resize", checar);
    }

    window.onload = async () => {
      garantirPaisagem();

      // Pr√©-carrega frames da cabe√ßa
      headFrames = generateHeadFramePaths();
      await preloadImages(headFrames);
      startHeadLoop();
      startTroncoBpm(bpmAtual);
      startHeadTiltBpm(bpmAtual);

      initializeApp();
    };
  </script>
</body>
</html>
