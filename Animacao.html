<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JamOn ‚Äì Visualizador com Anima√ß√£o</title>
  <script src="jamon-engine.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
      overflow: hidden;
    }
    .appRoot {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #animationArea {
      flex: 0 0 60%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #222 0, #050505 60%);
      position: relative;
    }
    #playerArea {
      flex: 0 0 40%;
      background: rgba(5,5,5,0.95);
      padding: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border-top: 1px solid #333;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 0.85rem;
    }
    #controls button, #controls input[type="range"] {
      padding: 4px 8px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .sliderGroup {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .sliderGroup label {
      font-size: 0.75rem;
      opacity: 0.85;
    }
    #progressBar {
      height: 4px;
      background: #222;
      margin-bottom: 6px;
      border-radius: 2px;
    }
    #progressFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #00c853, #ffd600);
      transition: width 0.1s linear;
    }
    #grids {
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .gridRow {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .gridLabel {
      width: 60px;
      font-size: 0.75rem;
      text-align: right;
      opacity: 0.85;
    }
    .drumGrid {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .drumRow {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .grid {
      flex: 1;
      display: grid;
      grid-auto-flow: column;
      grid-auto-rows: 22px;
      grid-auto-columns: minmax(20px, 1fr);
      gap: 2px;
      background: #0a0a0a;
      padding: 2px;
      border: 1px solid #333;
      border-radius: 4px;
    }
    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      background: #151515;
      border: 1px solid #333;
      border-radius: 3px;
      color: #f5f5f5;
      user-select: none;
    }
    .cell.active {
      background: #1b5e20;
      border-color: #00c853;
      font-weight: bold;
    }
    .cell.x {
      background: #333;
      color: #888;
    }
    #stageWrapper {
      position: relative;
      width: 90vw;
      max-width: 500px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #baixistaStage {
      position: relative;
      width: 100%;
      height: 100%;
      max-height: 340px;
      margin: 0 auto;
    }
    #baixistaStage img {
      position: absolute;
      image-rendering: pixelated;
      pointer-events: none;
    }
    #pernasLayer { z-index: 1; }
    #troncoBaixoLayer { z-index: 3; }
    #antebracoLayer { z-index: 4; }
    #bracoDireitoLayer { z-index: 5; }
    #cabecaLayer { z-index: 6; }
    .countdown {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.85);
      color: white;
      font-size: 2.5rem;
      font-weight: bold;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="appRoot">
    <div id="animationArea">
      <div id="stageWrapper">
        <div id="baixistaStage">
          <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />
          <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="Tronco" />
          <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" alt="Antebra√ßo" />
          <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" alt="M√£o direita" />
          <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" alt="Cabe√ßa" />
          <div class="countdown" id="countdown">3</div>
        </div>
      </div>
    </div>
    <div id="playerArea">
      <div id="controls">
        <button id="btnPlay">‚ñ∂ Play</button>
        <button id="btnAleatorio">üé≤ Playback Aleat√≥rio</button>
        <button id="btnCarregar">üìÅ Carregar JSON</button>
        <span id="bpmLabel">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        <div class="sliderGroup">
          <label>Baixo</label>
          <input type="range" id="volBaixo" min="0" max="1" step="0.01" value="0.85" />
        </div>
        <div class="sliderGroup">
          <label>Bateria</label>
          <input type="range" id="volBateria" min="0" max="1" step="0.01" value="0.85" />
        </div>
      </div>
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
      <div id="grids">
        <div class="gridRow">
          <div class="gridLabel">Baixo</div>
          <div id="baixoGrid" class="grid"></div>
        </div>
        <div class="drumGrid" id="drumGrid"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== NOTAS E PASTAS ==========
    const NOTAS_VALIDAS = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS",
      "11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B",
      "21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A",
      "31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G",
      "41GS","42A","43AS","44B","45C","46CS","47D","48DS","49E"
    ];

    const PASTA_MAP = {
      1:  ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"],
      2:  ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"],
      3:  ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"],
      4:  ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"],
      5:  ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"],
      6:  ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"],
      7:  ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"],
      8:  ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"],
      9:  ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"],
      10: ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"],
      11: ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"],
      12: ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS"],
      13: ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"],
      14: ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"],
      15: ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"],
      16: ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"],
      17: ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"],
      18: ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"],
      19: ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"],
      20: ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"],
      21: ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"],
      22: ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"],
      23: ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"],
      24: ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"]
    };

    const DRUM_LINES = [
      { id: "bumbo", label: "B" },
      { id: "caixa", label: "C" },
      { id: "chimbal", label: "HH" },
      { id: "chimbalaberto", label: "HHo" },
      { id: "conducao", label: "Rd" },
      { id: "ataque", label: "Atk" },
      { id: "tom1", label: "T1" },
      { id: "tom2", label: "T2" },
      { id: "surdo", label: "Sd" }
    ];

    // ========== ESTADO ==========
    let baixoSeq = Array(16).fill("x");
    let bateriaSeq = {};
    DRUM_LINES.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    let isPlaying = false;
    let currentStep = 0;
    let playbackInterval = null;
    let currentBpm = 120;
    let posicaoAtualPasta = 1;
    let ultimaNotaReal = "1E";
    let lastAudio = null;

    // ========== ANIMA√á√ÉO ==========
    function getCorda(nota) {
      if (!nota || nota === "x") return "E";
      const num = parseInt(nota.match(/^\d+/)?.[0] || "1", 10);
      if (num >= 37) return "G";
      if (num >= 29) return "D";
      if (num >= 21) return "A";
      return "E";
    }

    function encontrarPastas(nota) {
      const pastas = [];
      for (let i = 1; i <= 24; i++) {
        if (PASTA_MAP[i].includes(nota)) pastas.push(i);
      }
      return pastas;
    }

    function escolherPasta(nota, atual) {
      if (nota === "x") return atual;
      const pastas = encontrarPastas(nota);
      if (!pastas.length) return atual;
      return pastas.reduce((melhor, p) => 
        Math.abs(p - atual) < Math.abs(melhor - atual) ? p : melhor
      , pastas[0]);
    }

    function atualizarTronco(nota) {
      if (nota === "x") {
        // usa ultima nota real
        const pasta = escolherPasta(ultimaNotaReal, posicaoAtualPasta);
        document.getElementById("troncoBaixoLayer").src = `animacao/tronco_baixo/Pasta_${pasta}F/${ultimaNotaReal}.png`;
        return;
      }
      posicaoAtualPasta = escolherPasta(nota, posicaoAtualPasta);
      ultimaNotaReal = nota;
      document.getElementById("troncoBaixoLayer").src = `animacao/tronco_baixo/Pasta_${posicaoAtualPasta}F/${nota}.png`;
    }

    function atualizarAntebraco(nota) {
      const corda = getCorda(nota);
      document.getElementById("antebracoLayer").src = `animacao/antebraco/antebraco${corda}.png`;
    }

    function atualizarMaoDireita(nota) {
      const corda = getCorda(nota);
      // ciclo simples de frames
      const frames = ["1","2","3","4","5"];
      let idx = 0;
      const interval = setInterval(() => {
        document.getElementById("bracoDireitoLayer").src = `animacao/braco_direito/Corda_${corda}${frames[idx]}.png`;
        idx = (idx + 1) % frames.length;
      }, 100);
      // parar depois de 1s
      setTimeout(() => clearInterval(interval), 1000);
    }

    function atualizarCabe√ßa() {
      let frame = 1;
      const interval = setInterval(() => {
        const num = String(frame).padStart(4, "0");
        document.getElementById("cabecaLayer").src = `animacao/cabeca/cabeca${num}.png`;
        frame = frame % 100 + 1;
      }, 33); // ~30fps
      return interval;
    }

    let cabecaInterval = null;

    // ========== √ÅUDIO ==========
    function tocarNota(nota, volume) {
      if (lastAudio) {
        lastAudio.pause();
        lastAudio = null;
      }
      if (nota === "x") return;
      const audio = new Audio(`assets/BaixoMelodia/${nota}.mp3`);
      audio.volume = volume;
      audio.play().catch(e => console.warn("Erro ao tocar:", nota, e));
      lastAudio = audio;
    }

    function tocarBateria(step, volume) {
      DRUM_LINES.forEach(d => {
        if (bateriaSeq[d.id][step] === d.id) {
          const map = {
            bumbo: "bumbo.mp3",
            caixa: "caixa.mp3",
            chimbal: "chimbal.mp3",
            chimbalaberto: "chimbal-aberto.mp3",
            conducao: "conducao.mp3",
            ataque: "ataque.mp3",
            tom1: "tom-1.mp3",
            tom2: "tom-2.mp3",
            surdo: "surdo.mp3"
          };
          const file = map[d.id];
          if (file) {
            const a = new Audio(`assets/${file}`);
            a.volume = volume;
            a.play().catch(e => {});
          }
        }
      });
    }

    // ========== PLAYBACK ==========
    function playStep(step) {
      const nota = baixoSeq[step] || "x";
      const volBaixo = parseFloat(document.getElementById("volBaixo").value);
      const volBateria = parseFloat(document.getElementById("volBateria").value);

      tocarNota(nota, volBaixo);
      tocarBateria(step, volBateria);

      atualizarTronco(nota);
      if (nota !== "x") {
        atualizarAntebraco(nota);
        atualizarMaoDireita(nota);
      }

      const total = Math.max(baixoSeq.length, ...Object.values(bateriaSeq).map(a => a.length));
      document.getElementById("progressFill").style.width = `${(step / total) * 100}%`;
    }

    function iniciarPlayback() {
      if (isPlaying) return;
      isPlaying = true;
      currentStep = 0;
      const tempo = (60000 / currentBpm) / 4;
      playStep(currentStep);
      playbackInterval = setInterval(() => {
        currentStep++;
        const totalSteps = Math.max(baixoSeq.length, ...Object.values(bateriaSeq).map(a => a.length));
        if (currentStep >= totalSteps) currentStep = 0;
        playStep(currentStep);
      }, tempo);
      document.getElementById("btnPlay").textContent = "‚è∏ Pause";
    }

    function pararPlayback() {
      if (!isPlaying) return;
      isPlaying = false;
      clearInterval(playbackInterval);
      if (lastAudio) {
        lastAudio.pause();
        lastAudio = null;
      }
      document.getElementById("btnPlay").textContent = "‚ñ∂ Play";
    }

    // ========== UI ==========
    function construirGradeBaixo() {
      const grid = document.getElementById("baixoGrid");
      grid.innerHTML = "";
      baixoSeq.forEach((nota, i) => {
        const cell = document.createElement("div");
        cell.className = nota === "x" ? "cell x" : "cell active";
        cell.textContent = nota === "x" ? "X" : nota.replace(/S/g, "#");
        grid.appendChild(cell);
      });
    }

    function construirGradeBateria() {
      const grid = document.getElementById("drumGrid");
      grid.innerHTML = "";
      DRUM_LINES.forEach(d => {
        const row = document.createElement("div");
        row.className = "drumRow";
        const label = document.createElement("div");
        label.className = "gridLabel";
        label.textContent = d.label;
        row.appendChild(label);
        const subgrid = document.createElement("div");
        subgrid.className = "grid";
        bateriaSeq[d.id].forEach((val, i) => {
          const cell = document.createElement("div");
          if (val === "x") {
            cell.className = "cell";
            cell.textContent = "X";
          } else {
            cell.className = "cell active";
            cell.textContent = d.label;
          }
          subgrid.appendChild(cell);
        });
        row.appendChild(subgrid);
        grid.appendChild(row);
      });
    }

    function garantirMesmoTamanho() {
      const len = Math.max(baixoSeq.length, ...Object.values(bateriaSeq).map(a => a.length));
      baixoSeq = [...baixoSeq, ...Array(Math.max(0, len - baixoSeq.length)).fill("x")];
      DRUM_LINES.forEach(d => {
        bateriaSeq[d.id] = [...bateriaSeq[d.id], ...Array(Math.max(0, len - bateriaSeq[d.id].length)).fill("x")];
      });
    }

    // ========== INICIALIZA√á√ÉO ==========
    function iniciar() {
      construirGradeBaixo();
      construirGradeBateria();

      // controles
      document.getElementById("btnPlay").onclick = () => isPlaying ? pararPlayback() : iniciarPlayback();
      document.getElementById("btnAleatorio").onclick = () => {
        const passos = baixoSeq.length;
        const res = JamOnEngine.generateRandomPlayback(passos, currentBpm);
        baixoSeq = res.bassSeq;
        DRUM_LINES.forEach(d => {
          bateriaSeq[d.id] = res.bateriaSeq[d.id] || Array(passos).fill("x");
        });
        garantirMesmoTamanho();
        construirGradeBaixo();
        construirGradeBateria();
        pararPlayback();
        document.getElementById("bpmSlider").value = res.bpm;
        currentBpm = res.bpm;
        document.getElementById("bpmLabel").textContent = `${res.bpm} BPM`;
      };

      document.getElementById("bpmSlider").oninput = () => {
        currentBpm = parseInt(document.getElementById("bpmSlider").value);
        document.getElementById("bpmLabel").textContent = `${currentBpm} BPM`;
      };

      document.getElementById("btnCarregar").onclick = () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(reader.result);
              if (!Array.isArray(data.baixo) || typeof data.bpm !== "number") {
                alert("JSON inv√°lido!");
                return;
              }
              baixoSeq = data.baixo;
              DRUM_LINES.forEach(d => {
                bateriaSeq[d.id] = Array.isArray(data.bateria?.[d.id]) ? data.bateria[d.id] : Array(baixoSeq.length).fill("x");
              });
              garantirMesmoTamanho();
              construirGradeBaixo();
              construirGradeBateria();
              currentBpm = data.bpm;
              document.getElementById("bpmSlider").value = data.bpm;
              document.getElementById("bpmLabel").textContent = `${data.bpm} BPM`;
            } catch (err) {
              alert("Erro ao carregar JSON.");
            }
          };
          reader.readAsText(file);
        };
        input.click();
      };

      // anima√ß√£o cabe√ßa
      cabecaInterval = atualizarCabe√ßa();
    }

    window.onload = iniciar;
  </script>
</body>
</html>
