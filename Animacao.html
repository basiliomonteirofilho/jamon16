<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Baixista + Bateria - Anima√ß√£o Integrada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
      overflow: hidden;
    }

    #orientationOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 9999;
      padding: 16px;
    }

    #orientationOverlay h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }

    #orientationOverlay p {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .appRoot {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #222 0, #050505 60%);
    }

    #topArea {
      position: relative;
      flex: 0 0 58%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 24px;
    }

    #bottomArea {
      flex: 0 0 42%;
      display: flex;
      flex-direction: column;
      background: rgba(5, 5, 5, 0.95);
      border-top: 1px solid #333;
      padding: 6px 10px 10px 10px;
      overflow: hidden;
    }

    #playerControlsRow {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    #playerControlsRow button,
    #playerControlsRow input[type="range"] {
      cursor: pointer;
    }

    #playBtn,
    #playAleatorioBtn,
    #playExportadoBtn,
    #addBaixoCol,
    #addCol,
    #duplicateSeq,
    #clearBaixo,
    #clearAll {
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      font-size: 0.82rem;
      transition: background 0.2s, transform 0.1s;
    }

    #playBtn:hover,
    #playAleatorioBtn:hover,
    #playExportadoBtn:hover,
    #addBaixoCol:hover,
    #addCol:hover,
    #duplicateSeq:hover,
    #clearBaixo:hover,
    #clearAll:hover {
      background: #333;
      transform: translateY(-1px);
    }

    #bpmDisplay {
      min-width: 70px;
      font-weight: 600;
    }

    .sliderGroup {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .sliderGroup label {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .sliderGroup input[type="range"] {
      width: 90px;
    }

    #progressContainer {
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: #2c2c2c;
      overflow: hidden;
      margin-bottom: 8px;
    }

    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00c853, #ffd600);
      transition: width 0.12s linear;
    }

    #gridsArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: auto;
    }

    #baixoLabelRow {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    #baixoLabelRow span {
      font-size: 0.78rem;
      opacity: 0.9;
    }

    #baixoGridContainer {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    #baixoGridLabel {
      width: 60px;
      font-size: 0.78rem;
      text-align: right;
      opacity: 0.85;
      padding-right: 6px;
    }

    #baixoGrid {
      flex: 1;
      display: grid;
      grid-auto-rows: 24px;
      grid-auto-flow: column;
      grid-auto-columns: minmax(20px, 1fr);
      gap: 2px;
      background: #080808;
      padding: 2px;
      border-radius: 4px;
      border: 1px solid #333;
    }

    .gridWrapper {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #drumGrid {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding-top: 2px;
      border-top: 1px solid #222;
      margin-top: 2px;
    }

    .drumRow {
      display: flex;
      align-items: center;
      gap: 4px;
      min-height: 22px;
    }

    .drumLabel {
      width: 60px;
      font-size: 0.76rem;
      text-align: right;
      opacity: 0.85;
      padding-right: 6px;
      white-space: nowrap;
    }

    .composicaoGrid {
      flex: 1;
      display: grid;
      grid-auto-rows: 22px;
      grid-auto-flow: column;
      grid-auto-columns: minmax(20px, 1fr);
      gap: 2px;
      background: #050505;
      padding: 2px;
      border-radius: 4px;
      border: 1px solid #222;
    }

    .cell {
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      border: 1px solid #333;
      background: #151515;
      cursor: pointer;
      user-select: none;
      color: #f5f5f5;
      min-width: 20px;
    }

    .cell.active {
      background: #1b5e20;
      border-color: #00c853;
      font-weight: 600;
    }

    .cell:hover {
      filter: brightness(1.2);
    }

    #animacaoStageWrapper {
      position: relative;
      width: 60vw;
      max-width: 520px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #baixistaStage {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 100%;
      max-height: 360px;
      margin: 0 auto;
    }

    #baixistaStage img {
      position: absolute;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      pointer-events: none;
    }

    #cabecaLayer {
      z-index: 10;
    }

    #troncoBaixoLayer {
      z-index: 5;
    }

    #antebracoLayer {
      z-index: 8;
    }

    #bracoDireitoLayer {
      z-index: 9;
    }

    #pernasLayer {
      z-index: 1;
    }

    .countdownOverlay {
      position: absolute;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1500;
      background: radial-gradient(circle, rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.95));
      color: #fff;
      font-size: 3rem;
      font-weight: bold;
    }

    #selectionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }

    #selectionOverlay.visible {
      display: flex;
    }

    #selectionPanel {
      background: #181818;
      padding: 10px;
      border-radius: 6px;
      max-width: 520px;
      max-height: 70vh;
      overflow: auto;
      border: 1px solid #444;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
    }

    #selectionTitle {
      font-size: 0.9rem;
      margin-bottom: 6px;
      font-weight: 600;
    }

    #selectionOptions {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 4px;
    }

    .selection-option {
      border-radius: 4px;
      background: #222;
      border: 1px solid #555;
      font-size: 0.72rem;
      text-align: center;
      padding: 4px 2px;
      cursor: pointer;
      user-select: none;
    }

    .selection-option.active {
      background: #1b5e20;
      border-color: #00c853;
      font-weight: 600;
    }

    .selection-option.x-option {
      background: #880e4f;
      border-color: #f50057;
    }

    .selection-option.x-option.active {
      background: #ad1457;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-track {
      background: #111;
    }

    #posEditorPanel {
      position: fixed;
      top: 6px;
      left: 6px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }
    #posEditorPanel label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #posEditorPanel select {
      font-size: 12px;
    }
    #posEditButtons button,
    #posCopyCssBtn {
      font-size: 11px;
      padding: 2px 6px;
      cursor: pointer;
    }

    @media (max-width: 900px) {
      #animacaoStageWrapper {
        width: 90vw;
      }
      #baixistaStage {
        max-height: 320px;
      }
      #bottomArea {
        flex-basis: 45%;
      }
      #playerControlsRow {
        font-size: 0.8rem;
      }
    }

    @media (max-width: 600px) {
      #bottomArea {
        flex-basis: 48%;
      }
      #playerControlsRow button {
        padding: 3px 6px;
        font-size: 0.7rem;
      }
      #baixoGrid,
      .composicaoGrid {
        grid-auto-rows: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="orientationOverlay">
    <div>
      <h1>Gire o dispositivo</h1>
      <p>Para uma experi√™ncia melhor, use em modo paisagem (deitado).</p>
    </div>
  </div>

  <!-- Painel de ajuste de posi√ß√£o (modo editor) -->
  <div id="posEditorPanel">
    <label>
      <input type="checkbox" id="posEditToggle" />
      Modo edi√ß√£o de posi√ß√£o
    </label>
    <label for="posPartSelect">Parte:</label>
    <select id="posPartSelect">
      <option value="troncoBaixoLayer">Tronco / Baixo</option>
      <option value="cabecaLayer">Cabe√ßa</option>
      <option value="antebracoLayer">Antebra√ßo</option>
      <option value="bracoDireitoLayer">Bra√ßo direito</option>
      <option value="pernasLayer">Pernas</option>
    </select>
    <div id="posEditButtons">
      <button type="button" id="posUpBtn">‚Üë</button>
      <button type="button" id="posDownBtn">‚Üì</button>
      <button type="button" id="posLeftBtn">‚Üê</button>
      <button type="button" id="posRightBtn">‚Üí</button>
    </div>
    <button type="button" id="posCopyCssBtn">Copiar CSS</button>
    <small>(Use apenas para calibrar, depois pode desativar no c√≥digo.)</small>
  </div>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="baixistaStage">
          <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />
          <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="Tronco/Baixo" />
          <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" alt="Antebra√ßo direito" />
          <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" alt="Bra√ßo direito" />
          <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" alt="Cabe√ßa" />
          <div id="countdownOverlay" class="countdownOverlay">
            <span id="countdownText">3</span>
          </div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="playAleatorioBtn">üé≤ Playback aleat√≥rio</button>
        <button id="playExportadoBtn">üìÅ Carregar JSON exportado</button>

        <span id="bpmDisplay">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />

        <div class="sliderGroup">
          <label for="baixoVolume">Baixo</label>
          <input type="range" id="baixoVolume" min="0" max="1" step="0.01" value="0.9" />
        </div>

        <div class="sliderGroup">
          <label for="drumVolume">Bateria</label>
          <input type="range" id="drumVolume" min="0" max="1" step="0.01" value="0.9" />
        </div>

        <button id="addBaixoCol">+1 passo baixo</button>
        <button id="addCol">+1 passo tudo</button>
        <button id="duplicateSeq">√ó2 √∫ltimos 16</button>
        <button id="clearBaixo">Limpar baixo</button>
        <button id="clearAll">Limpar tudo</button>
      </div>

      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>

      <div id="gridsArea">
        <div id="baixoLabelRow">
          <span>Baixo: clique nas c√©lulas para escolher nota ou X (ghost note).</span>
        </div>
        <div id="baixoGridContainer">
          <div id="baixoGridLabel">Baixo</div>
          <div id="baixoGrid"></div>
        </div>
        <div class="gridWrapper" id="drumGrid"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div id="selectionTitle">Selecione a nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <script src="jamon-engine.js"></script>
  <script>
    let headFrames = [];
    let headFrameIndex = 0;
    let headLoopTimer = null;
    let troncoTimerBpm = null;
    let headTiltTimerBpm = null;
    let lateralTimer = null;
    let animTimers = [];

    let bpmAtual = 120;
    let baixoSeq = [];
    let bateriaSeq = {};
    let isPlaying = false;
    let playbackInterval = null;
    let atualPasso = 0;

    let baixoVolumeGlobal = 0.9;
    let bateriaVolumeGlobal = 0.9;

    let audioBaixoAtual = null;
    let audioBaixoTimer = null;

    let notaAnteriorTronco = null;
    let ultimaCordaUsada = "E";

    const notasValidas = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS",
      "11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B",
      "21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A",
      "31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G",
      "41GS","42A","43AS"
    ];

    const BAIXO_SAMPLES = {};
    notasValidas.forEach(n => {
      BAIXO_SAMPLES[n] = "assets/BaixoMelodia/" + n + ".mp3";
    });
    BAIXO_SAMPLES["x"] = "assets/bass-muted.mp3";

    const drumLines = [
      { id: "bumbo",          label: "B",    file: "bumbo.mp3" },
      { id: "caixa",          label: "C",    file: "caixa.mp3" },
      { id: "caixaAro",       label: "Rim",  file: "caixaAro.mp3" },
      { id: "chimbal",        label: "HH",   file: "chimbal.mp3" },
      { id: "chimbal_pedal",  label: "HHP",  file: "chimbal-pedal.mp3" },
      { id: "chimbalaberto",  label: "HHo",  file: "chimbal-aberto.mp3" },
      { id: "ataque",         label: "Atk",  file: "ataque.mp3" },
      { id: "tom1",           label: "T1",   file: "tom-1.mp3" },
      { id: "tom2",           label: "T2",   file: "tom-2.mp3" },
      { id: "surdo",          label: "Sd",   file: "surdo.mp3" },
      { id: "conducao",       label: "Rd",   file: "conducao.mp3" },
      { id: "conducao_centro",label: "RdC",  file: "conducao-centro.mp3" }
    ];

    function generateHeadFramePaths() {
      const arr = [];
      for (let i = 1; i <= 100; i++) {
        const num = String(i).padStart(4, "0");
        arr.push("animacao/cabeca/cabeca" + num + ".png");
      }
      return arr;
    }

    function preloadImages(urls) {
      return new Promise(resolve => {
        if (!urls || !urls.length) return resolve();
        let loaded = 0;
        urls.forEach(src => {
          const img = new Image();
          img.onload = img.onerror = () => {
            loaded++;
            if (loaded >= urls.length) resolve();
          };
          img.src = src;
        });
      });
    }

    function startHeadLoop() {
      const el = document.getElementById("cabecaLayer");
      if (!el) return;
      if (headLoopTimer) clearInterval(headLoopTimer);
      headLoopTimer = setInterval(() => {
        headFrameIndex = (headFrameIndex + 1) % headFrames.length;
        el.src = headFrames[headFrameIndex];
      }, 1000 / 30);
    }

    function startTroncoBpm(bpm) {
      const el = document.getElementById("troncoBaixoLayer");
      if (!el) return;
      if (troncoTimerBpm) clearInterval(troncoTimerBpm);
      const interval = (60000 / bpm) / 2;
      let up = false;
      troncoTimerBpm = setInterval(() => {
        up = !up;
        el.style.transform = up ? "translateY(-2px)" : "translateY(0px)";
      }, interval);
    }

    function startHeadTiltBpm(bpm) {
      const el = document.getElementById("cabecaLayer");
      if (!el) return;
      if (headTiltTimerBpm) clearInterval(headTiltTimerBpm);
      const interval = (60000 / bpm) / 4;
      let toggle = false;
      headTiltTimerBpm = setInterval(() => {
        toggle = !toggle;
        el.style.transform = toggle ? "rotate(-2deg)" : "rotate(2deg)";
      }, interval);
    }

    function startLateralMovement() {
      const el = document.getElementById("baixistaStage");
      if (!el) return;
      if (lateralTimer) clearInterval(lateralTimer);
      let dir = 1;
      let offset = 0;
      lateralTimer = setInterval(() => {
        offset += dir * 0.4;
        if (offset > 2) dir = -1;
        if (offset < -2) dir = 1;
        el.style.transform = "translateX(" + offset + "px)";
      }, 80);
    }

    function resetAnimTimers() {
      animTimers.forEach(id => clearInterval(id));
      animTimers = [];
    }

    function pararAudioBaixo() {
      if (audioBaixoAtual) {
        audioBaixoAtual.pause();
        audioBaixoAtual.currentTime = 0;
        audioBaixoAtual = null;
      }
      if (audioBaixoTimer) {
        clearTimeout(audioBaixoTimer);
        audioBaixoTimer = null;
      }
    }

    function tocarBateriaNoStep(step, volume) {
      drumLines.forEach(line => {
        const seq = bateriaSeq[line.id];
        if (!seq || step >= seq.length) return;
        const val = seq[step];
        if (val === line.id) {
          const a = new Audio("assets/" + line.file);
          a.volume = volume;
          a.play().catch(e => console.log("Erro ao tocar bateria:", e));
        }
      });
    }

    function tocarNotaAudioBaixo(nota, volume) {
      if (!nota) return;
      let src = BAIXO_SAMPLES[nota];
      if (!src) src = BAIXO_SAMPLES["x"];
      if (audioBaixoAtual) {
        audioBaixoAtual.pause();
        audioBaixoAtual.currentTime = 0;
      }
      const a = new Audio(src);
      a.volume = volume;
      audioBaixoAtual = a;
      audioBaixoAtual.play().catch(e => {
        console.log("Erro ao tocar √°udio do baixo:", nota, e);
      });
    }

    function getPastaDaNota(nota) {
      const idxAtual = notasValidas.indexOf(nota);
      if (idxAtual < 0) return "Pasta_1F";
      
      if (idxAtual < 8) return "Pasta_1F";
      else if (idxAtual < 12) return "Pasta_2FS";
      else if (idxAtual < 16) return "Pasta_3G";
      else if (idxAtual < 20) return "Pasta_4GS";
      else if (idxAtual < 24) return "Pasta_5A";
      else if (idxAtual < 28) return "Pasta_6AS";
      else if (idxAtual < 32) return "Pasta_7B";
      else if (idxAtual < 36) return "Pasta_8C";
      else if (idxAtual < 40) return "Pasta_9CS";
      else if (idxAtual < 44) return "Pasta_10D";
      else if (idxAtual < 48) return "Pasta_11DS";
      else if (idxAtual < 52) return "Pasta_12E";
      else if (idxAtual < 56) return "Pasta_13F";
      else if (idxAtual < 60) return "Pasta_14FS";
      else if (idxAtual < 64) return "Pasta_15G";
      else if (idxAtual < 68) return "Pasta_16GS";
      else if (idxAtual < 72) return "Pasta_17A";
      else if (idxAtual < 76) return "Pasta_18AS";
      else if (idxAtual < 80) return "Pasta_19B";
      else if (idxAtual < 84) return "Pasta_20C";
      else if (idxAtual < 88) return "Pasta_21CS";
      else if (idxAtual < 92) return "Pasta_22D";
      else if (idxAtual < 96) return "Pasta_23DS";
      else return "Pasta_24E";
    }

    function trocarFrameTronco(nota) {
      const tronco = document.getElementById("troncoBaixoLayer");
      if (!tronco) return;
      if (!nota || nota === "x") return;

      const pasta = getPastaDaNota(nota);
      const path = "animacao/tronco_baixo/" + pasta + "/" + nota + ".png";
      tronco.onerror = () => {
        console.warn("Falha ao carregar:", path);
      };
      tronco.src = path;
      notaAnteriorTronco = nota;
    }

    function getCordaDaNota(nota) {
      const m = nota && nota.match(/^(\d+)/);
      if (!m) return "E";
      const n = parseInt(m[1], 10);
      if (n <= 5) return "E";
      if (n <= 10) return "A";
      if (n <= 15) return "D";
      return "G";
    }

    function trocarAntebraco(corda) {
      const el = document.getElementById("antebracoLayer");
      if (!el) return;
      const path = "animacao/antebraco/antebraco" + corda + ".png";
      el.src = path;
    }

    function animarBracoDireito(corda, duracaoMs) {
      const el = document.getElementById("bracoDireitoLayer");
      if (!el) return;
      let frame = 1;
      const totalFrames = 5;
      const intervalo = Math.max(40, duracaoMs / (totalFrames * 2));
      if (!corda) corda = "E";
      clearInterval(el.__timerBraco || 0);

      el.__timerBraco = setInterval(() => {
        const path = "animacao/braco_direito/Corda_" + corda + frame + ".png";
        el.src = path;
        frame++;
        if (frame > totalFrames) {
          frame = 1;
        }
      }, intervalo);
    }

    function tocarNotaComAnimacao(nota, duracaoMs, volume) {
      tocarNotaAudioBaixo(nota, volume);

      if (nota === "x") {
        const cordaGhost = ultimaCordaUsada || "E";
        animarBracoDireito(cordaGhost, duracaoMs);
        return;
      }

      trocarFrameTronco(nota);

      const corda = getCordaDaNota(nota);
      ultimaCordaUsada = corda;

      trocarAntebraco(corda);
      animarBracoDireito(corda, duracaoMs);
    }

    function tocarPasso(passo) {
      const baixoLen = Array.isArray(baixoSeq) ? baixoSeq.length : 0;
      const nota = (passo < baixoLen) ? baixoSeq[passo] : "x";
      const stepTime = (60000 / bpmAtual) / 4;
      tocarNotaComAnimacao(nota, stepTime, baixoVolumeGlobal);
      tocarBateriaNoStep(passo, bateriaVolumeGlobal);

      const totalSteps = Math.max(
        baixoLen,
        ...(drumLines.map(line => (bateriaSeq[line.id] || []).length))
      );
      atualizarBarraProgresso(totalSteps > 0 ? (passo / totalSteps) * 100 : 0);
    }

    function iniciarPlayback() {
      if (isPlaying) return;
      isPlaying = true;
      atualPasso = 0;
      const stepTime = (60000 / bpmAtual) / 4;
      playbackInterval = setInterval(() => {
        tocarPasso(atualPasso);
        atualPasso++;
        const baixoLen = Array.isArray(baixoSeq) ? baixoSeq.length : 0;
        const totalSteps = Math.max(
          baixoLen,
          ...(drumLines.map(line => (bateriaSeq[line.id] || []).length))
        );
        if (totalSteps === 0) return;
        if (atualPasso >= totalSteps) atualPasso = 0;
      }, stepTime);
      document.getElementById("playBtn").innerText = "‚è∏ Pause";
    }

    function pararPlayback() {
      if (!isPlaying) return;
      isPlaying = false;
      clearInterval(playbackInterval);
      playbackInterval = null;
      pararAudioBaixo();
      document.getElementById("playBtn").innerText = "‚ñ∂ Play";
    }

    function togglePlay() {
      if (!isPlaying) iniciarPlayback();
      else pararPlayback();
    }

    function iniciarContagemRegressiva(callback) {
      const overlay = document.getElementById("countdownOverlay");
      const txt = document.getElementById("countdownText");
      if (!overlay || !txt) {
        callback();
        return;
      }
      let valor = 4;
      overlay.style.display = "flex";
      txt.textContent = valor;
      const id = setInterval(() => {
        valor--;
        if (valor <= 0) {
          clearInterval(id);
          overlay.style.display = "none";
          callback();
        } else {
          txt.textContent = valor;
        }
      }, 60000 / bpmAtual);
    }

    async function preScanAnimacao() {
      const frames = [];
      let notaAnt = null;
      (baixoSeq || []).forEach(nota => {
        if (!nota || nota === "x") return;
        const pasta = getPastaDaNota(nota);
        frames.push("animacao/tronco_baixo/" + pasta + "/" + nota + ".png");
        notaAnt = nota;
      });
      await preloadImages(frames);
      console.log("Pr√©-carregamento de imagens da anima√ß√£o conclu√≠do.");
    }

    function tocarPlaybackCompleto(bpm) {
      pararPlayback();
      resetAnimTimers();

      startTroncoBpm(bpm);
      startHeadTiltBpm(bpm);
      startLateralMovement();

      iniciarContagemRegressiva(async () => {
        try {
          await preScanAnimacao();
        } catch (e) {
          console.warn("Falha ao pr√©-carregar imagens da anima√ß√£o:", e);
        }
        iniciarPlayback();
      });
    }

    const selectionOverlay = document.getElementById("selectionOverlay");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionOptions = document.getElementById("selectionOptions");
    const painelSelecao = { tipo: null, seqRef: null, idx: null, cell: null, drumLine: null };

    function abrirPainelSelecaoBaixo(seqRef, idx, cellEl) {
      painelSelecao.tipo = "baixo";
      painelSelecao.seqRef = seqRef;
      painelSelecao.idx = idx;
      painelSelecao.cell = cellEl;
      const valorAtual = seqRef[idx];
      const opcoes = ["x", ...notasValidas];
      selectionTitle.textContent = "Selecione a nota do baixo";
      selectionOptions.innerHTML = "";
      opcoes.forEach(opt => {
        const div = document.createElement("div");
        div.className = "selection-option";
        let label = opt;
        if (opt === "x") {
          div.classList.add("x-option");
          label = "X";
        } else {
          label = opt.replace(/S/g, "#");
        }
        if (opt === valorAtual) div.classList.add("active");
        div.textContent = label;
        div.onclick = () => {
          painelSelecao.seqRef[painelSelecao.idx] = opt;
          const c = painelSelecao.cell;
          c.textContent = label;
          if (opt === "x") c.classList.remove("active");
          else c.classList.add("active");
          fecharPainelSelecao();
        };
        selectionOptions.appendChild(div);
      });
      selectionOverlay.classList.add("visible");
    }

    function fecharPainelSelecao() {
      selectionOverlay.classList.remove("visible");
      Object.keys(painelSelecao).forEach(k => painelSelecao[k] = null);
    }

    selectionOverlay.addEventListener("click", (ev) => {
      if (ev.target === selectionOverlay) fecharPainelSelecao();
    });

    function construirGridBaixo(container, seq) {
      container.innerHTML = "";
      if (!Array.isArray(seq)) return;
      seq.forEach((nota, idx) => {
        const div = document.createElement("div");
        div.className = "cell";
        if (nota === "x") {
          div.textContent = "X";
        } else {
          div.textContent = String(nota).replace(/S/g, "#");
          div.classList.add("active");
        }
        div.onclick = () => abrirPainelSelecaoBaixo(seq, idx, div);
        container.appendChild(div);
      });
    }

    function construirGridBateria(container, bateriaSeqObj) {
      container.innerHTML = "";
      drumLines.forEach(line => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "drumRow";
        const label = document.createElement("div");
        label.className = "drumLabel";
        label.textContent = line.label;
        rowDiv.appendChild(label);
        const rowGrid = document.createElement("div");
        rowGrid.className = "composicaoGrid";
        const seq = bateriaSeqObj[line.id] || [];
        
        // Garantir que a bateria tenha o mesmo n√∫mero de c√©lulas que o baixo
        while (seq.length < baixoSeq.length) {
          seq.push("x");
        }
        
        seq.forEach((item, idx) => {
          const cell = document.createElement("div");
          cell.className = "cell";
          if (item === "x") {
            cell.textContent = "X";
          } else if (item === line.id) {
            cell.textContent = line.label.toUpperCase();
            cell.classList.add("active");
          } else {
            cell.textContent = "?";
          }
          cell.onclick = () => {
            if (seq[idx] === "x") {
              seq[idx] = line.id;
              cell.classList.add("active");
              cell.textContent = line.label.toUpperCase();
            } else {
              seq[idx] = "x";
              cell.classList.remove("active");
              cell.textContent = "X";
            }
          };
          rowGrid.appendChild(cell);
        });
        rowDiv.appendChild(rowGrid);
        container.appendChild(rowDiv);
      });
    }

    function atualizarBarraProgresso(perc) {
      document.getElementById("progressBar").style.width = perc + "%";
    }

    function gerarSequenciaAleatoriaBaixo(tam) {
      const seq = [];
      for (let i = 0; i < tam; i++) {
        if (Math.random() < 0.6) seq.push("x");
        else seq.push(notasValidas[Math.floor(Math.random() * notasValidas.length)]);
      }
      return seq;
    }

    function gerarSequenciasAleatoriasBateria(tam) {
      const obj = {};
      drumLines.forEach(line => {
        obj[line.id] = [];
        for (let i = 0; i < tam; i++) {
          obj[line.id].push(Math.random() < 0.75 ? "x" : line.id);
        }
      });
      return obj;
    }

    function configurarPlaybackExportado() {
      const btn = document.getElementById("playExportadoBtn");
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "application/json";
      input.style.display = "none";
      document.body.appendChild(input);
      btn.onclick = () => input.click();
      input.onchange = async (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        try {
          const txt = await file.text();
          const obj = JSON.parse(txt);
          if (!Array.isArray(obj.baixo) || typeof obj.bpm !== "number" || typeof obj.bateria !== "object") {
            alert("JSON inv√°lido. Esperado: { bpm, baixo[], bateria{bumbo[],...} }");
            return;
          }
          baixoSeq = obj.baixo;
          bpmAtual = obj.bpm;
          drumLines.forEach(line => {
            if (Array.isArray(obj.bateria[line.id])) {
              bateriaSeq[line.id] = obj.bateria[line.id];
            } else {
              bateriaSeq[line.id] = Array(baixoSeq.length).fill("x");
            }
          });
          document.getElementById("bpmSlider").value = bpmAtual;
          document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
          construirGridBaixo(document.getElementById("baixoGrid"), baixoSeq);
          construirGridBateria(document.getElementById("drumGrid"), bateriaSeq);
          tocarPlaybackCompleto(bpmAtual);
        } catch (e) {
          console.error(e);
          alert("Erro ao ler o arquivo JSON.");
        }
      };
    }

    function garantirPaisagem() {
      const overlay = document.getElementById("orientationOverlay");
      function checar() {
        overlay.style.display = (window.innerWidth < window.innerHeight) ? "flex" : "none";
      }
      checar();
      window.addEventListener("resize", checar);
    }

    function iniciarInterface() {
      const baixoGrid = document.getElementById("baixoGrid");
      const drumGrid = document.getElementById("drumGrid");
      const passosIniciais = 16;
      baixoSeq = gerarSequenciaAleatoriaBaixo(passosIniciais);
      bateriaSeq = gerarSequenciasAleatoriasBateria(passosIniciais);
      construirGridBaixo(baixoGrid, baixoSeq);
      construirGridBateria(drumGrid, bateriaSeq);

      document.getElementById("bpmSlider").oninput = () => {
        bpmAtual = parseInt(document.getElementById("bpmSlider").value, 10);
        document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
        startTroncoBpm(bpmAtual);
        startHeadTiltBpm(bpmAtual);
      };

      document.getElementById("baixoVolume").oninput = () => {
        baixoVolumeGlobal = parseFloat(document.getElementById("baixoVolume").value);
      };
      document.getElementById("drumVolume").oninput = () => {
        bateriaVolumeGlobal = parseFloat(document.getElementById("drumVolume").value);
      };

      document.getElementById("addBaixoCol").onclick = () => {
        baixoSeq.push("x");
        construirGridBaixo(baixoGrid, baixoSeq);
      };

      document.getElementById("clearBaixo").onclick = () => {
        baixoSeq = baixoSeq.map(() => "x");
        construirGridBaixo(baixoGrid, baixoSeq);
      };

      document.getElementById("clearAll").onclick = () => {
        baixoSeq = baixoSeq.map(() => "x");
        drumLines.forEach(line => bateriaSeq[line.id] = bateriaSeq[line.id].map(() => "x"));
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      document.getElementById("addCol").onclick = () => {
        baixoSeq.push("x");
        drumLines.forEach(line => {
          if (!Array.isArray(bateriaSeq[line.id])) bateriaSeq[line.id] = [];
          bateriaSeq[line.id].push("x");
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      document.getElementById("duplicateSeq").onclick = () => {
        const bloco = 16;
        if (baixoSeq.length >= bloco) {
          const ultimas = baixoSeq.slice(-bloco);
          baixoSeq = baixoSeq.concat(ultimas);
        }
        drumLines.forEach(line => {
          const arr = bateriaSeq[line.id] || [];
          if (arr.length >= bloco) {
            const ultimas = arr.slice(-bloco);
            bateriaSeq[line.id] = arr.concat(ultimas);
          } else {
            bateriaSeq[line.id] = arr;
          }
        });
        construirGridBaixo(baixoGrid, baixoSeq);
        construirGridBateria(drumGrid, bateriaSeq);
      };

      configurarPlaybackExportado();
    }

    window.onload = async () => {
      garantirPaisagem();
      headFrames = generateHeadFramePaths();
      await preloadImages(headFrames);
      startHeadLoop();
      startTroncoBpm(bpmAtual);
      startHeadTiltBpm(bpmAtual);
      startLateralMovement();
      iniciarInterface();
      if (window.__initPosEditor) window.__initPosEditor();

      document.getElementById("playBtn").onclick = togglePlay;

      document.getElementById("playAleatorioBtn").onclick = () => {
        try {
          if (!window.JamOnEngine || typeof JamOnEngine.generateRandomPlayback !== "function") {
            alert("Engine de playback n√£o encontrada.");
            return;
          }
          const passos = (Array.isArray(baixoSeq) && baixoSeq.length) ? baixoSeq.length : 16;
          const playback = JamOnEngine.generateRandomPlayback(bpmAtual, passos);

          baixoSeq = Array.isArray(playback.bassSeq) ? playback.bassSeq.slice() : [];

          const bateriaOrig = playback.bateriaSeq || {};
          bateriaSeq = {};
          drumLines.forEach(line => {
            const arr = bateriaOrig[line.id];
            if (Array.isArray(arr)) {
              bateriaSeq[line.id] = arr.slice();
            } else {
              bateriaSeq[line.id] = new Array(baixoSeq.length || passos).fill("x");
            }
          });

          construirGridBaixo(document.getElementById("baixoGrid"), baixoSeq);
          construirGridBateria(document.getElementById("drumGrid"), bateriaSeq);
          tocarPlaybackCompleto(bpmAtual);
        } catch (error) {
          console.error("Erro ao gerar playback aleat√≥rio:", error);
          alert("Erro ao gerar playback aleat√≥rio. Veja o console.");
        }
      };
    };

    async function gerarPlaybackAleatorioAvancado(tamanho, bpm) {
      if (window.JamOnEngine && typeof JamOnEngine.generateRandomPlayback === "function") {
        const res = JamOnEngine.generateRandomPlayback(bpm, tamanho);
        return {
          baixo: res.bassSeq || [],
          bateria: res.bateriaSeq || {}
        };
      } else {
        const baixo = gerarSequenciaAleatoriaBaixo(tamanho);
        const bateria = gerarSequenciasAleatoriasBateria(tamanho);
        return { baixo, bateria };
      }
    }

    (function configurarEditorPosicao() {
      const partIds = [
        "cabecaLayer",
        "troncoBaixoLayer",
        "antebracoLayer",
        "bracoDireitoLayer",
        "pernasLayer"
      ];
      const posMap = {};
      let posEditEnabled = false;
      let selectedPartId = "troncoBaixoLayer";

      function lerPosicaoInicial(id) {
        const el = document.getElementById(id);
        if (!el) return { top: 0, left: 0 };
        const st = window.getComputedStyle(el);
        const top = parseInt(st.top || "0", 10) || 0;
        const left = parseInt(st.left || "0", 10) || 0;
        return { top, left };
      }

      function aplicarPosicao(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const p = posMap[id];
        el.style.top = p.top + "px";
        el.style.left = p.left + "px";
      }

      function moverSelecionado(dx, dy) {
        if (!posEditEnabled) return;
        const id = selectedPartId;
        if (!posMap[id]) return;
        posMap[id].left += dx;
        posMap[id].top += dy;
        aplicarPosicao(id);
      }

      function copiarCss() {
        let css = "";
        for (const id of partIds) {
          const p = posMap[id];
          if (!p) continue;
          css += "#" + id + "{ top:" + p.top + "px; left:" + p.left + "px; }\n";
        }
        console.log("CSS sugerido para posicionamento:\n" + css);
        alert("CSS de posicionamento impresso no console (F12). Copie e cole no seu arquivo CSS.");
      }

      window.__initPosEditor = function() {
        partIds.forEach(id => {
          posMap[id] = lerPosicaoInicial(id);
        });

        const toggle = document.getElementById("posEditToggle");
        const select = document.getElementById("posPartSelect");
        const upBtn = document.getElementById("posUpBtn");
        const downBtn = document.getElementById("posDownBtn");
        const leftBtn = document.getElementById("posLeftBtn");
        const rightBtn = document.getElementById("posRightBtn");
        const copyBtn = document.getElementById("posCopyCssBtn");

        if (!toggle || !select) return;

        toggle.addEventListener("change", () => {
          posEditEnabled = toggle.checked;
        });
        select.addEventListener("change", () => {
          selectedPartId = select.value;
        });
        if (upBtn)   upBtn.addEventListener("click", () => moverSelecionado(0, -1));
        if (downBtn) downBtn.addEventListener("click", () => moverSelecionado(0, 1));
        if (leftBtn) leftBtn.addEventListener("click", () => moverSelecionado(-1, 0));
        if (rightBtn)rightBtn.addEventListener("click", () => moverSelecionado(1, 0));
        if (copyBtn) copyBtn.addEventListener("click", copiarCss);
      };
    })();
  </script>
</body>
</html>
