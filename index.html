<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jam On ‚Äì Playback Aleat√≥rio</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121822;--panel-2:#0f141d;--text:#e6edf3;--muted:#9fb3c8;--accent:#5eead4;--accent-2:#22d3ee;--danger:#ff6b6b;--ok:#22c55e;--warning:#fbbf24
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;background:linear-gradient(180deg,var(--bg),#0e1622 40%,#0a1018);color:var(--text);}
    h1{font-size:clamp(1.2rem,2.5vw,1.8rem);margin:0 0 .25rem}
    .app{max-width:1100px;margin:24px auto;padding:16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1e293b;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 2px}
    button,.toggle{cursor:pointer;border:none;padding:10px 14px;border-radius:12px;background:#0b1220;color:var(--text);border:1px solid #253244;transition:all .15s ease;display:inline-flex;gap:8px;align-items:center}
    button:hover,.toggle:hover{transform:translateY(-1px);border-color:#2f4159}
    button.primary{background:linear-gradient(180deg,#0ea5b6,#0891b2);border-color:#0ea5b6}
    button.warn{background:linear-gradient(180deg,#b45309,#92400e)}
    button.danger{background:linear-gradient(180deg,#dc2626,#b91c1c)}
    .toggles{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .toggle[data-on="true"]{background:linear-gradient(180deg,#0f1b2d,#0d2331);box-shadow:inset 0 0 0 2px #1f2a3a}
    .toggle[data-on="true"] .dot{transform:translateX(18px);background:var(--ok)}
    .toggle .label{min-width:120px}
    .toggle .dotwrap{width:36px;height:20px;border-radius:999px;background:#111827;border:1px solid #263244;display:inline-flex;align-items:center;padding:0 2px}
    .toggle .dot{width:16px;height:16px;border-radius:50%;background:#64748b;transition:transform .2s ease,background .2s ease}
    .readout{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .card{background:rgba(15,23,42,.6);border:1px solid #1e293b;border-radius:14px;padding:10px 12px}
    .value{font-size:1.25rem;font-weight:700;color:var(--accent)}
    .muted{color:var(--muted);font-size:.85rem}
    .bpm{display:flex;gap:6px;align-items:center}
    .bpm input{width:80px}
    .bpm button{padding:8px 10px}
    .editor{margin-top:14px}
    .editor h3{margin:.2rem 0 .4rem;font-size:1rem;color:var(--accent)}
    textarea{width:100%;min-height:120px;background:#0b1220;color:var(--text);border:1px solid #253244;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .small{font-size:.82rem;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #263244;border-radius:8px;padding:2px 6px;color:#9fb3c8}
    .footer{opacity:.8;margin-top:12px}
    .pill{display:inline-block;border:1px solid #263244;background:#0b1220;border-radius:999px;padding:2px 8px;margin-right:6px}
    .keytag{background:#0f172a;border-color:#1f2a44}
    a{color:var(--accent-2)}
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h1>Jam On ‚Äì Playback Aleat√≥rio</h1>
      <div class="controls">
        <button id="btnPlay" class="primary">‚ñ∂Ô∏è Play</button>
        <button id="btnPause">‚è∏Ô∏è Pause</button>
        <button id="btnStop" class="danger">‚èπÔ∏è Parar</button>
        <button id="btnRepeat" class="warn">üîÅ Repetir</button>
        <button id="btnBack">‚èÆÔ∏è Voltar</button>
        <button id="btnSave">üíæ Salvar MP3 (5 min)</button>
      </div>

      <div class="toggles">
        <div class="toggle" id="tglBass" data-on="true"><span class="label">Baixo</span><span class="dotwrap"><span class="dot"></span></span></div>
        <div class="toggle" id="tglDrums" data-on="true"><span class="label">Bateria</span><span class="dotwrap"><span class="dot"></span></span></div>
        <div class="toggle" id="tglGtrDist" data-on="true"><span class="label">Guitarra Dist.</span><span class="dotwrap"><span class="dot"></span></span></div>
        <div class="toggle" id="tglGtrClean" data-on="true"><span class="label">Guitarra Limpa</span><span class="dotwrap"><span class="dot"></span></span></div>
      </div>

      <div class="readout">
        <div class="card">
          <div class="muted">Acorde atual</div>
          <div id="uiChord" class="value">‚Äî</div>
          <div class="small">Campo harm√¥nico: <span id="uiKey" class="pill keytag">‚Äî</span> | Divis√£o r√≠tmica: <span id="uiTS" class="pill">‚Äî</span></div>
        </div>
        <div class="card">
          <div class="muted">BPM</div>
          <div class="bpm">
            <button id="bpmDown">‚Äì</button>
            <div id="uiBpm" class="value">100</div>
            <button id="bpmUp">+</button>
          </div>
          <div class="small">Cada pulso = sem√≠nima</div>
        </div>
        <div class="card">
          <div class="muted">Status</div>
          <div id="uiStatus" class="value">Pronto</div>
          <div class="small">Count-in na abertura para pr√©-carregar √°udios.</div>
        </div>
      </div>

      <div class="editor">
        <h3>üéõÔ∏è Editar Levadas (Intro "[]" toca 1x, Loop "()" repete)</h3>
        <div class="row small">
          <span class="pill">Bateria: bu, ca, ch, cha, co, at, to1, to2, su, ba, bch, cch, bc, cc, "-" (sil√™ncio)</span>
        </div>
        <textarea id="drumsPatterns" spellcheck="false"></textarea>
        <div class="row small" style="margin-top:8px">
          <span class="pill">Baixo: sb, m, sm, c, sc, -, ¬∞ (mute anterior), x (ghost)</span>
        </div>
        <textarea id="bassPatterns" spellcheck="false"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnApply">Aplicar Levadas</button>
          <span class="small">Use v√≠rgula <span class="kbd">,</span> para barras. Ex.: <span class="kbd">[ca ca - -] (bch - ch - , cch - ch -)</span></span>
        </div>
      </div>

      <div class="footer small">
        Dica: "Parar" prepara um novo playback aleat√≥rio para o pr√≥ximo Play. "Repetir" reinicia desde a introdu√ß√£o.
      </div>
    </div>
  </div>

  <!-- LameJS para exportar MP3 -->
  <script src="https://unpkg.com/lamejs@1.2.0/lame.min.js"></script>
  <script>
  // ======================
  // CONFIGURA√á√ÉO EDIT√ÅVEL
  // ======================

  // ‚öôÔ∏è Padr√µes iniciais (voc√™ pode editar no UI e clicar "Aplicar Levadas")
  const DEFAULT_DRUMS_TEXT = `Bateria (4/4)\n[ca ca ca - ba - - - ca - ca - to1 - to2 -]\n(ba - ch bu cch - ch - bch - ch - cch - ch -,\n bch - ch bu cch - ch - bch - ch - cch - ch -,\n bch - ch bu cch - ch - bch - ch - cch - ch -,\n bch - ch bu cch - ch - bch - ch - cch - ch -)`;

  const DEFAULT_BASS_TEXT = `Baixo (4/4)\n[sc sc c sm cc cc]\n(c c c c c c c c,\n sc sc sc sc cc sc sc sc sc c,\n sb,\n c c c c c c c c)`;

  // üéµ Campos harm√¥nicos (maiores + menores 7) ‚Äì mapeados para nota√ß√£o usada nos samples
  // Observa√ß√£o: arquivos de baixo usam naturais e sustenidos com sufixo 'S' (AS, CS, DS, FS, GS). Bem√≥is s√£o convertidos.
  const HARMONIC_FIELDS = {
    // MAIORES
    'C': ['C','Dm','Em','F','G','Am','Bm7(b5)'],
    'C#': ['C#','D#m','E#m','F#','G#','A#m','B#m7(b5)'],
    'Db': ['Db','Ebm','Fm','Gb','Ab','Bbm','Cm7(b5)'],
    'D': ['D','Em','F#m','G','A','Bm','C#m7(b5)'],
    'Eb': ['Eb','Fm','Gm','Ab','Bb','Cm','Dm7(b5)'],
    'E': ['E','F#m','G#m','A','B','C#m','D#m7(b5)'],
    'F': ['F','Gm','Am','Bb','C','Dm','Em7(b5)'],
    'F#': ['F#','G#m','A#m','B','C#','D#m','E#m7(b5)'],
    'Gb': ['Gb','Abm','Bbm','Cb','Db','Ebm','Fm7(b5)'],
    'G': ['G','Am','Bm','C','D','Em','F#m7(b5)'],
    'Ab': ['Ab','Bbm','Cm','Db','Eb','Fm','Gm7(b5)'],
    'A': ['A','Bm','C#m','D','E','F#m','G#m7(b5)'],
    'Bb': ['Bb','Cm','Dm','Eb','F','Gm','Am7(b5)'],
    'B': ['B','C#m','D#m','E','F#','G#m','A#m7(b5)'],

    // MENORES (m7)
    'Am7': ['Am7','Bm7(b5)','Cmaj7','Dm7','Em7','Fmaj7','G7'],
    'A#m7': ['A#m7','B#m7(b5)','C#maj7','D#m7','E#m7','F#maj7','G#7'],
    'Bbm7': ['Bbm7','Cm7(b5)','Dbmaj7','Ebm7','Fm7','Gbmaj7','Ab7'],
    'Bm7': ['Bm7','C#m7(b5)','Dmaj7','Em7','F#m7','Gmaj7','A7'],
    'Cm7': ['Cm7','Dm7(b5)','Ebmaj7','Fm7','Gm7','Abmaj7','Bb7'],
    'C#m7': ['C#m7','D#m7(b5)','Emaj7','F#m7','G#m7','Amaj7','B7'],
    'Dm7': ['Dm7','Em7(b5)','Fmaj7','Gm7','Am7','Bbmaj7','C7'],
    'D#m7': ['D#m7','E#m7(b5)','F#maj7','G#m7','A#m7','Bmaj7','C#7'],
    'Ebm7': ['Ebm7','Fm7(b5)','Gbmaj7','Abm7','Bbm7','Cbmaj7','Db7'],
    'Em7': ['Em7','F#m7(b5)','Gmaj7','Am7','Bm7','Cmaj7','D7'],
    'Fm7': ['Fm7','Gm7(b5)','Abmaj7','Bbm7','Cm7','Dbmaj7','Eb7'],
    'F#m7': ['F#m7','G#m7(b5)','A7M','Bm7','C#m7','D7M','E7'],
    'Gm7': ['Gm7','Am7(b5)','Bbmaj7','Cm7','Dm7','Ebmaj7','F7']
  };

  // üé∏ Conjuntos de acordes dispon√≠veis por nota para guitarra (nomes de arquivo)
  const GUITAR_CHORDS_BY_ROOT = {
    A: ['A','A11','A13','A4','A45+','A5','A5+','A6','A7','A75+','A9','A95+','Adim','Am','Am4','Am5','Am5+','Am6','Am7','Am75+','Am79','Am9'],
    AS:['AS','AS11','AS13','AS4','AS45+','AS5','AS5+','AS6','AS7','AS75+','AS9','AS95+','ASdim','ASm','ASm4','ASm5','ASm5+','ASm6','ASm7','ASm75+','ASm79','ASm9'],
    B: ['B','B11','B13','B4','B45+','B5','B5+','B6','B7','B75+','B9','B95+','Bdim','Bm','Bm4','Bm5','Bm5+','Bm6','Bm7','Bm75+','Bm79','Bm9'],
    C: ['C','C11','C13','C4','C45+','C5','C5+','C6','C7','C75+','C9','C95+','Cdim','Cm','Cm4','Cm5','Cm5+','Cm6','Cm7','Cm75+','Cm79','Cm9'],
    CS:['CS','CS11','CS13','CS4','CS45+','CS5','CS5+','CS6','CS7','CS75+','CS9','CS95+','CSdim','CSm','CSm4','CSm5','CSm5+','CSm6','CSm7','CSm75+','CSm79','CSm9'],
    D: ['D','D11','D13','D4','D45+','D5','D5+','D6','D7','D75+','D9','D95+','Ddim','Dm','Dm4','Dm5','Dm5+','Dm6','Dm7','Dm75+','Dm79','Dm9'],
    DS:['DS','DS11','DS13','DS4','DS45+','DS5','DS5+','DS6','DS7','DS75+','DS9','DS95+','DSdim','DSm','DSm4','DSm5','DSm5+','DSm6','DSm7','DSm75+','DSm79','DSm9'],
    E: ['E','E11','E13','E4','E45+','E5','E5+','E6','E7','E75+','E9','E95+','Edim','Em','Em4','Em5','Em5+','Em6','Em7','Em75+','Em79','Em9'],
    F: ['F','F11','F13','F4','F45+','F5','F5+','F6','F7','F75+','F9','F95+','Fdim','Fm','Fm4','Fm5','Fm5+','Fm6','Fm7','Fm75+','Fm79','Fm9'],
    FS:['FS','FS11','FS13','FS4','FS45+','FS5','FS5+','FS6','FS7','FS75+','FS9','FS95+','FSdim','FSm','FSm4','FSm5','FSm5+','FSm6','FSm7','FSm75+','FSm79','FSm9'],
    G: ['G','G11','G13','G4','G45+','G5','G5+','G6','G7','G75+','G9','G95+','Gdim','Gm','Gm4','Gm5','Gm5+','Gm6','Gm7','Gm75+','Gm79','Gm9'],
    GS:['GS','GS11','GS13','GS4','GS45+','GS5','GS5+','GS6','GS7','GS75+','GS9','GS95+','GSdim','GSm','GSm4','GSm5','GSm5+','GSm6','GSm7','GSm75+','GSm79','GSm9']
  };

  // ü•Å Mapeamento de s√≠mbolos da bateria para arquivos (pasta assets)
  const DRUM_FILES = {
    bu:'assets/bumbo.mp3',
    ca:'assets/caixa.mp3',
    ch:'assets/chimbal.mp3',
    cha:'assets/chimbal-aberto.mp3',
    co:'assets/conducao.mp3',
    at:'assets/ataque.mp3',
    to1:'assets/tom1.mp3',
    to2:'assets/tom2.mp3',
    su:'assets/surdo.mp3',
    ba:'assets/bumbo-ataque.mp3',
    bch:'assets/bumbo-chimbal.mp3',
    cch:'assets/caixa-chimbal.mp3',
    bc:'assets/bumbo-conducao.mp3',
    cc:'assets/caixa-conducao.mp3'
  };

  // üé∏ Pastas de acordes de guitarra (na raiz do reposit√≥rio)
  const GTR_DIST_DIR = 'guitarraDistorcao';
  const GTR_CLEAN_DIR = 'guitarraLimpa';

  // üéöÔ∏è Estado
  let AudioCtx, masterGain, clockInterval, nowPlaying=null, isPaused=false, shouldStop=false; 
  let BPM = 100, tsNum = 4, tsDen = 4; // divis√£o r√≠tmica
  let seedHistory = [], currentIndex = -1; // hist√≥rico para "Voltar"
  let introSpec = null, loopSpec = null; // objetos interpretados dos padr√µes
  let instrumentsEnabled = { bass:true, drums:true, gtrDist:true, gtrClean:true };
  let currentKeyName = '-', currentField = [], currentChords = []; // sequ√™ncia de acordes pelos compassos
  let barForGuitarChange = 4; // aleat√≥rio 2..7

  // üîä Nodos de sa√≠da e grava√ß√£o
  let mixBus, recNode, recBuffersL=[], recBuffersR=[], recRecording=false, recLength=0, lameEncoder=null, recordTimeout=null;

  // üîÅ Utilidades
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const choice=arr=>arr[Math.floor(Math.random()*arr.length)];

  // Convers√µes entre nomes (bem√≥is -> sustenidos) para samples do baixo
  const ENHARMONIC = {
    'Db':'CS','Eb':'DS','Gb':'FS','Ab':'GS','Bb':'AS',
    'Cb':'B','Fb':'E','E#':'F','B#':'C'
  };
  const NOTE_TO_SAMPLE = n=> (ENHARMONIC[n]||n).replace('#','S'); // C# -> CS

  // ======================
  // √ÅUDIO & CARREGAMENTO
  // ======================

  const buffers = new Map();

  async function loadSample(url){
    if(buffers.has(url)) return buffers.get(url);
    const res = await fetch(url);
    if(!res.ok) throw new Error('Falha ao carregar: '+url);
    const arr = await res.arrayBuffer();
    const buf = await AudioCtx.decodeAudioData(arr);
    buffers.set(url,buf);
    return buf;
  }

  function playBuffer(buf, when=0, dest=masterGain, options={}){
    const src = AudioCtx.createBufferSource();
    src.buffer = buf;
    if(options.loop){src.loop=true}
    const gain = AudioCtx.createGain();
    gain.gain.value = options.gain ?? 1;
    src.connect(gain).connect(dest);
    if(options.stopAt){src.stop(options.stopAt)}
    src.start(when);
    return {src,gain};
  }

  function metronomeClick(time, strong=false){
    const osc = AudioCtx.createOscillator();
    const g = AudioCtx.createGain();
    osc.frequency.value = strong? 1400 : 900;
    g.gain.value = .0001;
    osc.connect(g).connect(masterGain);
    osc.start(time);
    g.gain.setValueAtTime(.0001,time);
    g.gain.exponentialRampToValueAtTime(.5,time+0.002);
    g.gain.exponentialRampToValueAtTime(.0001,time+0.04);
    osc.stop(time+0.06);
  }

  // ======================
  // PARSER DE LEVADAS
  // ======================

  function parsePatternText(text){
    // Retorna {intro: string[][], loop: string[][], ts:"4/4"}
    const ts = (text.match(/\((\d+\/\d+)\)/)?.[1]) || (text.match(/\((?:.|\n)*\)/)?'4/4':'4/4');
    const introMatch = text.match(/\[(.|\n)*?\]/);
    const loopMatch = text.match(/\((.|\n)*?\)/);
    const sectToBars = s => !s? [] : s.slice(1,-1)
      .split(',')
      .map(line=>line.trim())
      .filter(Boolean)
      .map(bar=> bar.split(/\s+/).filter(Boolean));
    return {
      ts: (text.match(/\d+\/\d+/)?.[0]) || '4/4',
      intro: sectToBars(introMatch? introMatch[0]:''),
      loop: sectToBars(loopMatch? loopMatch[0]:''),
    }
  }

  // ======================
  // GERADOR HARM√îNICO
  // ======================

  function pickHarmonicField(){
    const keys = Object.keys(HARMONIC_FIELDS);
    const keyName = choice(keys);
    return { keyName, field: HARMONIC_FIELDS[keyName].slice() };
  }
  function rootsFromField(field){
    // Converte lista de acordes te√≥ricos para ra√≠zes (para guitarras)
    return field.map(ch=> ch.replace(/maj7|7M|maj|m7\(b5\)|m7|7|m|dim|aug|\+|\d+/g,'').replace(/\s+/g,'').replace(/([A-G])b/g,(m,p)=>ENHARMONIC[p+'b']||m));
  }
  function normalizeRoot(n){
    // Ex.: Db -> CS, Ab -> GS
    const root = n.match(/^[A-G](#|b)?/)[0];
    return (ENHARMONIC[root]||root).replace('#','S');
  }

  function buildChordTimeline(numBars){
    // Seleciona sequ√™ncias aleat√≥rias do campo harm√¥nico
    const seq=[];
    for(let i=0;i<numBars;i++){
      seq.push(choice(currentField));
    }
    return seq;
  }

  // ======================
  // AGENDADOR
  // ======================

  function secondsPerBeat(){return 60/BPM}
  function sixteenthDur(){return secondsPerBeat()/4}

  async function scheduleCountIn(){
    const beats = tsNum; // um compasso de count-in
    const start = AudioCtx.currentTime + 0.1;
    for(let i=0;i<beats;i++){
      metronomeClick(start + i*secondsPerBeat(), i===0);
    }
    return start + beats*secondsPerBeat();
  }

  function patternToSixteenths(barTokens){
    // Para bateria: cada token ocupa 1 semicolcheia (sc). "-" = sil√™ncio.
    return barTokens;
  }

  function bassDurFromToken(tok){
    switch(tok){
      case 'sb': return 16; // 4 sem√≠nimas = 16 sc
      case 'm': return 8;  // 2 sem√≠nimas
      case 'sm': return 4; // 1 sem√≠nima
      case 'c': return 2;  // colcheia
      case 'sc': return 1; // semicolcheia
      case '-': return 1;  // sil√™ncio de sc
      case 'x': return 1;  // ghost nota de sc
      case '¬∞': return 0;  // mute imediato
      default: return 1;
    }
  }

  function pickBassNoteForChord(chord){
    // Retorna caminho do arquivo de baixo adequado ao acorde atual
    // Extrai raiz e qualidade para escolher 1,3,5,7; por simplicidade escolhemos aleatoriamente 1/3/5/8.
    const rootMatch = chord.match(/^[A-G](#|b)?/);
    const root = rootMatch? rootMatch[0] : 'C';
    const scale = ['C','CS','D','DS','E','F','FS','G','GS','A','AS','B'];
    const toIdx = n=> scale.indexOf(NOTE_TO_SAMPLE(n));
    let idx = toIdx(root);
    if(idx<0) idx=0;
    const chordTones = [0,4,7,12]; // 1,3,5,8 simplificado em semitons
    const sel = idx + choice(chordTones);
    const noteName = scale[sel%12];
    const octaves = [ '', '8', '16', '24' ];
    const suff = choice(octaves);
    return suff ? `assets/bass-${noteName}${suff}.mp3` : `assets/bass-${noteName}.mp3`;
  }

  function pickGuitarFile(root, variant, dist=true){
    const dir = dist? GTR_DIST_DIR : GTR_CLEAN_DIR;
    // arquivos organizados por pasta da raiz (ex.: guitarraDistorcao/A/A7.mp3)
    return `${dir}/${root}/${variant}.mp3`;
  }

  async function scheduleSection(sectionBars, startTime, startBarIndex){
    const spb = secondsPerBeat();
    const sc = sixteenthDur();
    let time = startTime;
    let barIndex = startBarIndex;

    for(const bar of sectionBars){
      // Atualiza acorde atual
      const chord = currentChords[barIndex % currentChords.length];
      document.getElementById('uiChord').textContent = chord || '‚Äî';

      // Troca de acorde para guitarra a cada N compassos
      if(barIndex % barForGuitarChange === 0){
        await scheduleGuitars(time, spb*tsNum, chord);
      }

      // BATERIA
      if(instrumentsEnabled.drums){
        const tokens = patternToSixteenths(bar);
        for(let i=0;i<tokens.length;i++){
          const t = tokens[i];
          if(t==='-') continue;
          const file = DRUM_FILES[t];
          if(file){
            const buf = await loadSample(file);
            playBuffer(buf, time + i*sc, mixBus);
          }
        }
      }

      // BAIXO
      if(instrumentsEnabled.bass){
        let cursor = 0; // em sc
        for(const tok of bar){
          if(tok==='¬∞'){
            // mute imediato
            time += 0; // no-op; nota anterior se encerra abaixo (usamos dura√ß√£o curta)
            continue;
          }
          const durSc = bassDurFromToken(tok);
          if(tok==='-' ){ cursor += durSc; continue; }
          if(tok==='x'){
            const ghost = await loadSample('assets/bass-muted.mp3');
            playBuffer(ghost, time + cursor*sc, mixBus, {gain:.7});
            cursor += durSc; continue;
          }
          // Nota real
          const noteFile = pickBassNoteForChord(chord);
          const buf = await loadSample(noteFile);
          const stopAt = (time + (cursor+durSc)*sc) + 0.001;
          playBuffer(buf, time + cursor*sc, mixBus, {gain:1, stopAt});
          cursor += durSc;
        }
      }

      // metr√¥nomo (apenas para sincronizar count-in visual/√°udio se desejar)
      // metronomeClick(time, true);

      time += spb * tsNum;
      barIndex++;
      if(shouldStop) break;
    }

    return time;
  }

  async function scheduleGuitars(time, barDur, chord){
    const root = normalizeRoot(chord);
    const variants = GUITAR_CHORDS_BY_ROOT[root] || GUITAR_CHORDS_BY_ROOT['C'];
    const variant = choice(variants);
    if(instrumentsEnabled.gtrDist){
      try{ const dist = await loadSample(pickGuitarFile(root, variant, true));
        playBuffer(dist, time, mixBus, {gain:.9}); }catch(e){/* ignora */}
    }
    if(instrumentsEnabled.gtrClean){
      try{ const clean = await loadSample(pickGuitarFile(root, variant, false));
        playBuffer(clean, time+0.02, mixBus, {gain:.9}); }catch(e){/* ignora */}
    }
  }

  async function playCurrent(){
    if(!AudioCtx){
      AudioCtx = new (window.AudioContext||window.webkitAudioContext)();
      masterGain = AudioCtx.createGain();
      masterGain.gain.value=.9;
      mixBus = AudioCtx.createGain();
      mixBus.gain.value=1;
      mixBus.connect(masterGain).connect(AudioCtx.destination);

      // Grava√ß√£o: ScriptProcessor -> buffers PCM -> LameJS
      const proc = AudioCtx.createScriptProcessor(4096, 2, 2);
      mixBus.connect(proc);
      proc.connect(AudioCtx.destination);
      proc.onaudioprocess = (e)=>{
        if(!recRecording) return;
        const L = e.inputBuffer.getChannelData(0);
        const R = e.inputBuffer.getChannelData(1);
        recBuffersL.push(new Float32Array(L));
        recBuffersR.push(new Float32Array(R));
        recLength += L.length;
      };
    }

    shouldStop=false;
    isPaused=false;
    document.getElementById('uiStatus').textContent = 'Carregando... (count-in)';

    // Count-in para pr√©-carregar
    const startAt = await scheduleCountIn();

    const spb = secondsPerBeat();
    const totalBars = 32; // timeline base ‚Äì ser√° tocada em loop do trecho "loop"

    // AGENDA intro + loop
    let t = startAt;
    let barIdx = 0;

    // Intro 1x
    if(introSpec.intro.length){
      t = await scheduleSection(introSpec.intro, t, barIdx);
      barIdx += introSpec.intro.length;
    }

    // Loop infinito at√© pressionar Stop
    document.getElementById('uiStatus').textContent = 'Reproduzindo';

    const loopBars = introSpec.loop.length? introSpec.loop : [['-','-','-','-']];

    function loopOnce(){
      scheduleSection(loopBars, AudioCtx.currentTime+0.05, barIdx).then(()=>{
        if(!shouldStop && !isPaused){ loopOnce(); }
      });
    }
    loopOnce();

    // Iniciar grava√ß√£o autom√°tica somente quando clicar em Salvar
  }

  function stopPlayback(){
    shouldStop=true;
    document.getElementById('uiStatus').textContent = 'Parado (pronto para novo playback)';
  }

  function pausePlayback(){
    if(!AudioCtx) return;
    if(isPaused){ AudioCtx.resume(); document.getElementById('uiStatus').textContent='Reproduzindo'; }
    else { AudioCtx.suspend(); document.getElementById('uiStatus').textContent='Pausado'; }
    isPaused = !isPaused;
  }

  function newRandomSetup(){
    // Sorteia divis√£o r√≠tmica e campo harm√¥nico
    const TS_OPTIONS = ['2/4','3/4','4/4','5/4','6/8'];
    const ts = choice(TS_OPTIONS);
    const [num,den] = ts.split('/').map(Number);
    tsNum=num; tsDen=den;
    barForGuitarChange = rand(2,7);

    const {keyName, field} = pickHarmonicField();
    currentKeyName = keyName;
    currentField = field;

    currentChords = buildChordTimeline(64);

    // Parse padr√µes atuais da UI
    introSpec = parsePatternText(document.getElementById('drumsPatterns').value);
    const bassSpec = parsePatternText(document.getElementById('bassPatterns').value);

    // Unifica bateria e baixo por compasso (mesmo texto de tokens); aqui mantemos separados

    document.getElementById('uiKey').textContent = currentKeyName;
    document.getElementById('uiTS').textContent = `${tsNum}/${tsDen}`;

    // Guarda no hist√≥rico uma semente (texto) para voltar
    const snapshot = {
      bpm:BPM, ts:`${tsNum}/${tsDen}`, key:currentKeyName,
      drumsText: document.getElementById('drumsPatterns').value,
      bassText: document.getElementById('bassPatterns').value,
      chords: currentChords.slice(), gtrEvery: barForGuitarChange,
    };
    seedHistory.push(snapshot);
    currentIndex = seedHistory.length-1;

    // Reconstroi spec combinando bateria/baxo
    // Nota: introSpec armazena apenas bateria; baix0 √© lido dentro do scheduler por token (mesmos arrays)
    // Para permitir edi√ß√µes separadas e mesma divis√£o por sc, mantemos as duas caixas.
  }

  function goBack(){
    if(currentIndex<=0) return;
    currentIndex--;
    const s = seedHistory[currentIndex];
    BPM = s.bpm;
    [tsNum, tsDen] = s.ts.split('/').map(Number);
    currentKeyName = s.key;
    document.getElementById('drumsPatterns').value = s.drumsText;
    document.getElementById('bassPatterns').value = s.bassText;
    currentChords = s.chords.slice();
    barForGuitarChange = s.gtrEvery;
    document.getElementById('uiBpm').textContent=BPM;
    document.getElementById('uiKey').textContent=currentKeyName;
    document.getElementById('uiTS').textContent=`${tsNum}/${tsDen}`;
  }

  // ======================
  // SALVAR MP3 (5 minutos)
  // ======================

  function floatTo16BitPCM(floatBuffer){
    const buffer = new Int16Array(floatBuffer.length);
    for (let i = 0; i < floatBuffer.length; i++) {
      let s = Math.max(-1, Math.min(1, floatBuffer[i]));
      buffer[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
    return buffer;
  }

  function interleave(L, R){
    const length = L.length + R.length;
    const result = new Float32Array(length);
    let index = 0, inputIndex = 0;
    while (index < length) {
      result[index++] = L[inputIndex];
      result[index++] = R[inputIndex];
      inputIndex++;
    }
    return result;
  }

  function encodeToMp3(){
    const sampleRate = AudioCtx.sampleRate;
    const left = mergeBuffers(recBuffersL, recLength);
    const right = mergeBuffers(recBuffersR, recLength);
    const interleaved = interleave(left, right);

    const mp3encoder = new lamejs.Mp3Encoder(2, sampleRate, 128);
    const samples = floatTo16BitPCM(interleaved);
    const blockSize = 1152 * 2; // est√©reo
    const mp3Data = [];

    for (let i = 0; i < samples.length; i += blockSize) {
      const chunk = samples.subarray(i, i + blockSize);
      const mp3buf = mp3encoder.encodeBuffer(chunk);
      if (mp3buf.length > 0) mp3Data.push(mp3buf);
    }
    const end = mp3encoder.flush();
    if (end.length > 0) mp3Data.push(end);
    return new Blob(mp3Data, {type: 'audio/mpeg'});
  }

  function mergeBuffers(recBuffers, recLength){
    const result = new Float32Array(recLength);
    let offset = 0;
    for (let i = 0; i < recBuffers.length; i++) {
      result.set(recBuffers[i], offset);
      offset += recBuffers[i].length;
    }
    return result;
  }

  function startRecordingForFiveMinutes(){
    if(!AudioCtx) return;
    recBuffersL=[]; recBuffersR=[]; recLength=0; recRecording=true;
    document.getElementById('uiStatus').textContent='Gravando (5 min)';
    if(recordTimeout) clearTimeout(recordTimeout);
    recordTimeout = setTimeout(()=>{ stopRecordingAndDownload(); }, 5*60*1000);
  }

  function stopRecordingAndDownload(){
    recRecording=false;
    const blob = encodeToMp3();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `jamon-${Date.now()}.mp3`;
    a.click();
    URL.revokeObjectURL(url);
    document.getElementById('uiStatus').textContent='MP3 salvo';
  }

  // ======================
  // UI BINDINGS
  // ======================

  function setToggle(el, key){
    el.addEventListener('click',()=>{
      const on = el.getAttribute('data-on')==='true';
      el.setAttribute('data-on', String(!on));
      instrumentsEnabled[key]=!on;
    });
  }

  function applyLevadasFromUI(){
    introSpec = parsePatternText(document.getElementById('drumsPatterns').value);
    // baixo: usamos os mesmos tokens e dura√ß√£o (interpreta√ß√£o em tempo real)
  }

  function setupUI(){
    document.getElementById('drumsPatterns').value = DEFAULT_DRUMS_TEXT;
    document.getElementById('bassPatterns').value = DEFAULT_BASS_TEXT;

    document.getElementById('btnApply').addEventListener('click',()=>{
      applyLevadasFromUI();
    });

    document.getElementById('bpmUp').addEventListener('click',()=>{ BPM=clamp(BPM+2,30,240); document.getElementById('uiBpm').textContent=BPM;});
    document.getElementById('bpmDown').addEventListener('click',()=>{ BPM=clamp(BPM-2,30,240); document.getElementById('uiBpm').textContent=BPM;});

    document.getElementById('btnPlay').addEventListener('click',()=>{
      if(nowPlaying && isPaused){ pausePlayback(); return; }
      if(document.getElementById('uiStatus').textContent.startsWith('Parado')){
        newRandomSetup();
      } else if(seedHistory.length===0){
        newRandomSetup();
      }
      playCurrent();
    });

    document.getElementById('btnPause').addEventListener('click',()=>{ pausePlayback(); });
    document.getElementById('btnStop').addEventListener('click',()=>{ stopPlayback(); });
    document.getElementById('btnRepeat').addEventListener('click',()=>{
      stopPlayback();
      // Reinicia com o mesmo snapshot
      const s = seedHistory[currentIndex];
      if(s){
        document.getElementById('drumsPatterns').value = s.drumsText;
        document.getElementById('bassPatterns').value = s.bassText;
        BPM = s.bpm; document.getElementById('uiBpm').textContent=BPM;
        document.getElementById('uiStatus').textContent='Reiniciando...';
        setTimeout(()=> playCurrent(), 150);
      }
    });
    document.getElementById('btnBack').addEventListener('click',()=>{ stopPlayback(); goBack(); });

    document.getElementById('btnSave').addEventListener('click',()=>{
      startRecordingForFiveMinutes();
    });

    setToggle(document.getElementById('tglBass'),'bass');
    setToggle(document.getElementById('tglDrums'),'drums');
    setToggle(document.getElementById('tglGtrDist'),'gtrDist');
    setToggle(document.getElementById('tglGtrClean'),'gtrClean');

    document.getElementById('uiBpm').textContent=BPM;
  }

  // STARTUP
  window.addEventListener('load', setupUI);

  </script>
</body>
</html>
