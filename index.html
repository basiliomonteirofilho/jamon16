<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jam on ‚Äì Playback Aleat√≥rio</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 20px; background: #f0f0f0; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .row { display: flex; align-items: center; margin: 10px 0; }
    .row label { width: 120px; }
    button { padding: 10px; margin: 5px; cursor: pointer; border: none; border-radius: 6px; }
    .primary { background: #4CAF50; color: white; }
    .danger { background: #f44336; color: white; }
    .muted { opacity: 0.6; }
    .chord-display { text-align: center; margin: 20px 0; }
    .chord-name { font-size: 2.5em; margin: 0; }
    .mono { font-family: monospace; font-size: 0.9em; background: #eee; padding: 10px; border-radius: 6px; }
    .footer { font-size: 0.8em; color: #666; margin-top: 10px; }
    .pill { display: inline-block; background: #000; color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; }
    #log { height: 120px; overflow:auto; white-space: pre-wrap; margin-top:10px; }
    .slider-row { display: flex; align-items: center; gap: 10px; margin: 5px 0; }
    .slider-row label { width: 100px; }
    .slider-row input[type=range] { flex: 1; }
    .chord-item {
      display: inline-block;
      padding: 6px 10px;
      margin: 0 4px;
      border-radius: 6px;
      background: #eee;
      transition: background 0.3s;
    }
    .chord-item.current {
      background: #4CAF50;
      color: white;
      font-weight: bold;
    }

    /* --- MELODY ADDON: estilos da matriz --- */
    .melody-panel { margin-top: 16px; }
    .melody-toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
    .melody-block { border: 1px dashed #bbb; border-radius: 8px; padding: 8px; background: #fafafa; margin-bottom: 10px; }
    .melody-table { border-collapse: collapse; width: 100%; table-layout: fixed; }
    .melody-table th, .melody-table td { border: 1px solid #ddd; padding: 2px; text-align: center; }
    .melody-table input { width: 100%; box-sizing: border-box; padding: 6px; text-align: center; }
    .melody-caption { font-size: 0.9em; color: #333; margin-bottom: 6px; }
    .line-label { font-size: 0.85em; color: #444; }
  </style>
</head>
<body>
  <header>
    <h1>Jam on ‚Äì Playback Aleat√≥rio (baixo + bateria + guitarra)</h1>
    <div class="pill">Cada pulso do BPM = sem√≠nima</div>
  </header>

  <div class="chord-display">
    <h2 class="chord-name" id="currentChord">‚Äî</h2>
    <div id="chordTimer">‚Äî</div>
    <div id="chordProgression" style="margin-top: 10px; font-size: 1.2em; font-family: monospace;">
      <!-- Os acordes aparecer√£o aqui -->
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button id="btnPlay" class="primary">‚ñ∂ Play</button>
      <button id="btnPause">‚è∏ Pause</button>
      <button id="btnStop" class="danger">‚èπ Stop</button>
      <button id="btnSave" class="primary">üíæ Salvar 4 min (MP3)</button>

      <div style="margin-top: 10px;">
        <button id="muteBass" data-mute="off">üé∏ Baixo</button>
        <button id="muteDrums" data-mute="off">ü•Å Bateria</button>
        <button id="muteClean" data-mute="off">üé∏ Limpa</button>
        <button id="muteDist" data-mute="off">üî• Distor√ß√£o</button>
      </div>

      <div class="row">
        <label>BPM</label>
        <input id="bpm" type="number" min="40" max="220" value="100" style="width:90px">
      </div>

      <div class="row">
        <label>Assinatura</label>
        <select id="meter">
          <option value="auto" selected>aleat√≥ria</option>
          <option>2/4</option>
          <option>3/4</option>
          <option>4/4</option>
          <option>5/4</option>
          <option>6/4</option>
          <option>7/4</option>
        </select>
      </div>

      <!-- Sliders de Volume -->
      <div style="margin-top: 15px;">
        <h3>Controle de Volume</h3>
        <div class="slider-row">
          <label>Baixo</label>
          <input type="range" id="volBass" min="0" max="1" step="0.01" value="0.45">
          <span id="volBassLabel">45%</span>
        </div>
        <div class="slider-row">
          <label>Bateria</label>
          <input type="range" id="volDrums" min="0" max="1" step="0.01" value="0.6">
          <span id="volDrumsLabel">60%</span>
        </div>
        <div class="slider-row">
          <label>Limpa</label>
          <input type="range" id="volClean" min="0" max="1" step="0.01" value="0.45">
          <span id="volCleanLabel">45%</span>
        </div>
        <div class="slider-row">
          <label>Distorcida</label>
          <input type="range" id="volDist" min="0" max="1" step="0.01" value="0.35">
          <span id="volDistLabel">35%</span>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Estado atual</h3>
      <div class="mono" id="state"></div>
      <div class="footer">Ao clicar em <b>Play</b>, gera um novo playback aleat√≥rio.</div>
    </div>

    <div class="panel">
      <h3>Arquivos esperados</h3>
      <div class="mono">
        <div>Coloque os √°udios nas pastas:</div>
        <ul>
          <li><b>guitarraLimpa/[nota]/[nota][tipo].mp3</b> ‚Äî Ex: guitarraLimpa/A/A.mp3 ou guitarraLimpa/C/Cm.mp3</li>
          <li><b>guitarraDistorcao/[nota]/[nota][tipo].mp3</b></li>
          <li><b>assets/bumbo.mp3</b>, <b>assets/caixa.mp3</b>, <b>assets/chimbal.mp3</b></li>
          <li><b>assets/bass-A.mp3</b>, <b>assets/bass-AS.mp3</b>, etc. (A, AS, B, C, CS, ...)</li>
          <li><b>assets/bass-muted.mp3</b> ‚Üí para ghost note (x)</li>
        </ul>
      </div>
    </div>

    <!-- --- MELODY ADDON: Painel da matriz de melodia --- -->
    <div class="panel melody-panel">
      <h3>üé∏ Melodia da Guitarra (notas individuais)</h3>
      <div class="melody-toolbar">
        <button id="btnMelodyAdd" class="primary">‚ûï Adicionar bloco de matriz</button>
        <button id="btnMelodyClear" class="danger">üßπ Limpar blocos</button>
        <span>As linhas: <b>Semibreve</b>, <b>M√≠nima</b>, <b>Sem√≠nima</b>, <b>Colcheia</b>, <b>Semicolcheia</b>.  
        Use n√∫meros (1‚Äì49), <b>x</b> (sil√™ncio), <b>¬∞</b> (mute imediato).</span>
      </div>
      <div id="melodyBlocks"></div>
      <div class="footer">Os arquivos de nota devem estar em <code>guitarraDistorcao/Melodia/</code> com nomes como <code>13E.mp3</code>, <code>22CS.mp3</code>‚Ä¶</div>
    </div>

    <div class="log mono" id="log"></div>
  </div>

  <script>
    // Fun√ß√£o de transposi√ß√£o: 3 semitons abaixo
    function transposeDown3Semitones(note) {
      const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const index = notes.indexOf(note);
      if (index === -1) return note;
      const newIndex = (index - 3 + 12) % 12;
      return notes[newIndex];
    }

    const ui = {
      play: document.getElementById('btnPlay'),
      pause: document.getElementById('btnPause'),
      stop: document.getElementById('btnStop'),
      save: document.getElementById('btnSave'),
      muteBass: document.getElementById('muteBass'),
      muteDrums: document.getElementById('muteDrums'),
      muteClean: document.getElementById('muteClean'),
      muteDist: document.getElementById('muteDist'),
      bpm: document.getElementById('bpm'),
      meter: document.getElementById('meter'),
      state: document.getElementById('state'),
      log: document.getElementById('log'),
      currentChord: document.getElementById('currentChord'),
      chordTimer: document.getElementById('chordTimer'),
      volBass: document.getElementById('volBass'),
      volDrums: document.getElementById('volDrums'),
      volClean: document.getElementById('volClean'),
      volDist: document.getElementById('volDist'),
      volBassLabel: document.getElementById('volBassLabel'),
      volDrumsLabel: document.getElementById('volDrumsLabel'),
      volCleanLabel: document.getElementById('volCleanLabel'),
      volDistLabel: document.getElementById('volDistLabel'),

      // --- MELODY ADDON ---
      melodyBlocks: document.getElementById('melodyBlocks'),
      btnMelodyAdd: document.getElementById('btnMelodyAdd'),
      btnMelodyClear: document.getElementById('btnMelodyClear')
    };

    const audio = {
      ctx: null,
      master: null,
      mix: null,
      drumGain: null,
      bassGain: null,
      cleanGain: null,
      distGain: null,
      schedulerTimer: null
    };

    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
    const CHORD_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

    const DRUMS = {
      ba: 'bumbo-ataque',
      cch:  'caixa-chimbal',
      bch: 'bumbo-chimbal',
      bu: 'bumbo',
      ca: 'caixa',
      ch: 'chimbal'
    };

    // Bass samples
    const BASS_SAMPLES = {};
    for (const p of PITCHES) {
      BASS_SAMPLES[p] = `assets/bass-${p}.mp3`;
    }
    BASS_SAMPLES['x'] = 'assets/bass-muted.mp3'; // ghost note

    const ALL_GROOVES = [
      {
        name: "Rock B√°sico",
        meter: "4/4",
        drumPattern: ["ba - ch - cch - ch - bch - ch - cch - ch bu", "ba - ch - cch - ch - bch - ch - cch - ch bu"],
        bassRhythm: ["bo - sm - bo - sm - bo - sm - bo bo bo bo", "bo - sm - bo - sm - bo - sm - bo x bo bo"]
      },
