<!DOCTYPE html> 
<html lang="pt-BR"> 
<head> 
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>Jam on ‚Äì Playback Aleat√≥rio</title> 
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script> 
  <style> 
    :root { 
      --bg: #0b0f14; 
      --panel: #121822; 
      --accent: #5eead4; 
      --muted: #7a89a6; 
      --text: #e6edf6; 
      --danger: #f87171; 
      --ok: #86efac; 
    } 
    * { 
      box-sizing: border-box; 
    } 
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 
"Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; 
      min-height: 100vh; 
      display: grid; 
      place-items: center; 
    } 
    .wrap { 
      width: min(1100px, 92vw); 
    } 
    header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 1rem; 
      margin: 2rem 0 1.25rem; 
    } 
    h1 { 
      font-size: clamp(1.4rem, 2.2vw, 2rem); 
      margin: 0; 
      letter-spacing: .3px; 
    } 
    .chord-display { 
      grid-column: span 12; 
      text-align: center; 
      margin: 1rem 0; 
    } 
    .chord-name { 
      font-size: 4rem; 
      font-weight: bold; 
      color: var(--accent); 
      margin: 0; 
    } 
    .chord-timer { 
      font-size: 1.5rem; 
      color: var(--ok); 
    } 
    .card { 
      background: linear-gradient(180deg, #121822, #0d131c); 
      border: 1px solid #1e293b; 
      border-radius: 18px; 
      padding: 1rem; 
      box-shadow: 0 10px 40px rgba(0,0,0,.25); 
    } 
    .grid { 
      display: grid; 
      grid-template-columns: repeat(12, 1fr); 
      gap: 12px; 
    } 
    .controls { 
      grid-column: span 12; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      align-items: center; 
    } 
    .controls button, 
    .controls select, 
    .controls input[type="number"] { 
      background: #0f172a; 
      color: var(--text); 
      border: 1px solid #1f2937; 
      border-radius: 12px; 
      padding: .65rem .9rem; 
      font-size: .95rem; 
      outline: none; 
    } 
    .controls button.muted { 
      opacity: 0.5; 
      text-decoration: line-through; 
    } 
    .controls button { 
      cursor: pointer; 
      border-color: #334155; 
      transition: transform .06s ease, background .2s ease, border-color .2s ease; 
    } 
    .controls button:hover { 
      transform: translateY(-1px); 
    } 
    .controls button.primary { 
      background: #0b3b39; 
      border-color: #134e4a; 
    } 
    .controls button.primary[data-state="on"] { 
      background: #065f46; 
      border-color: #0f766e; 
    } 
    .controls button.danger { 
      background: #3b0b0b; 
      border-color: #7f1d1d; 
    } 
    .pill { 
      background: #0b1320; 
      border: 1px solid #1f2a44; 
      padding: .4rem .6rem; 
      border-radius: 999px; 
      font-size: .85rem; 
      color: var(--muted); 
    } 
    .split { 
      grid-column: span 12; 
      display: grid; 
      grid-template-columns: repeat(12, 1fr); 
      gap: 12px; 
    } 
    .panel { 
      grid-column: span 6; 
      background: #0b0f16; 
      border: 1px solid #1b2538; 
      border-radius: 12px; 
      padding: 12px; 
    } 
    .panel h3 { 
      margin: 0 0 8px; 
      font-size: 1rem; 
      color: #a6b4cf; 
    } 
    .mono { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation 
Mono", "Courier New", monospace; 
      font-size: .92rem; 
    } 
    .log { 
      grid-column: span 12; 
      background: #080c12; 
      border: 1px dashed #1b283b; 
      border-radius: 12px; 
      padding: 10px; 
      height: 170px; 
      overflow: auto; 
      white-space: pre-wrap; 
      font-size: .9rem; 
      color: #cbd5e1; 
    } 
    .footer { 
      margin: .75rem 0 0; 
      color: var(--muted); 
      font-size: .85rem; 
    } 
    .badge { 
      display: inline-block; 
      padding: .15rem .45rem; 
      border-radius: 6px; 
      border: 1px solid #294256; 
      background: #0b1826; 
      color: #9bd5f0; 
      font-size: .8rem; 
    } 
    .row { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; 
    } 
    .spacer { 
      flex: 1 1 auto; 
    } 
    .muted { 
      opacity: 0.5; 
    } 
    .groove-editor { 
      grid-column: span 12; 
      background: #0b0f16; 
      border: 1px solid #1b2538; 
      border-radius: 12px; 
      padding: 12px; 
      margin-top: 12px; 
    } 
    .groove-editor h3 { 
      margin: 0 0 8px; 
      font-size: 1rem; 
      color: #a6b4cf; 
    } 
    .groove-editor textarea { 
      width: 100%; 
      background: #0f172a; 
      color: var(--text); 
      border: 1px solid #1f2937; 
      border-radius: 8px; 
      padding: 8px; 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation 
Mono", "Courier New", monospace; 
      font-size: 0.9rem; 
      min-height: 80px; 
      resize: vertical; 
    } 
    .groove-editor button { 
      margin-top: 8px; 
      background: #0b3b39; 
      border: 1px solid #134e4a; 
      color: var(--text); 
      padding: 6px 12px; 
      border-radius: 6px; 
      cursor: pointer; 
    } 
  </style> 
</head> 
<body> 
  <div class="wrap"> 
    <header> 
      <h1>Jam on ‚Äì Playback Aleat√≥rio (baixo + bateria + guitarra)</h1> 
      <div class="pill">Cada pulso do BPM = sem√≠nima</div> 
    </header> 
 
    <!-- Visor de acorde --> 
    <div class="chord-display"> 
      <h2 class="chord-name" id="currentChord">‚Äî</h2> 
      <div class="chord-timer" id="chordTimer">‚Äî</div> 
    </div> 
 
    <section class="card"> 
      <div class="grid"> 
        <div class="controls"> 
          <button id="btnRestart">‚èÆ Reiniciar</button> 
          <button id="btnPrev">
 ‚è™
 Anterior</button> 
          <button id="btnPlay" class="primary">‚ñ∂ Play</button> 
          <button id="btnPause">
 ‚è∏
 Pause</button> 
          <button id="btnStop" class="danger">
 ‚èπ
 Stop</button> 
          <button id="btnSave" class="primary">
 üíæ
 Salvar 4 min (MP3)</button> 
 
          <span class="spacer"></span> 
          <button id="muteBass" data-mute="off">
 üé∏
 Baixo</button> 
          <button id="muteDrums" data-mute="off">
 ü•Å
 Bateria</button> 
          <button id="muteClean" data-mute="off">
 üé∏
 Limpa</button> 
          <button id="muteDist" data-mute="off">
 üî•
 Distor√ß√£o</button> 
 
          <label class="row"> 
            BPM 
            <input id="bpm" type="number" min="40" max="220" value="100" 
style="width:90px"> 
          </label> 
          <label class="row"> 
            Assinatura 
            <select id="meter"> 
              <option value="auto" selected>aleat√≥ria</option> 
              <option>2/4</option> 
              <option>3/4</option> 
              <option>4/4</option> 
              <option>5/4</option> 
              <option>6/4</option> 
              <option>7/4</option> 
            </select> 
          </label> 
        </div> 
 
        <div class="groove-editor"> 
          <h3>Editor de Levadas</h3> 
          <div class="row"> 
            <div style="flex: 1;"> 
              <label>Bateria:</label> 
              <textarea id="drumPattern" placeholder="Ex: [ca ca ca - ba - - - ca - ca - to1 - 
to2-]&#10;(ba - ch bu cch - ch - bch - ch - cch - ch -)"></textarea> 
            </div> 
            <div style="flex: 1;"> 
              <label>Baixo:</label> 
              <textarea id="bassRhythm" placeholder="Ex: [sc sc c sm cc cc]&#10;(c c c c c c c 
c)"></textarea> 
            </div> 
          </div> 
          <div class="row"> 
            <div style="flex: 1;"> 
              <label>Nome do Estilo:</label> 
              <input type="text" id="grooveName" placeholder="Ex: Rock B√°sico" style="width: 
100%;"> 
            </div> 
            <div style="flex: 1;"> 
              <label>Compasso:</label> 
              <select id="grooveMeter" style="width: 100%;"> 
                <option>2/4</option> 
                <option>3/4</option> 
                <option selected>4/4</option> 
                <option>5/4</option> 
                <option>6/4</option> 
                <option>7/4</option> 
              </select> 
            </div> 
          </div> 
          <button id="btnApplyGroove">Aplicar Levada</button> 
        </div> 
 
        <div class="split"> 
          <div class="panel" style="grid-column: span 6;"> 
            <h3>Estado atual</h3> 
            <div class="mono" id="state"></div> 
            <div class="footer">Ao clicar em <b>Play</b>, gera um novo playback 
aleat√≥rio.</div> 
          </div> 
 
          <div class="panel" style="grid-column: span 6;"> 
            <h3>Arquivos esperados</h3> 
            <div class="mono"> 
              <div>Coloque os √°udios nas pastas:</div> 
              <ul> 
                <li><b>guitarraLimpa/[nota]/acorde.mp3</b> (ex: 
<code>guitarraLimpa/A/A.mp3</code>, <code>guitarraLimpa/A/Am.mp3</code>)</li> 
                <li><b>guitarraDistorcao/[nota]/acorde.mp3</b> (ex: 
<code>guitarraDistorcao/AS/AS7.mp3</code>, 
<code>guitarraDistorcao/C/C.mp3</code>)</li> 
                <li>Pe√ßas de bateria: <b>bumbo.mp3</b>, <b>caixa.mp3</b>, etc.</li> 
                <li>Baixo: <b>bass-A.mp3</b>, <b>bass-AS.mp3</b>, etc.</li> 
              </ul> 
            </div> 
          </div> 
 
          <div class="log mono" id="log"></div> 
        </div> 
      </div> 
    </section> 
  </div> 
 
  <script> 
    const ui = { 
      play: document.getElementById('btnPlay'), 
      pause: document.getElementById('btnPause'), 
      stop: document.getElementById('btnStop'), 
      save: document.getElementById('btnSave'), 
      muteBass: document.getElementById('muteBass'), 
      muteDrums: document.getElementById('muteDrums'), 
      muteClean: document.getElementById('muteClean'), 
      muteDist: document.getElementById('muteDist'), 
      bpm: document.getElementById('bpm'), 
      meter: document.getElementById('meter'), 
      log: document.getElementById('log'), 
      state: document.getElementById('state'), 
      currentChord: document.getElementById('currentChord'), 
      chordTimer: document.getElementById('chordTimer'), 
      btnRestart: document.getElementById('btnRestart'), 
      btnPrev: document.getElementById('btnPrev'), 
      drumPattern: document.getElementById('drumPattern'), 
      bassRhythm: document.getElementById('bassRhythm'), 
      grooveName: document.getElementById('grooveName'), 
      grooveMeter: document.getElementById('grooveMeter'), 
      btnApplyGroove: document.getElementById('btnApplyGroove') 
    }; 
 
    const audio = { 
      ctx: null, 
      master: null, 
      mix: null, 
      drumGain: null, 
      bassGain: null, 
      cleanGain: null, 
      distGain: null, 
      schedulerTimer: null, 
      lookahead: 0.1, 
      scheduleHorizon: 0.25, 
    }; 
 
    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS']; 
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 }; 
 
    const DRUMS = { 
      bu: 'bumbo', // bumbo.mp3 
      ca: 'caixa', // caixa.mp3 
      ch: 'chimbal', // chimbal.mp3 
      cha: 'chimbalAberto', // chimbal-aberto.mp3 
      co: 'conducao', // conducao.mp3 
      at: 'ataque', // ataque.mp3 
      to1: 'tom1', // tom1.mp3 
      to2: 'tom2', // tom2.mp3 
      su: 'surdo', // surdo.mp3 
      ba: 'ba', // bumbo + ataque bumbo-ataque.mp3 
      bch: 'bch', // bumbo + chimbal bumbo-chimbal.mp3 
      cch: 'cch', // caixa + chimbal caixa-chimbal.mp3 
      bc: 'bc', // bumbo + condu√ß√£o bumbo-conducao.mp3 
      cc: 'cc' // caixa + condu√ß√£o caixa-conducao.mp3 
    }; 
 
    const BASS_SAMPLES = (() => { 
      const table = {}; 
      for (const p of PITCHES) { 
        const letter = p[0]; 
        const isSharp = p.includes('S'); 
        for (const oct of ['', '8', '16', '24']) { 
          const key = p + (oct || ''); 
          const fileName = `bass-${letter}${oct}${isSharp ? 'S' : ''}.mp3`; 
          table[key] = `assets/${fileName}`; 
        } 
      } 
      table['X'] = 'assets/bass-muted.mp3'; 
      return table; 
    })(); 
 
    // Mapeamento acorde ‚Üí notas do baixo (mantido igual ao fornecido) 
    const BASS_NOTE_MAP = { 
       
// A 
'A':     ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A11':   ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A13':   ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A4':    ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A45+':  ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A5':    ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A5+':   ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A6':    ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A7':    ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A75+':  ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A9':    ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'A95+':  ['A','A8','A16','CS','CS8','CS16','E','E8','E16'], 
'Adim':  ['A','A8','A16','C','C8','C16','DS','DS8','DS16'], 
'Am':    ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am4':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am5':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am5+':  ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am6':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am7':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am75+': ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am79':  ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am9':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
// B 
'B':     ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B11':   ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B13':   ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B4':    ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B45+':  ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B5':    ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B5+':   ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B6':    ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B7':    ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B75+':  ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B9':    ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'B95+':  ['B','B8','B16','DS','DS8','DS16','FS','FS8','FS16'], 
'Bdim':  ['B','B8','B16','D','D8','D16','F','F8','F16'], 
'Bm':    ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm4':   ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm5':   ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm5+':  ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm6':   ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm7':   ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm75+': ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm79':  ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
'Bm9':   ['B','B8','B16','D','D8','D16','FS','FS8','FS16'], 
// C 
'C':     ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C11':   ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C13':   ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C4':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C45+':  ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C5':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C5+':   ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C6':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C7':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C75+':  ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C9':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C95+':  ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'Cdim':  ['C','C8','C16','DS','DS8','DS16','A','A8','A16'], 
'Cm':    ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm4':   ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm5':   ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm5+':  ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm6':   ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm7':   ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm75+': ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm79':  ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
'Cm9':   ['C','C8','C16','DS','DS8','DS16','G','G8','G16'], 
// CS 
'CS':     ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS11':   ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS13':   ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS4':    ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS45+':  ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS5':    ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS5+':   ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS6':    ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS7':    ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS75+':  ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS9':    ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CS95+':  ['CS','CS8','CS16','F','F8','F16','GS','GS8','GS16'], 
'CSdim':  ['CS','CS8','CS16','E','E8','E16','G','G8','G16'], 
'CSm':    ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm4':   ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm5':   ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm5+':  ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm6':   ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm7':   ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm75+': ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm79':  ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
'CSm9':   ['CS','CS8','CS16','E','E8','E16','GS','GS8','GS16'], 
// D 
'D':     ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D11':   ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D13':   ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D4':    ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D45+':  ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D5':    ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D5+':   ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D6':    ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D7':    ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D75+':  ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D9':    ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'D95+':  ['D','D8','D16','FS','FS8','FS16','A','A8','A16'], 
'Ddim':  ['D','D8','D16','F','F8','F16','GS','GS8','GS16'], 
'Dm':    ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm4':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm5':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm5+':  ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm6':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm7':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm75+': ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm79':  ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm9':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
// DS 
'DS':     ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS11':   ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS13':   ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS4':    ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS45+':  ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS5':    ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS5+':   ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS6':    ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS7':    ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS75+':  ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS9':    ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DS95+':  ['DS','DS8','DS16','G','G8','G16','AS','AS8','AS16'], 
'DSdim':  ['DS','DS8','DS16','FS','FS8','FS16','A','A8','A16'], 
'DSm':    ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm4':   ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm5':   ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm5+':  ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm6':   ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm7':   ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm75+': ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm79':  ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
'DSm9':   ['DS','DS8','DS16','FS','FS8','FS16','AS','AS8','AS16'], 
// E 
'E':     ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E11':   ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E13':   ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E4':    ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E45+':  ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E5':    ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E5+':   ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E6':    ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E7':    ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E75+':  ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E9':    ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'E95+':  ['E','E8','E16','E24','GS','GS8','GS16','B','B8','B16'], 
'Edim':  ['E','E8','E16','G','G8','G16','AS','AS8','AS16'], 
'Em':    ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em4':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em5':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em5+':  ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em6':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em7':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em75+': ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em79':  ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em9':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
// F 
'F':     ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F11':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F13':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F4':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F45+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F5':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F5+':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F6':    
['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F45+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F5':    
['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F5+':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F6':    
'F7': ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F75+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F9':    
['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F95+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'Fdim':  ['F','F8','F16','GS','GS8','GS16','B','B8','B16'], 
'Fm':    ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm4':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm5':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm5+':  ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm6':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm7':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm75+': ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm79':  ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm9':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
// FS 
'FS':    ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS11':  ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'F7':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F75+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F9':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F95+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'Fdim':  ['F','F8','F16','GS','GS8','GS16','B','B8','B16'], 
'Fm':    ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm4':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm5':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm5+':  ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm6':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm7':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm75+': ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm79':  ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
'Fm9':   ['F','F8','F16','F24','GS','GS8','GS16','C','C8','C16'], 
// FS 
'FS':     ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS11':   ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS13':   ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS4':    ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS45+':  ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS5':    ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS5+':   ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS6':    ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS7':    ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS75+':  ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS9':    ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FS95+':  ['FS','FS8','FS16','FS24','AS','AS8','AS16','CS','CS8','CS16'], 
'FSdim':  ['FS','FS8','FS16','A','A8','A16','C','C8','C16'], 
'FSm':    ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm4':   ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm5':   ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm5+':  ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm6':   ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm7':   ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm75+': ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm79':  ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
'FSm9':   ['FS','FS8','FS16','FS24','A','A8','A16','CS','CS8','CS16'], 
// G 
'G':     ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G11':   ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G13':   ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G4':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G45+':  ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G5':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G5+':   ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G6':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G7':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G75+':  ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G9':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G95+':  ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'Gdim':  ['G','G8','G16','AS','AS8','AS16','CS','CS8','CS16'], 
'Gm':    ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm4':   ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm5':   ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm5+':  ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm6':   ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm7':   ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm75+': ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm79':  ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
'Gm9':   ['G','G8','G16','G24','AS','AS8','AS16','D','D8','D16'], 
// GS 
'GS':     ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS11':   ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS13':   ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS4':    ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS45+':  ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS5':    ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS5+':   ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS6':    ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS7':    ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS75+':  ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS9':    ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GS95+':  ['GS','GS8','GS16','C','C8','C16','DS','DS8','DS16'], 
'GSdim':  ['GS','GS8','GS16','B','B8','B16','D','D8','D16'], 
'GSm':    ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm4':   ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm5':   ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm5+':  ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm6':   ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm7':   ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm75+': ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm79':  ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'], 
'GSm9':   ['GS','GS8','GS16','B','B8','B16','DS','DS8','DS16'] 
    }; 
 
    const CUSTOM_GROOVES = [ 
      { name:"Rock B√°sico", meter:"4/4", drumPattern:["[ba - ch - cch - ch - bch - ch - cch - ch]","(ba - ch - cch - ch - bch - ch - cch - ch)"], 
bassRhythm:["[sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -]","(sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -)"] }, 

      { name:"Pop", meter:"4/4", drumPattern:["[ba - ch - cch - ch - bch - ch - cch - ch]","(ba - ch - cch - ch - bch - ch - cch - ch)"], 
bassRhythm:["[sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -]","(sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -)"] }, 

      { name:"Groove Alternado", meter:"4/4", drumPattern:["[ba - ch - cch - ch - bch - ch - cch - ch]","(ba - ch - cch - ch - bch - ch - cch - ch)"], 
bassRhythm:["[sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -]","(sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -)"] } 
    ]; 
 
    const PROGRESSIONS = [ 
      [1, 1, 1, 1, 4, 4, 5, 5], 
      [1, 1, 1, 1, 5, 5, 6, 6, 4, 4, 5, 5], 
      [1, 1, 1, 1, 4, 4, 5, 5, 1, 1, 1, 1] 
    ]; 
 
    const lastState = { 
      chordProgression: [], 
      key: null, 
      quality: null, 
      currentGroove: null, 
      meter: null 
    }; 
 
    const state = { 
      running: false, 
      paused: false, 
      nextNoteTime: 0, 
      meter: '4/4', 
      bpm: 100, 
      sixteenthDur: 0.15, 
      stepIndex: 0, 
      pattern: [], 
      buffers: { drums: {}, bass: {}, guitar: {} }, 
      lastBassSrc: null, 
      bassPlan: [], 
      bassNoteEndTime: 0, 
      signatureTag: '', 
      key: null, 
      keyIdx: 0, 
      quality: 'maj', 
      chordProgression: [], 
      chordDurations: [], 
      currentGroove: null, 
      currentChordIndex: 0, 
      barsInChord: 0, 
      bassMode: 'tonica', 
      bassCycleCount: 0, 
      recordingTimer: null 
    }; 
 
    const mute = { 
      bass: false, 
      drums: false, 
      clean: false, 
      dist: false 
    }; 
 
    let recorder = null; 
    let recChunks = []; 
 
    function log(msg) { 
      ui.log.textContent += `\n${msg}`; 
      ui.log.scrollTop = ui.log.scrollHeight; 
    } 
 
    function setStatePanel() { 
      ui.state.innerHTML = ` 
        <div>Estilo: <b>${state.signatureTag}</b></div> 
        <div>Compasso: <b>${state.meter}</b></div> 
        <div>BPM: <b>${state.bpm}</b> (semicolcheia=${(state.sixteenthDur * 
1000).toFixed(0)} ms)</div> 
        <div>Tom: <b>${state.key}${state.quality}</b></div> 
        <div>Progress√£o: <b>${state.chordProgression.join('-')}</b></div> 
      `; 
    } 
 
    async function loadBuffer(url) { 
      try { 
        const res = await fetch(url); 
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`); 
        const arrayBuffer = await res.arrayBuffer(); 
        const audioBuffer = await audio.ctx.decodeAudioData(arrayBuffer); 
        return audioBuffer; 
      } catch (e) { 
        log(`[ERRO] Falha ao carregar: ${url} ‚Üí ${e.message}`); 
        return null; 
      } 
    } 
 
    async function ensureSamples() { 
      const allDrums = Object.keys(DRUMS); 
      const promises = []; 
 
      for (const k of allDrums) { 
        if (!state.buffers.drums[k]) { 
          promises.push(loadBuffer(DRUMS[k]).then(buf => { 
            if (buf) { 
              state.buffers.drums[k] = buf; 
              log(`[DRUM] ‚úî Carregado: ${k}`); 
            } 
          })); 
        } 
      } 
 
      for (const [k, url] of Object.entries(BASS_SAMPLES)) { 
        if (!state.buffers.bass[k]) { 
          promises.push(loadBuffer(url).then(buf => { 
            if (buf) state.buffers.bass[k] = buf; 
          })); 
        } 
      } 
 
      await Promise.all(promises); 
    } 
 
    function initAudio() { 
      if (audio.ctx) return; 
      const ctx = new (window.AudioContext || window.webkitAudioContext)(); 
      audio.ctx = ctx; 
      audio.master = ctx.createGain(); 
      audio.master.gain.value = 0.9; 
 
      audio.drumGain = ctx.createGain(); audio.drumGain.gain.value = 0.85; 
      audio.bassGain = ctx.createGain(); audio.bassGain.gain.value = 0.9; 
      audio.cleanGain = ctx.createGain(); audio.cleanGain.gain.value = 0.8; 
      audio.distGain = ctx.createGain(); audio.distGain.gain.value = 0.8; 
 
      audio.mix = ctx.createMediaStreamDestination(); 
 
      audio.drumGain.connect(audio.master); 
      audio.bassGain.connect(audio.master); 
      audio.cleanGain.connect(audio.master); 
      audio.distGain.connect(audio.master); 
      audio.master.connect(audio.mix); 
      audio.master.connect(ctx.destination); 
    } 
 
    function randItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; } 
    function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; } 
 
    function meterToBeats(meter) { 
      const [num, den] = meter.split('/').map(Number); 
      return [num, den]; 
    } 
 
    function playClick(isStrong) { 
      const ctx = audio.ctx; 
      const osc = ctx.createOscillator(); 
      const gain = ctx.createGain(); 
      osc.connect(gain); 
      gain.connect(audio.drumGain); 
      osc.frequency.setValueAtTime(isStrong ? 880 : 440, ctx.currentTime); 
      gain.gain.setValueAtTime(0.3, ctx.currentTime); 
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08); 
      osc.start(ctx.currentTime); 
      osc.stop(ctx.currentTime + 0.08); 
    } 
 
    async function playChord(time, note, type, isDistorted) { 
      const folder = isDistorted ? 'guitarraDistorcao' : 'guitarraLimpa'; 
      const key = `${folder}_${note}${type}`; 
      const url = `${folder}/${note}/${note}${type}.mp3`; 
 
      if (state.buffers.guitar[key]) { 
        const src = audio.ctx.createBufferSource(); 
        const gainNode = isDistorted ? audio.distGain : audio.cleanGain; 
        src.buffer = state.buffers.guitar[key]; 
        src.connect(gainNode); 
        src.start(time); 
        return; 
      } 
 
      try { 
        const buf = await loadBuffer(url); 
        if (!buf) throw new Error('Falha ao decodificar'); 
        state.buffers.guitar[key] = buf; 
        const src = audio.ctx.createBufferSource(); 
        src.buffer = buf; 
        src.connect(isDistorted ? audio.distGain : audio.cleanGain); 
        src.start(time); 
      } catch (e) { 
        log(`[ERRO] Falha ao carregar acorde: ${url}`); 
      } 
    } 
 
    function getCurrentChord() { 
      const chordNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; 
      const degree = state.chordProgression[state.currentChordIndex]; 
      const rootOffset = DEGREE_TO_ROOT[degree] || 0; 
      const noteIndex = (state.keyIdx + rootOffset) % 12; 
      const noteSharp = chordNames[noteIndex]; 
      const noteWithS = noteSharp.replace('#', 'S'); 
      const chordType = state.quality === 'maj' ? randItem(['', '7']) : randItem(['m', 'm7']); 
      return { note: noteWithS, type: chordType, displayName: noteSharp + chordType }; 
    } 
 
    // Fun√ß√£o para parsear padr√µes de bateria e baixo 
    function parsePattern(patternText, type) {
    const result = { intro: [], loop: [] };
    const introMatch = patternText.match(/\[(.*?)\]/);
    const loopMatch = patternText.match(/\((.*?)\)/);

    if (introMatch) {
        result.intro = introMatch[1].trim().split(/\s+/).filter(s => s);
    }
    if (loopMatch) {
        result.loop = loopMatch[1].trim().split(/\s+/).filter(s => s);
    }

    // Expandir para sempre ter loop
    if (result.intro.length === 0) result.intro = [...result.loop];
    return result;
}
 
    // Fun√ß√£o para expandir padr√µes r√≠tmicos de baixo 
    function expandRhythm(pattern, totalSteps) {
  const expanded = [];
  let step = 0;

  // Junta e limpa o padr√£o
  const flatPattern = pattern.join(' ').trim().split(/\s+/).filter(s => s);

  while (step < totalSteps) {
    for (const symbol of flatPattern) {
      if (step >= totalSteps) break;

      if (symbol === 'sm') {
        // Sem√≠nima = 4 semicolcheias
        expanded.push('sm');
        for (let i = 1; i < 4; i++) {
          if (step + i < totalSteps) expanded.push('-');
        }
        step += 4;
      } else if (symbol === 'x') {
        expanded.push('x');
        step++;
      } else if (symbol === '¬∞') {
        expanded.push('¬∞');
        step++;
      } else if (symbol === '-') {
        expanded.push('-');
        step++;
      } else {
        // S√≠mbolo desconhecido ‚Üí trata como vazio
        expanded.push('-');
        step++;
      }
    }
  }

  return expanded;
}
 
    function buildDrumPattern() { 
      const groove = state.currentGroove; 
      const [num, den] = meterToBeats(state.meter); 
      const sixteenthsPerBar = num * 4; 
      const totalBars = 16; 
      const totalSteps = totalBars * sixteenthsPerBar; 
 
      // Parse do padr√£o de bateria 
      const drumPattern = parsePattern(groove.drumPattern.join(' '), 'drum'); 
      const fullDrumPattern = [...drumPattern.intro, ...drumPattern.loop]; 
       
      const result = []; 
      let patternIndex = 0; 
       
      for (let i = 0; i < totalSteps; i++) { 
        if (patternIndex >= fullDrumPattern.length) patternIndex = 0; 
         
        const cell = fullDrumPattern[patternIndex]; 
         
        if (!cell || cell === '-') { 
          result.push('-'); 
        } else { 
          // Processar combina√ß√µes de bateria 
          const processedCell = cell 
            .replace(/\(bu\s+at\)|\(at\s+bu\)/gi, 'ba') 
            .replace(/\(bu\s+ch\)|\(ch\s+bu\)/gi, 'bch') 
            .replace(/\(ch\s+ca\)|\(ca\s+ch\)/gi, 'cch') 
            .replace(/\(bu\s+co\)|\(co\s+bu\)/gi, 'bc') 
            .replace(/\(ca\s+co\)|\(co\s+ca\)/gi, 'cc'); 
           
          const pieces = processedCell.split(/\s+/).filter(Boolean); 
          result.push(pieces.join(',')); 
        } 
         
        patternIndex++; 
      } 
       
      return result; 
    } 
 
    function updateChordDisplay() { 
      const chordNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; 
      const degree = state.chordProgression[state.currentChordIndex]; 
      const rootOffset = DEGREE_TO_ROOT[degree] || 0; 
      const rootIdx = (state.keyIdx + rootOffset) % 12; 
      const rootNote = chordNames[rootIdx]; 
      const chordType = state.quality === 'maj' ? '' : 'm'; 
      const currentChord = rootNote + chordType; 
      const barsLeft = state.chordDurations[state.currentChordIndex] - state.barsInChord; 
      ui.currentChord.textContent = currentChord; 
      ui.chordTimer.textContent = `Pr√≥x: ${barsLeft} compasso(s)`; 
    } 
 
    async function onPlay() { 
      if (state.running) { onStop(); setTimeout(onPlay, 100); return; } 
      initAudio(); 
      await ensureSamples(); 
      state.currentGroove = randItem(CUSTOM_GROOVES); 
 
      lastState.chordProgression = [...state.chordProgression]; 
      lastState.key = state.key; 
      lastState.quality = state.quality; 
      lastState.currentGroove = state.currentGroove; 
      lastState.meter = state.meter; 
 
      buildBassPlan(); 
      state.pattern = buildDrumPattern(); 
      state.bpm = Number(ui.bpm.value) || 100; 
      state.sixteenthDur = (60 / state.bpm) / 4; 
      state.stepIndex = 0; 
      state.nextNoteTime = audio.ctx.currentTime + 0.1; 
      state.barsInChord = 0; 
      state.currentChordIndex = 0; 
      state.bassMode = 'tonica'; 
      state.bassCycleCount = 0; 
      state.bassNoteEndTime = 0; 
 
      const [num] = meterToBeats(state.meter); 
      const quarterDur = 60 / state.bpm; 
      const totalClicks = num * 2; 
 
      for (let i = 0; i < totalClicks; i++) { 
        const isStrong = i % num === 0; 
        const clickTime = audio.ctx.currentTime + 0.1 + i * quarterDur; 
        setTimeout(() => playClick(isStrong), (clickTime - audio.ctx.currentTime) * 1000); 
      } 
 
      setTimeout(() => { 
        state.running = true; 
        startScheduler(); 
        ui.play.dataset.state = 'on'; 
        log(`[PLAY] Estilo: ${state.signatureTag} | ${state.meter}@${state.bpm} BPM`); 
      }, totalClicks * quarterDur * 1000); 
 
      setStatePanel(); 
      updateChordDisplay(); 
    } 
 
    function scheduler() { 
      const now = audio.ctx.currentTime; 
      while (state.nextNoteTime < now + audio.scheduleHorizon) { 
        scheduleStep(state.nextNoteTime, state.stepIndex); 
        state.nextNoteTime += state.sixteenthDur; 
        state.stepIndex++; 
      } 
    } 
 
    function scheduleStep(time, stepIdx) {
    const cell = state.pattern[stepIdx % state.pattern.length];
    const [num, den] = meterToBeats(state.meter);
    const sixteenthsPerBar = num * 4;
    const isNewBar = stepIdx % sixteenthsPerBar === 0;

    // --- BATERIA ---
    if (cell && cell !== '-' && !mute.drums) {
        const isSixteenth = stepIdx % 4 !== 0;
        const dynamicGain = isSixteenth ? 0.6 + Math.random() * 0.3 : 1.0;

        cell.split(',').forEach(p => {
            const buf = state.buffers.drums[p];
            if (!buf) return;
            const src = audio.ctx.createBufferSource();
            const gainNode = audio.ctx.createGain();
            src.buffer = buf;
            src.connect(gainNode);
            gainNode.connect(audio.drumGain);
            gainNode.gain.value = 0.8 * dynamicGain;
            src.start(time);
            if (p !== 'ataque' && p !== 'ba') src.stop(time + 0.15);
        });
    }

    // --- MUDAN√áA DE ACORDE ---
    if (isNewBar && stepIdx > 0) {
        state.barsInChord++;
        if (state.barsInChord >= state.chordDurations[state.currentChordIndex]) {
            state.currentChordIndex = (state.currentChordIndex + 1) % state.chordProgression.length;
            state.barsInChord = 0;
        }
        const chord = getCurrentChord();
        if (!mute.clean) playChord(time, chord.note, chord.type, false);
        if (!mute.dist) playChord(time, chord.note, chord.type, true);
        updateChordDisplay();
    }

    // --- BAIXO ---
    const bassKey = state.bassPlan[stepIdx % state.bassPlan.length];
    if (bassKey === 'X' && !mute.bass) {
        const src = audio.ctx.createBufferSource();
        src.buffer = state.buffers.bass['X'];
        src.connect(audio.bassGain);
        src.start(time);
        src.stop(time + 0.1);
        if (state.lastBassSrc) state.lastBassSrc.stop(time + 0.005);
        state.lastBassSrc = src;
        src.onended = () => { if (state.lastBassSrc === src) state.lastBassSrc = null; };
    } else if (bassKey === '¬∞' && !mute.bass) {
        // MUTE: corta a nota anterior
        if (state.lastBassSrc) {
            state.lastBassSrc.stop(time + 0.01);
            state.lastBassSrc = null;
        }
    } else if (bassKey !== '-' && bassKey !== '¬∞' && !mute.bass) {
        // Nova nota: para a anterior e toca a nova
        if (state.lastBassSrc) {
            state.lastBassSrc.stop(time + 0.005);
        }
        const run = async () => {
            if (!state.buffers.bass[bassKey]) {
                state.buffers.bass[bassKey] = await loadBuffer(BASS_SAMPLES[bassKey]);
            }
            const src = audio.ctx.createBufferSource();
            src.buffer = state.buffers.bass[bassKey];
            src.connect(audio.bassGain);
            src.start(time);
            state.lastBassSrc = src;
            src.onended = () => { if (state.lastBassSrc === src) state.lastBassSrc = null; };
        };
        run();
    }
    // Se for '-', n√£o faz nada: a nota anterior continua
}
 
    function startScheduler() { 
      stopScheduler(); 
      audio.schedulerTimer = setInterval(scheduler, audio.lookahead * 1000); 
    } 
 
    function stopScheduler() { 
      if (audio.schedulerTimer) { 
        clearInterval(audio.schedulerTimer); 
        audio.schedulerTimer = null; 
      } 
    } 
 
    function onPause() { 
      if (state.running && !state.paused) { 
        audio.ctx.suspend(); 
        state.paused = true; 
        stopScheduler(); 
        ui.play.textContent = '‚ñ∂ Retomar'; 
      } else if (state.paused) { 
        audio.ctx.resume(); 
        state.paused = false; 
        ui.play.textContent = '
 ‚è∏
 Pause'; 
        startScheduler(); 
      } 
    } 
 
    async function onStop() { 
      stopScheduler(); 
      stopRecording(); 
      if (audio.ctx && audio.ctx.state !== 'closed') { 
        try { await audio.ctx.close(); } catch (e) {} 
      } 
      audio.ctx = null; 
      state.running = false; 
      state.paused = false; 
      state.stepIndex = 0; 
      state.pattern = []; 
      state.bassPlan = []; 
      state.currentGroove = null; 
      ui.currentChord.textContent = '‚Äî'; 
      ui.chordTimer.textContent = '‚Äî'; 
      ui.play.dataset.state = ''; 
      ui.play.textContent = '‚ñ∂ Play'; 
      log('[STOP] Pronto.'); 
    } 
 
    function onRestart() { 
      if (!state.running) return; 
      onStop(); 
      setTimeout(() => onPlay(), 100); 
    } 
 
    function onPrev() { 
      if (!lastState.currentGroove) return log('[INFO] Nenhum playback anterior.'); 
      onStop(); 
      setTimeout(() => { 
        state.currentGroove = lastState.currentGroove; 
        state.key = lastState.key; 
        state.keyIdx = PITCHES.indexOf(lastState.key); 
        state.quality = lastState.quality; 
        state.chordProgression = [...lastState.chordProgression]; 
        state.meter = lastState.meter; 
        state.bpm = Number(ui.bpm.value) || 100; 
        buildBassPlan(); 
        state.pattern = buildDrumPattern(); 
        initAudio(); 
        ensureSamples(); 
        state.stepIndex = 0; 
        state.nextNoteTime = audio.ctx.currentTime + 0.1; 
        state.barsInChord = 0; 
        state.currentChordIndex = 0; 
        startScheduler(); 
        setStatePanel(); 
        updateChordDisplay(); 
        log('[PREV] Playback anterior restaurado.'); 
      }, 100); 
    } 
    function buildBassPlan() {
  const groove = state.currentGroove;
  state.meter = ui.meter.value === 'auto' ? groove.meter : ui.meter.value;
  const [num, den] = meterToBeats(state.meter);
  const sixteenthsPerBar = num * 4;
  const totalBars = 16;
  const totalSteps = totalBars * sixteenthsPerBar;

  state.keyIdx = randInt(0, PITCHES.length - 1);
  state.key = PITCHES[state.keyIdx];
  state.quality = randItem(['maj', 'min']);
  state.chordProgression = randItem(PROGRESSIONS);

  // Dura√ß√µes dos acordes
  const durations = [];
  let current = state.chordProgression[0], count = 1;
  for (let i = 1; i < state.chordProgression.length; i++) {
    if (state.chordProgression[i] === current) count++;
    else { durations.push(count); current = state.chordProgression[i]; count = 1; }
  }
  durations.push(count);
  state.chordDurations = durations;

  // Expandir padr√£o de baixo
  const bassPattern = parsePattern(groove.bassRhythm.join(' '), 'bass');
  const fullPattern = [...bassPattern.intro, ...bassPattern.loop];
  const rhythm = expandRhythm(fullPattern, totalSteps);

  const plan = [];
  let barsInChord = 0;
  let chordIndex = 0;

  for (let step = 0; step < totalSteps; step++) {
    const sixteenthInBar = step % sixteenthsPerBar;
    if (sixteenthInBar === 0 && step > 0) {
      barsInChord++;
      if (barsInChord >= state.chordDurations[chordIndex]) {
        chordIndex = (chordIndex + 1) % state.chordProgression.length;
        barsInChord = 0;
      }
    }

    const degree = state.chordProgression[chordIndex];
    const rootOffset = DEGREE_TO_ROOT[degree] || 0;
    const rootIdx = (state.keyIdx + rootOffset) % 12;
    const rootNote = PITCHES[rootIdx];
    const chordType = state.quality === 'maj' ? '' : 'm';
    const chordName = rootNote + chordType;
    const availableNotes = BASS_NOTE_MAP[chordName] || [rootNote];

    const symbol = rhythm[step];
    let note = '-';

    if (symbol === 'x') {
      note = 'X'; // ghost note
    } else if (symbol === '¬∞') {
      note = '¬∞'; // mute
    } else if (symbol === 'sm') {
      // Nova nota: toca a raiz ou aleat√≥ria
      note = randItem(availableNotes);
    }
    // Se for '-', mant√©m a anterior (n√£o faz nada)

    plan.push(note);
  }

  state.bassPlan = plan;
  state.signatureTag = groove.name;
  updateChordDisplay();
}
 
    function onSave() { 
      if (!audio.ctx) return; 
      startRecording(); 
    } 
 
    function startRecording() { 
      if (!audio.mix) return; 
      try { 
        recorder = new MediaRecorder(audio.mix.stream, { mimeType: 'audio/webm' }); 
      } catch (e) { 
        log('[REC] Erro ao iniciar grava√ß√£o: ' + e.message); 
        return; 
      } 
      recChunks = []; 
      recorder.ondataavailable = e => { if (e.data.size) recChunks.push(e.data); }; 
      recorder.onstop = async () => { 
        const webmBlob = new Blob(recChunks, { type: 'audio/webm' }); 
        const arrayBuffer = await webmBlob.arrayBuffer(); 
        const audioContext = new (window.AudioContext || window.webkitAudioContext)(); 
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer); 
        const samples = audioBuffer.getChannelData(0); 
        const samplesRight = audioBuffer.numberOfChannels > 1 ? 
audioBuffer.getChannelData(1) : samples; 
        const mp3Encoder = new lamejs.Mp3Encoder(2, 44100, 128); 
        const mp3Data = []; 
        const frameSize = 1152; 
        for (let i = 0; i < samples.length; i += frameSize) { 
          const left = samples.subarray(i, i + frameSize); 
          const right = samplesRight.subarray(i, i + frameSize); 
          const mp3buf = mp3Encoder.encodeBuffer(left, right); 
          if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf)); 
        } 
        const final = mp3Encoder.flush(); 
        if (final.length > 0) mp3Data.push(new Int8Array(final)); 
        const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' }); 
        downloadMp3(mp3Blob); 
      }; 
      recorder.start(); 
      const fixedDuration = 4 * 60 * 1000; 
      const startTime = Date.now(); 
      const finalTimer = setInterval(() => { 
        const now = Date.now(); 
        if (now >= startTime + fixedDuration) { 
          if (recorder && recorder.state !== 'inactive') recorder.stop(); 
          clearInterval(finalTimer); 
          log('[ ‚úÖ ] Grava√ß√£o de 4 minutos conclu√≠da!'); 
        } 
      }, 1000); 
      if (state.recordingTimer) clearInterval(state.recordingTimer); 
      state.recordingTimer = finalTimer; 
      log('[REC] Grava√ß√£o iniciada. Dura√ß√£o fixa: 4 minutos (ser√° convertido para MP3).'); 
      ui.save.disabled = true; 
      ui.save.textContent = '
 ‚è≥
 Gravando... (4 min)'; 
    } 
 
    function stopRecording() { 
      if (recorder && recorder.state !== 'inactive') recorder.stop(); 
    } 
 
    function downloadMp3(blob) { 
      const audioPreview = new Audio(); 
      audioPreview.src = URL.createObjectURL(blob); 
      audioPreview.controls = true; 
      audioPreview.style.display = 'block'; 
      audioPreview.style.margin = '10px 0'; 
      audioPreview.style.width = '100%'; 
      audioPreview.addEventListener('ended', () => 
URL.revokeObjectURL(audioPreview.src)); 
      const previewDiv = document.createElement('div'); 
      previewDiv.innerHTML = '<div><b>
 üéß
 Pr√©via do seu playback:</b></div>'; 
      previewDiv.appendChild(audioPreview); 
      ui.log.parentNode.insertBefore(previewDiv, ui.log); 
 
      const now = new Date(); 
      const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + 
                     String(now.getDate()).padStart(2, '0') + '-' + 
                     String(now.getHours()).padStart(2, '0') + 
                     String(now.getMinutes()).padStart(2, '0'); 
      const filename = `jam-${state.signatureTag}-${dateStr}.mp3`; 
 
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = filename; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(a.href); 
      log(`[
 ‚úÖ
 ] Arquivo salvo: ${filename}`); 
      ui.save.disabled = false; 
      ui.save.textContent = '
 üíæ
 Salvar 4 min (MP3)'; 
    } 
 
    function toggleMute(type, button) { 
      mute[type] = !mute[type]; 
      button.dataset.mute = mute[type] ? 'on' : 'off'; 
      const icon = mute[type] ? '
 üîá
 ' : '
 üîä
 '; 
      const label = button.textContent.split(' ')[1]; 
      button.textContent = `${icon} ${label}`; 
      button.classList.toggle('muted', mute[type]); 
    } 
 
    // Fun√ß√£o para aplicar a levada personalizada 
    function applyCustomGroove() { 
      const name = ui.grooveName.value || "Personalizado"; 
      const meter = ui.grooveMeter.value; 
      const drumPattern = ui.drumPattern.value.split('\n').filter(line => line.trim()); 
      const bassRhythm = ui.bassRhythm.value.split('\n').filter(line => line.trim()); 
       
      if (drumPattern.length === 0 || bassRhythm.length === 0) { 
        log('[ERRO] Padr√µes de bateria e baixo s√£o obrigat√≥rios.'); 
        return; 
      } 
       
      const customGroove = { 
        name, 
        meter, 
        drumPattern, 
        bassRhythm 
      }; 
       
      CUSTOM_GROOVES.push(customGroove); 
      state.currentGroove = customGroove; 
       
      log(`[LEVADA] "${name}" aplicada com sucesso!`); 
      log(`- Compasso: ${meter}`); 
      log(`- Bateria: ${drumPattern.join(' | ')}`); 
      log(`- Baixo: ${bassRhythm.join(' | ')}`); 
    } 
 
    ui.play.addEventListener('click', onPlay); 
    ui.pause.addEventListener('click', onPause); 
    ui.stop.addEventListener('click', onStop); 
    ui.save.addEventListener('click', onSave); 
    ui.btnRestart.addEventListener('click', onRestart); 
ui.btnPrev.addEventListener('click', onPrev); 
ui.btnApplyGroove.addEventListener('click', applyCustomGroove); 
ui.muteBass.addEventListener('click', () => toggleMute('bass', ui.muteBass)); 
ui.muteDrums.addEventListener('click', () => toggleMute('drums', ui.muteDrums)); 
ui.muteClean.addEventListener('click', () => toggleMute('clean', ui.muteClean)); 
ui.muteDist.addEventListener('click', () => toggleMute('dist', ui.muteDist)); 
window.addEventListener('load', () => { 
log('üîß Pr√©-carregando acordes...'); 
initAudio(); 
}); 
</script> 
</body>
</html>