<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playback Aleatório Musical</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #fdbb2d;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 24px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            transition: width 0.5s;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.active {
            background: linear-gradient(135deg, #fdbb2d, #b21f1f);
        }
        
        .btn.toggle {
            background: linear-gradient(135deg, #333, #555);
        }
        
        .btn.toggle.active {
            background: linear-gradient(135deg, #1a2a6c, #2980b9);
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            font-size: 14px;
            color: #fdbb2d;
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .bpm-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
        }
        
        .bpm-control button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            margin: 0 10px;
        }
        
        .bpm-display {
            font-size: 28px;
            font-weight: bold;
            margin: 0 15px;
            min-width: 80px;
            text-align: center;
        }
        
        .editor {
            margin-top: 20px;
        }
        
        .editor h3 {
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .instrument-name {
            font-weight: bold;
            color: #fdbb2d;
            margin-top: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .chord-display {
            font-size: 32px;
            text-align: center;
            margin: 20px 0;
            height: 50px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            color: #fdbb2d;
        }
        
        .key-display {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #fff;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
        }
        
        .pattern-info {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Playback Aleatório Musical</h1>
        
        <div id="loading" class="loading">
            <p>Carregando arquivos de áudio...</p>
            <p>Clique para iniciar o carregamento</p>
            <div class="loading-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <button class="btn" id="startLoading" style="margin-top: 20px;">Iniciar Carregamento</button>
        </div>
        
        <div id="mainContent" class="hidden">
            <div class="key-display">
                Campo Harmônico: <span id="currentKey">C Maior</span>
            </div>
            
            <div class="chord-display" id="chordDisplay">
                A
            </div>
            
            <div class="status">
                <div class="status-item">
                    <div class="status-label">BPM</div>
                    <div class="status-value" id="bpmValue">120</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Compasso</div>
                    <div class="status-value" id="measureCount">1</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Estado</div>
                    <div class="status-value" id="playbackState">Parado</div>
                </div>
            </div>
            
            <div class="bpm-control">
                <button class="btn" id="bpmDown">-</button>
                <div class="bpm-display" id="bpmDisplay">120</div>
                <button class="btn" id="bpmUp">+</button>
            </div>
            
            <div class="controls">
                <button class="btn" id="playBtn">Play</button>
                <button class="btn" id="pauseBtn">Pause</button>
                <button class="btn" id="stopBtn">Parar</button>
                <button class="btn" id="saveBtn">Salvar</button>
                <button class="btn" id="backBtn">Voltar</button>
                <button class="btn" id="repeatBtn">Repetir</button>
            </div>
            
            <div class="controls">
                <button class="btn toggle active" id="bassToggle">Baixo: Ativado</button>
                <button class="btn toggle active" id="drumsToggle">Bateria: Ativado</button>
                <button class="btn toggle active" id="distGuitarToggle">Guitarra Dist: Ativado</button>
                <button class="btn toggle active" id="cleanGuitarToggle">Guitarra Limpa: Ativado</button>
            </div>
            
            <div class="editor">
                <h3>Editor de Levadas</h3>
                <div class="pattern-info">Bateria: use símbolos como bu, ca, ch, cha, co, at, to1, to2, su, ba, bch, cch, bc, cc</div>
                <div class="instrument-name">Bateria:</div>
                <textarea id="drumsPattern">
[ca,ca,ca,-,ba,-,-,-,ca,-,ca,-,to1,-,to2,-]
(ba,-,ch,bu,cch,-,ch,-,bch,-,ch,-,cch,-,ch,-,
bch,-,ch,bu,cch,-,ch,-,bch,-,ch,-,cch,-,ch,-, 
bch,-,ch,bu,cch,-,ch,-,bch,-,ch,-,cch,-,ch,-,
bch,-,ch,bu,cch,-,ch,-,bch,-,ch,-,cch,-,ch,-)
                </textarea>
                
                <div class="pattern-info">Baixo: use símbolos como sb, m, sm, c, sc, -, °, x</div>
                <div class="instrument-name">Baixo:</div>
                <textarea id="bassPattern">
[sc,sc,c,sm,sc,sc]
(c,c,c,c,c,c,c,c,
sc,sc,sc,sc,sc,sc,sc,sc,
sb,
c,c,c,c,c,c,c,c)
                </textarea>
                
                <button class="btn" id="applyPatterns">Aplicar Padrões</button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let audioContext;
        let isLoading = false;
        let isPlaying = false;
        let currentBPM = 120;
        let measureCount = 0;
        let currentChord = "A";
        let currentKey = "C Maior";
        let audioBuffers = {};
        let scheduledEvents = [];
        let nextNoteTime = 0;
        let current16thNote = 0;
        let lookahead = 25;
        let scheduleAheadTime = 0.1;
        let timerID = null;
        let isIntroPlaying = true;
        let currentPatternIndex = 0;
        let drumsPattern = [];
        let bassPattern = [];
        let currentChordIndex = 0;
        let chordProgression = [];
        let chordChangeInterval = 4; // Mudar acorde a cada 4 compassos
        let lastPlaybackSettings = null;
        
        // Elementos DOM
        const loadingElement = document.getElementById('loading');
        const mainContentElement = document.getElementById('mainContent');
        const progressBarElement = document.getElementById('progressBar');
        const startLoadingButton = document.getElementById('startLoading');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveBtn = document.getElementById('saveBtn');
        const backBtn = document.getElementById('backBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const bassToggle = document.getElementById('bassToggle');
        const drumsToggle = document.getElementById('drumsToggle');
        const distGuitarToggle = document.getElementById('distGuitarToggle');
        const cleanGuitarToggle = document.getElementById('cleanGuitarToggle');
        const bpmDisplay = document.getElementById('bpmDisplay');
        const bpmValue = document.getElementById('bpmValue');
        const bpmUp = document.getElementById('bpmUp');
        const bpmDown = document.getElementById('bpmDown');
        const chordDisplay = document.getElementById('chordDisplay');
        const measureCountElement = document.getElementById('measureCount');
        const playbackStateElement = document.getElementById('playbackState');
        const currentKeyElement = document.getElementById('currentKey');
        const drumsPatternElement = document.getElementById('drumsPattern');
        const bassPatternElement = document.getElementById('bassPattern');
        const applyPatternsButton = document.getElementById('applyPatterns');
        
        // Event Listeners
        startLoadingButton.addEventListener('click', startLoading);
        playBtn.addEventListener('click', togglePlay);
        pauseBtn.addEventListener('click', togglePause);
        stopBtn.addEventListener('click', stopPlayback);
        saveBtn.addEventListener('click', savePlayback);
        backBtn.addEventListener('click', goBack);
        repeatBtn.addEventListener('click', repeatPlayback);
        bassToggle.addEventListener('click', () => toggleInstrument(bassToggle, 'bass'));
        drumsToggle.addEventListener('click', () => toggleInstrument(drumsToggle, 'drums'));
        distGuitarToggle.addEventListener('click', () => toggleInstrument(distGuitarToggle, 'distGuitar'));
        cleanGuitarToggle.addEventListener('click', () => toggleInstrument(cleanGuitarToggle, 'cleanGuitar'));
        bpmUp.addEventListener('click', () => changeBPM(5));
        bpmDown.addEventListener('click', () => changeBPM(-5));
        applyPatternsButton.addEventListener('click', applyPatterns);
        
        // Iniciar carregamento
        function startLoading() {
            if (isLoading) return;
            
            isLoading = true;
            startLoadingButton.disabled = true;
            
            // Inicializar contexto de áudio
            initializeAudioContext();
            
            // Carregar todos os samples
            loadAllSamples().then(() => {
                progressBarElement.style.width = '100%';
                setTimeout(() => {
                    loadingElement.classList.add('hidden');
                    mainContentElement.classList.remove('hidden');
                    parsePatterns();
                    generateChordProgression();
                }, 500);
            }).catch(error => {
                console.error("Erro ao carregar samples:", error);
                alert("Erro ao carregar arquivos de áudio. Verifique o console para mais detalhes.");
            });
        }
        
        // Inicializar contexto de áudio
        function initializeAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("Contexto de áudio inicializado");
            } catch (e) {
                alert("Seu navegador não suporta Web Audio API. Por favor, use um navegador moderno.");
                console.error(e);
            }
        }
        
        // Carregar todos os samples
        async function loadAllSamples() {
            const totalSamples = 200; // Número aproximado de samples
            let loadedSamples = 0;
            
            // Função para carregar um sample individual
            async function loadSample(name, path) {
                try {
                    const response = await fetch(path);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    audioBuffers[name] = audioBuffer;
                    loadedSamples++;
                    progressBarElement.style.width = `${(loadedSamples / totalSamples) * 100}%`;
                } catch (error) {
                    console.error(`Erro ao carregar ${name}:`, error);
                }
            }
            
            // Carregar bateria
            const drumSamples = [
                'bu', 'ca', 'ch', 'cha', 'co', 'at', 'to1', 'to2', 'su', 'ba', 'bch', 'cch', 'bc', 'cc'
            ];
            
            for (const sample of drumSamples) {
                await loadSample(sample, `assets/${sample}.mp3`);
            }
            
            // Carregar baixo (notas básicas)
            const bassNotes = ['A', 'AS', 'B', 'C', 'CS', 'D', 'DS', 'E', 'F', 'FS', 'G', 'GS'];
            for (const note of bassNotes) {
                await loadSample(`bass-${note}`, `assets/bass-${note}.mp3`);
                await loadSample(`bass-${note}8`, `assets/bass-${note}8.mp3`);
                await loadSample(`bass-${note}16`, `assets/bass-${note}16.mp3`);
                
                // Notas sustenidas têm versões com S
                if (note.includes('S')) {
                    const naturalNote = note.replace('S', '');
                    await loadSample(`bass-${naturalNote}S`, `assets/bass-${naturalNote}S.mp3`);
                    await loadSample(`bass-${naturalNote}8S`, `assets/bass-${naturalNote}8S.mp3`);
                    await loadSample(`bass-${naturalNote}16S`, `assets/bass-${naturalNote}16S.mp3`);
                }
            }
            
            // Carregar notas especiais de baixo
            await loadSample('bass-muted', 'assets/bass-muted.mp3');
            
            // Carregar alguns acordes de guitarra (apenas alguns para exemplo)
            const guitarChords = ['A', 'Am', 'C', 'D', 'Dm', 'E', 'Em', 'G'];
            
            for (const chord of guitarChords) {
                // Guitarra distorcida
                await loadSample(`dist-${chord}`, `assets/guitarraDistorcao/${chord}.mp3`);
                // Guitarra limpa
                await loadSample(`clean-${chord}`, `assets/guitarraLimpa/${chord}.mp3`);
            }
            
            return Promise.resolve();
        }
        
        // Analisar padrões da textarea
        function parsePatterns() {
            try {
                // Analisar padrão de bateria
                const drumsText = drumsPatternElement.value;
                const drumsIntroMatch = drumsText.match(/\[(.*?)\]/);
                const drumsLoopMatch = drumsText.match(/\((.*?)\)/s);
                
                if (drumsIntroMatch) {
                    const introPart = drumsIntroMatch[1].split(',').map(item => item.trim()).filter(item => item);
                    drumsPattern.push(...introPart);
                }
                
                if (drumsLoopMatch) {
                    const loopParts = drumsLoopMatch[1].split(',').map(item => item.trim()).filter(item => item);
                    drumsPattern.push(...loopParts);
                }
                
                // Analisar padrão de baixo
                const bassText = bassPatternElement.value;
                const bassIntroMatch = bassText.match(/\[(.*?)\]/);
                const bassLoopMatch = bassText.match(/\((.*?)\)/s);
                
                if (bassIntroMatch) {
                    const introPart = bassIntroMatch[1].split(',').map(item => item.trim()).filter(item => item);
                    bassPattern.push(...introPart);
                }
                
                if (bassLoopMatch) {
                    const loopParts = bassLoopMatch[1].split(',').map(item => item.trim()).filter(item => item);
                    bassPattern.push(...loopParts);
                }
                
                console.log("Padrões analisados:", {drumsPattern, bassPattern});
            } catch (error) {
                console.error("Erro ao analisar padrões:", error);
                alert("Erro ao analisar padrões. Verifique a formatação.");
            }
        }
        
        // Gerar progressão de acordes
        function generateChordProgression() {
            const keys = [
                "C Maior", "C# Maior", "Db Maior", "D Maior", "Eb Maior", 
                "E Maior", "F Maior", "F# Maior", "Gb Maior", "G Maior", 
                "Ab Maior", "A Maior", "Bb Maior", "B Maior"
            ];
            
            currentKey = keys[Math.floor(Math.random() * keys.length)];
            currentKeyElement.textContent = currentKey;
            
            // Gerar progressão de acordes simples baseada na tonalidade
            const chords = {
                "C Maior": ["C", "Dm", "Em", "F", "G", "Am"],
                "A Maior": ["A", "Bm", "C#m", "D", "E", "F#m"],
                "G Maior": ["G", "Am", "Bm", "C", "D", "Em"],
                "E Maior": ["E", "F#m", "G#m", "A", "B", "C#m"],
                "D Maior": ["D", "Em", "F#m", "G", "A", "Bm"]
            };
            
            // Usar progressão padrão se a tonalidade não estiver definida
            chordProgression = chords[currentKey] || ["C", "G", "Am", "F"];
            
            // Embaralhar progressão
            for (let i = chordProgression.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [chordProgression[i], chordProgression[j]] = [chordProgression[j], chordProgression[i]];
            }
            
            currentChord = chordProgression[0];
            chordDisplay.textContent = currentChord;
        }
        
        // Tocar um sample
        function playSample(name, time, volume = 1.0) {
            if (!audioBuffers[name]) {
                console.warn(`Sample não encontrado: ${name}`);
                return;
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffers[name];
            
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;
            
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            source.start(time);
            
            return source;
        }
        
        // Agendar próximos eventos
        function scheduler() {
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                scheduleNote(current16thNote, nextNoteTime);
                nextNote();
            }
            
            timerID = setTimeout(scheduler, lookahead);
        }
        
        // Agendar uma nota específica
        function scheduleNote(time16th, time) {
            // Tocar bateria se ativada
            if (drumsToggle.classList.contains('active') && drumsPattern.length > 0) {
                const drumNote = drumsPattern[time16th % drumsPattern.length];
                if (drumNote && drumNote !== '-') {
                    playSample(drumNote, time);
                }
            }
            
            // Tocar baixo se ativado
            if (bassToggle.classList.contains('active') && bassPattern.length > 0) {
                const bassNote = bassPattern[time16th % bassPattern.length];
                if (bassNote && bassNote !== '-') {
                    if (bassNote === 'x') {
                        playSample('bass-muted', time, 0.7);
                    } else {
                        // Tocar a nota do baixo correspondente ao acorde atual
                        const rootNote = currentChord.replace('m', '').replace('M', '');
                        playSample(`bass-${rootNote}`, time, 0.8);
                    }
                }
            }
            
            // Tocar acorde de guitarra no início do compasso
            if (time16th % 16 === 0) {
                // Mudar acorde a cada X compassos
                if (time16th % (16 * chordChangeInterval) === 0) {
                    currentChordIndex = (currentChordIndex + 1) % chordProgression.length;
                    currentChord = chordProgression[currentChordIndex];
                    chordDisplay.textContent = currentChord;
                    measureCount++;
                    measureCountElement.textContent = measureCount;
                }
                
                // Tocar guitarra distorcida se ativada
                if (distGuitarToggle.classList.contains('active')) {
                    playSample(`dist-${currentChord}`, time, 0.9);
                }
                
                // Tocar guitarra limpa se ativada
                if (cleanGuitarToggle.classList.contains('active')) {
                    playSample(`clean-${currentChord}`, time, 0.9);
                }
            }
        }
        
        // Avançar para a próxima nota
        function nextNote() {
            const secondsPerBeat = 60.0 / currentBPM;
            nextNoteTime += 0.25 * secondsPerBeat; // 16th note
            
            current16thNote++;
            
            if (current16thNote >= 16) {
                current16thNote = 0;
            }
        }
        
        // Alternar reprodução
        function togglePlay() {
            if (!isPlaying) {
                isPlaying = true;
                playbackStateElement.textContent = "Tocando";
                playBtn.textContent = "Playing";
                
                // Salvar configurações atuais para possível uso do botão "voltar"
                lastPlaybackSettings = {
                    drumsPattern: [...drumsPattern],
                    bassPattern: [...bassPattern],
                    chordProgression: [...chordProgression],
                    currentChord: currentChord,
                    currentKey: currentKey
                };
                
                // Iniciar reprodução
                nextNoteTime = audioContext.currentTime;
                current16thNote = 0;
                measureCount = 1;
                measureCountElement.textContent = measureCount;
                isIntroPlaying = true;
                scheduler();
            } else {
                togglePause();
            }
        }
        
        // Alternar pausa
        function togglePause() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playbackStateElement.textContent = "Tocando";
                playBtn.textContent = "Playing";
                nextNoteTime = audioContext.currentTime;
                scheduler();
            } else {
                playbackStateElement.textContent = "Pausado";
                playBtn.textContent = "Play";
                clearTimeout(timerID);
            }
        }
        
        // Parar reprodução
        function stopPlayback() {
            isPlaying = false;
            clearTimeout(timerID);
            measureCount = 0;
            measureCountElement.textContent = measureCount;
            playbackStateElement.textContent = "Parado";
            playBtn.textContent = "Play";
            
            // Sortear novo campo harmônico e progressão
            generateChordProgression();
        }
        
        // Salvar playback (simulado)
        function savePlayback() {
            alert("Funcionalidade de salvar seria implementada aqui. Geraria um MP3 de 5 minutos do playback atual.");
        }
        
        // Voltar para o playback anterior
        function goBack() {
            if (lastPlaybackSettings) {
                drumsPattern = [...lastPlaybackSettings.drumsPattern];
                bassPattern = [...lastPlaybackSettings.bassPattern];
                chordProgression = [...lastPlaybackSettings.chordProgression];
                currentChord = lastPlaybackSettings.currentChord;
                currentKey = lastPlaybackSettings.currentKey;
                
                currentKeyElement.textContent = currentKey;
                chordDisplay.textContent = currentChord;
                
                alert("Voltando para o playback anterior");
                stopPlayback();
            } else {
                alert("Nenhum playback anterior disponível");
            }
        }
        
        // Repetir playback
        function repeatPlayback() {
            alert("Repetindo a partir da introdução");
            stopPlayback();
            togglePlay();
        }
        
        // Alternar instrumento
        function toggleInstrument(button, instrument) {
            button.classList.toggle('active');
            const isActive = button.classList.contains('active');
            button.textContent = `${button.textContent.split(':')[0]}: ${isActive ? 'Ativado' : 'Desativado'}`;
            console.log(`${instrument} ${isActive ? 'ativado' : 'desativado'}`);
        }
        
        // Alterar BPM
        function changeBPM(delta) {
            currentBPM += delta;
            if (currentBPM < 60) currentBPM = 60;
            if (currentBPM > 200) currentBPM = 200;
            
            bpmDisplay.textContent = currentBPM;
            bpmValue.textContent = currentBPM;
        }
        
        // Aplicar padrões editados
        function applyPatterns() {
            drumsPattern = [];
            bassPattern = [];
            parsePatterns();
            alert("Padrões aplicados com sucesso!");
        }
    </script>
</body>
</html>