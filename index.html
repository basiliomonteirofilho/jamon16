<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jam On ‚Äì Playback Aleat√≥rio</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      color: #5eead4;
      font-size: 1.8em;
      margin: 0;
    }
    .pill {
      display: inline-block;
      background: #333;
      color: #aaa;
      font-size: 0.75em;
      padding: 4px 10px;
      border-radius: 12px;
    }
    .card {
      max-width: 800px;
      margin: 0 auto;
      background: #1e1e1e;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      overflow: hidden;
      padding: 20px;
      text-align: left;
    }
    .chord-display {
      text-align: center;
      margin: 20px 0;
    }
    .chord-name {
      font-size: 3em;
      color: #5eead4;
      margin: 0;
      font-weight: bold;
    }
    #chordTimer {
      font-size: 1.1em;
      color: #aaa;
    }
    #chordProgression {
      margin-top: 12px;
      font-family: monospace;
      font-size: 1.1em;
      white-space: nowrap;
      overflow-x: auto;
      padding: 8px 0;
    }
    .chord-item {
      display: inline-block;
      padding: 6px 10px;
      margin: 0 4px;
      border-radius: 6px;
      background: #333;
      transition: background 0.3s;
    }
    .chord-item.current {
      background: #5eead4;
      color: #121212;
      font-weight: bold;
    }
    .controls {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
      transition: opacity 0.2s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.primary {
      background: #5eead4;
      color: #121212;
    }
    button.danger {
      background: #f44336;
      color: white;
    }
    button:hover:not(:disabled) {
      opacity: 0.9;
    }
    .mute-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    .mute-buttons button {
      padding: 8px 14px;
      font-size: 0.9em;
    }
    .mute-buttons button.muted {
      opacity: 0.5;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    .row label {
      width: 100px;
      text-align: right;
      color: #ccc;
    }
    input[type="number"], select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #2a2a2a;
      color: #fff;
      width: 90px;
    }
    select {
      width: auto;
      min-width: 120px;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    .slider-row label {
      width: 80px;
      text-align: right;
      font-size: 0.9em;
    }
    input[type="range"] {
      width: 180px;
      accent-color: #5eead4;
    }
    .slider-value {
      width: 40px;
      text-align: left;
      font-size: 0.9em;
      color: #aaa;
    }
    .panel {
      margin-top: 20px;
    }
    .panel h3 {
      color: #5eead4;
      margin-top: 0;
    }
    .melody-panel {
      margin-top: 20px;
    }
    .melody-toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
    }
    .melody-block {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      background: #222;
    }
    .melody-caption {
      font-size: 0.9em;
      color: #ccc;
      margin-bottom: 6px;
    }
    .melody-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85em;
    }
    .melody-table th, .melody-table td {
      border: 1px solid #555;
      padding: 2px;
    }
    .melody-table input {
      width: 100%;
      padding: 4px;
      text-align: center;
      background: #333;
      border: 1px solid #555;
      color: white;
      border-radius: 4px;
    }
    .line-label {
      font-size: 0.8em;
      color: #aaa;
    }
    .instructions {
      font-size: 0.85em;
      color: #aaa;
      margin-top: 8px;
      text-align: center;
    }
    /* === ESTILOS PARA MOBILE === */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .card {
        padding: 15px;
        border-radius: 12px;
      }
      h1 {
        font-size: 1.5em;
      }
      .chord-name {
        font-size: 2em;
      }
      button {
        padding: 14px 22px;
        font-size: 1em;
      }
      .row label {
        width: 80px;
        font-size: 0.9em;
      }
      input[type="number"], select {
        width: 70px;
        font-size: 0.9em;
        padding: 10px;
      }
      .slider-row label {
        width: 60px;
        font-size: 0.8em;
      }
      input[type="range"] {
        width: 140px;
      }
      .slider-value {
        width: 35px;
        font-size: 0.8em;
      }
      .melody-table {
        font-size: 0.9em;
      }
      .melody-table input {
        height: 40px;
        font-size: 0.9em;
        padding: 8px;
      }
      .melody-caption {
        font-size: 0.85em;
      }
    }
    /* === ESTILOS DO PICKER DE N√öMEROS === */
    #numberPicker {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1e1e1e;
      border-top: 2px solid #5eead4;
      padding: 15px;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    #numberPicker h3 {
      color: #5eead4;
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
      grid-column: span 4;
    }
    .number-btn {
      background: #333;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px 0;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.1s ease;
    }
    .number-btn:hover {
      background: #444;
    }
    .number-btn:active {
      transform: scale(0.95);
      background: #5eead4;
      color: #121212;
    }
    .close-btn {
      grid-column: span 4;
      background: #f44336;
      color: white;
      font-weight: bold;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .recording-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: #f44336;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Jam On ‚Äì Playback Aleat√≥rio</h1>
    <div class="pill">Cada pulso do BPM = sem√≠nima</div>
  </header>
  <div class="chord-display">
    <h2 class="chord-name" id="currentChord">‚Äî</h2>
    <div id="chordTimer">‚Äî</div>
    <div id="chordProgression"></div>
  </div>
  <div class="card">
    <div class="controls">
      <div class="btn-row">
        <button id="btnPlay" class="primary">‚ñ∂ Play</button>
        <button id="btnPause">‚è∏ Pause</button>
        <button id="btnStop" class="danger">‚èπ Stop</button>
        <button id="btnPrevious" class="primary">‚èÆ Voltar</button>
        <button id="btnSaveWAV" class="primary">üíæ Salvar como WAV</button>
        <button id="btnOpenManual" class="primary" style="font-size: 1em; padding: 14px 24px;">
      üéõÔ∏è Abrir Composi√ß√£o Manual
      </button>
      </div>
      <div class="mute-buttons">
        <button id="muteBass" data-mute="off">üé∏ Baixo</button>
        <button id="muteDrums" data-mute="off">ü•Å Bateria</button>
        <button id="muteClean" data-mute="off">üîá Limpa</button>
        <button id="muteDist" data-mute="off">üîá Distor√ß√£o</button>
        <button id="mutePianoString" data-mute="off">üîá Piano</button>
        <!-- NOVOS BOT√ïES PARA OS NOVOS INSTRUMENTOS -->
        <button id="muteEcho" data-mute="off">üîá Guitarra Echo</button>
        <button id="muteCleanPicked" data-mute="off">üîá Guitarra Dedilhada</button>
        <button id="muteOrgan" data-mute="off">üîá √ìrg√£o</button>
      </div>
      <!-- ... outros controles ... -->
<div class="row">
  <label>Assinatura</label>
  <select id="meter">
    <option value="auto" selected>aleat√≥ria</option>
    <option>2/4</option>
    <option>3/4</option>
    <option>4/4</option>
    <option>5/4</option>
    <option>6/4</option>
    <option>7/4</option>
  </select>
</div>
<!-- NOVO CONTROLE DE BPM -->
<div class="row">
  <label>BPM</label>
  <input type="number" id="bpm" min="40" max="220" value="100">
</div>
<!-- NOVOS CONTROLES -->
<div class="row">
  <label>Estilo</label>
  <select id="styleSelect">
    <option value="auto" selected>aleat√≥rio</option>
    <!-- As op√ß√µes ser√£o preenchidas dinamicamente pelo JavaScript -->
  </select>
</div>
<!-- ADICIONE ESTE BLOCO -->
<div class="row">
  <label>Tonalidade</label>
  <select id="keySelect">
    <option value="auto" selected>aleat√≥ria</option>
    <!-- As op√ß√µes ser√£o preenchidas dinamicamente pelo JavaScript -->
  </select>
</div>
<!-- ADICIONA O NOVO CONTROLE DE QUALIDADE -->
<div class="row">
  <label>Qualidade</label>
  <select id="qualitySelect">
    <option value="maj" selected>Maior</option>
    <option value="min">Menor</option>
  </select>
</div>
<!-- FIM DOS NOVOS CONTROLES -->
<div class="row">
  <label>Melodia</label>
  <select id="melodyInstrument">
    <option value="dist">Guitarra Distorcida</option>
    <option value="piano">Piano/String</option>
    <option value="baixo">Baixo</option>
    <option value="sax">Sax</option>
    <option value="acordeon">Acordeon</option>
    <option value="sinos">Sinos</option>
    <option value="violao_aco">Viol√£o A√ßo</option>
    <option value="violao_nylon">Viol√£o Nylon</option>
    <option value="cordas">Cordas</option>
  </select>
</div>
<!-- ... resto dos controles ... -->
      <h3 style="color: #5eead4; margin: 15px 0 5px;">Controle de Volume</h3>
      <div class="slider-row">
        <label>Baixo</label>
        <input type="range" id="volBass" min="0" max="1" step="0.01" value="0.45">
        <span class="slider-value" id="volBassLabel">45%</span>
      </div>
      <div class="slider-row">
        <label>Bateria</label>
        <input type="range" id="volDrums" min="0" max="1" step="0.01" value="0.6">
        <span class="slider-value" id="volDrumsLabel">60%</span>
      </div>
      <div class="slider-row">
        <label>Limpa</label>
        <input type="range" id="volClean" min="0" max="1" step="0.01" value="0.45">
        <span class="slider-value" id="volCleanLabel">45%</span>
      </div>
      <div class="slider-row">
        <label>Distorcida</label>
        <input type="range" id="volDist" min="0" max="1" step="0.01" value="0.35">
        <span class="slider-value" id="volDistLabel">35%</span>
      </div>
      <div class="slider-row">
  <label>Piano</label>
  <input type="range" id="volPianoString" min="0" max="1" step="0.01" value="0.50">
  <span class="slider-value" id="volPianoStringLabel">50%</span>
</div>
      <div class="slider-row">
        <label>Melodia</label>
        <input type="range" id="volMelody" min="0" max="1" step="0.01" value="0.50">
        <span class="slider-value" id="volMelodyLabel">50%</span>
      </div>
    </div>
    <div class="panel">
      <h3>Estado Atual</h3>
      <div class="mono" id="state">Parado</div>
    </div>
    <div class="panel melody-panel">
      <h3>üé∏ Melodia Adaptativa</h3>
      <div class="melody-toolbar">
        <button id="btnMelodyAdd" class="primary">‚ûï Adicionar Bloco</button>
        <button id="btnMelodyClear" class="danger">üßπ Limpar Blocos</button>
        <span style="font-size: 0.9em; color: #aaa;">Notas se estendem at√© pr√≥xima nota ou "x"</span>
      </div>
      <div class="instructions">
        Digite n√∫meros (1-49) para notas, "x" para pausa, ou deixe vazio para continuar nota anterior
      </div>
      <div id="melodyBlocks"></div>
    </div>
  </div>
  <div id="numberPicker">
    <h3>Selecione uma nota</h3>
    <div id="numberGrid"></div>
  </div>
 <script>
    // ===== FUN√á√ïES PRINCIPAIS =====
    function transposeDown3Semitones(note) {
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const index = notes.indexOf(note);
        if (index === -1) return note;
        return notes[(index - 3 + 12) % 12];
    }

    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // ===== ELEMENTOS DA INTERFACE =====
    const ui = {
        play: document.getElementById('btnPlay'),
        pause: document.getElementById('btnPause'),
        stop: document.getElementById('btnStop'),
        previous: document.getElementById('btnPrevious'),
        muteBass: document.getElementById('muteBass'),
        muteDrums: document.getElementById('muteDrums'),
        muteClean: document.getElementById('muteClean'),
        muteDist: document.getElementById('muteDist'),
        mutePianoString: document.getElementById('mutePianoString'),
        // --- NOVOS ELEMENTOS ---
        muteEcho: document.getElementById('muteEcho'),
        muteCleanPicked: document.getElementById('muteCleanPicked'),
        muteOrgan: document.getElementById('muteOrgan'),
        // --- FIM DOS NOVOS ELEMENTOS ---
        bpm: document.getElementById('bpm'),
        meter: document.getElementById('meter'),
        styleSelect: document.getElementById('styleSelect'),
        keySelect: document.getElementById('keySelect'),
        qualitySelect: document.getElementById('qualitySelect'),
        currentChord: document.getElementById('currentChord'),
        chordTimer: document.getElementById('chordTimer'),
        volPianoString: document.getElementById('volPianoString'),
        volPianoStringLabel: document.getElementById('volPianoStringLabel'),
        // --- NOVOS CONTROLES DE VOLUME ---
        volEcho: document.getElementById('volEcho'),
        volEchoLabel: document.getElementById('volEchoLabel'),
        volCleanPicked: document.getElementById('volCleanPicked'),
        volCleanPickedLabel: document.getElementById('volCleanPickedLabel'),
        volOrgan: document.getElementById('volOrgan'),
        volOrganLabel: document.getElementById('volOrganLabel'),
        // --- FIM ---
        volBass: document.getElementById('volBass'),
        volDrums: document.getElementById('volDrums'),
        volClean: document.getElementById('volClean'),
        volDist: document.getElementById('volDist'),
        volBassLabel: document.getElementById('volBassLabel'),
        volDrumsLabel: document.getElementById('volDrumsLabel'),
        volCleanLabel: document.getElementById('volCleanLabel'),
        volDistLabel: document.getElementById('volDistLabel'),
        volMelody: document.getElementById('volMelody'),
        volMelodyLabel: document.getElementById('volMelodyLabel'),
        melodyBlocks: document.getElementById('melodyBlocks'),
        btnMelodyAdd: document.getElementById('btnMelodyAdd'),
        btnMelodyClear: document.getElementById('btnMelodyClear'),
        melodyInstrument: document.getElementById('melodyInstrument'),
        numberPicker: document.getElementById('numberPicker'),
        numberGrid: document.getElementById('numberGrid'),
        btnSaveWAV: document.getElementById('btnSaveWAV'),
        chordProgression: document.getElementById('chordProgression'),
        btnOpenManual: document.getElementById('btnOpenManual')
    };

    // Fun√ß√£o para inicializar os selects de Estilo e Tonalidade
    function initializeStyleAndKeySelectors() {
        // Preenche o select de Estilos
        const uniqueStyles = [...new Set(ALL_GROOVES.map(g => g.name))].sort();
        uniqueStyles.forEach(styleName => {
            const opt = document.createElement('option');
            opt.value = styleName;
            opt.textContent = styleName;
            ui.styleSelect.appendChild(opt);
        });

        // Preenche o select de Tonalidades
        const uniqueKeys = [...new Set(PITCHES)].sort();
        uniqueKeys.forEach(keyName => {
            const opt = document.createElement('option');
            opt.value = keyName;
            opt.textContent = keyName.replace('S', '#');
            ui.keySelect.appendChild(opt);
        });
    }

    // ===== SISTEMA DE √ÅUDIO =====
    const audio = {
        ctx: null,
        master: null,
        mix: null,
        drumGain: null,
        bassGain: null,
        cleanGain: null,
        distGain: null,
        melodyGain: null,
        pianoStringGain: null,
        // --- NOVOS GANHOS ---
        echoGain: null,
        cleanPickedGain: null,
        organGain: null
        // --- FIM ---
    };

    // ===== CONSTANTES MUSICAIS =====
    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
    const CHORD_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    
    const DRUMS = {
        bu: 'bumbo',
        ca: 'caixa',
        ch: 'chimbal',
        ba: 'bumbo-ataque',
        cch: 'caixa-chimbal',
        co: 'conducao',
        bco: 'bumbo-conducao',
        cco: 'caixa-conducao',
        to1: 'tom-1',
        to2: 'tom-2',
        su: 'surdo',
        bch: 'bumbo-chimbal'
    };

    const BASS_SAMPLES = {};
    for (const p of PITCHES) {
        BASS_SAMPLES[p] = `assets/bass-${p}.mp3`;
        if (p.endsWith('S')) {
            const base = p.replace('S', '');
            BASS_SAMPLES[base + '8S'] = `assets/bass-${base}8S.mp3`;
        } else {
            BASS_SAMPLES[p + '8'] = `assets/bass-${p}8.mp3`;
        }
    }
    BASS_SAMPLES['x'] = 'assets/bass-muted.mp3';

    const STYLE_PROGRESSIONS = {
        Rock: [[1,4,5,1], [1,5,6,4], [6,4,1,5]],
        Rock2: [[4,5,1,5], [5,4,1,4], [7,4,1,1]],
        Rock3: [[1,4,5,1], [1,3,4,5]],
        Rock4: [[6,4,1,5,1,5,4,5], [1,4,5,1,4,5,4,5], [1,5,6,4,1,5,6,7]],
        Rock5: [[1,5,7,4], [1,4,5,6], [1,5,6,4]],
        Rock6: [[1,5,6,4], [1,4,5,1], [1,5,6,7]],
        Rock7: [[2,3,5,1], [1,4,7,1], [1,5,3,4]],
        Rock_Progressivo: [[4,5,1,1,4,5,7], [1,4,1,4,5,6,5], [1,4,5,6,3,5,4]],
        Rock_Progressivo2: [[1,4,5,1,5], [4,5,3,1,3,1,4,5,7,5], [1,4,1,4,5]],
        Rock_Progressivo3: [[1,4,5,1,5,7], [1,3,4,5,2,5]],
        Rock_Progressivo4: [[4,5,1,1,4,5,7,5], [1,4,1,4,5,6,5,7], [1,4,5,6,3,5,4,5]],
        Rock_Progressivo5: [[4,5,1,1,4,5,7], [1,4,1,4,5,6,5], [1,4,5,6,3,5,4]], 
        Rock_Progressivo6: [[1,4,5,6,3,5], [1,4,1,4,5,6,5]],
        Rock_Progressivo7: [[4,5,1,1], [1,4,5,1]],      
        Blues: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,1]],
        Blues2: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,1]],
        Blues3: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,7]],
        Blues4: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,1]],
        Blues5: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,7]],
        Blues6: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,1]],
        Blues7: [[1,4,5,4,1,4,5,4,1,4,5,4], [1,4,5,1]],
        Forr√≥: [[1,5,1,5,4,5,4,5]],
        Samba: [[2,5,1,1], [1,4,5,1]],
        Metal: [[1, 3, 5, 6, 1, 2, 3, 4], [1, 3, 4, 5], [2, 5, 1, 5]],
        Metal2: [[1, 3, 5, 4, 1, 2, 3, 4], [1, 3, 4, 5], [2, 5, 1, 5]],
        Metal3: [[1, 3, 5, 3, 1, 2, 4, 5], [1, 3, 4, 5], [2, 5, 1, 5]],
        Jazz: [[1,2,5,1], [2,5,1,4], [3,6,2,5]]
    };

    const ALL_GROOVES = [
        { name: "Rock", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Rock2", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 5] },
        { name: "Rock3", meter: "4/4", drumPattern: ["bch - ch bu cch bu ch - bch - ch - cch - ch -"], bassRhythm: ["bo - - bo - - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 1] },
        { name: "Rock4", meter: "4/4", drumPattern: ["ba - co - cco - co - bco - co - cco bu bco bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 7, 8, 7, 5, 3] },
        { name: "Rock5", meter: "4/4", drumPattern: ["bch ch ch ch cch ch ch ch bch ch ch ch cch ch ch -"], bassRhythm: ["bo - - bo - - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 1, 5] },
        { name: "Rock6", meter: "4/4", drumPattern: ["bco co co co cco co co co bco co co co cco co co co"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [8, 8, 1, 1] },
        { name: "Rock7", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - co - cco - co -"], bassRhythm: ["bo - - bo - - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 1] },
        { name: "Rock_Progressivo", meter: "7/4", drumPattern: ["bch - ch -  cch - ch - bch - ch - cch - ch bu bch - ch - cch - ch - bch - ch bu"], bassRhythm: ["bo - - - - - - - bo - - - - - - bo - - bo bo bo bo bo bo bo bo bo bo"], bassScale: [1, 1, 1, 3, 5, 8, 3, 5, 8, 3, 5, 8, 5] },
        { name: "Rock_Progressivo2", meter: "5/4", drumPattern: ["ba - ch - bch - ch - cch - ch - bch - ch - cch - ch bu"], bassRhythm: ["bo - x x bo - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 1, 3, 5, 8, 1, 3, 5, 8] },
        { name: "Rock_Progressivo3", meter: "6/4", drumPattern: ["ba - - - ch - - bu cch - - - ch - - - bch - - - ch - - -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 3, 1, 1, 1, 3, 5, 5, 5, 1] },
        { name: "Rock_Progressivo4", meter: "4/4", drumPattern: ["ba - ch bu cch - ch - bch - ch bu cch - ch bu"], bassRhythm: ["bo - - bo - - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Rock_Progressivo5", meter: "7/4", drumPattern: ["ba - co -  cco - co - bco - co bu cco - co bu bch bu co - cch - ch - bch - ch bu"], bassRhythm: ["bo - - bo bo - - - bo - - bo bo - - bo - - bo bo - - bo bo - - bo bo"], bassScale: [1, 3, 5, 8] },
        { name: "Rock_Progressivo6", meter: "3/4", drumPattern: ["bch - - - ch - - bu cch - - -"], bassRhythm: ["bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8, 8, 8]},
        { name: "Rock_Progressivo7", meter: "4/4", drumPattern: ["bco co cch to1 cch - ch - bch - ch cch bu bu ch bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 1] },
        { name: "Blues", meter: "4/4", drumPattern: ["bch - - bu cch - ch - bch - - bu cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 7, 8, 7, 5, 3] },
        { name: "Blues2", meter: "4/4", drumPattern: ["bch - - - cch - - - bch - - - cch - - -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Blues3", meter: "4/4", drumPattern: ["bch - - bu cch - ch - ch - - bu cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 7] },
        { name: "Blues4", meter: "4/4", drumPattern: ["bch - - bu cch - ch - bch - - bu cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [8, 7, 5, 3, 1, 3, 5, 7] },
        { name: "Blues5", meter: "4/4", drumPattern: ["bch - - bu cch - ch - bch - - bu cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 7, 1, 1, 1, 1] },
        { name: "Blues6", meter: "4/4", drumPattern: ["bch - - bu cch - ch - bch - - bu cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8, 8, 8, 8, 8] },
        { name: "Blues7", meter: "4/4", drumPattern: ["bch - - bu cch - ch - bch - - bu cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8, 7, 5, 3, 5] },
        { name: "Forr√≥", meter: "2/4", drumPattern: ["bch co ch bu bco ch cch"], bassRhythm: ["bo - - - bo - - x"], bassScale: [8, 1] },
        { name: "Forr√≥2", meter: "2/4", drumPattern: ["su co ch bu bco ch co"], bassRhythm: ["bo - - - bo - - x"], bassScale: [8,1] },
        { name: "Forr√≥3", meter: "2/4", drumPattern: ["bch co ch su bco ch su"], bassRhythm: ["bo - - - bo - - x"], bassScale: [8, 1] },
        { name: "Forr√≥4", meter: "2/4", drumPattern: ["bch co ch bu bco su cch"], bassRhythm: ["bo - - - bo - - x"], bassScale: [8, 1] },
        { name: "Metal", meter: "4/4", drumPattern: ["bch bu bch bu cch bu bch bu bch bu bch bu cch bu bch bu"], bassRhythm: ["bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo"], guitarRhythm: ["ab ab ab ab so - - - ab - ab - so - - -"] },
        { name: "Metal2", meter: "4/4", drumPattern: ["bch bu bch bu cch bu bch bu cch - ch bu cch bu bch bu"], bassRhythm: ["bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo bo"], guitarRhythm: ["ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab"] },
        { name: "Metal3", meter: "4/4", drumPattern: ["bch bu bch - cch - ch - bch bu ch bu cch - ch -"], bassRhythm: ["bo bo bo - - - - - bo bo - bo - - - -"] },
        { name: "Metal4", meter: "4/4", drumPattern: ["bch bu cch - bu bu cch - bu bu cch - bu bu cch -"], bassRhythm: ["bo bo bo - bo bo bo - bo bo bo - bo bo bo -"], guitarRhythm: ["ab - ab - so - - - ab - ab - so - - -"] },
        { name: "Samba", meter: "2/4", drumPattern: ["bch - ch bu bch - ch bu"], bassRhythm: ["bo - - x bo - - x"], bassScale: [8, 5] },
        { name: "Jazz", meter: "4/4", drumPattern: ["bch co co - co co co ca bch co co - bch co co cch"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: "chromatic" },
    ];

    initializeStyleAndKeySelectors();

    // ===== ESTADO DA APLICA√á√ÉO =====
    const state = {
        running: false,
        paused: false,
        pauseTime: 0,
        nextNoteTime: 0,
        meter: '4/4',
        bpm: 100,
        sixteenthDur: 0.15,
        stepIndex: 0,
        buffers: { drums: {}, bass: {}, guitar: {}, melody: {} },
        bassPlan: [],
        chordPlan: [],
        signatureTag: '',
        key: null,
        keyIdx: 0,
        quality: 'maj',
        chordProgression: [],
        chordDurations: [],
        currentGroove: null,
        currentChordIndex: 0,
        barsInChord: 0,
        clickCount: 0,
        totalClicks: 0,
        drumSeq: [],
        lastBassSource: null,
        lastBassGainNode: null,
        lastCleanSource: null,
        lastDistSource: null,
        lastMelodySource: null,
        lastMelodyGain: null,
        lastPianoStringSource: null,
        // --- NOVAS PROPRIEDADES ---
        lastEchoSource: null,
        lastCleanPickedSource: null,
        lastOrganSource: null,
        // --- FIM ---
        melodyBlocks: [],
        melodyPlan: [],
        lastMelodyNote: null,
        guitarPlan: null,
        activeInput: null,
        schedulerTimer: null,
        isRecording: false,
        mediaRecorder: null,
        recordedChunks: [],
        pauseTime: 0,
        previousPlayback: null,
        currentPlayback: null
    };

    // ===== CONFIGURA√á√ÉO INICIAL DE MUTE =====
    // Baixo, bateria e melodia come√ßam ativos (n√£o mudos)
    // Todos os instrumentos de harmonia come√ßam mudos
    const mute = { 
        bass: false, 
        drums: false, 
        clean: true, 
        dist: true, 
        pianoString: true, 
        melody: false,
        // --- NOVOS INSTRUMENTOS MUTADOS POR PADR√ÉO ---
        echo: true,
        cleanPicked: true,
        organ: true
        // --- FIM ---
    };

    // ===== FUN√á√ïES UTILIT√ÅRIAS =====
    function log(msg) {
        console.log(`[LOG] ${msg}`);
    }

    function meterToBeats(meter) {
        return Number(meter.split('/')[0]) || 4;
    }

    // Painel "Estado Atual" foi removido conforme solicitado
    function setStatePanel() {
        // Fun√ß√£o vazia - o painel foi removido
    }

    let initPromise = null;

    function updateVolume() {
        if (audio.bassGain) audio.bassGain.gain.value = parseFloat(ui.volBass.value);
        if (audio.drumGain) audio.drumGain.gain.value = parseFloat(ui.volDrums.value);
        if (audio.cleanGain) audio.cleanGain.gain.value = parseFloat(ui.volClean.value);
        if (audio.distGain) audio.distGain.gain.value = parseFloat(ui.volDist.value);
        if (audio.pianoStringGain) audio.pianoStringGain.gain.value = parseFloat(ui.volPianoString.value);
        if (audio.melodyGain) audio.melodyGain.gain.value = parseFloat(ui.volMelody.value);
        // --- NOVOS VOLUMES ---
        if (audio.echoGain) audio.echoGain.gain.value = parseFloat(ui.volEcho.value);
        if (audio.cleanPickedGain) audio.cleanPickedGain.gain.value = parseFloat(ui.volCleanPicked.value);
        if (audio.organGain) audio.organGain.gain.value = parseFloat(ui.volOrgan.value);
        // --- FIM ---

        ui.volBassLabel.textContent = Math.round(ui.volBass.value * 100) + '%';
        ui.volDrumsLabel.textContent = Math.round(ui.volDrums.value * 100) + '%';
        ui.volCleanLabel.textContent = Math.round(ui.volClean.value * 100) + '%';
        ui.volDistLabel.textContent = Math.round(ui.volDist.value * 100) + '%';
        ui.volMelodyLabel.textContent = Math.round(ui.volMelody.value * 100) + '%';
        ui.volPianoStringLabel.textContent = Math.round(ui.volPianoString.value * 100) + '%';
        // --- NOVOS LABELS ---
        if (ui.volEchoLabel) ui.volEchoLabel.textContent = Math.round(ui.volEcho.value * 100) + '%';
        if (ui.volCleanPickedLabel) ui.volCleanPickedLabel.textContent = Math.round(ui.volCleanPicked.value * 100) + '%';
        if (ui.volOrganLabel) ui.volOrganLabel.textContent = Math.round(ui.volOrgan.value * 100) + '%';
    }

    async function initAudio() {
        if (audio.ctx) return;
        if (initPromise) return initPromise;

        initPromise = (async () => {
            try {
                audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
                audio.master = audio.ctx.createGain();
                audio.mix = audio.ctx.createGain();
                audio.drumGain = audio.ctx.createGain();
                audio.bassGain = audio.ctx.createGain();
                audio.cleanGain = audio.ctx.createGain();
                audio.distGain = audio.ctx.createGain();
                audio.pianoStringGain = audio.ctx.createGain();
                audio.melodyGain = audio.ctx.createGain();
                // --- NOVOS GANHOS ---
                audio.echoGain = audio.ctx.createGain();
                audio.cleanPickedGain = audio.ctx.createGain();
                audio.organGain = audio.ctx.createGain();
                // --- FIM ---

                // Configura volumes iniciais
                audio.pianoStringGain.gain.value = 0.50;
                audio.melodyGain.gain.value = 0.50;
                // --- NOVOS VOLUMES INICIAIS ---
                audio.echoGain.gain.value = 0.50;
                audio.cleanPickedGain.gain.value = 0.50;
                audio.organGain.gain.value = 0.50;
                // --- FIM ---

                audio.master.gain.value = 0.9;
                audio.drumGain.gain.value = 0.6;
                audio.bassGain.gain.value = 0.45;
                audio.cleanGain.gain.value = 0.45;
                audio.distGain.gain.value = 0.35;

                // Conex√µes
                audio.master.connect(audio.mix);
                audio.mix.connect(audio.ctx.destination);
                audio.drumGain.connect(audio.master);
                audio.bassGain.connect(audio.master);
                audio.cleanGain.connect(audio.master);
                audio.distGain.connect(audio.master);
                audio.pianoStringGain.connect(audio.master);
                audio.melodyGain.connect(audio.master);
                // --- NOVAS CONEX√ïES ---
                audio.echoGain.connect(audio.master);
                audio.cleanPickedGain.connect(audio.master);
                audio.organGain.connect(audio.master);
                // --- FIM ---

                if (!state.buffers.melody) state.buffers.melody = {};
                await ensureBasicSamples();

                // Event listeners para controles de volume
                ui.volBass.addEventListener('input', updateVolume);
                ui.volDrums.addEventListener('input', updateVolume);
                ui.volClean.addEventListener('input', updateVolume);
                ui.volDist.addEventListener('input', updateVolume);
                ui.volPianoString.addEventListener('input', updateVolume);
                ui.volMelody.addEventListener('input', updateVolume);
                // --- NOVOS EVENT LISTENERS ---
                if (ui.volEcho) ui.volEcho.addEventListener('input', updateVolume);
                if (ui.volCleanPicked) ui.volCleanPicked.addEventListener('input', updateVolume);
                if (ui.volOrgan) ui.volOrgan.addEventListener('input', updateVolume);
                // --- FIM ---

                updateVolume();
            } catch (error) {
                console.error('Erro ao inicializar √°udio:', error);
            }
        })();

        return initPromise;
    }

    async function loadBuffer(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const arrayBuffer = await res.arrayBuffer();
            return await audio.ctx.decodeAudioData(arrayBuffer);
        } catch (e) {
            console.warn(`Erro ao carregar: ${url}`);
            return null;
        }
    }

    async function ensureBasicSamples() {
        const promises = [];
        for (const [key, name] of Object.entries(DRUMS)) {
            const url = `assets/${name}.mp3`;
            if (!state.buffers.drums[key]) {
                promises.push(loadBuffer(url).then(buf => { if (buf) state.buffers.drums[key] = buf; }));
            }
        }
        for (const [key, url] of Object.entries(BASS_SAMPLES)) {
            if (!state.buffers.bass[key]) {
                promises.push(loadBuffer(url).then(buf => { if (buf) state.buffers.bass[key] = buf; }));
            }
        }
        await Promise.all(promises);
    }

    function expandRhythm(patternArray, totalSteps) {
        const joined = patternArray.join(' ').replace(/\s+/g, ' ').trim();
        const tokens = joined.split(/\s+/).filter(t => t);
        const out = [];
        let i = 0;
        while (out.length < totalSteps) {
            for (const token of tokens) {
                if (out.length >= totalSteps) break;
                out.push(token);
            }
            if (i++ > 1000) break;
        }
        return out.slice(0, totalSteps);
    }

    // ===== FUN√á√ïES PRINCIPAIS =====
    async function buildBassAndChordPlan() {
        // Escolhe o groove baseado na sele√ß√£o do usu√°rio ou aleatoriamente
        if (!ui.styleSelect || ui.styleSelect.value === 'auto') {
            state.currentGroove = ALL_GROOVES[Math.floor(Math.random() * ALL_GROOVES.length)];
        } else {
            // Filtra os grooves que correspondem ao estilo selecionado
            const matchingGrooves = ALL_GROOVES.filter(g => g.name === ui.styleSelect.value);
            state.currentGroove = matchingGrooves[Math.floor(Math.random() * matchingGrooves.length)] || ALL_GROOVES[0];
        }
        state.signatureTag = state.currentGroove.name;
        state.meter = ui.meter.value === 'auto' ? state.currentGroove.meter : ui.meter.value;

        if (state.currentGroove.name === "Samba") {
            ui.bpm.value = 70;
            state.bpm = 70;
        } else {
            state.bpm = Number(ui.bpm.value) || 100;
        }

        const beats = meterToBeats(state.meter);
        const sixteenthsPerBar = beats * 4;

        // Escolhe a tonalidade e qualidade baseadas na sele√ß√£o do usu√°rio ou aleatoriamente
        if (!ui.keySelect || ui.keySelect.value === 'auto') {
            state.keyIdx = Math.floor(Math.random() * PITCHES.length);
            state.key = PITCHES[state.keyIdx];
            // Se for aleat√≥rio, define qualidade aleat√≥ria
            state.quality = Math.random() > 0.5 ? 'maj' : 'min';
        } else {
            state.key = ui.keySelect.value;
            state.keyIdx = PITCHES.indexOf(state.key);
            // Define a qualidade baseada na nova sele√ß√£o do usu√°rio
            state.quality = ui.qualitySelect.value;
        }

        const grooveName = state.currentGroove.name;
        let styleKey = "Rock";
        if (grooveName.includes("Samba")) styleKey = "Samba";
        else if (grooveName.includes("Jazz")) styleKey = "Jazz";
        else if (grooveName.includes("Forr√≥")) styleKey = "Forr√≥";
        else if (grooveName.includes("Metal")) styleKey = "Metal";
        else if (grooveName.includes("Blues")) styleKey = "Blues";

        const progressions = STYLE_PROGRESSIONS[styleKey] || STYLE_PROGRESSIONS.Rock;
        
        // üîπ Aqui removemos todas as progress√µes que contenham o grau 7 (diminuto)
        let availableProgressions = progressions.filter(prog => !prog.includes(7));
        if (availableProgressions.length === 0) {
            availableProgressions = progressions; // fallback
        }
        state.chordProgression = availableProgressions[Math.floor(Math.random() * availableProgressions.length)];

        const totalBars = Math.min(state.chordProgression.length, 64);
        const totalSteps = sixteenthsPerBar * totalBars;

        const rhythm = expandRhythm(state.currentGroove.bassRhythm, totalSteps);
        const bassPlan = [];
        const chordPlan = [];

        function getBassNotesFromScale(degree, scale, chordType) {
            // Determina se o acorde DEVE ser menor com base na qualidade da tonalidade
            let isMinor = false;
            if ([1, 4, 5].includes(degree)) {
                isMinor = (state.quality === 'min');
            } else if ([2, 3, 6].includes(degree)) {
                isMinor = (state.quality === 'maj');
            }
            
            // Se o acorde √© diminuto (grau 7), for√ßa ser menor
            if (degree === 7) {
                isMinor = true;
            }

            // Se o acorde √© menor, ajusta a ter√ßa
            if (isMinor) {
                return [scale[degree - 1], scale[degree - 1] + 3, scale[degree - 1] + 7];
            } else {
                return [scale[degree - 1], scale[degree - 1] + 4, scale[degree - 1] + 7];
            }
        }

        // üîπ CORRE√á√ÉO: Verifica se os graus usados pelo baixo est√£o corretos
        function getBassNoteForChord(degree, scale, stepIndex, bassScalePattern) {
            const rootNote = scale[degree - 1];
            
            // Se n√£o h√° padr√£o de escala definido, usa a nota raiz
            if (!bassScalePattern || bassScalePattern.length === 0) {
                return rootNote;
            }
            
            // Usa o padr√£o de escala para determinar qual nota tocar
            const patternIndex = stepIndex % bassScalePattern.length;
            const scaleDegree = bassScalePattern[patternIndex];
            
            // Ajusta para garantir que est√° dentro da escala
            if (scaleDegree <= scale.length) {
                return scale[scaleDegree - 1];
            }
            
            return rootNote;
        }

        // Gera a escala baseada na tonalidade e qualidade
        const scale = [];
        const rootOffset = state.keyIdx;
        const intervals = state.quality === 'maj' ? [0, 2, 4, 5, 7, 9, 11] : [0, 2, 3, 5, 7, 8, 10];
        for (let i = 0; i < 3; i++) {
            for (const interval of intervals) {
                scale.push(i * 12 + interval + rootOffset);
            }
        }
        scale.sort((a, b) => a - b);

        // üîπ CORRE√á√ÉO: Verifica se o padr√£o de escala do baixo est√° correto
        let bassScalePattern = state.currentGroove.bassScale;
        if (bassScalePattern === "chromatic") {
            bassScalePattern = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
        } else if (!Array.isArray(bassScalePattern)) {
            bassScalePattern = [1, 3, 5, 8]; // padr√£o fallback
        }

        // üîπ CORRE√á√ÉO: Garante que os graus do baixo correspondem aos acordes
        for (let bar = 0; bar < totalBars; bar++) {
            const degree = state.chordProgression[bar % state.chordProgression.length];
            const chordNotes = getBassNotesFromScale(degree, scale, state.quality);
            
            for (let step = 0; step < sixteenthsPerBar; step++) {
                const stepIndex = bar * sixteenthsPerBar + step;
                const rhythmToken = rhythm[stepIndex];
                
                if (rhythmToken === 'bo' || rhythmToken === 'x') {
                    // üîπ CORRE√á√ÉO: Usa a fun√ß√£o corrigida para obter a nota do baixo
                    const bassNoteIndex = getBassNoteForChord(degree, scale, stepIndex, bassScalePattern);
                    const bassNote = scale[bassNoteIndex - 1] || scale[0];
                    
                    bassPlan.push({
                        step: stepIndex,
                        note: bassNote,
                        type: rhythmToken === 'x' ? 'muted' : 'normal'
                    });
                } else {
                    bassPlan.push(null);
                }
                
                chordPlan.push({
                    step: stepIndex,
                    degree: degree,
                    notes: chordNotes
                });
            }
        }

        state.bassPlan = bassPlan;
        state.chordPlan = chordPlan;
        state.totalClicks = totalSteps;
        state.stepIndex = 0;
        state.currentChordIndex = 0;
        state.barsInChord = 0;
        state.clickCount = 0;

        // Atualiza a interface com o acorde atual
        updateChordDisplay();
    }

    function updateChordDisplay() {
        if (state.chordPlan.length === 0) return;
        
        const currentChord = state.chordPlan[state.stepIndex];
        if (!currentChord) return;
        
        const degree = currentChord.degree;
        const rootNote = CHORD_NAMES[(DEGREE_TO_ROOT[degree] + PITCHES.indexOf(state.key)) % 12];
        
        // Determina se o acorde √© menor baseado na qualidade da tonalidade
        let chordQuality = '';
        if ([1, 4, 5].includes(degree)) {
            chordQuality = state.quality === 'min' ? 'm' : '';
        } else if ([2, 3, 6].includes(degree)) {
            chordQuality = state.quality === 'maj' ? 'm' : '';
        }
        
        // Se for o grau 7 (diminuto), marca como menor
        if (degree === 7) {
            chordQuality = 'm';
        }
        
        const chordSymbol = rootNote + chordQuality;
        ui.currentChord.textContent = chordSymbol;
        
        // Atualiza o timer do acorde
        const progress = ((state.clickCount % (meterToBeats(state.meter) * 4)) / (meterToBeats(state.meter) * 4)) * 100;
        ui.chordTimer.style.width = progress + '%';
    }

    function playBass(note, type) {
        if (!audio.ctx || mute.bass) return;
        
        // Para a nota anterior se ainda estiver tocando
        if (state.lastBassSource) {
            state.lastBassSource.stop();
        }
        if (state.lastBassGainNode) {
            state.lastBassGainNode.gain.cancelScheduledValues(audio.ctx.currentTime);
        }

        const bufferKey = type === 'muted' ? 'x' : getBassSampleForNote(note);
        const buffer = state.buffers.bass[bufferKey];
        if (!buffer) return;

        const source = audio.ctx.createBufferSource();
        source.buffer = buffer;
        
        const gainNode = audio.ctx.createGain();
        gainNode.gain.value = 0;
        
        source.connect(gainNode);
        gainNode.connect(audio.bassGain);
        
        const now = audio.ctx.currentTime;
        const attackTime = 0.02;
        const releaseTime = type === 'muted' ? 0.1 : 0.3;
        
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(parseFloat(ui.volBass.value), now + attackTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + releaseTime);
        
        source.start(now);
        source.stop(now + releaseTime);
        
        state.lastBassSource = source;
        state.lastBassGainNode = gainNode;
    }

    function getBassSampleForNote(noteValue) {
        const octave = Math.floor(noteValue / 12);
        const noteIndex = noteValue % 12;
        const noteName = PITCHES[noteIndex];
        
        if (octave === 2) {
            return noteName.endsWith('S') ? noteName.replace('S', '8S') : noteName + '8';
        }
        return noteName;
    }

    function playDrums(stepTokens) {
        if (!audio.ctx || mute.drums) return;
        
        const now = audio.ctx.currentTime;
        for (const token of stepTokens) {
            if (token === '-' || !DRUMS[token]) continue;
            
            const buffer = state.buffers.drums[token];
            if (!buffer) continue;
            
            const source = audio.ctx.createBufferSource();
            source.buffer = buffer;
            source.connect(audio.drumGain);
            source.start(now);
        }
    }

    function playGuitar(note, type) {
        if (!audio.ctx) return;
        
        // Determina qual ganho usar baseado no tipo
        let gainNode;
        if (type === 'clean') {
            if (mute.clean) return;
            gainNode = audio.cleanGain;
            // Para a nota anterior do clean se ainda estiver tocando
            if (state.lastCleanSource) {
                state.lastCleanSource.stop();
            }
        } else if (type === 'dist') {
            if (mute.dist) return;
            gainNode = audio.distGain;
            // Para a nota anterior do dist se ainda estiver tocando
            if (state.lastDistSource) {
                state.lastDistSource.stop();
            }
        } else {
            return;
        }

        const bufferKey = getGuitarSampleForNote(note, type);
        const buffer = state.buffers.guitar[bufferKey];
        if (!buffer) return;

        const source = audio.ctx.createBufferSource();
        source.buffer = buffer;
        source.connect(gainNode);
        
        const now = audio.ctx.currentTime;
        source.start(now);
        
        if (type === 'clean') {
            state.lastCleanSource = source;
        } else if (type === 'dist') {
            state.lastDistSource = source;
        }
    }

    function getGuitarSampleForNote(noteValue, type) {
        const octave = Math.floor(noteValue / 12);
        const noteIndex = noteValue % 12;
        const noteName = PITCHES[noteIndex];
        
        // Para guitarra, usamos amostras espec√≠ficas por tipo e oitava
        if (octave === 3) {
            return `${type}-${noteName}`;
        } else if (octave === 4) {
            return `${type}-${noteName}8`;
        }
        return `${type}-${noteName}`;
    }

    // ===== SCHEDULER =====
    function scheduler() {
        if (!state.running || state.paused) return;
        
        const now = audio.ctx.currentTime;
        const sixteenthDur = 60 / state.bpm / 4;
        
        while (state.nextNoteTime < now + 0.1) {
            scheduleNote(state.stepIndex, state.nextNoteTime);
            nextNote();
        }
        
        state.schedulerTimer = setTimeout(scheduler, 50);
    }

    function scheduleNote(stepIndex, time) {
        if (stepIndex >= state.totalClicks) return;
        
        // Toca a bateria
        const drumPattern = expandRhythm(state.currentGroove.drumPattern, state.totalClicks);
        const stepTokens = drumPattern[stepIndex] ? drumPattern[stepIndex].split(/\s+/) : [];
        playDrums(stepTokens);
        
        // Toca o baixo
        const bassEvent = state.bassPlan[stepIndex];
        if (bassEvent) {
            playBass(bassEvent.note, bassEvent.type);
        }
        
        // Atualiza o display do acorde
        updateChordDisplay();
        
        state.clickCount++;
        state.stepIndex = stepIndex;
    }

    function nextNote() {
        state.nextNoteTime += state.sixteenthDur;
        state.stepIndex++;
        
        if (state.stepIndex >= state.totalClicks) {
            state.stepIndex = 0;
            state.clickCount = 0;
        }
    }

    // ===== CONTROLES DE TRANSPORTE =====
    async function startPlayback() {
        await initAudio();
        if (audio.ctx.state === 'suspended') {
            await audio.ctx.resume();
        }
        
        if (state.paused) {
            // Retoma da pausa
            state.paused = false;
            state.nextNoteTime = audio.ctx.currentTime;
            scheduler();
        } else {
            // Inicia novo
            await buildBassAndChordPlan();
            state.running = true;
            state.paused = false;
            state.nextNoteTime = audio.ctx.currentTime;
            state.sixteenthDur = 60 / state.bpm / 4;
            scheduler();
        }
        
        updateTransportButtons();
    }

    function pausePlayback() {
        if (!state.running) return;
        
        state.paused = true;
        state.pauseTime = audio.ctx.currentTime;
        
        if (state.schedulerTimer) {
            clearTimeout(state.schedulerTimer);
            state.schedulerTimer = null;
        }
        
        updateTransportButtons();
    }

    function stopPlayback() {
        state.running = false;
        state.paused = false;
        
        if (state.schedulerTimer) {
            clearTimeout(state.schedulerTimer);
            state.schedulerTimer = null;
        }
        
        // Para todas as fontes de √°udio ativas
        if (state.lastBassSource) {
            state.lastBassSource.stop();
            state.lastBassSource = null;
        }
        if (state.lastCleanSource) {
            state.lastCleanSource.stop();
            state.lastCleanSource = null;
        }
        if (state.lastDistSource) {
            state.lastDistSource.stop();
            state.lastDistSource = null;
        }
        if (state.lastMelodySource) {
            state.lastMelodySource.stop();
            state.lastMelodySource = null;
        }
        if (state.lastPianoStringSource) {
            state.lastPianoStringSource.stop();
            state.lastPianoStringSource = null;
        }
        // --- PARA AS NOVAS FONTES ---
        if (state.lastEchoSource) {
            state.lastEchoSource.stop();
            state.lastEchoSource = null;
        }
        if (state.lastCleanPickedSource) {
            state.lastCleanPickedSource.stop();
            state.lastCleanPickedSource = null;
        }
        if (state.lastOrganSource) {
            state.lastOrganSource.stop();
            state.lastOrganSource = null;
        }
        // --- FIM ---
        
        updateTransportButtons();
    }

    function updateTransportButtons() {
        ui.play.disabled = state.running && !state.paused;
        ui.pause.disabled = !state.running || state.paused;
        ui.stop.disabled = !state.running;
    }

    // ===== EVENT LISTENERS =====
    ui.play.addEventListener('click', startPlayback);
    ui.pause.addEventListener('click', pausePlayback);
    ui.stop.addEventListener('click', stopPlayback);

    // Controles de mute
    ui.muteBass.addEventListener('change', (e) => { mute.bass = e.target.checked; });
    ui.muteDrums.addEventListener('change', (e) => { mute.drums = e.target.checked; });
    ui.muteClean.addEventListener('change', (e) => { mute.clean = e.target.checked; });
    ui.muteDist.addEventListener('change', (e) => { mute.dist = e.target.checked; });
    ui.mutePianoString.addEventListener('change', (e) => { mute.pianoString = e.target.checked; });
    // --- NOVOS CONTROLES DE MUTE ---
    if (ui.muteEcho) ui.muteEcho.addEventListener('change', (e) => { mute.echo = e.target.checked; });
    if (ui.muteCleanPicked) ui.muteCleanPicked.addEventListener('change', (e) => { mute.cleanPicked = e.target.checked; });
    if (ui.muteOrgan) ui.muteOrgan.addEventListener('change', (e) => { mute.organ = e.target.checked; });
    // --- FIM ---

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
        initializeStyleAndKeySelectors();
        updateTransportButtons();
        
        // Configura os controles de mute iniciais conforme solicitado
        // Baixo, bateria e melodia ativos; harmonia mudos
        ui.muteBass.checked = false;   // Baixo ativo
        ui.muteDrums.checked = false;  // Bateria ativa
        ui.muteClean.checked = true;   // Guitarra limpa muda
        ui.muteDist.checked = true;    // Guitarra distorcida muda
        ui.mutePianoString.checked = true; // Piano/Strings mudo
        
        // --- NOVOS INSTRUMENTOS MUDOS POR PADR√ÉO ---
        if (ui.muteEcho) ui.muteEcho.checked = true;           // Guitarra Echo muda
        if (ui.muteCleanPicked) ui.muteCleanPicked.checked = true; // Guitarra arpejo muda
        if (ui.muteOrgan) ui.muteOrgan.checked = true;         // Org√£o mudo
        // --- FIM ---
    });

    // ===== FUN√á√ïES ADICIONAIS (para completar) =====
    function updateMeterDisplay() {
        // Fun√ß√£o para atualizar o display do compasso
    }

    function updateBPMDisplay() {
        // Fun√ß√£o para atualizar o display do BPM
    }

    // Export para uso global se necess√°rio
    window.app = {
        audio,
        state,
        mute,
        startPlayback,
        pausePlayback,
        stopPlayback,
        buildBassAndChordPlan
    };
</script>
</body>
</html>
