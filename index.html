<!DOCTYPE html> 
<html lang="pt-BR"> 
<head> 
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>Jam on ‚Äì Playback Aleat√≥rio</title> 
  <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script> 
  <style> 
    :root { 
      --bg: #0b0f14; 
      --panel: #121822; 
      --accent: #5eead4; 
      --muted: #7a89a6; 
      --text: #e6edf6; 
      --danger: #f87171; 
      --ok: #86efac; 
    } 
    * { 
      box-sizing: border-box; 
    } 
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 
"Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; 
      min-height: 100vh; 
      display: grid; 
      place-items: center; 
    } 
    .wrap { 
      width: min(1100px, 92vw); 
    } 
    header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 1rem; 
      margin: 2rem 0 1.25rem; 
    } 
    h1 { 
      font-size: clamp(1.4rem, 2.2vw, 2rem); 
      margin: 0; 
      letter-spacing: .3px; 
    } 
    .chord-display { 
      grid-column: span 12; 
      text-align: center; 
      margin: 1rem 0; 
    } 
    .chord-name { 
      font-size: 4rem; 
      font-weight: bold; 
      color: var(--accent); 
      margin: 0; 
    } 
    .chord-timer { 
      font-size: 1.5rem; 
      color: var(--ok); 
    } 
    .card { 
      background: linear-gradient(180deg, #121822, #0d131c); 
      border: 1px solid #1e293b; 
      border-radius: 18px; 
      padding: 1rem; 
      box-shadow: 0 10px 40px rgba(0,0,0,.25); 
    } 
    .grid { 
      display: grid; 
      grid-template-columns: repeat(12, 1fr); 
      gap: 12px; 
    } 
    .controls { 
      grid-column: span 12; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      align-items: center; 
    } 
    .controls button, 
    .controls select, 
    .controls input[type="number"] { 
      background: #0f172a; 
      color: var(--text); 
      border: 1px solid #1f2937; 
      border-radius: 12px; 
      padding: .65rem .9rem; 
      font-size: .95rem; 
      outline: none; 
    } 
    .controls button.muted { 
      opacity: 0.5; 
      text-decoration: line-through; 
    } 
    .controls button { 
      cursor: pointer; 
      border-color: #334155; 
      transition: transform .06s ease, background .2s ease, border-color .2s ease; 
    } 
    .controls button:hover { 
      transform: translateY(-1px); 
    } 
    .controls button.primary { 
      background: #0b3b39; 
      border-color: #134e4a; 
    } 
    .controls button.primary[data-state="on"] { 
      background: #065f46; 
      border-color: #0f766e; 
    } 
    .controls button.danger { 
      background: #3b0b0b; 
      border-color: #7f1d1d; 
    } 
    .pill { 
      background: #0b1320; 
      border: 1px solid #1f2a44; 
      padding: .4rem .6rem; 
      border-radius: 999px; 
      font-size: .85rem; 
      color: var(--muted); 
    } 
    .split { 
      grid-column: span 12; 
      display: grid; 
      grid-template-columns: repeat(12, 1fr); 
      gap: 12px; 
    } 
    .panel { 
      grid-column: span 6; 
      background: #0b0f16; 
      border: 1px solid #1b2538; 
      border-radius: 12px; 
      padding: 12px; 
    } 
    .panel h3 { 
      margin: 0 0 8px; 
      font-size: 1rem; 
      color: #a6b4cf; 
    } 
    .mono { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation 
Mono", "Courier New", monospace; 
      font-size: .92rem; 
    } 
    .log { 
      grid-column: span 12; 
      background: #080c12; 
      border: 1px dashed #1b283b; 
      border-radius: 12px; 
      padding: 10px; 
      height: 170px; 
      overflow: auto; 
      white-space: pre-wrap; 
      font-size: .9rem; 
      color: #cbd5e1; 
    } 
    .footer { 
      margin: .75rem 0 0; 
      color: var(--muted); 
      font-size: .85rem; 
    } 
    .badge { 
      display: inline-block; 
      padding: .15rem .45rem; 
      border-radius: 6px; 
      border: 1px solid #294256; 
      background: #0b1826; 
      color: #9bd5f0; 
      font-size: .8rem; 
    } 
    .row { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; 
    } 
    .spacer { 
      flex: 1 1 auto; 
    } 
    .muted { 
      opacity: 0.5; 
    } 
    .groove-editor { 
      grid-column: span 12; 
      background: #0b0f16; 
      border: 1px solid #1b2538; 
      border-radius: 12px; 
      padding: 12px; 
      margin-top: 12px; 
    } 
    .groove-editor h3 { 
      margin: 0 0 8px; 
      font-size: 1rem; 
      color: #a6b4cf; 
    } 
    .groove-editor textarea { 
      width: 100%; 
      background: #0f172a; 
      color: var(--text); 
      border: 1px solid #1f2937; 
      border-radius: 8px; 
      padding: 8px; 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation 
Mono", "Courier New", monospace; 
      font-size: 0.9rem; 
      min-height: 80px; 
      resize: vertical; 
    } 
    .groove-editor button { 
      margin-top: 8px; 
      background: #0b3b39; 
      border: 1px solid #134e4a; 
      color: var(--text); 
      padding: 6px 12px; 
      border-radius: 6px; 
      cursor: pointer; 
    } 
  </style> 
</head> 
<body> 
  <div class="wrap"> 
    <header> 
      <h1>Jam on ‚Äì Playback Aleat√≥rio (baixo + bateria + guitarra)</h1> 
      <div class="pill">Cada pulso do BPM = sem√≠nima</div> 
    </header> 
 
    <!-- Visor de acorde --> 
    <div class="chord-display"> 
      <h2 class="chord-name" id="currentChord">‚Äî</h2> 
      <div class="chord-timer" id="chordTimer">‚Äî</div> 
    </div> 
 
    <section class="card"> 
      <div class="grid"> 
        <div class="controls"> 
          <button id="btnRestart">‚èÆ Reiniciar</button> 
          <button id="btnPrev">
 ‚è™
 Anterior</button> 
          <button id="btnPlay" class="primary">‚ñ∂ Play</button> 
          <button id="btnPause">
 ‚è∏
 Pause</button> 
          <button id="btnStop" class="danger">
 ‚èπ
 Stop</button> 
          <button id="btnSave" class="primary">
 üíæ
 Salvar 4 min (MP3)</button> 
 
          <span class="spacer"></span> 
          <button id="muteBass" data-mute="off">
 üé∏
 Baixo</button> 
          <button id="muteDrums" data-mute="off">
 ü•Å
 Bateria</button> 
          <button id="muteClean" data-mute="off">
 üé∏
 Limpa</button> 
          <button id="muteDist" data-mute="off">
 üî•
 Distor√ß√£o</button> 
 
          <label class="row"> 
            BPM 
            <input id="bpm" type="number" min="40" max="220" value="100" 
style="width:90px"> 
          </label> 
          <label class="row"> 
            Assinatura 
            <select id="meter"> 
              <option value="auto" selected>aleat√≥ria</option> 
              <option>2/4</option> 
              <option>3/4</option> 
              <option>4/4</option> 
              <option>5/4</option> 
              <option>6/4</option> 
              <option>7/4</option> 
            </select> 
          </label> 
        </div> 
 
        <div class="groove-editor"> 
          <h3>Editor de Levadas</h3> 
          <div class="row"> 
            <div style="flex: 1;"> 
              <label>Bateria:</label> 
              <textarea id="drumPattern" placeholder="Ex: [ca ca ca - ba - - - ca - ca - to1 - to2-]&#10;(ba - ch bu cch - ch - bch - ch - cch - ch -)"></textarea> 
            </div> 
            <div style="flex: 1;"> 
              <label>Baixo:</label> 
              <textarea id="bassRhythm" placeholder="Ex: [sc sc c sm cc cc]&#10;(c c c c c c c 
c)"></textarea> 
            </div> 
          </div> 
          <div class="row"> 
            <div style="flex: 1;"> 
              <label>Nome do Estilo:</label> 
              <input type="text" id="grooveName" placeholder="Ex: Rock B√°sico" style="width: 
100%;"> 
            </div> 
            <div style="flex: 1;"> 
              <label>Compasso:</label> 
              <select id="grooveMeter" style="width: 100%;"> 
                <option>2/4</option> 
                <option>3/4</option> 
                <option selected>4/4</option> 
                <option>5/4</option> 
                <option>6/4</option> 
                <option>7/4</option> 
              </select> 
            </div> 
          </div> 
          <button id="btnApplyGroove">Aplicar Levada</button> 
        </div> 
 
        <div class="split"> 
          <div class="panel" style="grid-column: span 6;"> 
            <h3>Estado atual</h3> 
            <div class="mono" id="state"></div> 
            <div class="footer">Ao clicar em <b>Play</b>, gera um novo playback 
aleat√≥rio.</div> 
          </div> 
 
          <div class="panel" style="grid-column: span 6;"> 
            <h3>Arquivos esperados</h3> 
            <div class="mono"> 
              <div>Coloque os √°udios nas pastas:</div> 
              <ul> 
                <li><b>guitarraLimpa/[nota]/acorde.mp3</b> (ex: 
<code>guitarraLimpa/A/A.mp3</code>, <code>guitarraLimpa/A/Am.mp3</code>)</li> 
                <li><b>guitarraDistorcao/[nota]/acorde.mp3</b> (ex: 
<code>guitarraDistorcao/AS/AS7.mp3</code>, 
<code>guitarraDistorcao/C/C.mp3</code>)</li> 
                <li>Pe√ßas de bateria: <b>bumbo.mp3</b>, <b>caixa.mp3</b>, etc.</li> 
                <li>Baixo: <b>bass-A.mp3</b>, <b>bass-AS.mp3</b>, etc.</li> 
              </ul> 
            </div> 
          </div> 
 
          <div class="log mono" id="log"></div> 
        </div> 
      </div> 
    </section> 
  </div> 
 
  <script>
    const ui = {
      play: document.getElementById('btnPlay'),
      pause: document.getElementById('btnPause'),
      stop: document.getElementById('btnStop'),
      save: document.getElementById('btnSave'),
      muteBass: document.getElementById('muteBass'),
      muteDrums: document.getElementById('muteDrums'),
      muteClean: document.getElementById('muteClean'),
      muteDist: document.getElementById('muteDist'),
      bpm: document.getElementById('bpm'),
      meter: document.getElementById('meter'),
      drumPattern: document.getElementById('drumPattern'),
      bassRhythm: document.getElementById('bassRhythm'),
      grooveName: document.getElementById('grooveName'),
      grooveMeter: document.getElementById('grooveMeter'),
      btnApplyGroove: document.getElementById('btnApplyGroove'),
      state: document.getElementById('state'),
      log: document.getElementById('log')
    };

    const audio = {
      ctx: null,
      master: null,
      mix: null,
      drumGain: null,
      bassGain: null,
      cleanGain: null,
      distGain: null,
      schedulerTimer: null,
      lookahead: 0.1,
      scheduleHorizon: 0.25
    };

    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };

    // Caminhos corretos para bateria
    const DRUMS = {
      bu: 'bumbo',
      ca: 'caixa',
      ch: 'chimbal',
      cha: 'chimbal-aberto',
      co: 'conducao',
      at: 'ataque',
      to1: 'tom1',
      to2: 'tom2',
      su: 'surdo',
      ba: 'bumbo-ataque',
      bch: 'bumbo-chimbal',
      cch: 'caixa-chimbal',
      bc: 'bumbo-conducao',
      cc: 'caixa-conducao'
    };

    // Caminhos corretos para baixo
    const BASS_SAMPLES = (() => {
  const table = {};
  const octaves = ['', '8', '16']; // Removido '24'
  for (const p of PITCHES) {
    const letter = p[0];
    const isSharp = p.includes('S');
    const sharpSuffix = isSharp ? 'S' : '';
    for (const oct of octaves) {
      const key = p + oct;
      const fileName = `bass-${letter}${oct}${sharpSuffix}.mp3`;
      table[key] = `assets/${fileName}`;
    }
  }
  table['X'] = 'assets/bass-muted.mp3';
  return table;
})();

    // Mapa de notas do baixo por acorde
    const BASS_NOTE_MAP = {
      // A 
'A':     ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A11':   ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A13':   ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A4':    ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A45+':  ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A5':    ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A5+':   ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A6':    ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A7':    ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A75+':  ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A9':    ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'A95+':  ['A','A8','A16','CS','C8S','C16S','E','E8','E16'], 
'Adim':  ['A','A8','A16','C','C8','C16','DS','D8S','D16S'], 
'Am':    ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am4':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am5':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am5+':  ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am6':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am7':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am75+': ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am79':  ['A','A8','A16','C','C8','C16','E','E8','E16'], 
'Am9':   ['A','A8','A16','C','C8','C16','E','E8','E16'], 
// B 
'B':     ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B11':   ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B13':   ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B4':    ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B45+':  ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B5':    ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B5+':   ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B6':    ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B7':    ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B75+':  ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B9':    ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'B95+':  ['B','B8','B16','DS','D8S','D16S','FS','F8S','F16S'], 
'Bdim':  ['B','B8','B16','D','D8','D16','F','F8','F16'], 
'Bm':    ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm4':   ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm5':   ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm5+':  ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm6':   ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm7':   ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm75+': ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm79':  ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
'Bm9':   ['B','B8','B16','D','D8','D16','FS','F8S','F16S'], 
// C 
'C':     ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C11':   ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C13':   ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C4':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C45+':  ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C5':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C5+':   ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C6':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C7':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C75+':  ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C9':    ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'C95+':  ['C','C8','C16','E','E8','E16','G','G8','G16'], 
'Cdim':  ['C','C8','C16','DS','D8S','D16S','A','A8','A16'], 
'Cm':    ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm4':   ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm5':   ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm5+':  ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm6':   ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm7':   ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm75+': ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm79':  ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
'Cm9':   ['C','C8','C16','DS','D8S','D16S','G','G8','G16'], 
// CS 
'CS':     ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS11':   ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS13':   ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS4':    ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS45+':  ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS5':    ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS5+':   ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS6':    ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS7':    ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS75+':  ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS9':    ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CS95+':  ['CS','C8S','C16S','F','F8','F16','GS','G8S','G16S'], 
'CSdim':  ['CS','C8S','C16S','E','E8','E16','G','G8','G16'], 
'CSm':    ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm4':   ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm5':   ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm5+':  ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm6':   ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm7':   ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm75+': ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm79':  ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
'CSm9':   ['CS','C8S','C16S','E','E8','E16','GS','G8S','G16S'], 
// D 
'D':     ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D11':   ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D13':   ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D4':    ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D45+':  ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D5':    ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D5+':   ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D6':    ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D7':    ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D75+':  ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D9':    ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'D95+':  ['D','D8','D16','FS','F8S','F16S','A','A8','A16'], 
'Ddim':  ['D','D8','D16','F','F8','F16','GS','G8S','G16S'], 
'Dm':    ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm4':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm5':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm5+':  ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm6':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm7':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm75+': ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm79':  ['D','D8','D16','F','F8','F16','A','A8','A16'], 
'Dm9':   ['D','D8','D16','F','F8','F16','A','A8','A16'], 
// DS 
'DS':     ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS11':   ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS13':   ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS4':    ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS45+':  ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS5':    ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS5+':   ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS6':    ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS7':    ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS75+':  ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS9':    ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DS95+':  ['DS','D8S','D16S','G','G8','G16','AS','A8S','A16S'], 
'DSdim':  ['DS','D8S','D16S','FS','F8S','F16S','A','A8','A16'], 
'DSm':    ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm4':   ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm5':   ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm5+':  ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm6':   ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm7':   ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm75+': ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm79':  ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
'DSm9':   ['DS','D8S','D16S','FS','F8S','F16S','AS','A8S','A16S'], 
// E 
'E':     ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E11':   ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E13':   ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E4':    ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E45+':  ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E5':    ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E5+':   ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E6':    ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E7':    ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E75+':  ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E9':    ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'E95+':  ['E','E8','E16','E24','GS','G8S','G16S','B','B8','B16'], 
'Edim':  ['E','E8','E16','G','G8','G16','AS','A8S','A16S'], 
'Em':    ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em4':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em5':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em5+':  ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em6':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em7':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em75+': ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em79':  ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
'Em9':   ['E','E8','E16','E24','G','G8','G16','B','B8','B16'], 
// F 
'F':     ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F11':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F13':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F4':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F45+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F5':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F5+':   ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F6':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F7':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F75+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F9':    ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'F95+':  ['F','F8','F16','F24','A','A8','A16','C','C8','C16'], 
'Fdim':  ['F','F8','F16','GS','G8S','G16S','B','B8','B16'], 
'Fm':    ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm4':   ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm5':   ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm5+':  ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm6':   ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm7':   ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm75+': ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm79':  ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'], 
'Fm9':   ['F','F8','F16','F24','GS','G8S','G16S','C','C8','C16'],  

// FS 
'FS':     ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS11':   ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS13':   ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS4':    ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS45+':  ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS5':    ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS5+':   ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS6':    ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS7':    ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS75+':  ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS9':    ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FS95+':  ['FS','F8S','F16S','F24S','AS','A8S','A16S','CS','C8S','C16S'], 
'FSdim':  ['FS','F8S','F16S','A','A8','A16','C','C8','C16'], 
'FSm':    ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm4':   ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm5':   ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm5+':  ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm6':   ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm7':   ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm75+': ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm79':  ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
'FSm9':   ['FS','F8S','F16S','F24S','A','A8','A16','CS','C8S','C16S'], 
// G 
'G':     ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G11':   ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G13':   ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G4':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G45+':  ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G5':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G5+':   ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G6':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G7':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G75+':  ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G9':    ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'G95+':  ['G','G8','G16','G24','B','B8','B16','D','D8','D16'], 
'Gdim':  ['G','G8','G16','AS','A8S','A16S','CS','C8S','C16S'], 
'Gm':    ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm4':   ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm5':   ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm5+':  ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm6':   ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm7':   ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm75+': ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm79':  ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
'Gm9':   ['G','G8','G16','G24','AS','A8S','A16S','D','D8','D16'], 
// GS 
'GS':     ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS11':   ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS13':   ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS4':    ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS45+':  ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS5':    ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS5+':   ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS6':    ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS7':    ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS75+':  ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS9':    ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GS95+':  ['GS','G8S','G16S','C','C8','C16','DS','D8S','D16S'], 
'GSdim':  ['GS','G8S','G16S','B','B8','B16','D','D8','D16'], 
'GSm':    ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm4':   ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm5':   ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm5+':  ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm6':   ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm7':   ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm75+': ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm79':  ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'], 
'GSm9':   ['GS','G8S','G16S','B','B8','B16','DS','D8S','D16S'] 
    }; 
    const CUSTOM_GROOVES = [
      {
        name: "Groove Alternado",
        meter: "4/4",
        drumPattern: [
          "[bu - ch - cch - ch - bch - ch - cch - ch]",
          "(bu - ch - cch - ch - bch - ch - cch - ch)"
        ],
        bassRhythm: [
          "(sm - - - sm - ¬∞ - sm - x - sm - ¬∞ -)",
          "(sm ¬∞ sm ¬∞ sm ¬∞ sm ¬∞)"
        ]
      }
    ];

    const PROGRESSIONS = [
      [1, 1, 1, 1, 4, 4, 5, 5],
      [1, 1, 1, 1, 5, 5, 6, 6, 4, 4, 5, 5],
      [1, 1, 1, 1, 4, 4, 5, 5, 1, 1, 1, 1]
    ];

    const state = {
      running: false,
      paused: false,
      nextNoteTime: 0,
      meter: '4/4',
      bpm: 100,
      sixteenthDur: 0.15,
      stepIndex: 0,
      buffers: { drums: {}, bass: {}, guitar: {} },
      lastBassSrc: null,
      bassPlan: [],
      signatureTag: '',
      key: null,
      keyIdx: 0,
      quality: 'maj',
      chordProgression: [],
      chordDurations: [],
      currentGroove: null,
      currentChordIndex: 0,
      barsInChord: 0
    };

    const mute = { bass: false, drums: false, clean: false, dist: false };
    let recorder = null;
    let recChunks = [];

    function log(msg) {
      ui.log.textContent += `\n${msg}`;
      ui.log.scrollTop = ui.log.scrollHeight;
    }

    function setStatePanel() {
      ui.state.innerHTML = `<div>Chord: ${state.signatureTag || '‚Äî'}</div>`;
    }

    async function initAudio() {
      try {
        audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
        audio.master = audio.ctx.createGain();
        audio.mix = audio.ctx.createGain();
        audio.drumGain = audio.ctx.createGain();
        audio.bassGain = audio.ctx.createGain();
        audio.cleanGain = audio.ctx.createGain();
        audio.distGain = audio.ctx.createGain();

        audio.master.connect(audio.mix);
        audio.mix.connect(audio.ctx.destination);

        audio.drumGain.connect(audio.master);
        audio.bassGain.connect(audio.master);
        audio.cleanGain.connect(audio.master);
        audio.distGain.connect(audio.master);

        await ensureSamples();
        log('‚úÖ √Åudios pr√©-carregados.');
      } catch (e) {
        log(`[ERRO] Falha ao iniciar √°udio: ${e.message}`);
      }
    }

    async function loadBuffer(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const arrayBuffer = await res.arrayBuffer();
        const audioBuffer = await audio.ctx.decodeAudioData(arrayBuffer);
        return audioBuffer;
      } catch (e) {
        log(`[ERRO] Falha ao carregar: ${url} ‚Üí ${e.message}`);
        return null;
      }
    }

    async function ensureSamples() {
      const promises = [];
      for (const [key, url] of Object.entries(BASS_SAMPLES)) {
        if (!state.buffers.bass[key]) {
          promises.push(loadBuffer(url).then(buf => {
            if (buf) state.buffers.bass[key] = buf;
          }));
        }
      }
      for (const [key, name] of Object.entries(DRUMS)) {
        const url = `assets/${name}.mp3`;
        if (!state.buffers.drums[key]) {
          promises.push(loadBuffer(url).then(buf => {
            if (buf) state.buffers.drums[key] = buf;
          }));
        }
      }
      await Promise.all(promises);
    }

    function expandRhythm(pattern, totalSteps) {
      const flat = pattern.join(' ').trim().split(/\s+/).filter(s => s);
      const expanded = [];
      let step = 0;
      while (step < totalSteps) {
        for (const symbol of flat) {
          if (step >= totalSteps) break;
          if (symbol === 'sm') {
            expanded.push('sm');
            for (let i = 1; i < 4; i++) if (step + i < totalSteps) expanded.push('-');
            step += 4;
          } else {
            expanded.push(symbol);
            step++;
          }
        }
      }
      return expanded;
    }

    function buildBassPlan() {
      const groove = state.currentGroove;
      state.meter = ui.meter.value === 'auto' ? groove.meter : ui.meter.value;
      const [num, den] = state.meter.split('/').map(Number);
      const sixteenthsPerBar = num * 4;
      const totalBars = 16;
      const totalSteps = totalBars * sixteenthsPerBar;

      state.keyIdx = Math.floor(Math.random() * PITCHES.length);
      state.key = PITCHES[state.keyIdx];
      state.quality = Math.random() > 0.5 ? 'maj' : 'min';
      state.chordProgression = PROGRESSIONS[Math.floor(Math.random() * PROGRESSIONS.length)];

      const durations = [];
      let count = 1;
      for (let i = 1; i < state.chordProgression.length; i++) {
        if (state.chordProgression[i] === state.chordProgression[i-1]) count++;
        else { durations.push(count); count = 1; }
      }
      durations.push(count);
      state.chordDurations = durations;

      const fullPattern = [...groove.bassRhythm, ...groove.bassRhythm];
      const rhythm = expandRhythm(fullPattern, totalSteps);

      const plan = [];
      let barsInChord = 0;
      let chordIndex = 0;

      for (let step = 0; step < totalSteps; step++) {
        const sixteenthInBar = step % sixteenthsPerBar;
        if (sixteenthInBar === 0 && step > 0) {
          barsInChord++;
          if (barsInChord >= state.chordDurations[chordIndex]) {
            chordIndex = (chordIndex + 1) % state.chordProgression.length;
            barsInChord = 0;
          }
        }

        const degree = state.chordProgression[chordIndex];
        const rootOffset = DEGREE_TO_ROOT[degree] || 0;
        const rootIdx = (state.keyIdx + rootOffset) % 12;
        const rootNote = PITCHES[rootIdx];
        const chordType = state.quality === 'maj' ? '' : 'm';
        const chordName = rootNote + chordType;
        const availableNotes = BASS_NOTE_MAP[chordName] || [rootNote];

        const symbol = rhythm[step];
        let note = '-';

        if (symbol === 'x') note = 'X';
        else if (symbol === '¬∞') note = '¬∞';
        else if (symbol === 'sm') note = availableNotes[Math.floor(Math.random() * availableNotes.length)];

        plan.push(note);
      }

      state.bassPlan = plan;
      state.signatureTag = groove.name;
      setStatePanel();
    }

    function scheduler() {
      if (!state.running || state.paused) return;
      const time = audio.ctx.currentTime;
      while (state.nextNoteTime < time + audio.scheduleHorizon) {
        scheduleStep();
      }
    }

    function scheduleStep() {
      const stepIdx = state.stepIndex;
      const time = state.nextNoteTime;
      const isNewBar = (stepIdx % (4 * 4)) === 0;

      // Bateria
      const drumPattern = parsePattern(state.currentGroove.drumPattern.join(' '), 'drum');
      const drumSeq = [...drumPattern.intro, ...drumPattern.loop];
      const drumSymbol = drumSeq[stepIdx % drumSeq.length];
      if (drumSymbol && DRUMS[drumSymbol] && !mute.drums) {
        const buf = state.buffers.drums[drumSymbol];
        if (buf) {
          const src = audio.ctx.createBufferSource();
          src.buffer = buf;
          src.connect(audio.drumGain);
          src.start(time);
        }
      }

      // Mudan√ßa de acorde
      if (isNewBar && stepIdx > 0) {
        state.barsInChord++;
        if (state.barsInChord >= state.chordDurations[state.currentChordIndex]) {
          state.currentChordIndex = (state.currentChordIndex + 1) % state.chordProgression.length;
          state.barsInChord = 0;
        }
      }

      // Baixo
      const bassKey = state.bassPlan[stepIdx % state.bassPlan.length];
      if (bassKey === 'X' && !mute.bass) {
        const src = audio.ctx.createBufferSource();
        src.buffer = state.buffers.bass['X'];
        src.connect(audio.bassGain);
        src.start(time);
        if (state.lastBassSrc) state.lastBassSrc.stop(time + 0.005);
        state.lastBassSrc = src;
      } else if (bassKey === '¬∞' && !mute.bass && state.lastBassSrc) {
        state.lastBassSrc.stop(time);
        state.lastBassSrc = null;
      } else if (bassKey !== '-' && !mute.bass) {
        if (state.lastBassSrc) state.lastBassSrc.stop(time);
        const src = audio.ctx.createBufferSource();
        src.buffer = state.buffers.bass[bassKey];
        src.connect(audio.bassGain);
        src.start(time);
        state.lastBassSrc = src;
      }

      state.stepIndex++;
      state.nextNoteTime += state.sixteenthDur;
    }

    function parsePattern(patternText, type) {
      const result = { intro: [], loop: [] };
      const introMatch = patternText.match(/\[(.*?)\]/);
      const loopMatch = patternText.match(/\((.*?)\)/);
      if (introMatch) result.intro = introMatch[1].trim().split(/\s+/).filter(s => s);
      if (loopMatch) result.loop = loopMatch[1].trim().split(/\s+/).filter(s => s);
      return result;
    }

    function onPlay() {
  if (state.running && !state.paused) return;
  if (!audio.ctx) initAudio();

  // Define um groove padr√£o se nenhum existir
  if (!state.currentGroove) {
    state.currentGroove = CUSTOM_GROOVES[0]; // Usa o primeiro groove personalizado
    log(`[INFO] Groove padr√£o definido: ${state.currentGroove.name}`);
  }

  if (state.paused) {
    state.paused = false;
    return;
  }

  state.running = true;
  state.paused = false;
  state.stepIndex = 0;
  state.nextNoteTime = audio.ctx.currentTime + 0.1;
  buildBassPlan();
  startScheduler();
}
    function onPause() {
      if (state.running && !state.paused) {
        state.paused = true;
      }
    }

    function onStop() {
      state.running = false;
      state.paused = false;
      stopScheduler();
      if (state.lastBassSrc) state.lastBassSrc.stop();
      state.lastBassSrc = null;
    }

    function startScheduler() {
      stopScheduler();
      audio.schedulerTimer = setInterval(scheduler, audio.lookahead * 1000);
    }

    function stopScheduler() {
      if (audio.schedulerTimer) {
        clearInterval(audio.schedulerTimer);
        audio.schedulerTimer = null;
      }
    }

    function toggleMute(type, button) {
      mute[type] = !mute[type];
      button.dataset.mute = mute[type] ? 'on' : 'off';
      const icon = mute[type] ? 'üîá' : 'üîä';
      const label = button.textContent.split(' ')[1];
      button.textContent = `${icon} ${label}`;
      button.classList.toggle('muted', mute[type]);
    }

    function applyCustomGroove() {
      const name = ui.grooveName.value || "Personalizado";
      const meter = ui.grooveMeter.value;
      const drumPattern = ui.drumPattern.value.split('\n').filter(line => line.trim());
      const bassRhythm = ui.bassRhythm.value.split('\n').filter(line => line.trim());
      if (drumPattern.length === 0 || bassRhythm.length === 0) {
        log('[ERRO] Padr√µes de bateria e baixo s√£o obrigat√≥rios.');
        return;
      }
      const customGroove = { name, meter, drumPattern, bassRhythm };
      state.currentGroove = customGroove;
      log(`[LEVADA] "${name}" aplicada com sucesso!`);
    }

    // Event Listeners
    ui.play.addEventListener('click', onPlay);
    ui.pause.addEventListener('click', onPause);
    ui.stop.addEventListener('click', onStop);
    ui.muteBass.addEventListener('click', () => toggleMute('bass', ui.muteBass));
    ui.muteDrums.addEventListener('click', () => toggleMute('drums', ui.muteDrums));
    ui.muteClean.addEventListener('click', () => toggleMute('clean', ui.muteClean));
    ui.muteDist.addEventListener('click', () => toggleMute('dist', ui.muteDist));
    ui.btnApplyGroove.addEventListener('click', applyCustomGroove);

    window.addEventListener('load', () => {
      log('üîß Pr√©-carregando √°udios...');
      initAudio();
    });
  </script>
</body>
</html>