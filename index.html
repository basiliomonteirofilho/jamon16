<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jam On ‚Äì Playback Aleat√≥rio</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      color: #5eead4;
      font-size: 1.8em;
      margin: 0;
    }
    .pill {
      display: inline-block;
      background: #333;
      color: #aaa;
      font-size: 0.75em;
      padding: 4px 10px;
      border-radius: 12px;
    }
    .card {
      max-width: 800px;
      margin: 0 auto;
      background: #1e1e1e;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      overflow: hidden;
      padding: 20px;
      text-align: left;
    }
    .chord-display {
      text-align: center;
      margin: 20px 0;
    }
    .chord-name {
      font-size: 3em;
      color: #5eead4;
      margin: 0;
      font-weight: bold;
    }
    #chordTimer {
      font-size: 1.1em;
      color: #aaa;
    }
    #chordProgression {
      margin-top: 12px;
      font-family: monospace;
      font-size: 1.1em;
      white-space: nowrap;
      overflow-x: auto;
      padding: 8px 0;
    }
    .chord-item {
      display: inline-block;
      padding: 6px 10px;
      margin: 0 4px;
      border-radius: 6px;
      background: #333;
      transition: background 0.3s;
    }
    .chord-item.current {
      background: #5eead4;
      color: #121212;
      font-weight: bold;
    }
    .controls {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    .btn-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
      transition: opacity 0.2s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button.primary {
      background: #5eead4;
      color: #121212;
    }
    button.danger {
      background: #f44336;
      color: white;
    }
    button:hover:not(:disabled) {
      opacity: 0.9;
    }
    .mute-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    .mute-buttons button {
      padding: 8px 14px;
      font-size: 0.9em;
    }
    .mute-buttons button.muted {
      opacity: 0.5;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    .row label {
      width: 100px;
      text-align: right;
      color: #ccc;
    }
    input[type="number"], select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #2a2a2a;
      color: #fff;
      width: 90px;
    }
    select {
      width: auto;
      min-width: 120px;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    .slider-row label {
      width: 80px;
      text-align: right;
      font-size: 0.9em;
    }
    input[type="range"] {
      width: 180px;
      accent-color: #5eead4;
    }
    .slider-value {
      width: 40px;
      text-align: left;
      font-size: 0.9em;
      color: #aaa;
    }
    .panel {
      margin-top: 20px;
    }
    .panel h3 {
      color: #5eead4;
      margin-top: 0;
    }
    .melody-panel {
      margin-top: 20px;
    }
    .melody-toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
    }
    .melody-block {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      background: #222;
    }
    .melody-caption {
      font-size: 0.9em;
      color: #ccc;
      margin-bottom: 6px;
    }
    .melody-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85em;
    }
    .melody-table th, .melody-table td {
      border: 1px solid #555;
      padding: 2px;
    }
    .melody-table input {
      width: 100%;
      padding: 4px;
      text-align: center;
      background: #333;
      border: 1px solid #555;
      color: white;
      border-radius: 4px;
    }
    .line-label {
      font-size: 0.8em;
      color: #aaa;
    }
    .instructions {
      font-size: 0.85em;
      color: #aaa;
      margin-top: 8px;
      text-align: center;
    }
    /* === ESTILOS PARA MOBILE === */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .card {
        padding: 15px;
        border-radius: 12px;
      }
      h1 {
        font-size: 1.5em;
      }
      .chord-name {
        font-size: 2em;
      }
      button {
        padding: 14px 22px;
        font-size: 1em;
      }
      .row label {
        width: 80px;
        font-size: 0.9em;
      }
      input[type="number"], select {
        width: 70px;
        font-size: 0.9em;
        padding: 10px;
      }
      .slider-row label {
        width: 60px;
        font-size: 0.8em;
      }
      input[type="range"] {
        width: 140px;
      }
      .slider-value {
        width: 35px;
        font-size: 0.8em;
      }
      .melody-table {
        font-size: 0.9em;
      }
      .melody-table input {
        height: 40px;
        font-size: 0.9em;
        padding: 8px;
      }
      .melody-caption {
        font-size: 0.85em;
      }
    }
    /* === ESTILOS DO PICKER DE N√öMEROS === */
    #numberPicker {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #1e1e1e;
      border-top: 2px solid #5eead4;
      padding: 15px;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    #numberPicker h3 {
      color: #5eead4;
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
      grid-column: span 4;
    }
    .number-btn {
      background: #333;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px 0;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.1s ease;
    }
    .number-btn:hover {
      background: #444;
    }
    .number-btn:active {
      transform: scale(0.95);
      background: #5eead4;
      color: #121212;
    }
    .close-btn {
      grid-column: span 4;
      background: #f44336;
      color: white;
      font-weight: bold;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .recording-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: #f44336;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Jam On ‚Äì Playback Aleat√≥rio</h1>
    <div class="pill">Cada pulso do BPM = sem√≠nima</div>
  </header>
  <div class="chord-display">
    <h2 class="chord-name" id="currentChord">‚Äî</h2>
    <div id="chordTimer">‚Äî</div>
    <div id="chordProgression"></div>
  </div>
  <div class="card">
    <div class="controls">
      <div class="btn-row">
        <button id="btnPlay" class="primary">‚ñ∂ Play</button>
        <button id="btnPause">‚è∏ Pause</button>
        <button id="btnStop" class="danger">‚èπ Stop</button>
        <button id="btnSaveWAV" class="primary">üíæ Salvar como WAV</button>
        <button id="btnOpenManual" class="primary" style="font-size: 1em; padding: 14px 24px;">
      üéõÔ∏è Abrir Composi√ß√£o Manual
      </button>
      </div>
      <div class="mute-buttons">
        <button id="muteBass" data-mute="off">üé∏ Baixo</button>
        <button id="muteDrums" data-mute="off">ü•Å Bateria</button>
        <button id="muteClean" data-mute="off">üé∏ Limpa</button>
        <button id="muteDist" data-mute="off">üî• Distor√ß√£o</button>
        <button id="mutePianoString" data-mute="off">üéπ Piano</button>
      </div>
      <!-- ... outros controles ... -->
<div class="row">
  <label>Assinatura</label>
  <select id="meter">
    <option value="auto" selected>aleat√≥ria</option>
    <option>2/4</option>
    <option>3/4</option>
    <option>4/4</option>
    <option>5/4</option>
    <option>6/4</option>
    <option>7/4</option>
  </select>
</div>
<!-- NOVO CONTROLE DE BPM -->
<div class="row">
  <label>BPM</label>
  <input type="number" id="bpm" min="40" max="220" value="100">
</div>
<!-- NOVOS CONTROLES -->
<div class="row">
  <label>Estilo</label>
  <select id="styleSelect">
    <option value="auto" selected>aleat√≥rio</option>
    <!-- As op√ß√µes ser√£o preenchidas dinamicamente pelo JavaScript -->
  </select>
</div>
<!-- ADICIONE ESTE BLOCO -->
<div class="row">
  <label>Tonalidade</label>
  <select id="keySelect">
    <option value="auto" selected>aleat√≥ria</option>
    <!-- As op√ß√µes ser√£o preenchidas dinamicamente pelo JavaScript -->
  </select>
</div>
<!-- FIM DOS NOVOS CONTROLES -->
<div class="row">
  <label>Melodia</label>
  <select id="melodyInstrument">
    <option value="dist">Guitarra Distorcida</option>
    <option value="piano">Piano/String</option>
    <option value="baixo">Baixo</option>
    <option value="sax">Sax</option>
    <option value="acordeon">Acordeon</option>
    <option value="sinos">Sinos</option>
    <option value="violao_aco">Viol√£o A√ßo</option>
    <option value="violao_nylon">Viol√£o Nylon</option>
    <option value="cordas">Cordas</option>
  </select>
</div>
<!-- ... resto dos controles ... -->
      <h3 style="color: #5eead4; margin: 15px 0 5px;">Controle de Volume</h3>
      <div class="slider-row">
        <label>Baixo</label>
        <input type="range" id="volBass" min="0" max="1" step="0.01" value="0.45">
        <span class="slider-value" id="volBassLabel">45%</span>
      </div>
      <div class="slider-row">
        <label>Bateria</label>
        <input type="range" id="volDrums" min="0" max="1" step="0.01" value="0.6">
        <span class="slider-value" id="volDrumsLabel">60%</span>
      </div>
      <div class="slider-row">
        <label>Limpa</label>
        <input type="range" id="volClean" min="0" max="1" step="0.01" value="0.45">
        <span class="slider-value" id="volCleanLabel">45%</span>
      </div>
      <div class="slider-row">
        <label>Distorcida</label>
        <input type="range" id="volDist" min="0" max="1" step="0.01" value="0.35">
        <span class="slider-value" id="volDistLabel">35%</span>
      </div>
      <div class="slider-row">
  <label>Piano</label>
  <input type="range" id="volPianoString" min="0" max="1" step="0.01" value="0.50">
  <span class="slider-value" id="volPianoStringLabel">50%</span>
</div>
      <div class="slider-row">
        <label>Melodia</label>
        <input type="range" id="volMelody" min="0" max="1" step="0.01" value="0.50">
        <span class="slider-value" id="volMelodyLabel">50%</span>
      </div>
    </div>
    <div class="panel">
      <h3>Estado Atual</h3>
      <div class="mono" id="state">Parado</div>
    </div>
    <div class="panel melody-panel">
      <h3>üé∏ Melodia Adaptativa</h3>
      <div class="melody-toolbar">
        <button id="btnMelodyAdd" class="primary">‚ûï Adicionar Bloco</button>
        <button id="btnMelodyClear" class="danger">üßπ Limpar Blocos</button>
        <span style="font-size: 0.9em; color: #aaa;">Notas se estendem at√© pr√≥xima nota ou "x"</span>
      </div>
      <div class="instructions">
        Digite n√∫meros (1-49) para notas, "x" para pausa, ou deixe vazio para continuar nota anterior
      </div>
      <div id="melodyBlocks"></div>
    </div>
  </div>
  <div id="numberPicker">
    <h3>Selecione uma nota</h3>
    <div id="numberGrid"></div>
  </div>
  <script>
const HARMONIC_INSTRUMENTS = {
  'distorted-guitar': 'guitarraDistorcao/',
  'clean-guitar': 'guitarraLimpa/',
  'piano-chord': 'assets/PianoStringChord/'
};

const MELODIC_INSTRUMENTS = {
  'accordion': 'assets/AcordeonMelodia/',
  'bass': 'assets/BaixoMelodia/',
  'strings': 'assets/Cordas/',
  'piano': 'assets/PianoString/',
  'sax': 'assets/SaxMelodia/',
  'guitar-steel': 'assets/ViolaoAcoMelodia/',
  'guitar-nylon': 'assets/ViolaoNylonMelodia/'
};

const DRUM_SAMPLES = [
  { key: 'ataque', path: 'assets/ataque.mp3' },
  { key: 'chimbal', path: 'assets/chimbal.mp3' },
  { key: 'conducao', path: 'assets/conducao.mp3' },
  { key: 'caixa', path: 'assets/caixa.mp3' },
  { key: 'chimbal-aberto', path: 'assets/chimbal-aberto.mp3' },
  { key: 'conducao-centro', path: 'assets/conducao-centro.mp3' },
  { key: 'bumbo', path: 'assets/bumbo.mp3' },
  { key: 'tom-1', path: 'assets/tom-1.mp3' },
  { key: 'tom-2', path: 'assets/tom-2.mp3' },
  { key: 'surdo', path: 'assets/surdo.mp3' }
];

const state = {
  audioCtx: null,
  buffers: { harmonic: {}, melodic: {}, drums: {} },
  loadedSamples: new Set(),
  playbackPlan: { harmony: [], melody1: [], melody2: [], bass: [], drums: {} }
};

function initAudio() {
  if (!state.audioCtx) {
    state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

async function loadSample(instrumentType, key, noteOrChord) {
  let filePath;
  let bufferKey;

  if (instrumentType === 'drum') {
    const sample = DRUM_SAMPLES.find(d => d.key === key);
    if (!sample) return;
    filePath = sample.path;
    bufferKey = key;
  } else if (instrumentType === 'melodic') {
    filePath = MELODIC_INSTRUMENTS[key] + noteOrChord + '.mp3';
    bufferKey = `melodic-${MELODIC_INSTRUMENTS[key]}-${noteOrChord}`;
  } else if (instrumentType === 'harmonic') {
    let root;
    if (noteOrChord.length >= 2 && ['AS','CS','DS','FS','GS'].includes(noteOrChord.slice(0, 2))) {
      root = noteOrChord.slice(0, 2);
    } else {
      root = noteOrChord[0];
    }
    filePath = HARMONIC_INSTRUMENTS[key] + root + '/' + noteOrChord + '.mp3';
    bufferKey = `harmonic-${HARMONIC_INSTRUMENTS[key]}-${noteOrChord}`;
  }

  if (!filePath) return;
  if (state.loadedSamples.has(bufferKey)) return;

  try {
    const response = await fetch(filePath);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const arrayBuffer = await response.arrayBuffer();
    const buffer = await state.audioCtx.decodeAudioData(arrayBuffer);

    if (instrumentType === 'drum') {
      state.buffers.drums[bufferKey] = buffer;
    } else if (instrumentType === 'melodic') {
      state.buffers.melodic[bufferKey] = buffer;
    } else if (instrumentType === 'harmonic') {
      state.buffers.harmonic[bufferKey] = buffer;
    }

    state.loadedSamples.add(bufferKey);
    console.log(`‚úÖ Carregado: ${filePath} ‚Üí chave: ${bufferKey}`);
  } catch (err) {
    console.warn(`‚ö†Ô∏è N√£o encontrado: ${filePath}`);
  }
}

function playChord(instrumentKey, chord, time, gainNode) {
  if (!state.audioCtx) return;
  const bufferKey = `harmonic-${HARMONIC_INSTRUMENTS[instrumentKey]}-${chord}`;
  const buffer = state.buffers.harmonic[bufferKey];
  if (!buffer) return;
  const source = state.audioCtx.createBufferSource();
  source.buffer = buffer;
  source.connect(gainNode);
  source.start(time);
  source.stop(time + 1.0);
}

function playDrum(drumKey, time, gainNode, volume = 1.0) {
  if (!state.audioCtx) return;
  const buffer = state.buffers.drums[drumKey];
  if (!buffer) return;
  const source = state.audioCtx.createBufferSource();
  source.buffer = buffer;
  const gain = state.audioCtx.createGain();
  gain.gain.setValueAtTime(volume, time);
  source.connect(gain);
  gain.connect(gainNode);
  source.start(time);
}

async function renderAndDownloadWAV() {
  const length = 8; // n¬∫ de compassos
  const sampleRate = 44100;
  const offlineCtx = new OfflineAudioContext(2, length * sampleRate * 2, sampleRate);

  const drumGain = offlineCtx.createGain();
  const harmonicGain = offlineCtx.createGain();
  const melodicGain = offlineCtx.createGain();
  drumGain.connect(offlineCtx.destination);
  harmonicGain.connect(offlineCtx.destination);
  melodicGain.connect(offlineCtx.destination);

  const stepDuration = 1.0;
  for (let step = 0; step < length; step++) {
    const time = step * stepDuration;

    // Harmonia
    if (step < state.playbackPlan.harmony.length && state.playbackPlan.harmony[step]) {
      const item = state.playbackPlan.harmony[step];
      if (item && item.chord !== 'X') {
        const bufferKey = `harmonic-${HARMONIC_INSTRUMENTS[item.instrument]}-${item.chord}`;
        const buffer = state.buffers.harmonic[bufferKey];
        if (buffer) {
          const source = offlineCtx.createBufferSource();
          source.buffer = buffer;
          source.connect(harmonicGain);
          source.start(time);
        }
      }
    }

    // Bateria
    Object.keys(state.playbackPlan.drums).forEach(key => {
      if (step < state.playbackPlan.drums[key].length && state.playbackPlan.drums[key][step]) {
        const buffer = state.buffers.drums[key];
        if (buffer) {
          const source = offlineCtx.createBufferSource();
          source.buffer = buffer;
          source.connect(drumGain);
          source.start(time);
        }
      }
    });

    // Melodias
    ['bass', 'melody1', 'melody2'].forEach(type => {
      if (step < state.playbackPlan[type].length && state.playbackPlan[type][step]) {
        const item = state.playbackPlan[type][step];
        if (item && item.note) {
          const bufferKey = `melodic-${MELODIC_INSTRUMENTS[item.instrument]}-${item.note}`;
          const buffer = state.buffers.melodic[bufferKey];
          if (buffer) {
            const source = offlineCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(melodicGain);
            source.start(time);
          }
        }
      }
    });
  }

  const renderedBuffer = await offlineCtx.startRendering();
  const wavData = audioBufferToWav(renderedBuffer);
  const blob = new Blob([new DataView(wavData)], { type: 'audio/wav' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "jam.wav";
  a.click();
  URL.revokeObjectURL(url);
}

function audioBufferToWav(buffer) {
  const numOfChan = buffer.numberOfChannels,
    length = buffer.length * numOfChan * 2 + 44,
    buffer2 = new ArrayBuffer(length),
    view = new DataView(buffer2),
    channels = [],
    sampleRate = buffer.sampleRate;
  let offset = 0;
  let pos = 0;

  function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
  function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }

  setUint32(0x46464952);
  setUint32(length - 8);
  setUint32(0x45564157);
  setUint32(0x20746d66);
  setUint32(16);
  setUint16(1);
  setUint16(numOfChan);
  setUint32(sampleRate);
  setUint32(sampleRate * 2 * numOfChan);
  setUint16(numOfChan * 2);
  setUint16(16);
  setUint32(0x61746164);
  setUint32(length - pos - 4);

  for (let i = 0; i < buffer.numberOfChannels; i++)
    channels.push(buffer.getChannelData(i));

  while (pos < length) {
    for (let i = 0; i < numOfChan; i++) {
      let sample = Math.max(-1, Math.min(1, channels[i][offset]));
      sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
      view.setInt16(pos, sample, true);
      pos += 2;
    }
    offset++;
  }
  return buffer2;
}
</script>

</body>
</html>

