<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jam Batch ‚Äì Gerador de Dataset Musical</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #121212;
      color: #e0e0e0;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #5eead4;
      text-align: center;
    }
    .controls {
      text-align: center;
      margin: 20px 0;
    }
    button {
      padding: 12px 24px;
      font-size: 1.1em;
      background: #5eead4;
      color: #121212;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Jam Batch ‚Äì Gerador de Dataset Musical</h1>
    <p>Clique para gerar 1000 m√∫sicas de 30s com todos os instrumentos e l√≥gica do Jam On.</p>
    <div class="controls">
      <button id="btnStart">üöÄ Iniciar Gera√ß√£o em Lote</button>
    </div>
    <div class="status" id="log">Aguardando...</div>
  </div>

  <script>
    // === COPIA DAS CONSTANTES E L√ìGICAS DO SEU JAM ON ===
    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const DEGREE_TO_ROOT = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
    const CHORD_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const STYLE_PROGRESSIONS = {
      Rock: [[1,4,5,1], [1,5,6,4]],
      Blues: [[1,4,5,1]],
      Samba: [[2,5,1,1]],
      Metal: [[1,3,5,6]],
      Jazz: [[2,5,1,4]]
    };
    const ALL_GROOVES = [
      { name: "Rock", meter: "4/4", bassScale: [1,3,5,8] },
      { name: "Blues", meter: "4/4", bassScale: [1,3,5,6,8] },
      { name: "Samba", meter: "2/4", bassScale: [8,5] },
      { name: "Metal", meter: "4/4", bassScale: [1,3,5,8] },
      { name: "Jazz", meter: "4/4", bassScale: "chromatic" }
    ];

    // === FUN√á√ïES AUXILIARES ===
    function meterToBeats(meter) {
      return Number(meter.split('/')[0]) || 4;
    }
    function randomChoice(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }
    function transposeDown3Semitones(note) {
      const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
      const index = notes.indexOf(note);
      if (index === -1) return note;
      return notes[(index - 3 + 12) % 12];
    }

    // === FUN√á√ïES DE √ÅUDIO (OFFLINE) ===
    function audioBufferToWav(buffer) {
      const numOfChan = buffer.numberOfChannels;
      const length = buffer.length * numOfChan * 2 + 44;
      const arrayBuffer = new ArrayBuffer(length);
      const view = new DataView(arrayBuffer);
      function writeString(offset, str) {
        for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
      }
      writeString(0, 'RIFF');
      view.setUint32(4, length - 8, true);
      writeString(8, 'WAVE');
      writeString(12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, numOfChan, true);
      view.setUint32(24, 44100, true);
      view.setUint32(28, 44100 * 2 * numOfChan, true);
      view.setUint16(32, 2 * numOfChan, true);
      view.setUint16(34, 16, true);
      writeString(36, 'data');
      view.setUint32(40, length - 44, true);
      const channels = [];
      for (let i = 0; i < numOfChan; i++) channels.push(buffer.getChannelData(i));
      let offset = 44;
      for (let i = 0; i < buffer.length; i++) {
        for (let ch = 0; ch < numOfChan; ch++) {
          const sample = Math.max(-1, Math.min(1, channels[ch][i]));
          const int16 = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
          view.setInt16(offset, int16, true);
          offset += 2;
        }
      }
      return new Blob([view], { type: 'audio/wav' });
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === GERA√á√ÉO DE METADADOS ===
    function generateMetadata(bpm, meter, key, quality, style, chordPlan, sixteenthDur) {
      const beats = meterToBeats(meter);
      const stepsPerBar = beats * 4;
      const totalSteps = Math.ceil(30.0 / sixteenthDur);
      const chords = [];
      for (let step = 0; step < totalSteps; step++) {
        const bar = Math.floor(step / stepsPerBar);
        const chordIndex = bar % chordPlan.length;
        const chord = chordPlan[chordIndex];
        const start = step * sixteenthDur;
        const end = start + sixteenthDur;
        if (end > 30.0) break;
        chords.push({
          start: parseFloat(start.toFixed(3)),
          end: parseFloat(end.toFixed(3)),
          chord: chord.display,
          root: chord.rootNote,
          quality: chord.type || 'maj',
          bar,
          step
        });
      }
      return {
        bpm,
        meter,
        key: CHORD_NAMES[PITCHES.indexOf(key)],
        quality,
        style,
        duration: 30.0,
        chords
      };
    }

    // === SIMULA√á√ÉO DE INSTRUMENTOS (sem carregar arquivos reais) ===
    // Na pr√°tica, substitua por loadBuffer() se quiser usar samples reais
    function playDummyNote(ctx, time, duration, freq, gainNode) {
      if (time >= 30.0) return;
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.value = freq;
      osc.connect(g);
      g.connect(gainNode);
      g.gain.setValueAtTime(0.2, time);
      g.gain.exponentialRampToValueAtTime(0.001, time + Math.min(duration, 0.5));
      osc.start(time);
      osc.stop(time + Math.min(duration, 0.5));
    }

    // === FUN√á√ÉO PRINCIPAL: GERA 1 M√öSICA ===
    async function generateOneMusic(index) {
      const logEl = document.getElementById('log');
      logEl.textContent += `\n[${index.toString().padStart(4, '0')}] Gerando...`;

      // Par√¢metros aleat√≥rios
      const groove = randomChoice(ALL_GROOVES);
      const style = groove.name;
      const meter = groove.meter;
      const bpm = Math.floor(Math.random() * 100) + 70;
      const key = randomChoice(PITCHES);
      const quality = Math.random() > 0.5 ? 'maj' : 'min';

      const sixteenthDur = 60 / bpm / 4;
      const beats = meterToBeats(meter);
      const totalSteps = Math.ceil(30.0 / sixteenthDur);

      // Progress√£o
      const progressions = STYLE_PROGRESSIONS[style] || STYLE_PROGRESSIONS.Rock;
      const prog = randomChoice(progressions);
      const chordPlan = prog.map(degree => {
        const rootIdx = (PITCHES.indexOf(key) + DEGREE_TO_ROOT[degree]) % 12;
        const rootNote = PITCHES[rootIdx];
        let type = '';
        if ([2,3,6].includes(degree) && quality === 'maj') type = 'm';
        return {
          note: rootNote,
          type,
          display: CHORD_NAMES[rootIdx] + type,
          rootNote: CHORD_NAMES[rootIdx]
        };
      });

      // Salva JSON
      const metadata = generateMetadata(bpm, meter, key, quality, style, chordPlan, sixteenthDur);
      const jsonBlob = new Blob([JSON.stringify(metadata, null, 2)], { type: 'application/json' });
      downloadBlob(jsonBlob, `jam-${index.toString().padStart(4, '0')}.json`);

      // Renderiza √°udio offline
      const sampleRate = 44100;
      const offlineCtx = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(2, Math.ceil(30 * sampleRate), sampleRate);

      // √Årvore de ganho
      const master = offlineCtx.createGain();
      master.gain.value = 0.8;
      master.connect(offlineCtx.destination);

      const gains = {};
      ['drums', 'bass', 'clean', 'dist', 'piano', 'echo', 'cleanPicked', 'organ', 'melody'].forEach(name => {
        gains[name] = offlineCtx.createGain();
        gains[name].gain.value = 0.5;
        gains[name].connect(master);
      });

      // Agenda eventos
      for (let step = 0; step < totalSteps; step++) {
        const time = step * sixteenthDur;
        if (time >= 30.0) break;

        const bar = Math.floor(step / (beats * 4));
        const chord = chordPlan[bar % chordPlan.length];
        const freqBase = 220 * Math.pow(2, (PITCHES.indexOf(chord.note) - 3) / 12);

        // Baixo
        playDummyNote(offlineCtx, time, 0.3, freqBase, gains.bass);

        // Bateria (a cada 4 steps)
        if (step % 4 === 0) playDummyNote(offlineCtx, time, 0.1, 60, gains.drums);

        // Harmonia (a cada compasso)
        if (step % (beats * 4) === 0) {
          playDummyNote(offlineCtx, time, 1.0, freqBase * 2, gains.clean);
          playDummyNote(offlineCtx, time, 1.0, freqBase * 2.5, gains.dist);
          playDummyNote(offlineCtx, time, 1.0, freqBase * 3, gains.piano);
          playDummyNote(offlineCtx, time, 1.0, freqBase * 2.2, gains.echo);
          playDummyNote(offlineCtx, time, 1.0, freqBase * 2.8, gains.cleanPicked);
          playDummyNote(offlineCtx, time, 1.0, freqBase * 3.5, gains.organ);
        }

        // Melodia
        if (step % 8 === 0) {
          const melodyFreq = freqBase * [1, 1.25, 1.5, 2][Math.floor(Math.random() * 4)];
          playDummyNote(offlineCtx, time, 0.4, melodyFreq, gains.melody);
        }
      }

      // Renderiza e salva WAV
      const buffer = await offlineCtx.startRendering();
      const wavBlob = audioBufferToWav(buffer);
      downloadBlob(wavBlob, `jam-${index.toString().padStart(4, '0')}.wav`);

      logEl.textContent += ` ‚úÖ`;
    }

    // === IN√çCIO DO LOTE ===
    document.getElementById('btnStart').addEventListener('click', async () => {
      const btn = document.getElementById('btnStart');
      btn.disabled = true;
      const logEl = document.getElementById('log');
      logEl.textContent = 'Iniciando gera√ß√£o de 1000 m√∫sicas...\n';

      for (let i = 1; i <= 1000; i++) {
        await generateOneMusic(i);
        // Pequena pausa para n√£o sobrecarregar o navegador
        await new Promise(r => setTimeout(r, 10));
      }

      logEl.textContent += '\n\n‚úÖ Todas as 1000 m√∫sicas foram geradas!';
      btn.textContent = 'Conclu√≠do!';
    });
  </script>
</body>
</html>
