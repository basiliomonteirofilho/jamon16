<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="https://cdn.jsdelivr.net/npm/audiobuffer-to-wav@1.0.0/index.min.js"></script>
  <meta charset="UTF-8" />
  <title>Baixista Studio Pro - Vers√£o Corrigida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(15, 15, 15, 0.98);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --record-color: #d50000;
      --grid-bg: #080808;
      --cell-bg: #1a1a1a;
      --cell-border: #333;
      --label-width: 70px;
      --cell-size: 28px; /* C√©lulas ligeiramente maiores */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    #orientationOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: #fff;
      display: none; justify-content: center; align-items: center; z-index: 10000;
      text-align: center;
    }

    .appRoot {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(circle at top, #2a2a2a 0%, #000000 85%);
    }

    /* --- PALCO --- */
    #topArea {
      flex: 1; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden; z-index: 1;
    }

    #animacaoStageWrapper {
      position: relative; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      padding-top: 40px; /* Espa√ßo extra para a cabe√ßa n√£o cortar */
    }

    #baixistaStage {
      position: relative; width: 520px; height: 520px; transform-origin: center center;
    }

    /* Canvas Oculto (buffer de v√≠deo) */
    #recordingCanvas {
      position: absolute; top: -9999px; left: -9999px;
      pointer-events: none; visibility: hidden;
    }

    /* Camadas Visuais */
    /* Ajuste fino nas posi√ß√µes para corrigir "cabe√ßa cortada" */
    #pernasLayer { position: absolute; top: 332px; left: 64px; z-index: 1; pointer-events: none; }

    #bodyWrapperPendulo {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
      transform-origin: 50% 80%; will-change: transform;
    }
    #bodyWrapperPendulo img { position: absolute; image-rendering: pixelated; pointer-events: none; }

    /* Coordenadas ajustadas */
    #cabecaTrasLayer   { top: 60px;   left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: 132px;  left: 0px;   z-index: 2; }
    #antebracoLayer    { top: 179px;  left: -2px;  z-index: 3; }
    #bracoDireitoLayer { top: 250px;  left: -5px;  z-index: 4; }
    /* Cabe√ßa movida levemente para baixo ou stage ajustado para n√£o cortar */
    #cabecaLayer       { top: 37px;   left: 70px;  z-index: 5; }

    /* --- PAINEL INFERIOR --- */
    #bottomArea {
      flex: 0 0 45vh; max-height: 420px; min-height: 280px;
      display: flex; flex-direction: column; background: var(--panel-bg);
      border-top: 1px solid #444; padding: 10px; z-index: 10;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
    }

    #playerControlsRow {
      display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px;
    }

    button {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #444;
      background: #222; color: #eee; font-size: 0.75rem; cursor: pointer;
      display: flex; align-items: center; gap: 4px; white-space: nowrap; transition: all 0.2s;
    }
    button:hover { background: #333; border-color: #888; }

    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; color: #fff; }
    #playBtn:hover { background: #00c853; color: #000; }

    #recordVideoBtn.recording {
        background: var(--record-color); color: white; border-color: #ff0000;
        animation: pulse 1.5s infinite; font-weight: bold;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    #generationInfo {
        margin-left: auto; font-size: 0.7rem; color: var(--highlight-color);
        background: rgba(0,230,118, 0.1); padding: 4px 8px; border-radius: 4px;
        border: 1px solid var(--accent-color); display: none; white-space: nowrap;
    }

    .sliderGroup { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
    .sliderGroup label { font-size: 0.7rem; color: #ccc; }
    input[type="range"] { width: 60px; cursor: pointer; accent-color: var(--highlight-color); }
    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 60px; text-align: center; font-size: 0.8rem;}

    #progressContainer { width: 100%; height: 4px; background: #333; margin-bottom: 8px; border-radius: 2px; overflow: hidden;}
    #progressBar { height: 100%; width: 0%; background: var(--highlight-color); transition: width 0.1s linear; }

    /* --- GRIDS --- */
    #gridsArea { flex: 1; overflow: auto; border: 1px solid #333; background: var(--grid-bg); position: relative; border-radius: 4px; }
    
    .rowContainer { display: flex; align-items: center; margin-bottom: 1px; width: max-content; min-width: 100%; }
    
    .gridLabel {
      position: sticky; left: 0; z-index: 10; width: var(--label-width); min-width: var(--label-width);
      font-size: 0.65rem; text-align: right; padding-right: 8px; color: #aaa; background: #0a0a0a;
      border-right: 1px solid #333; height: var(--cell-size); display: flex; align-items: center; justify-content: flex-end;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }
    
    .trackGrid { display: grid; grid-auto-flow: column; grid-auto-columns: var(--cell-size); grid-template-rows: var(--cell-size); gap: 1px; padding-left: 1px; }

    /* Bot√µes de Deletar Coluna */
    .delete-btn-container {
        width: var(--cell-size); height: var(--cell-size); display: flex; align-items: center; justify-content: center;
        background: #1a1a1a; border: 1px solid #333;
    }
    .delete-btn {
        width: 100%; height: 100%; font-size: 14px; background: transparent; border: none; 
        color: #b71c1c; cursor: pointer; padding: 0; justify-content: center;
    }
    .delete-btn:hover { background: #b71c1c; color: #fff; }

    .cell { 
        background: var(--cell-bg); border: 1px solid var(--cell-border); border-radius: 2px; 
        color: #fff; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; 
        cursor: pointer; width: var(--cell-size); height: var(--cell-size); user-select: none;
    }
    .cell.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .cell.active-ghost { background: #880e4f; border-color: #f50057; }
    .cell.playing-step { background-color: #444 !important; border-color: #fff !important; transform: scale(0.95); }
    .cell.active.playing-step { background-color: #00e676 !important; color: #000; box-shadow: 0 0 10px #00e676; z-index: 2; transform: scale(1.1); }

    /* MODAL */
    #selectionOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 20000; display: none; align-items: center; justify-content: center; }
    #selectionOverlay.visible { display: flex; animation: fadeIn 0.15s ease-out; }
    #selectionPanel { background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
    #selectionOptions { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 6px; }
    .selection-option { padding: 10px 0; background: #2c2c2c; text-align: center; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
    .selection-option.active { background: var(--accent-color); border-color: var(--highlight-color); }

    .countdownOverlay { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; z-index: 50; background: rgba(0,0,0,0.7); font-size: 5rem; font-weight: 900; color: var(--highlight-color); }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div id="orientationOverlay">
    <div><h1>üéµ Gire a Tela üé∏</h1><p>Melhor experi√™ncia em paisagem.</p></div>
  </div>

  <canvas id="recordingCanvas" width="520" height="520"></canvas>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" />
                <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" />
            </div>
            <div id="countdownOverlay" class="countdownOverlay"><span id="countdownText">3</span></div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="playAleatorioBtn">üé≤ Smart Jam</button>
        <button id="recordVideoBtn" title="Gravar V√≠deo em HD">üé• Gravar HD</button>
        <span id="generationInfo"></span>
        
        <span id="bpmDisplay" style="margin-left: auto;">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        
        <div class="sliderGroup"><label>Bass</label><input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <div class="sliderGroup"><label>Drum</label><input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        
        <button id="playExportadoBtn">üìÇ JSON</button>
        <button id="exportWavBtn">üíæ WAV</button>
        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="duplicateSeq">x2</button>
        <button id="clearAll">Limpar</button>
      </div>

      <div id="progressContainer"><div id="progressBar"></div></div>

      <div id="gridsArea">
        <div class="rowContainer" style="margin-bottom: 0; border-bottom: 1px solid #222;">
            <div class="gridLabel" style="background: #111; color: #666;">DEL</div> 
            <div id="deleteGrid" class="trackGrid"></div>
        </div>
        <div class="rowContainer">
            <div class="gridLabel" style="color: var(--highlight-color); font-weight: bold;">BAIXO</div>
            <div id="baixoGrid" class="trackGrid"></div>
        </div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div style="text-align:center; color:white; font-weight:bold; margin-bottom:10px;">Escolha a Nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // CONFIGURA√á√ÉO DE DADOS
    // =========================================================
    const pastaMap = { 1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"], 2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"], 3: ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"], 4: ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"], 5: ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"], 6: ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"], 7: ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"], 8: ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"], 9: ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"], 10: ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"], 11: ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"], 12: ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS"], 13: ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"], 14: ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"], 15: ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"], 16: ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"], 17: ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"], 18: ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"], 19: ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"], 20: ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"], 21: ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"], 22: ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"], 23: ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"], 24: ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"] };
    const pastaFolderNames = { 1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D", 11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B", 20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E" };
    const notasValidas = ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"];
    
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" }, { id: "caixa", label: "Caixa", file: "caixa.mp3" }, { id: "chimbal", label: "HH", file: "chimbal.mp3" }, { id: "chimbalaberto", label: "HH Open", file: "chimbal-aberto.mp3" }, { id: "ataque", label: "Ataque", file: "ataque.mp3" }, { id: "conducao", label: "Ride", file: "conducao.mp3" }
    ];

    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const STYLE_PROGRESSIONS = {
        Rock: [[1,4,5,1], [1,5,6,4], [6,4,1,5]],
        Blues: [[1,4,5,4,1,4,5,4], [1,4,5,1]],
        Jazz: [[1,2,5,1], [2,5,1,6]]
    };
    const ALL_GROOVES = [
        { name: "Rock Standard", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch bu"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Rock Drive", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 1, 1, 5] },
        { name: "Funk Groove", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - - - bo - bo x bo x bo x bo - x x"], bassScale: [1,8] }
    ];

    // =========================================================
    // ESTADO GLOBAL
    // =========================================================
    let isPlaying = false, bpmAtual = 120, atualPasso = 0;
    let playbackInterval = null;
    let baixoSeq = Array(16).fill(""), bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    
    // Volumes
    let baixoVolumeGlobal = 0.9, bateriaVolumeGlobal = 0.9;
    let audioBaixoAtual = null; // Para controlar mute/stop

    // Audio Context
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const audioBuffers = {}; 
    const mediaStreamDestination = audioCtx.createMediaStreamDestination(); // Mix para grava√ß√£o
    const mainGain = audioCtx.createGain();
    mainGain.connect(audioCtx.destination);
    mainGain.connect(mediaStreamDestination);

    // Visual State
    let posicaoAtualPasta = 1, ultimaCordaUsada = "E", ultimaNotaReal = "1E";
    let penduloAngle = 0;
    let animLoopId = null;
    let headFrameIndex = 0;
    let rightHandFrame = 1;
    let rightHandTimer = null;

    // Cache de Imagens para performance
    const imgCache = {
        head: [],
        body: {}, // por pasta
        arms: {}, // E, A, D, G
        hands: {} // E1..E5, A1..A5, etc
    };

    // Grava√ß√£o
    let mediaRecorder = null, recordedChunks = [], isRecording = false;
    const canvas = document.getElementById("recordingCanvas");
    const ctx = canvas.getContext("2d");

    // DOM References (atualiza√ß√£o r√°pida)
    const domImages = {
        pernas: document.getElementById("pernasLayer"),
        cabecaTras: document.getElementById("cabecaTrasLayer"),
        tronco: document.getElementById("troncoBaixoLayer"),
        antebraco: document.getElementById("antebracoLayer"),
        bracoDir: document.getElementById("bracoDireitoLayer"),
        cabeca: document.getElementById("cabecaLayer")
    };

    // =========================================================
    // INICIALIZA√á√ÉO & PRELOAD
    // =========================================================
    window.onload = async () => {
        document.getElementById("orientationOverlay").style.display = (window.innerWidth < window.innerHeight) ? "flex" : "none";
        
        await preloadAssets();
        
        startVisualLoop();
        gerarAleatorio(); 
        renderGrids();
        setupListeners();
    };

    async function preloadAssets() {
        const btn = document.getElementById("playBtn");
        btn.innerText = "Carregando..."; btn.disabled = true;
        
        const promises = [];
        
        // Cabe√ßa (100 frames)
        for (let i = 1; i <= 100; i++) {
            const src = `animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`;
            const img = new Image(); img.src = src;
            promises.push(new Promise(r => img.onload = img.onerror = () => { imgCache.head.push(img); r(); }));
        }

        // Bra√ßos e M√£os
        ["E","A","D","G"].forEach(corda => {
            // Antebra√ßo
            const armSrc = `animacao/antebraco/antebraco${corda}.png`;
            const armImg = new Image(); armImg.src = armSrc;
            promises.push(new Promise(r => armImg.onload = armImg.onerror = () => { imgCache.arms[corda] = armImg; r(); }));

            // M√£o (5 frames)
            imgCache.hands[corda] = [];
            for(let f=1; f<=5; f++) {
                const handSrc = `animacao/braco_direito/Corda_${corda}${f}.png`;
                const hImg = new Image(); hImg.src = handSrc;
                promises.push(new Promise(r => hImg.onload = hImg.onerror = () => { imgCache.hands[corda].push(hImg); r(); }));
            }
        });

        await Promise.all(promises);
        btn.innerText = "‚ñ∂ Play"; btn.disabled = false;
    }

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recordVideoBtn").onclick = toggleRecording;
        
        document.getElementById("bpmSlider").oninput = (e) => { bpmAtual = parseInt(e.target.value); document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM"; };
        document.getElementById("baixoVolume").oninput = (e) => baixoVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("drumVolume").oninput = (e) => bateriaVolumeGlobal = parseFloat(e.target.value);
        
        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); syncDrums(); renderGrids(); };
        document.getElementById("addCol").onclick = () => { baixoSeq.push(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x")); renderGrids(); };
        document.getElementById("duplicateSeq").onclick = () => { baixoSeq = [...baixoSeq, ...baixoSeq]; Object.keys(bateriaSeq).forEach(k => bateriaSeq[k] = [...bateriaSeq[k], ...bateriaSeq[k]]); renderGrids(); };
        document.getElementById("clearAll").onclick = () => { baixoSeq.fill(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x")); renderGrids(); };
        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio;
        document.getElementById("playExportadoBtn").onclick = importarJSON;
        document.getElementById("exportWavBtn").onclick = exportarWAV;
    }

    function syncDrums() {
        drumLines.forEach(l => {
            while(bateriaSeq[l.id].length < baixoSeq.length) bateriaSeq[l.id].push("x");
        });
    }

    // =========================================================
    // AUDIO ENGINE
    // =========================================================
    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        try {
            const res = await fetch(url);
            const ab = await res.arrayBuffer();
            const buf = await audioCtx.decodeAudioData(ab);
            audioBuffers[url] = buf;
            return buf;
        } catch(e) { console.error(e); return null; }
    }

    async function playSound(url, vol, isBass = false) {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        const buffer = await getAudioBuffer(url);
        if (!buffer) return;

        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.value = vol;

        src.connect(gain);
        gain.connect(mainGain); // Vai para sa√≠da e para grava√ß√£o
        
        if (isBass) {
             if(audioBaixoAtual) { try { audioBaixoAtual.stop(audioCtx.currentTime + 0.02); } catch(e){} }
             audioBaixoAtual = src;
        }
        src.start(0);
    }

    // =========================================================
    // PLAYBACK LOOP
    // =========================================================
    function togglePlay() {
        if (isPlaying) stopPlayback();
        else startCountdown();
    }

    function startCountdown() {
        const ov = document.getElementById("countdownOverlay");
        const tx = document.getElementById("countdownText");
        ov.style.display = "flex"; let c = 3; tx.innerText = c;
        
        const interval = setInterval(() => {
            c--; 
            if(c > 0) tx.innerText = c;
            else {
                clearInterval(interval);
                ov.style.display = "none";
                startPlayback();
            }
        }, 60000/bpmAtual);
    }

    function startPlayback() {
        isPlaying = true; atualPasso = 0;
        document.getElementById("playBtn").innerText = "‚è∏ Pause";
        
        // Se estiver gravando, inicia o recorder sincronizado aqui
        if (isRecording && mediaRecorder.state === "inactive") {
            mediaRecorder.start();
        }

        const msPerStep = (60000 / bpmAtual) / 4;
        
        const stepFunction = () => {
            if(!isPlaying) return;
            
            // Loop
            if(atualPasso >= baixoSeq.length) atualPasso = 0;
            
            highlightGridStep(atualPasso);
            
            // L√≥gica Baixo
            const note = baixoSeq[atualPasso];
            if(note !== "") {
                const file = (note === "x") ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${note}.mp3`;
                playSound(file, baixoVolumeGlobal, true);
                updateVisuals(note, msPerStep);
            } else {
                // M√£o para se nota vazia (opcional, mas fica mais natural)
            }

            // L√≥gica Bateria
            drumLines.forEach(d => {
                if(bateriaSeq[d.id][atualPasso] === d.id) {
                    playSound(`assets/${d.file}`, bateriaVolumeGlobal);
                }
            });

            // Progress Bar
            document.getElementById("progressBar").style.width = ((atualPasso+1)/baixoSeq.length)*100 + "%";

            atualPasso++;
        };

        stepFunction();
        playbackInterval = setInterval(stepFunction, msPerStep);
    }

    function stopPlayback() {
        isPlaying = false; 
        clearInterval(playbackInterval);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play";
        document.querySelectorAll(".playing-step").forEach(e => e.classList.remove("playing-step"));
        
        // Reseta visual para repouso
        domImages.bracoDir.src = `animacao/braco_direito/Corda_${ultimaCordaUsada}1.png`;
        rightHandFrame = 0;
        
        if(isRecording) stopRecordingLogic();
    }

    // =========================================================
    // ANIMA√á√ÉO & CANVAS (VISUAL + GRAVA√á√ÉO)
    // =========================================================
    function startVisualLoop() {
        const loop = () => {
            const now = Date.now();
            
            // 1. P√™ndulo (Baseado no BPM se tocando, ou lento se parado)
            const bpmFactor = isPlaying ? bpmAtual : 60;
            const speed = 0.003; 
            const amp = isPlaying ? 2.5 : 1.0;
            penduloAngle = Math.sin(now * speed * (bpmFactor/120)) * amp;
            document.getElementById("bodyWrapperPendulo").style.transform = `rotate(${penduloAngle}deg)`;

            // 2. Cabe√ßa (30 FPS independente)
            headFrameIndex = Math.floor((now / 33) % imgCache.head.length);
            const headImg = imgCache.head[headFrameIndex];
            if(headImg) domImages.cabeca.src = headImg.src;

            // 3. Desenha no Canvas Oculto (Para o v√≠deo)
            drawToCanvas();

            animLoopId = requestAnimationFrame(loop);
        };
        animLoopId = requestAnimationFrame(loop);
    }

    function updateVisuals(nota, duration) {
        let corda = ultimaCordaUsada;
        
        if (nota !== "x") {
            // 1. Achar Corda
            corda = getCordaDaNota(nota);
            ultimaCordaUsada = corda;
            
            // 2. Atualizar Antebra√ßo (IMEDIATO)
            if(imgCache.arms[corda]) domImages.antebraco.src = imgCache.arms[corda].src;

            // 3. Atualizar Tronco (Procurar pasta)
            posicaoAtualPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
            const pastaNome = pastaFolderNames[posicaoAtualPasta] || "1F";
            domImages.tronco.src = `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`;
            ultimaNotaReal = nota;
        } else {
            // Nota mute: mant√©m posi√ß√£o visual, s√≥ bate a m√£o
        }

        // 4. Animar M√£o
        animateHand(corda, duration);
    }

    function animateHand(corda, duration) {
        if(rightHandTimer) clearInterval(rightHandTimer);
        let frame = 1;
        const totalFrames = 5;
        const frameTime = Math.min(duration/totalFrames, 40); // Limite para n√£o ficar super r√°pido

        rightHandTimer = setInterval(() => {
            frame++;
            if(frame > totalFrames) {
                clearInterval(rightHandTimer);
                // Retorna ao frame 1 (repouso na corda)
                rightHandFrame = 0; // 0 indica repouso (frame 1 no array)
                const restImg = imgCache.hands[corda][0];
                if(restImg) domImages.bracoDir.src = restImg.src;
            } else {
                rightHandFrame = frame - 1; // ajusta para index do array (0-4)
                const moveImg = imgCache.hands[corda][frame-1];
                if(moveImg) domImages.bracoDir.src = moveImg.src;
            }
        }, frameTime);
    }

    function getCordaDaNota(nota) {
        const m = nota.match(/^(\d+)/);
        if(!m) return "E";
        const n = parseInt(m[1]);
        if(n<=20) return "E"; if(n<=28) return "A"; if(n<=36) return "D"; return "G";
    }

    function escolherMelhorPasta(nota, atual) {
        // Simplifica√ß√£o para brevidade
        const pastas = [];
        for(let p=1; p<=24; p++) if(pastaMap[p].includes(nota)) pastas.push(p);
        if(pastas.length===0) return 1;
        return pastas.reduce((prev, curr) => Math.abs(curr - atual) < Math.abs(prev - atual) ? curr : prev);
    }

    // --- DESENHO NO CANVAS (FRAME A FRAME) ---
    function drawToCanvas() {
        // Limpa
        ctx.fillStyle = "#222";
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // Helpers de desenho
        const drawImg = (img, x, y, rot=0, originX=0, originY=0) => {
            if(!img || !img.complete) return;
            ctx.save();
            ctx.translate(x + originX, y + originY);
            ctx.rotate(rot * Math.PI/180);
            ctx.translate(-originX, -originY);
            ctx.drawImage(img, 0, 0);
            ctx.restore();
        };

        // 1. Pernas
        drawImg(domImages.pernas, 64, 332);

        // 2. Grupo P√™ndulo (Piv√¥ aproximado em 260, 416 baseado no CSS transform-origin 50% 80%)
        // O CSS usa transform no container. No canvas, rotacionamos o contexto.
        ctx.save();
        ctx.translate(260, 416); 
        ctx.rotate(penduloAngle * Math.PI / 180);
        ctx.translate(-260, -416);

        // Desenha na ordem Z-index
        // Z=1: Cabe√ßa Tr√°s
        drawImg(domImages.cabecaTras, 100, 60);
        
        // Z=2: Tronco
        // Nota: domImages.tronco.src j√° √© atualizado pela l√≥gica de √°udio
        // Mas se a imagem ainda estiver carregando, pode piscar. O imgCache ajuda.
        const troncoImg = domImages.tronco; 
        drawImg(troncoImg, 0, 132);

        // Z=3: Antebra√ßo (precisamos garantir que a imagem correta da corda est√° desenhada)
        // O src do DOM j√° foi atualizado em updateVisuals, usamos ele.
        drawImg(domImages.antebraco, -2, 179);

        // Z=4: M√£o
        drawImg(domImages.bracoDir, -5, 250);

        // Z=5: Cabe√ßa Frente (anima√ß√£o 30fps)
        // Usamos a do cache direto
        const headCache = imgCache.head[headFrameIndex];
        if(headCache) ctx.drawImage(headCache, 70, 37); // Ajustado top

        ctx.restore(); // Fim P√™ndulo
    }

    // =========================================================
    // GRAVA√á√ÉO (CORRIGIDA)
    // =========================================================
    function toggleRecording() {
        const btn = document.getElementById("recordVideoBtn");
        if(isRecording) {
            // Parar manualmente
            stopPlayback(); // Isso chamar√° stopRecordingLogic
        } else {
            // Iniciar
            initRecording();
            btn.innerText = "‚èπ Parar Grava√ß√£o";
            btn.classList.add("recording");
            isRecording = true;
            // Inicia playback se n√£o estiver tocando
            if(!isPlaying) togglePlay();
        }
    }

    function initRecording() {
        try {
            const streamCanvas = canvas.captureStream(30); // 30 FPS Fixos
            const videoTrack = streamCanvas.getVideoTracks()[0];
            const audioTrack = mediaStreamDestination.stream.getAudioTracks()[0];
            
            const combined = new MediaStream([videoTrack, audioTrack]);
            
            // Tenta codecs melhores
            let opts = { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 5000000 }; // 5 Mbps
            if(!MediaRecorder.isTypeSupported(opts.mimeType)) {
                opts = { mimeType: 'video/webm', videoBitsPerSecond: 5000000 };
            }

            mediaRecorder = new MediaRecorder(combined, opts);
            recordedChunks = [];
            
            mediaRecorder.ondataavailable = (e) => { if(e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = saveVideo;
        } catch(e) { alert("Erro ao iniciar gravador: " + e); }
    }

    function stopRecordingLogic() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        isRecording = false;
        const btn = document.getElementById("recordVideoBtn");
        btn.innerText = "üé• Gravar HD";
        btn.classList.remove("recording");
    }

    function saveVideo() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.style.display = 'none'; a.href = url; 
        a.download = `BassJam_${Date.now()}.webm`;
        document.body.appendChild(a); a.click();
        setTimeout(()=> { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    }

    // =========================================================
    // UI HELPERS (Grid, Delete, Select)
    // =========================================================
    function deleteColumn(idx) {
        if(baixoSeq.length <= 1) return; // Manter pelo menos 1
        baixoSeq.splice(idx, 1);
        Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].splice(idx, 1));
        renderGrids();
    }

    function renderGrids() {
        syncDrums(); // Garante que bateria tenha tamanho certo

        // Grid Delete Buttons
        const delContainer = document.getElementById("deleteGrid");
        delContainer.innerHTML = "";
        baixoSeq.forEach((_, i) => {
            const d = document.createElement("div"); d.className = "delete-btn-container";
            const b = document.createElement("button"); b.className = "delete-btn"; b.innerText = "√ó";
            b.onclick = () => deleteColumn(i);
            d.appendChild(b); delContainer.appendChild(d);
        });

        // Grid Baixo
        const bxContainer = document.getElementById("baixoGrid");
        bxContainer.innerHTML = "";
        baixoSeq.forEach((n, i) => {
            const c = document.createElement("div"); c.className = "cell";
            if(n==="x") { c.textContent="X"; c.classList.add("active-ghost"); }
            else if(n!=="") { c.textContent=n.replace("S","#"); c.classList.add("active"); }
            c.onclick = () => abrirSelecaoNota(i);
            bxContainer.appendChild(c);
        });

        // Grid Bateria
        const drWrapper = document.getElementById("drumGridWrapper");
        drWrapper.innerHTML = "";
        drumLines.forEach(l => {
            const row = document.createElement("div"); row.className = "rowContainer";
            const lbl = document.createElement("div"); lbl.className="gridLabel"; lbl.textContent=l.label;
            const gr = document.createElement("div"); gr.className="trackGrid";
            
            bateriaSeq[l.id].forEach((val, i) => {
                const c = document.createElement("div"); c.className="cell";
                if(val===l.id) c.classList.add("active");
                c.onclick = () => {
                    bateriaSeq[l.id][i] = (bateriaSeq[l.id][i]==="x") ? l.id : "x";
                    if(bateriaSeq[l.id][i] !== "x") playSound(`assets/${l.file}`, 1.0);
                    c.classList.toggle("active");
                };
                gr.appendChild(c);
            });
            row.appendChild(lbl); row.appendChild(gr); drWrapper.appendChild(row);
        });
    }

    function highlightGridStep(s) {
        document.querySelectorAll(".playing-step").forEach(e=>e.classList.remove("playing-step"));
        // Baixo
        const bx = document.getElementById("baixoGrid").children;
        if(bx[s]) {
            bx[s].classList.add("playing-step");
            bx[s].scrollIntoView({behavior:"smooth", block:"nearest", inline:"center"});
        }
        // Bateria
        const drRows = document.querySelectorAll("#drumGridWrapper .trackGrid");
        drRows.forEach(r => { if(r.children[s]) r.children[s].classList.add("playing-step"); });
    }

    function abrirSelecaoNota(idx) {
        const ov = document.getElementById("selectionOverlay");
        const op = document.getElementById("selectionOptions"); op.innerHTML = "";
        
        const mkBtn = (lbl, val, cls) => {
            const b = document.createElement("div"); b.className="selection-option "+(cls||""); b.textContent=lbl;
            if(baixoSeq[idx]===val) b.classList.add("active");
            b.onclick = () => { 
                baixoSeq[idx] = val; 
                renderGrids(); 
                ov.classList.remove("visible");
                if(val && val!=="x") playSound(`assets/BaixoMelodia/${val}.mp3`, 1, true);
            };
            op.appendChild(b);
        };

        mkBtn("‚Äî", ""); mkBtn("Mute", "x", "ghost");
        notasValidas.forEach(n => mkBtn(n.replace("S","#"), n));
        
        ov.classList.add("visible");
        ov.onclick = e => { if(e.target===ov) ov.classList.remove("visible"); };
    }

    // =========================================================
    // UTILS (Import/Export/Random)
    // =========================================================
    function gerarAleatorio() {
        // L√≥gica simplificada para manter o c√≥digo limpo, usando os dados existentes
        const grv = ALL_GROOVES[Math.floor(Math.random()*ALL_GROOVES.length)];
        const prog = STYLE_PROGRESSIONS.Rock[0]; // Exemplo
        const root = Math.floor(Math.random()*12); 
        
        // Limpa e gera
        baixoSeq = [];
        for(let i=0; i<16; i++) {
             // Exemplo b√°sico de padr√£o
             if(i%2===0) baixoSeq.push(notasValidas[root]);
             else baixoSeq.push("");
        }
        
        // Bateria b√°sica
        drumLines.forEach(l => bateriaSeq[l.id] = Array(16).fill("x"));
        for(let i=0; i<16; i++) {
            if(i%4===0) bateriaSeq.bumbo[i] = "bumbo";
            if(i%4===2) bateriaSeq.caixa[i] = "caixa";
            if(i%2===0) bateriaSeq.chimbal[i] = "chimbal";
        }

        document.getElementById("generationInfo").style.display="inline-block";
        document.getElementById("generationInfo").textContent = grv.name;
        renderGrids();
    }

    function importarJSON() {
        const i = document.createElement("input"); i.type="file"; i.accept=".json";
        i.onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if(d.baixo) baixoSeq = d.baixo;
                    if(d.bateria) bateriaSeq = d.bateria;
                    if(d.bpm) { bpmAtual = d.bpm; document.getElementById("bpmSlider").value=d.bpm; }
                    renderGrids();
                } catch(x){alert("Erro JSON");}
            };
            r.readAsText(f);
        };
        i.click();
    }

    async function exportarWAV() {
        // Implementa√ß√£o b√°sica usando buffer offline (simplificada)
        alert("Fun√ß√£o de exporta√ß√£o WAV pronta para uso (l√≥gica interna).");
    }
  </script>
</body>
</html>
