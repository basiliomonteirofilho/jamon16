<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="jamon-engine.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/audiobuffer-to-wav@1.0.0/index.min.js"></script>
  <meta charset="UTF-8" />
  <title>Baixista Studio - Grava√ß√£o Autom√°tica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.98);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --record-color: #d50000;
      --grid-bg: #000;
      --cell-bg: #151515;
      --cell-border: #333;
      --label-width: 70px;
      --cell-size: 26px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    /* Overlay de Orienta√ß√£o */
    #orientationOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: #fff;
      display: none; justify-content: center; align-items: center; z-index: 10000;
    }

    .appRoot {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(circle at top, #222 0%, #000 80%);
    }

    /* √Årea da Anima√ß√£o */
    #topArea {
      flex: 1; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden;
    }

    #baixistaStage {
      position: relative; width: 520px; height: 520px; transform-origin: center center;
    }

    /* O Canvas de grava√ß√£o fica escondido visualmente, mas ativo na mem√≥ria */
    #recordingCanvas {
      position: absolute; top: -9999px; left: -9999px;
      pointer-events: none; visibility: hidden;
    }

    /* Camadas DOM (Visualiza√ß√£o na tela) */
    #pernasLayer { position: absolute; top: 332px; left: 64px; z-index: 1; pointer-events: none; }
    #bodyWrapperPendulo {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
      transform-origin: 50% 80%; will-change: transform;
    }
    #bodyWrapperPendulo img { position: absolute; image-rendering: pixelated; pointer-events: none; }

    /* Posi√ß√µes */
    #cabecaTrasLayer   { top: 60px;   left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: 132px;  left: 0px;   z-index: 2; }
    #antebracoLayer    { top: 179px;  left: -2px;  z-index: 3; }
    #bracoDireitoLayer { top: 250px;  left: -5px;  z-index: 4; }
    #cabecaLayer       { top: 37px;   left: 70px;  z-index: 5; }

    /* √Årea de Controles */
    #bottomArea {
      flex: 0 0 50vh; max-height: 450px; min-height: 300px;
      display: flex; flex-direction: column; background: var(--panel-bg);
      border-top: 1px solid #333; padding: 10px; z-index: 10;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
    }

    #playerControlsRow {
      display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px;
    }

    button {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #444;
      background: #222; color: #eee; font-size: 0.75rem; cursor: pointer;
      display: flex; align-items: center; gap: 4px; white-space: nowrap;
    }
    button:hover { background: #333; border-color: #777; }

    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; color: #fff; }
    #playBtn:hover { background: #00c853; color: #000; }

    /* Bot√£o de Gravar - Novo Estilo */
    #recordVideoBtn {
        background: #263238; border: 1px solid #546e7a; color: #cfd8dc;
    }
    #recordVideoBtn.recording {
        background: var(--record-color); color: white; border-color: #ff0000;
        animation: pulse 1.5s infinite; font-weight: bold;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(213, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(213, 0, 0, 0); } }

    .sliderGroup { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
    .sliderGroup label { font-size: 0.7rem; color: #ccc; }
    input[type="range"] { width: 70px; cursor: pointer; accent-color: var(--highlight-color); }
    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 65px; text-align: center; font-size: 0.8rem;}

    #progressContainer { width: 100%; height: 3px; background: #333; margin-bottom: 8px; }
    #progressBar { height: 100%; width: 0%; background: var(--highlight-color); transition: width 0.1s linear; }

    /* Grids */
    #gridsArea { flex: 1; overflow: auto; border: 1px solid #333; background: var(--grid-bg); position: relative; }
    .rowContainer { display: flex; align-items: center; margin-bottom: 1px; width: max-content; min-width: 100%; position: relative; }
    .gridLabel {
      position: sticky; left: 0; z-index: 10; width: var(--label-width); min-width: var(--label-width);
      font-size: 0.65rem; text-align: right; padding-right: 8px; color: #aaa; background: #000;
      border-right: 1px solid #333; height: var(--cell-size); display: flex; align-items: center; justify-content: flex-end;
    }
    .trackGrid { display: grid; grid-auto-flow: column; grid-auto-columns: var(--cell-size); grid-template-rows: var(--cell-size); gap: 1px; padding-left: 1px; }

    .delete-btn { width: var(--cell-size); height: 18px; font-size: 10px; background: #b71c1c; border: none; color: rgba(255,255,255,0.8); border-radius: 2px; cursor: pointer; }
    .delete-btn:hover { background: #f44336; color: #fff; }

    .cell { background: var(--cell-bg); border: 1px solid var(--cell-border); border-radius: 2px; color: #fff; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: pointer; width: var(--cell-size); height: var(--cell-size); }
    .cell.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .cell.active-ghost { background: #880e4f; border-color: #f50057; }
    .cell.playing-step { background-color: #333 !important; border-color: #fff !important; }
    .cell.active.playing-step { background-color: #00e676 !important; color: #000; box-shadow: 0 0 12px #00e676; z-index: 2; }

    /* Modal */
    #selectionOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 20000; display: none; align-items: center; justify-content: center; }
    #selectionOverlay.visible { display: flex; animation: fadeIn 0.15s ease-out; }
    #selectionPanel { background: #1a1a1a; border: 1px solid #444; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
    #selectionTitle { margin-bottom: 15px; font-weight: bold; color: #fff; text-align: center; }
    #selectionOptions { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 6px; }
    .selection-option { padding: 10px 0; background: #2c2c2c; text-align: center; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
    .selection-option.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .selection-option.ghost { color: #ff80ab; border-color: #880e4f; }

    .countdownOverlay { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; z-index: 50; background: rgba(0,0,0,0.7); font-size: 5rem; font-weight: 900; color: var(--highlight-color); }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    @media (max-width: 600px) { #bottomArea { flex-basis: 55vh; } :root { --label-width: 50px; --cell-size: 22px; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div id="orientationOverlay">
    <div><h1>üéµ Melhor Experi√™ncia üé∏</h1><p>Por favor, gire seu dispositivo.</p></div>
  </div>

  <canvas id="recordingCanvas" width="520" height="520"></canvas>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" />
                <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" />
            </div>
            <div id="countdownOverlay" class="countdownOverlay"><span id="countdownText">3</span></div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="recordVideoBtn" title="Grava apenas a baixista (autom√°tico)">üî¥ Gravar (Auto)</button>
        <div style="width:1px; height:20px; background:#444; margin:0 4px;"></div>
        <button id="playAleatorioBtn">üé≤ Aleat√≥rio</button>
        <button id="playExportadoBtn">üìÅ Importar</button>
        <button id="exportWavBtn">üíæ Exportar WAV</button>
        <span id="bpmDisplay">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        <div class="sliderGroup"><label>Bx</label><input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <div class="sliderGroup"><label>Dr</label><input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" /></div>
        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="duplicateSeq">x2</button>
        <button id="clearAll">Limpar</button>
      </div>

      <div id="progressContainer"><div id="progressBar"></div></div>

      <div id="gridsArea">
        <div class="rowContainer" style="margin-bottom: 4px;">
            <div class="gridLabel" style="background: transparent; border: none;"></div> 
            <div id="deleteGrid" class="trackGrid"></div>
        </div>
        <div class="rowContainer">
            <div class="gridLabel" style="color: var(--highlight-color); font-weight: bold;">BAIXO</div>
            <div id="baixoGrid" class="trackGrid"></div>
        </div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div id="selectionTitle">Nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // DADOS
    // =========================================================
    const pastaMap = { 1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"], 2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"], 3: ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"], 4: ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"], 5: ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"], 6: ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"], 7: ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"], 8: ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"], 9: ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"], 10: ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"], 11: ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"], 12: ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS"], 13: ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"], 14: ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"], 15: ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"], 16: ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"], 17: ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"], 18: ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"], 19: ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"], 20: ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"], 21: ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"], 22: ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"], 23: ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"], 24: ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"] };
    const pastaFolderNames = { 1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D", 11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B", 20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E" };
    const notasValidas = ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"];
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" }, { id: "caixa", label: "Caixa", file: "caixa.mp3" }, { id: "caixaAro", label: "Aro", file: "caixaAro.mp3" }, { id: "chimbal", label: "HH", file: "chimbal.mp3" }, { id: "chimbal_pedal", label: "HH Ped", file: "chimbal-pedal.mp3" }, { id: "chimbalaberto", label: "HH Open", file: "chimbal-aberto.mp3" }, { id: "ataque", label: "Ataque", file: "ataque.mp3" }, { id: "tom1", label: "Tom 1", file: "tom-1.mp3" }, { id: "tom2", label: "Tom 2", file: "tom-2.mp3" }, { id: "surdo", label: "Surdo", file: "surdo.mp3" }, { id: "conducao", label: "Ride", file: "conducao.mp3" }, { id: "conducao_centro", label: "Ride C", file: "conducao-centro.mp3" }
    ];

    // STATE
    let isPlaying = false, playbackInterval = null, bpmAtual = 120, atualPasso = 0;
    let baixoSeq = Array(16).fill(""), bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
    let baixoVolumeGlobal = 0.9, bateriaVolumeGlobal = 0.9, audioBaixoAtual = null;

    // Animation State
    let posicaoAtualPasta = 1, ultimaCordaUsada = "E", ultimaNotaReal = "1E";
    let reqAnimIdPendulo = null, headLoopTimer = null, rightHandTimer = null;
    let headFrameIndex = 0, headFrames = [];
    
    // Canvas & Recording State
    const canvas = document.getElementById("recordingCanvas");
    const ctx = canvas.getContext("2d");
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    const mediaStreamDestination = audioContext.createMediaStreamDestination();
    let mediaRecorder = null, recordedChunks = [], isRecording = false;
    let pendulumAngle = 0; // Estado global do angulo para o canvas saber onde desenhar

    // Imagens (DOM Elements) para leitura pelo Canvas
    const domImages = {
        pernas: document.getElementById("pernasLayer"),
        cabecaTras: document.getElementById("cabecaTrasLayer"),
        tronco: document.getElementById("troncoBaixoLayer"),
        antebraco: document.getElementById("antebracoLayer"),
        bracoDir: document.getElementById("bracoDireitoLayer"),
        cabeca: document.getElementById("cabecaLayer")
    };

    // =========================================================
    // INIT
    // =========================================================
    window.onload = async () => {
        verificarOrientacao();
        window.addEventListener("resize", verificarOrientacao);
        for (let i = 1; i <= 100; i++) headFrames.push(`animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`);
        preloadImages(headFrames).then(startHeadLoop);
        gerarAleatorio();
        renderGrids();
        setupListeners();
    };

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recordVideoBtn").onclick = toggleRecording;
        document.getElementById("bpmSlider").oninput = (e) => { bpmAtual = parseInt(e.target.value); document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM"; };
        document.getElementById("baixoVolume").oninput = (e) => baixoVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("drumVolume").oninput = (e) => bateriaVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); renderGrids(); };
        document.getElementById("addCol").onclick = () => { baixoSeq.push(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x")); renderGrids(); };
        document.getElementById("duplicateSeq").onclick = () => { baixoSeq = [...baixoSeq, ...baixoSeq]; Object.keys(bateriaSeq).forEach(k => bateriaSeq[k] = [...bateriaSeq[k], ...bateriaSeq[k]]); renderGrids(); };
        document.getElementById("clearAll").onclick = () => { baixoSeq.fill(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x")); renderGrids(); };
        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio;
        document.getElementById("playExportadoBtn").onclick = importarJSON;
        document.getElementById("exportWavBtn").onclick = exportarWAV;
    }

    function deleteColumn(idx) {
        if (baixoSeq.length <= 1) return;
        baixoSeq.splice(idx, 1);
        Object.keys(bateriaSeq).forEach(key => bateriaSeq[key].splice(idx, 1));
        renderGrids();
    }

    // =========================================================
    // L√ìGICA DE DESENHO NO CANVAS (SYNC COM DOM)
    // =========================================================
    function drawFrameToCanvas() {
        // Limpa
        ctx.fillStyle = "#111"; // Fundo preto ou da cor do site
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 1. Desenha Pernas (Est√°ticas, fundo)
        // DOM: top 332, left 64. Canvas: mesmo sistema de coordenadas.
        if (domImages.pernas.complete) ctx.drawImage(domImages.pernas, 64, 332);

        // 2. Configura Rota√ß√£o do Corpo
        // DOM Pivot: 50% 80% do wrapper (que √© 520x520). 
        // Pivot X = 260, Pivot Y = 416.
        ctx.save();
        ctx.translate(260, 416);
        ctx.rotate(pendulumAngle * Math.PI / 180); // Converte graus p/ radianos
        ctx.translate(-260, -416);

        // 3. Desenha Partes do Corpo (Offsets relativos ao wrapper 0,0)
        // Offsets ajustados para o sistema de coordenadas do Canvas (baseado no CSS anterior)
        
        // Cabe√ßa Tr√°s: top 60, left 100
        if (domImages.cabecaTras.complete) ctx.drawImage(domImages.cabecaTras, 100, 60);
        
        // Tronco: top 132, left 0
        if (domImages.tronco.complete) ctx.drawImage(domImages.tronco, 0, 132);
        
        // Antebra√ßo: top 179, left -2
        if (domImages.antebraco.complete) ctx.drawImage(domImages.antebraco, -2, 179);
        
        // Bra√ßo Direito: top 250, left -5
        if (domImages.bracoDir.complete) ctx.drawImage(domImages.bracoDir, -5, 250);
        
        // Cabe√ßa Frente: top 37, left 70
        if (domImages.cabeca.complete) ctx.drawImage(domImages.cabeca, 70, 37);

        ctx.restore();
    }

    // =========================================================
    // GRAVA√á√ÉO AUTOM√ÅTICA
    // =========================================================
    async function toggleRecording() {
        const btn = document.getElementById("recordVideoBtn");
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            btn.innerText = "üî¥ Gravar (Auto)";
            btn.classList.remove("recording");
        } else {
            try {
                if (audioContext.state === 'suspended') await audioContext.resume();
                
                // Captura o stream do CANVAS (30fps √© suficiente e leve)
                const canvasStream = canvas.captureStream(30);
                const videoTrack = canvasStream.getVideoTracks()[0];
                const audioTrack = mediaStreamDestination.stream.getAudioTracks()[0];
                const combinedStream = new MediaStream([videoTrack, audioTrack]);

                // Codec Preference
                let mimeType = 'video/webm';
                if (MediaRecorder.isTypeSupported('video/webm; codecs=vp9')) mimeType = 'video/webm; codecs=vp9';
                else if (MediaRecorder.isTypeSupported('video/webm; codecs=vp8')) mimeType = 'video/webm; codecs=vp8';

                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: mimeType, videoBitsPerSecond: 2500000 });
                recordedChunks = [];

                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = url; a.download = 'baixista_auto_jam.webm';
                    document.body.appendChild(a); a.click();
                    window.URL.revokeObjectURL(url);
                };

                mediaRecorder.start();
                isRecording = true;
                btn.innerText = "‚èπ Parar";
                btn.classList.add("recording");

                if (!isPlaying) togglePlay();
            } catch (err) {
                console.error(err);
                alert("Erro ao iniciar gravador interno.");
            }
        }
    }

    // =========================================================
    // PLAYBACK & ANIMATION LOOP
    // =========================================================
    function startPenduloAnim() {
        const wrapper = document.getElementById("bodyWrapperPendulo");
        const amplitude = 2.3, speed = 0.003; 
        const frame = () => {
            if (!isPlaying) return;
            const now = Date.now();
            // Calcula angulo
            pendulumAngle = Math.sin(now * speed * (bpmAtual / 120)) * amplitude;
            
            // Aplica no DOM (para o usu√°rio ver)
            wrapper.style.transform = `rotate(${pendulumAngle}deg)`;
            
            // Aplica no Canvas (para o gravador ver)
            drawFrameToCanvas();
            
            reqAnimIdPendulo = requestAnimationFrame(frame);
        };
        reqAnimIdPendulo = requestAnimationFrame(frame);
    }

    function stopPenduloAnim() {
        cancelAnimationFrame(reqAnimIdPendulo);
        const wrapper = document.getElementById("bodyWrapperPendulo");
        if(wrapper) wrapper.style.transform = "rotate(0deg)";
        pendulumAngle = 0;
        drawFrameToCanvas(); // Desenha frame est√°tico no canvas
    }

    function togglePlay() {
        if (isPlaying) pararPlayback();
        else {
            const overlay = document.getElementById("countdownOverlay"), txt = document.getElementById("countdownText");
            overlay.style.display = "flex"; let count = 4; txt.innerText = count;
            const countInt = setInterval(() => {
                count--;
                if(count > 0) txt.innerText = count;
                else { clearInterval(countInt); overlay.style.display = "none"; iniciarPlayback(); }
            }, 60000 / bpmAtual);
        }
    }

    function iniciarPlayback() {
        if (audioContext.state === 'suspended') audioContext.resume();
        isPlaying = true; atualPasso = 0;
        document.getElementById("playBtn").innerText = "‚è∏ Pause"; document.getElementById("playBtn").style.background = "#e65100";
        startPenduloAnim();
        const msPorStep = (60000 / bpmAtual) / 4;
        const loop = () => {
            if (!isPlaying) return;
            if (atualPasso >= baixoSeq.length) atualPasso = 0;
            highlightGridStep(atualPasso);
            
            const notaBaixo = baixoSeq[atualPasso];
            if (notaBaixo !== "") {
                let file = (notaBaixo === "x") ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${notaBaixo}.mp3`;
                tocarAudioBuffer(file, baixoVolumeGlobal);
                animarBaixo(notaBaixo, msPorStep);
            } else {
                stopRightHand();
            }

            drumLines.forEach(line => {
                if (bateriaSeq[line.id] && bateriaSeq[line.id][atualPasso] === line.id) {
                    tocarAudioBuffer(`assets/${line.file}`, bateriaVolumeGlobal);
                }
            });
            
            document.getElementById("progressBar").style.width = ((atualPasso + 1) / baixoSeq.length * 100) + "%";
            atualPasso++;
        };
        loop();
        playbackInterval = setInterval(loop, msPorStep);
    }

    function pararPlayback() {
        isPlaying = false; clearInterval(playbackInterval);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play"; document.getElementById("playBtn").style.background = "";
        stopPenduloAnim(); stopRightHand();
        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        if(audioBaixoAtual) { try{audioBaixoAtual.stop();}catch(e){} audioBaixoAtual = null; }
    }

    // =========================================================
    // AUDIO
    // =========================================================
    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        audioBuffers[url] = audioBuffer;
        return audioBuffer;
    }

    async function tocarAudioBuffer(path, vol) {
        try {
            const buffer = await getAudioBuffer(path);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = vol;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.connect(mediaStreamDestination); // Envia para o gravador
            source.start();
            if (path.includes("BaixoMelodia") || path.includes("bass-muted")) {
                if(audioBaixoAtual) try{audioBaixoAtual.stop();}catch(e){}
                audioBaixoAtual = source;
            }
        } catch (e) {}
    }

    // =========================================================
    // ANIMATION HELPERS
    // =========================================================
    function startHeadLoop() {
        if(headLoopTimer) clearInterval(headLoopTimer);
        headLoopTimer = setInterval(() => {
            headFrameIndex = (headFrameIndex + 1) % headFrames.length;
            if(headFrames[headFrameIndex]) {
                domImages.cabeca.src = headFrames[headFrameIndex];
                // O canvas l√™ o src atual da imagem DOM, ent√£o n√£o precisamos atualizar o canvas explicitamente aqui
                // Ele ser√° atualizado no pr√≥ximo frame do drawFrameToCanvas
            }
        }, 33);
    }

    function animarBaixo(nota, duracaoStep) {
        if (nota === "x") {
            if (ultimaNotaReal) {
                const pasta = pastaFolderNames[posicaoAtualPasta] || "1F";
                domImages.tronco.src = `animacao/tronco_baixo/Pasta_${pasta}/${ultimaNotaReal}.png`;
            }
            animarMaoDireita(ultimaCordaUsada, duracaoStep);
            return;
        }
        posicaoAtualPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
        ultimaNotaReal = nota;
        const pastaNome = pastaFolderNames[posicaoAtualPasta];
        domImages.tronco.src = `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`;
        const corda = getCordaDaNota(nota);
        ultimaCordaUsada = corda;
        domImages.antebraco.src = `animacao/antebraco/antebraco${corda}.png`;
        animarMaoDireita(corda, duracaoStep);
    }

    function getCordaDaNota(nota) {
        const m = nota.match(/^(\d+)/);
        if (!m) return "E";
        const n = parseInt(m[1], 10);
        if (n <= 20) return "E"; if (n <= 28) return "A"; if (n <= 36) return "D"; return "G";
    }

    function escolherMelhorPasta(nota, posAtual) {
        const pastas = [];
        for (let p = 1; p <= 24; p++) if (pastaMap[p].includes(nota)) pastas.push(p);
        if (pastas.length === 0) return 1;
        return pastas.reduce((prev, curr) => Math.abs(curr - posAtual) < Math.abs(prev - posAtual) ? curr : prev);
    }

    function animarMaoDireita(corda, duracaoTotal) {
        clearInterval(rightHandTimer);
        let frame = 1; const totalFrames = 5; const frameTime = Math.min(duracaoTotal / totalFrames, 40);
        rightHandTimer = setInterval(() => {
            domImages.bracoDir.src = `animacao/braco_direito/Corda_${corda}${frame}.png`;
            frame++;
            if (frame > totalFrames) {
                clearInterval(rightHandTimer);
                domImages.bracoDir.src = `animacao/braco_direito/Corda_${corda}1.png`;
            }
        }, frameTime);
    }

    function stopRightHand() {
        clearInterval(rightHandTimer);
        domImages.bracoDir.src = `animacao/braco_direito/Corda_${ultimaCordaUsada || 'E'}1.png`;
    }

    // =========================================================
    // EXPORT WAV
    // =========================================================
    async function exportarWAV() {
        const btn = document.getElementById("exportWavBtn"); btn.innerText = "..."; btn.disabled = true;
        try {
            const totalSteps = baixoSeq.length;
            const secPerStep = (60 / bpmAtual) / 4;
            const totalDur = totalSteps * secPerStep + 2;
            const ctx = new OfflineAudioContext(2, 44100 * totalDur, 44100);

            for (let i = 0; i < totalSteps; i++) {
                const n = baixoSeq[i];
                if (n !== "" && n !== null) {
                    const start = i * secPerStep;
                    let url = n === "x" ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${n}.mp3`;
                    const buf = await getAudioBuffer(url);
                    const src = ctx.createBufferSource(); src.buffer = buf;
                    const g = ctx.createGain(); g.gain.value = baixoVolumeGlobal;
                    src.connect(g); g.connect(ctx.destination);
                    
                    let durSteps = 1;
                    for (let j = i + 1; j < totalSteps; j++) { if (baixoSeq[j] !== "") break; durSteps++; }
                    const dur = durSteps * secPerStep;
                    src.start(start); src.stop(start + dur);
                    g.gain.setTargetAtTime(0, start + dur - 0.01, 0.01);
                }
            }
            for (const l of drumLines) {
                const s = bateriaSeq[l.id];
                if (s) for (let i = 0; i < totalSteps; i++) {
                    if (s[i] === l.id) {
                        const buf = await getAudioBuffer(`assets/${l.file}`);
                        const src = ctx.createBufferSource(); src.buffer = buf;
                        const g = ctx.createGain(); g.gain.value = bateriaVolumeGlobal;
                        src.connect(g); g.connect(ctx.destination);
                        src.start(i * secPerStep);
                    }
                }
            }
            const rendered = await ctx.startRendering();
            const wav = audioBufferToWav(rendered);
            const blob = new Blob([wav], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'composicao.wav'; a.click();
        } catch (e) { alert("Erro exporta√ß√£o"); }
        btn.innerText = "üíæ Exportar WAV"; btn.disabled = false;
    }

    // =========================================================
    // UI
    // =========================================================
    function renderGrids() {
        const delC = document.getElementById("deleteGrid"), bxC = document.getElementById("baixoGrid"), drW = document.getElementById("drumGridWrapper");
        delC.innerHTML = "";
        baixoSeq.forEach((_, idx) => {
            const b = document.createElement("button"); b.className = "delete-btn"; b.innerText = "√ó";
            b.onclick = () => deleteColumn(idx); delC.appendChild(b);
        });
        bxC.innerHTML = "";
        baixoSeq.forEach((n, idx) => {
            const c = document.createElement("div"); c.className = "cell";
            if (n === "x") { c.textContent = "X"; c.classList.add("active-ghost"); }
            else if (n !== "") { c.textContent = n.replace("S", "#"); c.classList.add("active"); }
            else c.style.opacity = "0.3";
            c.onclick = () => abrirSelecaoNota(idx, c); bxC.appendChild(c);
        });
        drW.innerHTML = "";
        drumLines.forEach(l => {
            const row = document.createElement("div"); row.className = "rowContainer";
            const lbl = document.createElement("div"); lbl.className = "gridLabel"; lbl.textContent = l.label; row.appendChild(lbl);
            const grid = document.createElement("div"); grid.className = "trackGrid";
            while(bateriaSeq[l.id].length < baixoSeq.length) bateriaSeq[l.id].push("x");
            bateriaSeq[l.id].forEach((v, idx) => {
                const c = document.createElement("div"); c.className = "cell";
                if (v === l.id) c.classList.add("active");
                c.onclick = () => {
                    bateriaSeq[l.id][idx] = (bateriaSeq[l.id][idx] === "x") ? l.id : "x";
                    if(bateriaSeq[l.id][idx]!== "x") tocarAudioBuffer(`assets/${l.file}`, 1.0);
                    renderGrids(); // Re-render to update view
                };
                grid.appendChild(c);
            });
            row.appendChild(grid); drW.appendChild(row);
        });
    }

    function highlightGridStep(s) {
        document.querySelectorAll(".playing-step").forEach(e => e.classList.remove("playing-step"));
        if(document.getElementById("baixoGrid").children[s]) {
             document.getElementById("baixoGrid").children[s].classList.add("playing-step");
             document.getElementById("baixoGrid").children[s].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
        document.querySelectorAll("#drumGridWrapper .trackGrid").forEach(r => { if(r.children[s]) r.children[s].classList.add("playing-step"); });
    }

    function abrirSelecaoNota(idx) {
        const ov = document.getElementById("selectionOverlay"), op = document.getElementById("selectionOptions");
        op.innerHTML = "";
        const addOpt = (lbl, val, cls) => {
            const d = document.createElement("div"); d.className = "selection-option " + (cls||""); d.textContent = lbl;
            if(val === baixoSeq[idx]) d.classList.add("active");
            d.onclick = () => { baixoSeq[idx] = val; ov.classList.remove("visible"); renderGrids(); if(val && val!=="x") tocarAudioBuffer(`assets/BaixoMelodia/${val}.mp3`,1); };
            op.appendChild(d);
        };
        addOpt("‚Äî", ""); addOpt("X", "x", "ghost");
        notasValidas.forEach(n => addOpt(n.replace("S","#"), n));
        ov.classList.add("visible");
        ov.onclick = (e) => { if(e.target === ov) ov.classList.remove("visible"); };
    }

    function gerarAleatorio() {
        if (window.JamOnEngine && typeof JamOnEngine.generateRandomPlayback === "function") {
            try {
                const r = JamOnEngine.generateRandomPlayback(bpmAtual, 16);
                baixoSeq = r.bassSeq || Array(16).fill("");
                drumLines.forEach(d => bateriaSeq[d.id] = (r.bateriaSeq||{})[d.id] || Array(16).fill("x"));
            } catch(e) { fallbackAleatorio(); }
        } else fallbackAleatorio();
        renderGrids();
    }
    function fallbackAleatorio() {
        baixoSeq = Array(16).fill(0).map(() => Math.random()<0.5?"":(Math.random()<0.6?"x":notasValidas[Math.floor(Math.random()*notasValidas.length)]));
        drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x").map(()=>Math.random()<0.2?d.id:"x"));
    }
    function importarJSON() {
        const i = document.createElement("input"); i.type = "file"; i.accept = ".json";
        i.onchange = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => { try {
                const d = JSON.parse(ev.target.result);
                if(d.baixo) baixoSeq = d.baixo; if(d.bateria) bateriaSeq = d.bateria; if(d.bpm) bpmAtual = d.bpm;
                renderGrids();
            } catch(err) { alert("Erro JSON"); } };
            r.readAsText(f);
        }; i.click();
    }
    function verificarOrientacao() {
        document.getElementById("orientationOverlay").style.display = (window.innerWidth < window.innerHeight && window.innerWidth < 900) ? "flex" : "none";
    }
    function preloadImages(srcs) { return Promise.all(srcs.map(s => new Promise(r => { const i = new Image(); i.onload=i.onerror=r; i.src=s; }))); }
  </script>
</body>
</html>
