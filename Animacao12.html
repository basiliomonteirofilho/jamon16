<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="jamon-engine.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/audiobuffer-to-wav@1.0.0/index.min.js"></script>
  <meta charset="UTF-8" />
  <title>Baixista + Bateria - Gravador e Exportador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.95);
      --highlight-color: #00e676; /* Verde Neon */
      --accent-color: #2e7d32;
      --record-color: #ff3d00;
      --grid-bg: #080808;
      --cell-bg: #151515;
      --cell-border: #333;
      --playing-col-bg: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    /* Overlay de Orienta√ß√£o */
    #orientationOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      color: #fff;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 10000;
      padding: 20px;
    }
    #orientationOverlay h1 { font-size: 1.5rem; margin-bottom: 10px; color: var(--highlight-color); }

    /* Layout Principal */
    .appRoot {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #2a2a2a 0%, #000000 80%);
    }

    /* √Årea da Anima√ß√£o (Topo) */
    #topArea {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    #animacaoStageWrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #baixistaStage {
      position: relative;
      width: 520px;
      height: 520px;
      transform-origin: center center;
    }

    /* Camadas da Anima√ß√£o */
    #pernasLayer {
      position: absolute;
      top: 332px; 
      left: 64px;
      z-index: 1;
      pointer-events: none;
    }

    #bodyWrapperPendulo {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
      transform-origin: 50% 80%;
      will-change: transform;
    }

    #bodyWrapperPendulo img {
      position: absolute;
      image-rendering: pixelated;
      pointer-events: none;
    }

    /* Posi√ß√µes ajustadas */
    #cabecaTrasLayer   { top: 60px;   left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: 132px;  left: 0px;   z-index: 2; }
    #antebracoLayer    { top: 179px;  left: -2px;  z-index: 3; }
    #bracoDireitoLayer { top: 250px;  left: -5px;  z-index: 4; }
    #cabecaLayer       { top: 37px;   left: 70px;  z-index: 5; }

    /* √Årea de Controles */
    #bottomArea {
      flex: 0 0 45vh;
      max-height: 400px;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      background: var(--panel-bg);
      border-top: 1px solid #444;
      padding: 10px;
      z-index: 10;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }

    #playerControlsRow {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    button {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    button:hover { background: #333; border-color: #777; }
    button:active { transform: translateY(1px); }
    
    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; }
    #playBtn:hover { background: #00c853; color: #000; }

    /* Bot√£o de Gravar V√≠deo */
    #recordVideoBtn {
        background: #3700b3;
        border-color: #6200ea;
    }
    #recordVideoBtn.recording {
        background: var(--record-color);
        border-color: #ff0000;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 61, 0, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(255, 61, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 61, 0, 0); }
    }

    .sliderGroup {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 4px;
    }
    .sliderGroup label { font-size: 0.75rem; color: #aaa; }
    input[type="range"] { width: 80px; cursor: pointer; }

    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 65px; text-align: center;}

    #progressContainer {
      width: 100%;
      height: 4px;
      background: #333;
      border-radius: 2px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: var(--highlight-color);
      transition: width 0.1s linear;
      box-shadow: 0 0 8px var(--highlight-color);
    }

    /* Grades */
    #gridsArea {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #333;
      background: #000;
      border-radius: 4px;
      padding: 5px;
    }

    .rowContainer {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }
    .gridLabel {
      width: 60px;
      min-width: 60px;
      font-size: 0.7rem;
      text-align: right;
      padding-right: 8px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      left: 0;
      background: #000;
      z-index: 2;
    }

    .trackGrid {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 24px; /* LARGURA DA C√âLULA */
      grid-template-rows: 24px;
      gap: 1px;
    }

    /* Estilo do bot√£o de deletar coluna */
    .delete-btn {
        width: 24px; /* Mesma largura da c√©lula */
        height: 18px;
        font-size: 12px;
        background: #b71c1c; /* Vermelho escuro */
        border: none;
        color: white;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 2px;
    }
    .delete-btn:hover {
        background: #f44336;
    }

    .cell {
      background: var(--cell-bg);
      border: 1px solid var(--cell-border);
      border-radius: 2px;
      color: #fff;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    .cell:hover { border-color: #666; }
    
    .cell.active {
      background: var(--accent-color);
      border-color: var(--highlight-color);
      box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
    }
    .cell.active-ghost {
      background: #880e4f;
      border-color: #f50057;
    }
    .cell.playing-step {
      background-color: #444 !important;
      border-color: #fff !important;
    }
    .cell.active.playing-step {
      background-color: #00e676 !important;
      color: #000;
      box-shadow: 0 0 8px #00e676;
    }

    /* Modal de Sele√ß√£o */
    #selectionOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 20000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #selectionOverlay.visible { display: flex; animation: fadeIn 0.15s ease-out; }
    
    #selectionPanel {
      background: #1a1a1a;
      border: 1px solid #555;
      padding: 15px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,1);
    }
    #selectionTitle { margin-bottom: 10px; font-weight: bold; color: #fff; text-align: center; }
    #selectionOptions {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
      gap: 5px;
    }
    .selection-option {
      padding: 8px 0;
      background: #333;
      text-align: center;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .selection-option:hover { background: #444; border-color: #888; }
    .selection-option.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .selection-option.ghost { color: #ff80ab; }

    .countdownOverlay {
      position: absolute;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
      background: rgba(0,0,0,0.7);
      font-size: 4rem;
      font-weight: 800;
      color: var(--highlight-color);
      text-shadow: 0 0 20px var(--highlight-color);
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    ::-webkit-scrollbar-track { background: #111; }

    @media (max-width: 600px) {
        #bottomArea { flex-basis: 50vh; }
        .gridLabel { width: 40px; font-size: 0.6rem; }
        #playerControlsRow button { padding: 4px 8px; font-size: 0.7rem; }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div id="orientationOverlay">
    <div>
      <h1>üéµ Melhor Experi√™ncia üé∏</h1>
      <p>Por favor, gire seu dispositivo para o modo paisagem.</p>
    </div>
  </div>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />

            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" alt="Cabe√ßa atr√°s" />
                <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="Tronco/Baixo" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" alt="Antebra√ßo esquerdo" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" alt="M√£o direita" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" alt="Cabe√ßa frente" />
            </div>

            <div id="countdownOverlay" class="countdownOverlay">
              <span id="countdownText">3</span>
            </div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="recordVideoBtn" title="Grava a aba do navegador">üî¥ Gravar V√≠deo</button>
        
        <div style="width:1px; height:20px; background:#444; margin:0 4px;"></div>
        
        <button id="playAleatorioBtn">üé≤ Aleat√≥rio</button>
        <button id="playExportadoBtn">üìÅ Importar</button>
        <button id="exportWavBtn">üíæ Exportar WAV</button>
        
        <span id="bpmDisplay">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" title="Tempo (BPM)" />

        <div class="sliderGroup">
          <label>Baixo</label>
          <input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" />
        </div>
        <div class="sliderGroup">
          <label>Bat.</label>
          <input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" />
        </div>

        <button id="addBaixoCol">+1</button>
        <button id="addCol">+Todos</button>
        <button id="duplicateSeq">x2</button>
        <button id="clearAll">Limpar</button>
      </div>

      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>

      <div id="gridsArea">
        <div class="rowContainer">
            <div class="gridLabel"></div> <div id="deleteGrid" class="trackGrid"></div>
        </div>

        <div class="rowContainer">
            <div class="gridLabel">Baixo</div>
            <div id="baixoGrid" class="trackGrid"></div>
        </div>

        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div id="selectionTitle">Escolha a Nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // DADOS EST√ÅTICOS
    // =========================================================
    const pastaMap = {
      1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"],
      2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"],
      3: ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"],
      4: ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"],
      5: ["6A","7AS","8B","9C","11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS"],
      6: ["7AS","8B","9C","10CS","12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E"],
      7: ["8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F"],
      8: ["9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS"],
      9: ["10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G"],
      10: ["11D","12DS","13E","14F","16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS"],
      11: ["12DS","13E","14F","15FS","17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A"],
      12: ["13E","14F","15FS","16G","18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS"],
      13: ["14F","15FS","16G","17GS","19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B"],
      14: ["15FS","16G","17GS","18A","20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C"],
      15: ["16G","17GS","18A","19AS","21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS"],
      16: ["17GS","18A","19AS","20B","22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D"],
      17: ["18A","19AS","20B","21C","23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS"],
      18: ["19AS","20B","21C","22CS","24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E"],
      19: ["20B","21C","22CS","23D","25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F"],
      20: ["21C","22CS","23D","24DS","26F","27FS","28G","29GS","31AS","32B","33C","34CS","36DS","37E","38F","39FS"],
      21: ["22CS","23D","24DS","25E","27FS","28G","29GS","30A","32B","33C","34CS","35D","37E","38F","39FS","40G"],
      22: ["23D","24DS","25E","26F","28G","29GS","30A","31AS","33C","34CS","35D","36DS","38F","39FS","40G","41GS"],
      23: ["24DS","25E","26F","27FS","29GS","30A","31AS","32B","34CS","35D","36DS","37E","39FS","40G","41GS","42A"],
      24: ["25E","26F","27FS","28G","30A","31AS","32B","33C","35D","36DS","37E","38F","40G","41GS","42A","43AS"]
    };

    const pastaFolderNames = {
      1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D",
      11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B",
      20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E"
    };

    const notasValidas = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS",
      "11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B",
      "21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A",
      "31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G",
      "41GS","42A","43AS"
    ];

    const drumLines = [
      { id: "bumbo",           label: "Bumbo",   file: "bumbo.mp3" },
      { id: "caixa",           label: "Caixa",   file: "caixa.mp3" },
      { id: "caixaAro",        label: "Aro",     file: "caixaAro.mp3" },
      { id: "chimbal",         label: "HH",      file: "chimbal.mp3" },
      { id: "chimbal_pedal",   label: "HH Ped",  file: "chimbal-pedal.mp3" },
      { id: "chimbalaberto",   label: "HH Open", file: "chimbal-aberto.mp3" },
      { id: "ataque",          label: "Ataque",  file: "ataque.mp3" },
      { id: "tom1",            label: "Tom 1",   file: "tom-1.mp3" },
      { id: "tom2",            label: "Tom 2",   file: "tom-2.mp3" },
      { id: "surdo",           label: "Surdo",   file: "surdo.mp3" },
      { id: "conducao",        label: "Ride",    file: "conducao.mp3" },
      { id: "conducao_centro", label: "Ride C",  file: "conducao-centro.mp3" }
    ];

    // =========================================================
    // ESTADO GLOBAL
    // =========================================================
    let isPlaying = false;
    let playbackInterval = null;
    let bpmAtual = 120;
    let atualPasso = 0;
    
    let baixoSeq = Array(16).fill(""); 
    let bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));

    let baixoVolumeGlobal = 0.9;
    let bateriaVolumeGlobal = 0.9;
    let audioBaixoAtual = null;

    // Anima√ß√£o
    let posicaoAtualPasta = 1;
    let ultimaCordaUsada = "E";
    let ultimaNotaReal = "1E";
    let reqAnimIdPendulo = null;
    let headLoopTimer = null;
    let rightHandTimer = null;
    let headFrameIndex = 0;
    const headFrames = [];

    // √Åudio
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    const mediaStreamDestination = audioContext.createMediaStreamDestination();
    
    // Gravador
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;

    // =========================================================
    // INICIALIZA√á√ÉO
    // =========================================================
    window.onload = async () => {
        verificarOrientacao();
        window.addEventListener("resize", verificarOrientacao);
        
        for (let i = 1; i <= 100; i++) {
            headFrames.push(`animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`);
        }
        preloadImages(headFrames).then(startHeadLoop);

        gerarAleatorio();
        renderGrids();
        setupListeners();
    };

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recordVideoBtn").onclick = toggleRecording;
        
        document.getElementById("bpmSlider").oninput = (e) => {
            bpmAtual = parseInt(e.target.value);
            document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
        };

        document.getElementById("baixoVolume").oninput = (e) => baixoVolumeGlobal = parseFloat(e.target.value);
        document.getElementById("drumVolume").oninput = (e) => bateriaVolumeGlobal = parseFloat(e.target.value);

        // Bot√µes Grid
        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); renderGrids(); };
        document.getElementById("addCol").onclick = () => {
            baixoSeq.push("");
            Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x"));
            renderGrids();
        };
        document.getElementById("duplicateSeq").onclick = () => {
            baixoSeq = [...baixoSeq, ...baixoSeq];
            Object.keys(bateriaSeq).forEach(k => bateriaSeq[k] = [...bateriaSeq[k], ...bateriaSeq[k]]);
            renderGrids();
        };
        document.getElementById("clearAll").onclick = () => {
            baixoSeq.fill("");
            Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x"));
            renderGrids();
        };

        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio;
        document.getElementById("playExportadoBtn").onclick = importarJSON;
        document.getElementById("exportWavBtn").onclick = exportarWAV;
    }

    // =========================================================
    // FUN√á√ïES NOVAS: DELETAR COLUNA
    // =========================================================
    function deleteColumn(idx) {
        // Evitar deletar se s√≥ tiver 1 coluna (opcional, pode remover se quiser permitir zerar)
        if (baixoSeq.length <= 1) return;

        // Remove do baixo
        baixoSeq.splice(idx, 1);

        // Remove da bateria
        Object.keys(bateriaSeq).forEach(key => {
            if (bateriaSeq[key]) {
                bateriaSeq[key].splice(idx, 1);
            }
        });

        renderGrids();
    }

    // =========================================================
    // GRAVA√á√ÉO DE V√çDEO
    // =========================================================
    async function toggleRecording() {
        const btn = document.getElementById("recordVideoBtn");
        
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            btn.innerText = "üî¥ Gravar V√≠deo";
            btn.classList.remove("recording");
        } else {
            try {
                alert("Para gravar a anima√ß√£o em alta qualidade:\n\n1. Na janela que abrir, escolha a aba 'Guia do Chrome' (ou Atual).\n2. Selecione esta aba onde est√° o baixista.\n3. Certifique-se de que 'Compartilhar √°udio da guia' esteja marcado.");
                
                const videoStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        frameRate: 60,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false 
                });

                const videoTrack = videoStream.getVideoTracks()[0];
                const audioTrack = mediaStreamDestination.stream.getAudioTracks()[0];
                const combinedStream = new MediaStream([videoTrack, audioTrack]);

                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9' });
                recordedChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'baixista_jam.webm';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    videoTrack.stop();
                };

                mediaRecorder.start();
                isRecording = true;
                btn.innerText = "‚èπ Parar Grava√ß√£o";
                btn.classList.add("recording");

                if (!isPlaying) togglePlay();

                videoTrack.onended = () => {
                    if (isRecording) toggleRecording();
                };

            } catch (err) {
                console.error("Erro ao iniciar grava√ß√£o:", err);
                alert("N√£o foi poss√≠vel iniciar a grava√ß√£o. Verifique as permiss√µes.");
            }
        }
    }

    // =========================================================
    // PLAYBACK
    // =========================================================
    function togglePlay() {
        if (isPlaying) pararPlayback();
        else {
            const overlay = document.getElementById("countdownOverlay");
            const txt = document.getElementById("countdownText");
            overlay.style.display = "flex";
            let count = 4;
            txt.innerText = count;
            
            const countInt = setInterval(() => {
                count--;
                if(count > 0) {
                    txt.innerText = count;
                } else {
                    clearInterval(countInt);
                    overlay.style.display = "none";
                    iniciarPlayback();
                }
            }, 60000 / bpmAtual);
        }
    }

    function iniciarPlayback() {
        if (audioContext.state === 'suspended') audioContext.resume();
        
        isPlaying = true;
        atualPasso = 0;
        document.getElementById("playBtn").innerText = "‚è∏ Pause";
        document.getElementById("playBtn").style.background = "#e65100";

        startPenduloAnim();

        const msPorStep = (60000 / bpmAtual) / 4;
        
        const loop = () => {
            if (!isPlaying) return;
            
            const totalSteps = baixoSeq.length;
            if (atualPasso >= totalSteps) atualPasso = 0;

            highlightGridStep(atualPasso);
            
            // BAIXO
            const notaBaixo = baixoSeq[atualPasso];
            if (notaBaixo !== "") {
                if (notaBaixo === "x") {
                    tocarAudioBuffer("assets/bass-muted.mp3", baixoVolumeGlobal);
                    animarBaixo("x", msPorStep);
                } else {
                    tocarAudioBuffer(`assets/BaixoMelodia/${notaBaixo}.mp3`, baixoVolumeGlobal);
                    animarBaixo(notaBaixo, msPorStep);
                }
            } else {
                stopRightHand();
            }

            // BATERIA
            drumLines.forEach(line => {
                const seq = bateriaSeq[line.id];
                if (seq && seq[atualPasso] === line.id) {
                    tocarAudioBuffer(`assets/${line.file}`, bateriaVolumeGlobal);
                }
            });
            
            const pct = ((atualPasso + 1) / totalSteps) * 100;
            document.getElementById("progressBar").style.width = pct + "%";

            atualPasso++;
        };

        loop();
        playbackInterval = setInterval(loop, msPorStep);
    }

    function pararPlayback() {
        isPlaying = false;
        clearInterval(playbackInterval);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play";
        document.getElementById("playBtn").style.background = "";
        
        stopPenduloAnim();
        stopRightHand();
        
        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        
        if(audioBaixoAtual) {
            audioBaixoAtual.stop();
            audioBaixoAtual = null;
        }
    }

    async function getAudioBuffer(url) {
        if (audioBuffers[url]) return audioBuffers[url];
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        audioBuffers[url] = audioBuffer;
        return audioBuffer;
    }

    async function tocarAudioBuffer(path, vol) {
        try {
            const buffer = await getAudioBuffer(path);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            
            const gainNode = audioContext.createGain();
            gainNode.gain.value = Math.max(0, Math.min(1, vol));
            
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.connect(mediaStreamDestination);
            
            source.start();
            
            if (path.includes("BaixoMelodia") || path.includes("bass-muted")) {
                if(audioBaixoAtual) {
                    try { audioBaixoAtual.stop(); } catch(e){}
                }
                audioBaixoAtual = source;
            }
        } catch (e) {
            console.warn("Erro ao tocar √°udio:", path, e);
        }
    }

    // =========================================================
    // EXPORTA√á√ÉO WAV
    // =========================================================
    async function exportarWAV() {
        const btn = document.getElementById("exportWavBtn");
        const originalText = btn.innerText;
        btn.innerText = "Processando...";
        btn.disabled = true;

        try {
            const totalSteps = baixoSeq.length;
            const secondsPerStep = (60 / bpmAtual) / 4;
            const totalDuration = totalSteps * secondsPerStep + 2; 
            const sampleRate = 44100;

            const offlineCtx = new OfflineAudioContext(2, sampleRate * totalDuration, sampleRate);

            for (let i = 0; i < totalSteps; i++) {
                const nota = baixoSeq[i];
                if (nota !== "" && nota !== null) {
                    const startTime = i * secondsPerStep;
                    let url = nota === "x" ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${nota}.mp3`;
                    
                    const buffer = await getAudioBuffer(url);
                    const source = offlineCtx.createBufferSource();
                    source.buffer = buffer;
                    
                    const gainNode = offlineCtx.createGain();
                    gainNode.gain.value = baixoVolumeGlobal;
                    
                    source.connect(gainNode);
                    gainNode.connect(offlineCtx.destination);
                    
                    let durationSteps = 1;
                    for (let j = i + 1; j < totalSteps; j++) {
                        if (baixoSeq[j] !== "") break; 
                        durationSteps++;
                    }
                    const durationSeconds = durationSteps * secondsPerStep;
                    
                    source.start(startTime);
                    source.stop(startTime + durationSeconds);
                    gainNode.gain.setTargetAtTime(0, startTime + durationSeconds - 0.01, 0.01);
                }
            }

            for (const line of drumLines) {
                const seq = bateriaSeq[line.id];
                if (seq) {
                    for (let i = 0; i < totalSteps; i++) {
                        if (seq[i] === line.id) {
                            const time = i * secondsPerStep;
                            const buffer = await getAudioBuffer(`assets/${line.file}`);
                            const source = offlineCtx.createBufferSource();
                            source.buffer = buffer;
                            const gainNode = offlineCtx.createGain();
                            gainNode.gain.value = bateriaVolumeGlobal;
                            source.connect(gainNode);
                            gainNode.connect(offlineCtx.destination);
                            source.start(time);
                        }
                    }
                }
            }

            const renderedBuffer = await offlineCtx.startRendering();
            const wavBuffer = audioBufferToWav(renderedBuffer);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'minha-composicao.wav';
            a.click();
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error("Erro ao exportar WAV:", error);
            alert("Falha na exporta√ß√£o.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // =========================================================
    // ANIMA√á√ÉO
    // =========================================================
    function startPenduloAnim() {
        const wrapper = document.getElementById("bodyWrapperPendulo");
        const amplitude = 2.3;
        const speed = 0.003; 
        const frame = () => {
            if (!isPlaying) return;
            const now = Date.now();
            const ang = Math.sin(now * speed * (bpmAtual / 120)) * amplitude; 
            wrapper.style.transform = `rotate(${ang}deg)`;
            reqAnimIdPendulo = requestAnimationFrame(frame);
        };
        reqAnimIdPendulo = requestAnimationFrame(frame);
    }

    function stopPenduloAnim() {
        cancelAnimationFrame(reqAnimIdPendulo);
        const wrapper = document.getElementById("bodyWrapperPendulo");
        if(wrapper) wrapper.style.transform = "rotate(0deg)";
    }

    function startHeadLoop() {
        const el = document.getElementById("cabecaLayer");
        if(headLoopTimer) clearInterval(headLoopTimer);
        headLoopTimer = setInterval(() => {
            headFrameIndex = (headFrameIndex + 1) % headFrames.length;
            if(headFrames[headFrameIndex]) el.src = headFrames[headFrameIndex];
        }, 33);
    }

    function animarBaixo(nota, duracaoStep) {
        const tronco = document.getElementById("troncoBaixoLayer");
        const antebraco = document.getElementById("antebracoLayer");

        if (nota === "x") {
            if (ultimaNotaReal) {
                const pasta = pastaFolderNames[posicaoAtualPasta] || "1F";
                tronco.src = `animacao/tronco_baixo/Pasta_${pasta}/${ultimaNotaReal}.png`;
            }
            animarMaoDireita(ultimaCordaUsada, duracaoStep);
            return;
        }

        const novaPasta = escolherMelhorPasta(nota, posicaoAtualPasta);
        posicaoAtualPasta = novaPasta;
        ultimaNotaReal = nota;

        const pastaNome = pastaFolderNames[novaPasta];
        tronco.src = `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`;

        const corda = getCordaDaNota(nota);
        ultimaCordaUsada = corda;
        antebraco.src = `animacao/antebraco/antebraco${corda}.png`;

        animarMaoDireita(corda, duracaoStep);
    }

    function getCordaDaNota(nota) {
        const m = nota.match(/^(\d+)/);
        if (!m) return "E";
        const n = parseInt(m[1], 10);
        if (n <= 20) return "E";
        if (n <= 28) return "A";
        if (n <= 36) return "D";
        return "G";
    }

    function escolherMelhorPasta(nota, posAtual) {
        const pastasDisponiveis = [];
        for (let p = 1; p <= 24; p++) {
            if (pastaMap[p].includes(nota)) pastasDisponiveis.push(p);
        }
        if (pastasDisponiveis.length === 0) return 1;
        return pastasDisponiveis.reduce((prev, curr) => {
            return (Math.abs(curr - posAtual) < Math.abs(prev - posAtual) ? curr : prev);
        });
    }

    function animarMaoDireita(corda, duracaoTotal) {
        const el = document.getElementById("bracoDireitoLayer");
        clearInterval(rightHandTimer);
        
        let frame = 1;
        const totalFrames = 5;
        const frameTime = Math.min(duracaoTotal / totalFrames, 40); 

        rightHandTimer = setInterval(() => {
            el.src = `animacao/braco_direito/Corda_${corda}${frame}.png`;
            frame++;
            if (frame > totalFrames) {
                clearInterval(rightHandTimer);
                el.src = `animacao/braco_direito/Corda_${corda}1.png`;
            }
        }, frameTime);
    }

    function stopRightHand() {
        const el = document.getElementById("bracoDireitoLayer");
        clearInterval(rightHandTimer);
        el.src = `animacao/braco_direito/Corda_${ultimaCordaUsada || 'E'}1.png`;
    }

    // =========================================================
    // GRIDS & UTIL
    // =========================================================
    function renderGrids() {
        const deleteContainer = document.getElementById("deleteGrid");
        const baixoContainer = document.getElementById("baixoGrid");
        const drumWrapper = document.getElementById("drumGridWrapper");

        // 0. Bot√µes de Deletar
        deleteContainer.innerHTML = "";
        baixoSeq.forEach((_, idx) => {
            const btn = document.createElement("button");
            btn.className = "delete-btn";
            btn.innerText = "√ó";
            btn.title = "Apagar coluna";
            btn.onclick = () => deleteColumn(idx);
            deleteContainer.appendChild(btn);
        });

        // 1. Baixo Grid
        baixoContainer.innerHTML = "";
        baixoSeq.forEach((nota, idx) => {
            const cell = document.createElement("div");
            cell.className = "cell";
            
            if (nota === "x") {
                cell.textContent = "X";
                cell.classList.add("active-ghost");
            } else if (nota !== "") {
                cell.textContent = nota.replace("S", "#");
                cell.classList.add("active");
            } else {
                cell.style.opacity = "0.3";
            }
            cell.onclick = () => abrirSelecaoNota(idx, cell);
            baixoContainer.appendChild(cell);
        });

        // 2. Bateria Grid
        drumWrapper.innerHTML = "";
        drumLines.forEach(line => {
            const row = document.createElement("div");
            row.className = "rowContainer";
            
            const label = document.createElement("div");
            label.className = "gridLabel";
            label.textContent = line.label;
            row.appendChild(label);

            const grid = document.createElement("div");
            grid.className = "trackGrid";
            
            while(bateriaSeq[line.id].length < baixoSeq.length) bateriaSeq[line.id].push("x");

            bateriaSeq[line.id].forEach((val, idx) => {
                const cell = document.createElement("div");
                cell.className = "cell";
                if (val === line.id) cell.classList.add("active");
                else cell.textContent = "";

                cell.onclick = () => {
                    if (bateriaSeq[line.id][idx] === "x") {
                        bateriaSeq[line.id][idx] = line.id;
                        cell.classList.add("active");
                        tocarAudioBuffer(`assets/${line.file}`, 1.0);
                    } else {
                        bateriaSeq[line.id][idx] = "x";
                        cell.classList.remove("active");
                    }
                };
                grid.appendChild(cell);
            });
            row.appendChild(grid);
            drumWrapper.appendChild(row);
        });
    }

    function highlightGridStep(step) {
        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        
        // Highlight no bot√£o delete tbm se quiser, mas aqui s√≥ nas notas
        const baixoCells = document.getElementById("baixoGrid").children;
        if(baixoCells[step]) baixoCells[step].classList.add("playing-step");
        
        const drumRows = document.querySelectorAll("#drumGridWrapper .trackGrid");
        drumRows.forEach(row => {
            if(row.children[step]) row.children[step].classList.add("playing-step");
        });

        if(baixoCells[step]) {
             baixoCells[step].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    function abrirSelecaoNota(idx, cellElement) {
        const overlay = document.getElementById("selectionOverlay");
        const optionsContainer = document.getElementById("selectionOptions");
        optionsContainer.innerHTML = "";

        const btnEmpty = document.createElement("div");
        btnEmpty.className = "selection-option";
        btnEmpty.textContent = "‚Äî";
        btnEmpty.onclick = () => selecionarNota(idx, "", overlay);
        optionsContainer.appendChild(btnEmpty);

        const btnGhost = document.createElement("div");
        btnGhost.className = "selection-option ghost";
        btnGhost.textContent = "X";
        btnGhost.onclick = () => selecionarNota(idx, "x", overlay);
        optionsContainer.appendChild(btnGhost);

        notasValidas.forEach(nota => {
            const btn = document.createElement("div");
            btn.className = "selection-option";
            btn.textContent = nota.replace("S", "#");
            if(nota === baixoSeq[idx]) btn.classList.add("active");
            
            btn.onclick = () => {
                selecionarNota(idx, nota, overlay);
                tocarAudioBuffer(`assets/BaixoMelodia/${nota}.mp3`, 1.0);
            };
            optionsContainer.appendChild(btn);
        });
        overlay.classList.add("visible");
        overlay.onclick = (e) => { if(e.target === overlay) overlay.classList.remove("visible"); };
    }

    function selecionarNota(idx, valor, overlay) {
        baixoSeq[idx] = valor;
        overlay.classList.remove("visible");
        renderGrids();
    }

    function gerarAleatorio() {
        if (window.JamOnEngine && typeof JamOnEngine.generateRandomPlayback === "function") {
            try {
                const res = JamOnEngine.generateRandomPlayback(bpmAtual, 16);
                baixoSeq = res.bassSeq || Array(16).fill("");
                const bat = res.bateriaSeq || {};
                drumLines.forEach(d => {
                     bateriaSeq[d.id] = bat[d.id] || Array(16).fill("x");
                });
            } catch(e) { fallbackAleatorio(); }
        } else { fallbackAleatorio(); }
        renderGrids();
    }

    function fallbackAleatorio() {
        baixoSeq = Array(16).fill(0).map(() => {
            const r = Math.random();
            if(r < 0.5) return "";
            if(r < 0.6) return "x";
            return notasValidas[Math.floor(Math.random() * notasValidas.length)];
        });
        drumLines.forEach(d => {
            bateriaSeq[d.id] = Array(16).fill(0).map(() => Math.random() < 0.2 ? d.id : "x");
        });
    }

    function importarJSON() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = JSON.parse(evt.target.result);
                    if(data.baixo) baixoSeq = data.baixo;
                    if(data.bateria) bateriaSeq = data.bateria;
                    if(data.bpm) {
                        bpmAtual = data.bpm;
                        document.getElementById("bpmSlider").value = bpmAtual;
                        document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
                    }
                    renderGrids();
                } catch(err) { alert("JSON Inv√°lido"); }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function verificarOrientacao() {
        const overlay = document.getElementById("orientationOverlay");
        if (window.innerWidth < window.innerHeight && window.innerWidth < 900) {
            overlay.style.display = "flex";
        } else {
            overlay.style.display = "none";
        }
    }

    function preloadImages(srcArray) {
        const promises = srcArray.map(src => new Promise(r => {
            const img = new Image();
            img.onload = img.onerror = r;
            img.src = src;
        }));
        return Promise.all(promises);
    }
  </script>
</body>
</html>
