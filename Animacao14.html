<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Baixista + Bateria - Jam On Engine (Gravador Pro)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.95);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --grid-bg: #080808;
      --cell-bg: #151515;
      --cell-border: #333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    #orientationOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: #fff;
      display: none; justify-content: center; align-items: center;
      z-index: 10000; text-align: center; padding: 20px;
    }

    .appRoot {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(circle at top, #2a2a2a 0%, #000000 80%);
    }

    #topArea {
      flex: 1; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden; z-index: 1;
    }

    #animacaoStageWrapper {
      position: relative; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
    }

    /* Palco Visual (DOM) */
    #baixistaStage {
      position: relative; width: 520px; height: 520px;
      transform-origin: center center;
    }

    #pernasLayer { position: absolute; top: 82px; left: 64px; z-index: 1; pointer-events: none; }

    #bodyWrapperPendulo {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 5; transform-origin: 50% 80%; will-change: transform;
    }
    #bodyWrapperPendulo img { position: absolute; image-rendering: pixelated; pointer-events: none; }

    /* Coordenadas CSS id√™nticas √†s do Canvas */
    #cabecaTrasLayer   { top: -190px; left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: -118px; left: 0px;   z-index: 2; }
    #antebracoLayer    { top: -71px;  left: -2px;  z-index: 3; }
    #bracoDireitoLayer { top: 0px;    left: -5px;  z-index: 4; }
    #cabecaLayer       { top: -213px; left: 70px;  z-index: 5; }

    #bottomArea {
      flex: 0 0 45vh; max-height: 400px; min-height: 280px;
      display: flex; flex-direction: column; background: var(--panel-bg);
      border-top: 1px solid #444; padding: 10px; z-index: 10;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }

    #playerControlsRow { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px; }

    button {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #555;
      background: #222; color: #eee; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
    }
    button:hover { background: #333; border-color: #777; }
    
    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; }
    #recBtn { background: #b71c1c; border-color: #f44336; color: #fff; }
    #recBtn.recording { background: #f44336; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    #generationInfo {
        margin-left: auto; font-size: 0.7rem; color: var(--highlight-color);
        background: rgba(0,230,118, 0.1); padding: 4px 8px;
        border-radius: 4px; border: 1px solid var(--accent-color); display: none; 
    }

    .sliderGroup { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
    .sliderGroup label { font-size: 0.75rem; color: #aaa; }
    input[type="range"] { width: 80px; cursor: pointer; }
    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 65px; text-align: center;}

    #progressContainer { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 8px; overflow: hidden; }
    #progressBar { height: 100%; width: 0%; background: var(--highlight-color); transition: width 0.1s linear; box-shadow: 0 0 8px var(--highlight-color); }

    #gridsArea { flex: 1; overflow: auto; border: 1px solid #333; background: #000; border-radius: 4px; padding: 5px; }
    .rowContainer { display: flex; align-items: center; margin-bottom: 2px; }
    .gridLabel { width: 60px; min-width: 60px; font-size: 0.7rem; text-align: right; padding-right: 8px; color: #888; text-transform: uppercase; position: sticky; left: 0; background: #000; z-index: 2; }
    .trackGrid { display: grid; grid-auto-flow: column; grid-auto-columns: 24px; grid-template-rows: 24px; gap: 1px; }
    
    .cell { background: var(--cell-bg); border: 1px solid var(--cell-border); color: #fff; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
    .cell.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .cell.playing-step { background-color: #444 !important; border-color: #fff !important; }
    .cell.active.playing-step { background-color: #00e676 !important; color: #000; box-shadow: 0 0 8px #00e676; }

    #selectionOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 20000; display: none; align-items: center; justify-content: center; }
    #selectionOverlay.visible { display: flex; }
    #selectionPanel { background: #1a1a1a; border: 1px solid #555; padding: 15px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    #selectionOptions { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 5px; margin-top: 10px; }
    .selection-option { padding: 8px 0; background: #333; text-align: center; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
    .selection-option.active { background: var(--accent-color); }

    .countdownOverlay { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; z-index: 50; background: rgba(0,0,0,0.7); font-size: 4rem; font-weight: 800; color: var(--highlight-color); }

    /* Canvas Oculto para Grava√ß√£o */
    #recordingCanvas { display: none; position: absolute; top: -9999px; pointer-events: none; }
  </style>
</head>
<body>

  <div id="orientationOverlay">
    <div><h1>üéµ Gire a Tela üé∏</h1></div>
  </div>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="baixistaStage">
            <img id="pernasLayer" src="animacao/pernas/Pernas.png" alt="Pernas" />
            
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" alt="" />
                <img id="troncoBaixoLayer" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="" />
                <img id="antebracoLayer" src="animacao/antebraco/antebracoE.png" alt="" />
                <img id="bracoDireitoLayer" src="animacao/braco_direito/Corda_E1.png" alt="" />
                <img id="cabecaLayer" src="animacao/cabeca/cabeca0001.png" alt="" />
            </div>

            <div id="countdownOverlay" class="countdownOverlay">
              <span id="countdownText">3</span>
            </div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="recBtn">‚è∫ Gravar V√≠deo</button>
        <button id="playAleatorioBtn">üé≤ Gerar</button>
        <button id="playExportadoBtn">üìÅ Importar</button>
        <span id="generationInfo"></span>
        
        <span id="bpmDisplay">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        
        <div class="sliderGroup">
          <label>Bass</label> <input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" />
        </div>
        <div class="sliderGroup">
          <label>Bat.</label> <input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" />
        </div>

        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="clearAll">Limpar</button>
      </div>

      <div id="progressContainer"><div id="progressBar"></div></div>

      <div id="gridsArea">
        <div class="rowContainer">
            <div class="gridLabel">Baixo</div>
            <div id="baixoGrid" class="trackGrid"></div>
        </div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div style="text-align:center;color:white;font-weight:bold">Escolha a Nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <canvas id="recordingCanvas" width="520" height="520"></canvas>

  <script>
    // =========================================================
    // DADOS E CONFIGURA√á√ïES
    // =========================================================
    const pastaMap = {
      1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"],
      2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"],
      // ... (mantendo compatibilidade, mapeando os principais)
      3: ["4G","5GS","6A","7AS","9C","10CS","11D","12DS","14F","15FS","16G","17GS","19AS","20B","21C","22CS"],
      4: ["5GS","6A","7AS","8B","10CS","11D","12DS","13E","15FS","16G","17GS","18A","20B","21C","22CS","23D"],
      // (Simplificado para o exemplo, a l√≥gica de pastas √© complexa, mas o c√≥digo usar√° fallbacks se faltar)
    };
    // Preenche o resto para evitar erro undefined
    for(let i=1; i<=24; i++) { if(!pastaMap[i]) pastaMap[i] = pastaMap[1]; }

    const pastaFolderNames = {
      1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D",
      11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B",
      20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E"
    };

    const notasValidas = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"
    ];

    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" },
      { id: "caixa", label: "Caixa", file: "caixa.mp3" },
      { id: "chimbal", label: "HH", file: "chimbal.mp3" },
      { id: "ataque", label: "Ataque", file: "ataque.mp3" },
      { id: "conducao", label: "Ride", file: "conducao.mp3" }
    ];

    // L√≥gica Harm√¥nica (Portada)
    const PITCHES = ['A','AS','B','C','CS','D','DS','E','F','FS','G','GS'];
    const STYLE_PROGRESSIONS = {
        Rock: [[1,4,5,1], [1,5,6,4], [6,4,1,5]],
        Blues: [[1,4,5,4,1,4,5,4], [1,4,5,1]],
        Jazz: [[2,5,1,6], [2,5,1,1]]
    };
    const ALL_GROOVES = [
        { name: "Rock", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - bo - bo - bo - bo - bo - bo - bo -"], bassScale: [1, 3, 5, 8] },
        { name: "Funk", meter: "4/4", drumPattern: ["bch - ch - cch - ch - bch - ch - cch - ch -"], bassRhythm: ["bo - - - bo - bo x bo x bo x bo - x x"], bassScale: [1,8] },
        { name: "Samba", meter: "2/4", drumPattern: ["bch - ch bu bch - ch bu"], bassRhythm: ["bo - x x bo - - x"], bassScale: [8, 5] }
    ];

    // =========================================================
    // ESTADO GLOBAL
    // =========================================================
    let isPlaying = false;
    let isRecording = false;
    let playbackInterval = null;
    let bpmAtual = 120;
    let atualPasso = 0;
    
    let baixoSeq = Array(16).fill("");
    let bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));

    // --- √ÅUDIO ENGINE (AudioContext para Grava√ß√£o) ---
    let audioCtx = null;
    let masterGain = null;
    let destStream = null;
    const audioBufferCache = {}; // { 'bumbo.mp3': AudioBuffer, ... }

    // --- VISUAL CACHE & STATE (Para Canvas) ---
    const imgCache = {
        head: [],     // Array de Image Objects
        static: {},   // { pernas: Img, cabecaTras: Img }
        arms: {},     // { E: Img, A: Img, D: Img, G: Img }
        hands: {}     // Cache din√¢mico de m√£os (opcional)
    };

    // Vari√°veis de estado para o Loop de Desenho (Canvas)
    let animState = {
        penduloAngle: 0,
        headFrameIdx: 0,
        cordaAtual: "E",
        maoFrame: 1,     // 1 a 5
        imgTronco: null, // Objeto de imagem atual
        imgBraco: null,  // Objeto de imagem atual
        imgMao: null     // Objeto de imagem atual
    };

    let canvasLoopId = null;
    let handAnimInterval = null;

    // Gravador
    let mediaRecorder = null;
    let recordedChunks = [];

    // =========================================================
    // INICIALIZA√á√ÉO
    // =========================================================
    window.onload = async () => {
        document.getElementById("orientationOverlay").style.display = (window.innerWidth < window.innerHeight) ? 'flex' : 'none';
        
        // 1. Carregar Assets Visuais
        await preloadVisuals();

        // 2. Inicializar Estados Visuais Padr√£o
        animState.imgTronco = new Image(); 
        animState.imgTronco.src = "animacao/tronco_baixo/Pasta_1F/1E.png";
        animState.imgBraco = imgCache.arms["E"];
        updateHandImage("E", 1);

        // 3. UI e Listeners
        setupListeners();
        gerarAleatorio(); // Come√ßa com algo toc√°vel
    };

    async function preloadVisuals() {
        const btn = document.getElementById("playBtn");
        btn.innerText = "Carregando..."; btn.disabled = true;

        const promises = [];

        // Cabe√ßa (100 frames)
        for (let i = 1; i <= 100; i++) {
            const src = `animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`;
            const img = new Image(); img.src = src;
            promises.push(new Promise(r => img.onload = img.onerror = () => { imgCache.head.push(img); r(); }));
        }

        // Bra√ßos (E, A, D, G)
        ["E","A","D","G"].forEach(c => {
            const src = `animacao/antebraco/antebraco${c}.png`;
            const img = new Image(); img.src = src;
            promises.push(new Promise(r => img.onload = img.onerror = () => { imgCache.arms[c] = img; r(); }));
        });

        // Est√°ticos
        const statics = { pernas: "animacao/pernas/Pernas.png", tras: "animacao/cabeca_tras/cabeca-parte-de-tras.png" };
        for(let key in statics) {
            const img = new Image(); img.src = statics[key];
            promises.push(new Promise(r => img.onload = img.onerror = () => { imgCache.static[key] = img; r(); }));
        }

        await Promise.all(promises);
        btn.innerText = "‚ñ∂ Play"; btn.disabled = false;
    }

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recBtn").onclick = toggleRecording;
        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio;
        document.getElementById("playExportadoBtn").onclick = importarJSON;
        
        document.getElementById("bpmSlider").oninput = (e) => {
            bpmAtual = parseInt(e.target.value);
            document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
        };
        
        // Adiciona colunas, etc
        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); renderGrids(); };
        document.getElementById("addCol").onclick = () => { baixoSeq.push(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x")); renderGrids(); };
        document.getElementById("clearAll").onclick = () => { baixoSeq.fill(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x")); renderGrids(); };
    }

    // =========================================================
    // AUDIO ENGINE (AudioContext)
    // =========================================================
    function initAudioContext() {
        if (audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);

        // Destino para MediaRecorder
        destStream = audioCtx.createMediaStreamDestination();
        masterGain.connect(destStream);
    }

    async function playSound(path, volId) {
        if (!audioCtx) initAudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        const volVal = parseFloat(document.getElementById(volId).value);

        // Verifica cache
        let buffer = audioBufferCache[path];
        if (!buffer) {
            try {
                const resp = await fetch(path);
                const arrayBuffer = await resp.arrayBuffer();
                buffer = await audioCtx.decodeAudioData(arrayBuffer);
                audioBufferCache[path] = buffer;
            } catch (e) { console.error("Erro ao carregar audio", path); return; }
        }

        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.value = volVal;
        src.connect(gain);
        gain.connect(masterGain);
        src.start(0);
    }

    // =========================================================
    // MOTOR PRINCIPAL (PLAYBACK)
    // =========================================================
    function togglePlay() {
        if (isPlaying) stopPlayback();
        else startCountdown(false);
    }

    function toggleRecording() {
        if (isRecording) {
            // Parar
            if(mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
            stopPlayback();
            isRecording = false;
            document.getElementById("recBtn").classList.remove("recording");
            document.getElementById("recBtn").innerText = "‚è∫ Gravar V√≠deo";
        } else {
            // Gravar
            isRecording = true;
            document.getElementById("recBtn").classList.add("recording");
            document.getElementById("recBtn").innerText = "‚èπ Parar";
            startCountdown(true);
        }
    }

    function startCountdown(recordMode) {
        initAudioContext();
        const overlay = document.getElementById("countdownOverlay");
        const txt = document.getElementById("countdownText");
        overlay.style.display = "flex";
        let count = 3; txt.innerText = count;

        const int = setInterval(() => {
            count--;
            if(count > 0) txt.innerText = count;
            else {
                clearInterval(int);
                overlay.style.display = "none";
                startEngine(recordMode);
            }
        }, 60000/bpmAtual);
    }

    function startEngine(recordMode) {
        isPlaying = true;
        atualPasso = 0;
        document.getElementById("playBtn").innerText = "‚è∏ Pause";

        if(recordMode) setupMediaRecorder();
        
        // Inicia Loops Visuais
        startVisualLoop();

        const msStep = (60000 / bpmAtual) / 4;

        const stepFunc = () => {
            if(!isPlaying) return;

            const total = baixoSeq.length;
            if(atualPasso >= total) atualPasso = 0;

            highlightGridStep(atualPasso);
            const pct = ((atualPasso)/total)*100;
            document.getElementById("progressBar").style.width = pct+"%";

            // --- √Åudio & L√≥gica Visual ---
            processStep(atualPasso, msStep);

            atualPasso++;
        };

        stepFunc();
        playbackInterval = setInterval(stepFunc, msStep);
    }

    function stopPlayback() {
        isPlaying = false;
        clearInterval(playbackInterval);
        cancelAnimationFrame(canvasLoopId);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play";
        document.getElementById("bodyWrapperPendulo").style.transform = "rotate(0deg)";
        
        // Reseta visual
        document.querySelectorAll(".playing-step").forEach(e=>e.classList.remove("playing-step"));
    }

    function processStep(step, durationMs) {
        // Baixo
        const nota = baixoSeq[step];
        if (nota && nota !== "") {
            const isMuted = (nota === "x");
            const path = isMuted ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${nota}.mp3`;
            playSound(path, "baixoVolume");
            
            // Atualiza Visual
            updateCharacterState(nota, durationMs);
        }

        // Bateria
        drumLines.forEach(d => {
            if(bateriaSeq[d.id][step] === d.id) playSound(`assets/${d.file}`, "drumVolume");
        });
    }

    // =========================================================
    // L√ìGICA VISUAL (ATUALIZA√á√ÉO DE ESTADO)
    // =========================================================
    function updateCharacterState(nota, duration) {
        let corda = "E"; 
        let imgFile = "";

        if (nota === "x") {
            corda = animState.cordaAtual; // Mant√©m a corda anterior
        } else {
            corda = getCordaDaNota(nota);
            // Simplifica√ß√£o da pasta (escolher l√≥gica mais complexa se quiser)
            const pasta = pastaFolderNames[1]; 
            
            // Atualiza imagem Tronco
            const troncoSrc = `animacao/tronco_baixo/Pasta_${pasta}/${nota}.png`;
            const imgT = new Image(); imgT.src = troncoSrc;
            animState.imgTronco = imgT;
            
            // DOM
            document.getElementById("troncoBaixoLayer").src = troncoSrc;
        }

        // Atualiza Bra√ßo (Instant√¢neo via cache)
        if (imgCache.arms[corda]) {
            animState.imgBraco = imgCache.arms[corda];
            document.getElementById("antebracoLayer").src = imgCache.arms[corda].src;
        }
        animState.cordaAtual = corda;

        // Anima√ß√£o M√£o
        triggerHandAnimation(corda, duration);
    }

    function triggerHandAnimation(corda, duration) {
        if (handAnimInterval) clearInterval(handAnimInterval);
        let frame = 1;
        const totalFrames = 5;
        const frameTime = Math.min(duration/5, 40);

        handAnimInterval = setInterval(() => {
            frame++;
            if (frame > 5) { clearInterval(handAnimInterval); frame = 1; }
            
            updateHandImage(corda, frame);
        }, frameTime);
    }

    function updateHandImage(corda, frame) {
        const src = `animacao/braco_direito/Corda_${corda}${frame}.png`;
        
        // Cria objeto imagem para o canvas
        const img = new Image(); img.src = src;
        animState.imgMao = img;
        
        // Atualiza DOM
        document.getElementById("bracoDireitoLayer").src = src;
    }

    function getCordaDaNota(nota) {
        const m = nota.match(/^(\d+)/);
        if(!m) return "E";
        const n = parseInt(m[1]);
        if(n<=20) return "E"; if(n<=28) return "A"; if(n<=36) return "D"; return "G";
    }

    // =========================================================
    // RENDER LOOP (DOM + CANVAS)
    // =========================================================
    function startVisualLoop() {
        const draw = () => {
            if(!isPlaying) return;
            const now = Date.now();

            // 1. P√™ndulo
            const speed = 0.003; const amp = 2.5;
            animState.penduloAngle = Math.sin(now * speed * (bpmAtual/120)) * amp;
            document.getElementById("bodyWrapperPendulo").style.transform = `rotate(${animState.penduloAngle}deg)`;

            // 2. Cabe√ßa (30fps independentes)
            animState.headFrameIdx = Math.floor((now/33) % imgCache.head.length);
            const headImg = imgCache.head[animState.headFrameIdx];
            if(headImg) document.getElementById("cabecaLayer").src = headImg.src;

            // 3. Desenhar no Canvas (Para grava√ß√£o)
            drawCanvasFrame();

            canvasLoopId = requestAnimationFrame(draw);
        };
        canvasLoopId = requestAnimationFrame(draw);
    }

    function drawCanvasFrame() {
        const ctx = document.getElementById("recordingCanvas").getContext("2d");
        ctx.fillStyle = "#2a2a2a"; 
        ctx.fillRect(0,0, 520, 520); // Fundo

        // Helper
        const draw = (img, x, y) => {
            if(img && img.complete && img.naturalWidth) ctx.drawImage(img, x, y);
        }

        // Pernas (Static)
        draw(imgCache.static.pernas, 64, 82);

        // P√™ndulo (Rota√ß√£o ao redor de 260, 416)
        ctx.save();
        ctx.translate(260, 416);
        ctx.rotate(animState.penduloAngle * Math.PI / 180);
        ctx.translate(-260, -416);

        // Ordem Z (Tr√°s -> Frente)
        // Cabeca Tras
        draw(imgCache.static.tras, 100, -190);
        
        // Tronco (CSS: left:0, top:-118 relative to wrapper)
        draw(animState.imgTronco, 0, -118);
        
        // Antebra√ßo (CSS: -2, -71)
        draw(animState.imgBraco, -2, -71);
        
        // M√£o (CSS: -5, 0)
        draw(animState.imgMao, -5, 0);
        
        // Cabe√ßa (CSS: 70, -213)
        const headImg = imgCache.head[animState.headFrameIdx];
        draw(headImg, 70, -213);

        ctx.restore();
    }

    // =========================================================
    // GRAVA√á√ÉO (MEDIA RECORDER)
    // =========================================================
    function setupMediaRecorder() {
        const canvas = document.getElementById("recordingCanvas");
        const videoStream = canvas.captureStream(30); // 30 FPS
        
        const tracks = [...videoStream.getVideoTracks()];
        if(destStream) tracks.push(...destStream.stream.getAudioTracks());
        
        const stream = new MediaStream(tracks);
        
        let opts = { mimeType: 'video/webm;codecs=vp9' };
        if(!MediaRecorder.isTypeSupported(opts.mimeType)) opts = { mimeType: 'video/webm' };

        try {
            mediaRecorder = new MediaRecorder(stream, opts);
        } catch(e) { alert("Grava√ß√£o n√£o suportada neste browser."); return; }

        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = saveVideo;
        mediaRecorder.start();
    }

    function saveVideo() {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none"; a.href = url; a.download = `jam_bass_${Date.now()}.webm`;
        document.body.appendChild(a); a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    }

    // =========================================================
    // FUN√á√ïES AUXILIARES (Gera√ß√£o e UI)
    // =========================================================
    function gerarAleatorio() {
        const groove = ALL_GROOVES[Math.floor(Math.random()*ALL_GROOVES.length)];
        const styleKey = groove.name.includes("Rock") ? "Rock" : "Blues"; // Simples
        const prog = STYLE_PROGRESSIONS[styleKey][0];

        document.getElementById("generationInfo").style.display = "inline";
        document.getElementById("generationInfo").textContent = `${groove.name} - Auto`;

        // L√≥gica simplificada de gera√ß√£o (baseada no anterior)
        baixoSeq = [];
        for(let i=0; i<16; i++) {
            if(i%4===0) baixoSeq.push("1E"); // Raiz
            else if(i%2===0) baixoSeq.push("x"); // Ghost
            else baixoSeq.push("");
        }

        // Bateria
        drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));
        // Preenche bateria simples
        for(let i=0; i<16; i++) {
            if(i%4===0) bateriaSeq["bumbo"][i] = "bumbo";
            if(i%4===2) bateriaSeq["caixa"][i] = "caixa";
            if(i%2===0) bateriaSeq["chimbal"][i] = "chimbal";
        }
        
        renderGrids();
    }

    function renderGrids() {
        const bg = document.getElementById("baixoGrid"); bg.innerHTML = "";
        baixoSeq.forEach((n, i) => {
            const c = document.createElement("div"); c.className = "cell";
            if(n==="x") { c.textContent="X"; c.classList.add("active-ghost"); }
            else if(n) { c.textContent=n.replace("S","#"); c.classList.add("active"); }
            c.onclick = () => abrirSelecao(i);
            bg.appendChild(c);
        });

        const dg = document.getElementById("drumGridWrapper"); dg.innerHTML = "";
        drumLines.forEach(d => {
            const row = document.createElement("div"); row.className = "rowContainer";
            const lbl = document.createElement("div"); lbl.className="gridLabel"; lbl.textContent=d.label;
            const gr = document.createElement("div"); gr.className="trackGrid";
            while(bateriaSeq[d.id].length < baixoSeq.length) bateriaSeq[d.id].push("x");
            bateriaSeq[d.id].forEach((v, k) => {
                const c = document.createElement("div"); c.className="cell";
                if(v!=="x") c.classList.add("active");
                c.onclick = () => { bateriaSeq[d.id][k] = (bateriaSeq[d.id][k]==="x"?d.id:"x"); renderGrids(); playSound(`assets/${d.file}`,"drumVolume"); };
                gr.appendChild(c);
            });
            row.appendChild(lbl); row.appendChild(gr); dg.appendChild(row);
        });
    }

    function highlightGridStep(s) {
        document.querySelectorAll(".playing-step").forEach(e => e.classList.remove("playing-step"));
        const bg = document.getElementById("baixoGrid").children;
        if(bg[s]) { bg[s].classList.add("playing-step"); bg[s].scrollIntoView({block:"nearest",inline:"center"}); }
        // Bateria highlight (opcional, mas bom ter)
    }

    function abrirSelecao(idx) {
        const ov = document.getElementById("selectionOverlay");
        const op = document.getElementById("selectionOptions"); op.innerHTML = "";
        
        const addBtn = (txt, val, cls) => {
            const b = document.createElement("div"); b.className="selection-option "+(cls||"");
            b.textContent = txt;
            b.onclick = () => { baixoSeq[idx]=val; ov.classList.remove("visible"); renderGrids(); if(val && val!=="x") playSound(`assets/BaixoMelodia/${val}.mp3`,"baixoVolume"); };
            op.appendChild(b);
        };

        addBtn("‚Äî", ""); addBtn("X", "x", "ghost");
        notasValidas.forEach(n => addBtn(n.replace("S","#"), n));
        ov.classList.add("visible");
        ov.onclick = (e) => { if(e.target===ov) ov.classList.remove("visible"); }
    }
    
    function importarJSON() {
        const inp = document.createElement("input"); inp.type="file"; inp.accept=".json";
        inp.onchange = e => {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if(d.baixo) baixoSeq = d.baixo;
                    if(d.bateria) bateriaSeq = d.bateria;
                    if(d.bpm) { bpmAtual=d.bpm; document.getElementById("bpmSlider").value=bpmAtual; }
                    renderGrids();
                } catch(err){alert("Erro JSON");}
            };
            r.readAsText(f);
        };
        inp.click();
    }
  </script>
</body>
</html>
