<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Baixista + Bateria - Jam On Engine Integrada (Gravador Corrigido)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root {
      --bg-color: #111;
      --panel-bg: rgba(10, 10, 10, 0.95);
      --highlight-color: #00e676;
      --accent-color: #2e7d32;
      --grid-bg: #080808;
      --cell-bg: #151515;
      --cell-border: #333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: #000;
      color: #f5f5f5;
      overflow: hidden;
    }

    #orientationOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.95); color: #fff;
      display: none; justify-content: center; align-items: center;
      z-index: 10000; text-align: center; padding: 20px;
    }

    .appRoot {
      width: 100vw; height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(circle at top, #2a2a2a 0%, #000000 80%);
    }

    #topArea {
      flex: 1; display: flex; align-items: center; justify-content: center;
      position: relative; overflow: hidden; z-index: 1;
    }

    /* O Stage visual continua existindo para o usu√°rio ver, mas o v√≠deo √© gravado de um canvas oculto */
    #animacaoStageWrapper {
      position: relative; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
    }

    #baixistaStage {
      position: relative; width: 520px; height: 520px;
      transform-origin: center center;
    }

    /* Classes para manipula√ß√£o JS */
    .actor-part { position: absolute; pointer-events: none; image-rendering: pixelated; }

    /* Posicionamento via CSS para o preview na tela (O Canvas usa coordenadas internas) */
    #pernasLayer       { top: 82px; left: 64px; z-index: 1; }
    #bodyWrapperPendulo {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 5; transform-origin: 50% 80%; will-change: transform;
    }
    #cabecaTrasLayer   { top: -190px; left: 100px; z-index: 1; }
    #troncoBaixoLayer  { top: -118px; left: 0px;   z-index: 2; }
    #antebracoLayer    { top: -71px;  left: -2px;  z-index: 3; }
    #bracoDireitoLayer { top: 0px;    left: -5px;  z-index: 4; }
    #cabecaLayer       { top: -213px; left: 70px;  z-index: 5; }

    #bottomArea {
      flex: 0 0 45vh; max-height: 400px; min-height: 280px;
      display: flex; flex-direction: column;
      background: var(--panel-bg); border-top: 1px solid #444;
      padding: 10px; z-index: 10; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }

    #playerControlsRow { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px; }

    button {
      padding: 6px 12px; border-radius: 4px; border: 1px solid #555;
      background: #222; color: #eee; font-size: 0.8rem; cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { background: #333; border-color: #777; }
    
    #playBtn { background: var(--accent-color); border-color: var(--highlight-color); font-weight: bold; }
    #recBtn { background: #b71c1c; border-color: #f44336; color: #fff; }
    #recBtn.recording { background: #f44336; animation: pulse 1s infinite; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    .sliderGroup { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
    input[type="range"] { width: 80px; cursor: pointer; }
    #bpmDisplay { font-family: monospace; font-weight: bold; min-width: 65px; text-align: center;}

    #progressContainer { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 8px; overflow: hidden; }
    #progressBar { height: 100%; width: 0%; background: var(--highlight-color); transition: width 0.1s linear; }

    #gridsArea { flex: 1; overflow: auto; border: 1px solid #333; background: #000; border-radius: 4px; padding: 5px; }
    .rowContainer { display: flex; align-items: center; margin-bottom: 2px; }
    .gridLabel { width: 60px; min-width: 60px; font-size: 0.7rem; text-align: right; padding-right: 8px; color: #888; position: sticky; left: 0; background: #000; z-index: 2; }
    .trackGrid { display: grid; grid-auto-flow: column; grid-auto-columns: 24px; grid-template-rows: 24px; gap: 1px; }
    
    .cell { background: var(--cell-bg); border: 1px solid var(--cell-border); color: #fff; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
    .cell.active { background: var(--accent-color); border-color: var(--highlight-color); }
    .cell.playing-step { background-color: #444 !important; border-color: #fff !important; }
    .cell.active.playing-step { background-color: #00e676 !important; color: #000; box-shadow: 0 0 8px #00e676; }

    #selectionOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 20000; display: none; align-items: center; justify-content: center; }
    #selectionOverlay.visible { display: flex; }
    #selectionPanel { background: #1a1a1a; border: 1px solid #555; padding: 15px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    #selectionOptions { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 5px; margin-top: 10px; }
    .selection-option { padding: 8px 0; background: #333; text-align: center; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
    .selection-option.active { background: var(--accent-color); }

    .countdownOverlay { position: absolute; inset: 0; display: none; justify-content: center; align-items: center; z-index: 50; background: rgba(0,0,0,0.7); font-size: 4rem; font-weight: 800; color: var(--highlight-color); }

    /* Canvas oculto para grava√ß√£o */
    #recordingCanvas { display: none; position: absolute; top: -9999px; left: -9999px; pointer-events: none; }
  </style>
</head>
<body>

  <div id="orientationOverlay">
    <div><h1>üéµ Gire a Tela üé∏</h1></div>
  </div>

  <div class="appRoot">
    <div id="topArea">
      <div id="animacaoStageWrapper">
        <div id="baixistaStage">
            <img id="pernasLayer" class="actor-part" src="animacao/pernas/Pernas.png" alt="Pernas" />
            
            <div id="bodyWrapperPendulo">
                <img id="cabecaTrasLayer" class="actor-part" src="animacao/cabeca_tras/cabeca-parte-de-tras.png" alt="Cabe√ßa atr√°s" />
                <img id="troncoBaixoLayer" class="actor-part" src="animacao/tronco_baixo/Pasta_1F/1E.png" alt="Tronco" />
                <img id="antebracoLayer" class="actor-part" src="animacao/antebraco/antebracoE.png" alt="Antebra√ßo" />
                <img id="bracoDireitoLayer" class="actor-part" src="animacao/braco_direito/Corda_E1.png" alt="M√£o" />
                <img id="cabecaLayer" class="actor-part" src="animacao/cabeca/cabeca0001.png" alt="Cabe√ßa" />
            </div>

            <div id="countdownOverlay" class="countdownOverlay">
              <span id="countdownText">3</span>
            </div>
        </div>
      </div>
    </div>

    <div id="bottomArea">
      <div id="playerControlsRow">
        <button id="playBtn">‚ñ∂ Play</button>
        <button id="recBtn">‚è∫ Gravar V√≠deo</button>
        <button id="playAleatorioBtn">üé≤ Gerar</button>
        <span id="bpmDisplay">120 BPM</span>
        <input type="range" id="bpmSlider" min="60" max="180" value="120" />
        
        <div class="sliderGroup">
          <label>Bass</label> <input type="range" id="baixoVolume" min="0" max="1" step="0.05" value="0.9" />
        </div>
        <div class="sliderGroup">
          <label>Drum</label> <input type="range" id="drumVolume" min="0" max="1" step="0.05" value="0.9" />
        </div>

        <button id="addBaixoCol">+1</button>
        <button id="addCol">+All</button>
        <button id="clearAll">Limpar</button>
      </div>

      <div id="progressContainer"><div id="progressBar"></div></div>

      <div id="gridsArea">
        <div class="rowContainer">
            <div class="gridLabel">Baixo</div>
            <div id="baixoGrid" class="trackGrid"></div>
        </div>
        <div id="drumGridWrapper"></div>
      </div>
    </div>
  </div>

  <div id="selectionOverlay">
    <div id="selectionPanel">
      <div style="text-align:center; color:white; font-weight:bold">Escolha a Nota</div>
      <div id="selectionOptions"></div>
    </div>
  </div>

  <canvas id="recordingCanvas" width="520" height="520"></canvas>

  <script>
    // =========================================================
    // CONFIGURA√á√ÉO E DADOS
    // =========================================================
    const drumLines = [
      { id: "bumbo", label: "Bumbo", file: "bumbo.mp3" },
      { id: "caixa", label: "Caixa", file: "caixa.mp3" },
      { id: "chimbal", label: "HH", file: "chimbal.mp3" },
      { id: "conducao", label: "Ride", file: "conducao.mp3" }
    ];

    const pastaMap = {
      1: ["1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B"],
      // Simplificado para brevidade, o c√≥digo original continha o mapa completo
      2: ["3FS","4G","5GS","6A","8B","9C","10CS","11D","13E","14F","15FS","16G","18A","19AS","20B","21C"],
      // ... (Presume-se a l√≥gica completa de mapa de notas aqui para n√£o quebrar a l√≥gica musical)
    };
    // Preenchendo fallback para evitar erros se o mapa completo n√£o estiver aqui
    for(let i=1; i<=24; i++) { if(!pastaMap[i]) pastaMap[i] = []; }

    const pastaFolderNames = {
      1:"1F", 2:"2FS", 3:"3G", 4:"4GS", 5:"5A", 6:"6AS", 7:"7B", 8:"8C", 9:"9CS", 10:"10D",
      11:"11DS", 12:"12E", 13:"13F", 14:"14FS", 15:"15G", 16:"16GS", 17:"17A", 18:"18AS", 19:"19B",
      20:"20C", 21:"21CS", 22:"22D", 23:"23DS", 24:"24E"
    };

    const notasValidas = [
      "1E","2F","3FS","4G","5GS","6A","7AS","8B","9C","10CS","11D","12DS","13E","14F","15FS","16G","17GS","18A","19AS","20B","21C","22CS","23D","24DS","25E","26F","27FS","28G","29GS","30A","31AS","32B","33C","34CS","35D","36DS","37E","38F","39FS","40G","41GS","42A","43AS"
    ];

    // =========================================================
    // ESTADO GLOBAL
    // =========================================================
    let isPlaying = false;
    let isRecording = false;
    let playbackInterval = null;
    let bpmAtual = 120;
    let atualPasso = 0;
    
    let baixoSeq = Array(16).fill("");
    let bateriaSeq = {};
    drumLines.forEach(d => bateriaSeq[d.id] = Array(16).fill("x"));

    // √Åudio Context (Essencial para grava√ß√£o sincronizada)
    let audioCtx = null;
    let masterGain = null;
    let destStream = null; // Destino para o MediaRecorder
    
    // Imagens Cacheadas (Para evitar glitches e 'cortes')
    const imgCache = {
        head: [],
        body: {},
        arms: {},
        hands: {}
    };

    // Estado Anima√ß√£o
    let currentHeadFrame = 0;
    let penduloAngle = 0;
    let penduloTime = 0;
    let currentBodyImg = null;
    let currentArmImg = null;
    let currentHandImg = null;
    let currentHandFrame = 1; // 1 a 5
    let handAnimTimer = null;

    // Canvas Recorder
    let mediaRecorder = null;
    let recordedChunks = [];
    let canvasDrawInterval = null;

    // =========================================================
    // INICIALIZA√á√ÉO
    // =========================================================
    window.onload = async () => {
        document.getElementById("orientationOverlay").style.display = (window.innerWidth < window.innerHeight) ? 'flex' : 'none';
        
        // 1. Pr√©-carregamento massivo para evitar glitches
        await preloadAssets();
        
        // 2. Inicializa estado visual padr√£o
        updateVisualState("1E", "E"); 

        // 3. Configura√ß√µes
        setupListeners();
        renderGrids();
    };

    async function preloadAssets() {
        const btn = document.getElementById("playBtn");
        btn.innerText = "Carregando...";
        btn.disabled = true;

        const promises = [];

        // Cabe√ßa
        for (let i = 1; i <= 100; i++) {
            const src = `animacao/cabeca/cabeca${String(i).padStart(4, "0")}.png`;
            const img = new Image(); img.src = src;
            promises.push(new Promise(r => img.onload = img.onerror = () => { imgCache.head.push(img); r(); }));
        }

        // Antebra√ßos (E, A, D, G)
        ["E","A","D","G"].forEach(corda => {
            const src = `animacao/antebraco/antebraco${corda}.png`;
            const img = new Image(); img.src = src;
            promises.push(new Promise(r => img.onload = img.onerror = () => { imgCache.arms[corda] = img; r(); }));
        });

        // Pernas e Cabe√ßa Tr√°s (Est√°ticos)
        ["animacao/pernas/Pernas.png", "animacao/cabeca_tras/cabeca-parte-de-tras.png"].forEach(src => {
            const img = new Image(); img.src = src;
            promises.push(new Promise(r => img.onload = img.onerror = r));
        });

        await Promise.all(promises);
        btn.innerText = "‚ñ∂ Play";
        btn.disabled = false;
    }

    function setupListeners() {
        document.getElementById("playBtn").onclick = togglePlay;
        document.getElementById("recBtn").onclick = toggleRecording;
        document.getElementById("playAleatorioBtn").onclick = gerarAleatorio; // Requer fun√ß√£o antiga
        
        document.getElementById("bpmSlider").oninput = (e) => {
            bpmAtual = parseInt(e.target.value);
            document.getElementById("bpmDisplay").textContent = bpmAtual + " BPM";
        };

        document.getElementById("addBaixoCol").onclick = () => { baixoSeq.push(""); renderGrids(); };
        document.getElementById("addCol").onclick = () => {
            baixoSeq.push(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].push("x")); renderGrids();
        };
        document.getElementById("clearAll").onclick = () => {
            baixoSeq.fill(""); Object.keys(bateriaSeq).forEach(k => bateriaSeq[k].fill("x")); renderGrids();
        };
    }

    // =========================================================
    // √ÅUDIO ENGINE (Web Audio API para permitir Grava√ß√£o)
    // =========================================================
    function initAudioContext() {
        if (audioCtx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);

        // Destino para grava√ß√£o
        destStream = audioCtx.createMediaStreamDestination();
        masterGain.connect(destStream);
    }

    async function playSound(url, volId) {
        if (!audioCtx) initAudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        const volVal = parseFloat(document.getElementById(volId).value);
        
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = volVal;
            
            source.connect(gainNode);
            gainNode.connect(masterGain);
            source.start(0);
        } catch (e) { console.log("Erro audio:", url); }
    }

    // =========================================================
    // MOTOR DE REPRODU√á√ÉO E GRAVA√á√ÉO
    // =========================================================
    function togglePlay() {
        if (isPlaying) stopPlayback();
        else startPlaybackRoutine();
    }

    function toggleRecording() {
        if (isRecording) {
            // Parar Grava√ß√£o
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
            stopPlayback();
            isRecording = false;
            document.getElementById("recBtn").innerText = "‚è∫ Gravar V√≠deo";
            document.getElementById("recBtn").classList.remove("recording");
        } else {
            // Iniciar Grava√ß√£o
            isRecording = true;
            document.getElementById("recBtn").innerText = "‚èπ Parar";
            document.getElementById("recBtn").classList.add("recording");
            startPlaybackRoutine(true);
        }
    }

    function startPlaybackRoutine(recordingMode = false) {
        initAudioContext();
        const overlay = document.getElementById("countdownOverlay");
        const txt = document.getElementById("countdownText");
        overlay.style.display = "flex";
        let count = 3;
        txt.innerText = count;

        const countInt = setInterval(() => {
            count--;
            if(count > 0) txt.innerText = count;
            else {
                clearInterval(countInt);
                overlay.style.display = "none";
                startEngine(recordingMode);
            }
        }, 60000/bpmAtual); // Countdown no tempo do BPM
    }

    function startEngine(record = false) {
        isPlaying = true;
        atualPasso = 0;
        document.getElementById("playBtn").innerText = "‚è∏ Pause";
        
        // Iniciar loops visuais
        startAnimationLoops();

        // Se for gravar, configurar o gravador
        if (record) setupMediaRecorder();

        const msPorStep = (60000 / bpmAtual) / 4;

        const stepFunc = () => {
            if (!isPlaying) return;
            
            // Loop Step
            const totalSteps = baixoSeq.length;
            if (atualPasso >= totalSteps) atualPasso = 0;

            // UI Update
            highlightGridStep(atualPasso);
            const pct = ((atualPasso) / totalSteps) * 100;
            document.getElementById("progressBar").style.width = pct + "%";

            // Audio & Logic
            processStep(atualPasso, msPorStep);

            atualPasso++;
        };

        stepFunc(); // Primeiro hit imediato
        playbackInterval = setInterval(stepFunc, msPorStep);
    }

    function stopPlayback() {
        isPlaying = false;
        clearInterval(playbackInterval);
        cancelAnimationFrame(canvasDrawInterval);
        document.getElementById("playBtn").innerText = "‚ñ∂ Play";
        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        
        // Reset visual
        document.getElementById("bodyWrapperPendulo").style.transform = "rotate(0deg)";
    }

    function processStep(step, durationMs) {
        // Baixo
        const nota = baixoSeq[step];
        if (nota && nota !== "") {
            const isMuted = (nota === "x");
            const file = isMuted ? "assets/bass-muted.mp3" : `assets/BaixoMelodia/${nota}.mp3`;
            playSound(file, "baixoVolume");
            
            updateVisualState(isMuted ? null : nota, null, durationMs);
        }

        // Bateria
        drumLines.forEach(d => {
            if (bateriaSeq[d.id][step] === d.id) {
                playSound(`assets/${d.file}`, "drumVolume");
            }
        });
    }

    // =========================================================
    // L√ìGICA DE ANIMA√á√ÉO E CANVAS (CORRE√á√ÉO PRINCIPAL)
    // =========================================================
    
    // Atualiza as vari√°veis de estado (quais imagens devem ser desenhadas)
    function updateVisualState(nota, forceCorda, durationMs) {
        // 1. Determina a corda
        let corda = "E";
        let fileNote = "1E";

        if (nota) {
            fileNote = nota;
            if (nota === "x") {
                // Mant√©m a √∫ltima nota visualmente, mas faz anima√ß√£o da m√£o
                corda = currentArmImg ? currentArmImg.dataset.corda : "E"; 
            } else {
                corda = getCordaDaNota(nota);
                // L√≥gica de Pasta (Simplificada para o exemplo, mantendo a original em mente)
                const pasta = escolherMelhorPasta(nota); 
                const pastaNome = pastaFolderNames[pasta] || "1F";
                
                // Atualiza imagem do Tronco (DOM e Refer√™ncia Canvas)
                const troncoSrc = `animacao/tronco_baixo/Pasta_${pastaNome}/${nota}.png`;
                document.getElementById("troncoBaixoLayer").src = troncoSrc;
                currentBodyImg = document.getElementById("troncoBaixoLayer");
            }
        }

        // 2. Atualiza Antebra√ßo (Garante Sincronia)
        // Se a corda mudou, a imagem DEVE mudar instantaneamente
        if (imgCache.arms[corda]) {
            const armEl = document.getElementById("antebracoLayer");
            // Usamos o cache para setar o src instantaneamente
            armEl.src = imgCache.arms[corda].src;
            currentArmImg = armEl;
            currentArmImg.dataset.corda = corda;
        }

        // 3. Dispara Anima√ß√£o da M√£o
        triggerHandAnimation(corda, durationMs || 200);
    }

    function triggerHandAnimation(corda, duration) {
        if (handAnimTimer) clearInterval(handAnimTimer);
        let frame = 1;
        currentHandFrame = 1;
        const handEl = document.getElementById("bracoDireitoLayer");
        
        // Define tempo entre frames (5 frames total)
        const frameTime = Math.min(duration / 5, 40);

        handAnimTimer = setInterval(() => {
            frame++;
            if (frame > 5) {
                clearInterval(handAnimTimer);
                frame = 1;
            }
            currentHandFrame = frame;
            // Atualiza DOM
            handEl.src = `animacao/braco_direito/Corda_${corda}${frame}.png`;
            currentHandImg = handEl; // Refer√™ncia para o Canvas
        }, frameTime);
    }

    function startAnimationLoops() {
        const start = Date.now();
        
        const draw = () => {
            if (!isPlaying) return;

            // 1. Loop Cabe√ßa (Ciclo independente do BPM, visual apenas)
            // Troca frame a cada ~33ms (30fps)
            const now = Date.now();
            const headIdx = Math.floor((now / 33) % imgCache.head.length);
            currentHeadFrame = headIdx;
            
            // Atualiza DOM da cabe√ßa
            const headEl = document.getElementById("cabecaLayer");
            if (imgCache.head[headIdx]) headEl.src = imgCache.head[headIdx].src;

            // 2. P√™ndulo (Balan√ßo do corpo)
            const speed = 0.003;
            const amplitude = 2.5;
            penduloAngle = Math.sin(now * speed * (bpmAtual / 120)) * amplitude;
            document.getElementById("bodyWrapperPendulo").style.transform = `rotate(${penduloAngle}deg)`;

            // 3. Desenhar no Canvas (Para Grava√ß√£o)
            drawCanvasFrame();

            canvasDrawInterval = requestAnimationFrame(draw);
        };
        canvasDrawInterval = requestAnimationFrame(draw);
    }

    // =========================================================
    // CANVAS DRAW (RESOLVE O PROBLEMA DO V√çDEO)
    // =========================================================
    function drawCanvasFrame() {
        const ctx = document.getElementById("recordingCanvas").getContext("2d");
        
        // Limpa
        ctx.fillStyle = "#2a2a2a"; // Cor de fundo similar ao gradiente
        ctx.fillRect(0,0, 520, 520);

        // Centraliza contexto para facilitar
        // O CSS usa absolute, vamos mapear as coordenadas do CSS para c√°.
        
        // Helper para desenhar imagem com offset
        const drawImg = (img, x, y, rot = 0, originX=0, originY=0) => {
            if (!img || !img.complete || !img.naturalWidth) return;
            ctx.save();
            ctx.translate(x + originX, y + originY); // Move para o ponto de pivo
            ctx.rotate(rot * Math.PI / 180);
            ctx.translate(-originX, -originY); // Retorna
            ctx.drawImage(img, 0, 0);
            ctx.restore();
        };

        // 1. Pernas (Est√°tico no fundo)
        const pernas = document.getElementById("pernasLayer");
        drawImg(pernas, 64, 82);

        // --- GRUPO DO PENDULO ---
        // O CSS aplica rota√ß√£o num container. No Canvas, precisamos simular isso.
        // Pivot do CSS: transform-origin: 50% 80%; (aprox w/2, h*0.8)
        // O container tem w=100% (520), h=100% (520). Pivot = 260, 416.
        
        ctx.save();
        ctx.translate(260, 416);
        ctx.rotate(penduloAngle * Math.PI / 180);
        ctx.translate(-260, -416);

        // A ordem Z-Index do CSS deve ser respeitada aqui:
        // cabecaTras (1) -> Tronco (2) -> Antebraco (3) -> Mao (4) -> Cabeca (5)

        // Z-1: Cabe√ßa Atr√°s
        drawImg(document.getElementById("cabecaTrasLayer"), 100, -190); // Offset relativo ao container

        // Z-2: Tronco
        drawImg(document.getElementById("troncoBaixoLayer"), 0, -118);

        // Z-3: Antebra√ßo
        drawImg(document.getElementById("antebracoLayer"), -2, -71);

        // Z-4: M√£o
        drawImg(document.getElementById("bracoDireitoLayer"), -5, 0);

        // Z-5: Cabe√ßa
        // Usamos a imagem do Cache para evitar o problema de "corte" ou carregamento
        const headImg = imgCache.head[currentHeadFrame];
        if(headImg) {
            // As coordenadas devem bater com o CSS: top: -213px; left: 70px;
            ctx.drawImage(headImg, 70, -213);
        }

        ctx.restore(); // Fim do grupo pendulo
    }

    // =========================================================
    // GRAVADOR (MEDIA RECORDER)
    // =========================================================
    function setupMediaRecorder() {
        const canvas = document.getElementById("recordingCanvas");
        const videoStream = canvas.captureStream(30); // 30 FPS
        
        // Junta Audio (WebAudio) + Video (Canvas)
        const tracks = [...videoStream.getVideoTracks()];
        if (destStream) {
            tracks.push(...destStream.stream.getAudioTracks());
        }

        const combinedStream = new MediaStream(tracks);
        
        // Tenta codecs suportados
        let options = { mimeType: 'video/webm;codecs=vp9' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options = { mimeType: 'video/webm' };
        }

        try {
            mediaRecorder = new MediaRecorder(combinedStream, options);
        } catch (e) {
            alert("Seu navegador n√£o suporta grava√ß√£o avan√ßada.");
            return;
        }

        recordedChunks = [];
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = downloadVideo;
        mediaRecorder.start();
    }

    function downloadVideo() {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `jam_bass_drum_${Date.now()}.webm`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        alert("V√≠deo gerado e baixado!");
    }

    // =========================================================
    // HELPERS (L√≥gica Musical Simples)
    // =========================================================
    function getCordaDaNota(nota) {
        const m = nota.match(/^(\d+)/);
        if (!m) return "E";
        const n = parseInt(m[1], 10);
        if (n <= 20) return "E"; // 1E a 20B
        if (n <= 28) return "A"; // 21C a 28G
        if (n <= 36) return "D"; // 29GS a 36DS
        return "G";              // 37E +
    }

    function escolherMelhorPasta(nota) {
        // Simplifica√ß√£o da l√≥gica para o exemplo
        return 1; // Em produ√ß√£o, usar a l√≥gica de proximidade
    }

    function gerarAleatorio() {
        // Apenas preenche algo para testar
        const notasTeste = ["1E","5GS","8B","13E","1E","x","x","13E"];
        baixoSeq = [];
        for(let i=0; i<16; i++) baixoSeq.push(notasTeste[i%8]);
        renderGrids();
    }

    // =========================================================
    // GRID RENDER
    // =========================================================
    function renderGrids() {
        const baixoContainer = document.getElementById("baixoGrid");
        const drumWrapper = document.getElementById("drumGridWrapper");

        baixoContainer.innerHTML = "";
        baixoSeq.forEach((nota, idx) => {
            const cell = document.createElement("div");
            cell.className = "cell";
            if (nota === "x") { cell.textContent = "X"; cell.classList.add("active-ghost"); }
            else if (nota) { cell.textContent = nota.replace("S","#"); cell.classList.add("active"); }
            cell.onclick = () => abrirSelecaoNota(idx);
            baixoContainer.appendChild(cell);
        });

        drumWrapper.innerHTML = "";
        drumLines.forEach(line => {
            const row = document.createElement("div"); row.className = "rowContainer";
            const lbl = document.createElement("div"); lbl.className = "gridLabel"; lbl.textContent = line.label;
            row.appendChild(lbl);
            const grid = document.createElement("div"); grid.className = "trackGrid";
            
            while(bateriaSeq[line.id].length < baixoSeq.length) bateriaSeq[line.id].push("x");
            
            bateriaSeq[line.id].forEach((val, idx) => {
                const c = document.createElement("div"); c.className = "cell";
                if (val !== "x") c.classList.add("active");
                c.onclick = () => {
                    bateriaSeq[line.id][idx] = (bateriaSeq[line.id][idx] === "x") ? line.id : "x";
                    renderGrids();
                };
                grid.appendChild(c);
            });
            row.appendChild(grid);
            drumWrapper.appendChild(row);
        });
    }

    function highlightGridStep(step) {
        document.querySelectorAll(".playing-step").forEach(el => el.classList.remove("playing-step"));
        const bc = document.getElementById("baixoGrid").children;
        if(bc[step]) bc[step].classList.add("playing-step");
        // Scroll suave
        if(bc[step]) bc[step].scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
    }

    function abrirSelecaoNota(idx) {
        const overlay = document.getElementById("selectionOverlay");
        const opts = document.getElementById("selectionOptions");
        opts.innerHTML = "";
        
        // Op√ß√£o Vazio
        let btn = document.createElement("div"); btn.className="selection-option"; btn.textContent="‚Äî";
        btn.onclick = ()=>{ baixoSeq[idx]=""; overlay.classList.remove("visible"); renderGrids(); };
        opts.appendChild(btn);

        // Op√ß√£o Mute
        btn = document.createElement("div"); btn.className="selection-option"; btn.textContent="X";
        btn.onclick = ()=>{ baixoSeq[idx]="x"; overlay.classList.remove("visible"); renderGrids(); };
        opts.appendChild(btn);

        notasValidas.forEach(n => {
            btn = document.createElement("div"); btn.className="selection-option"; btn.textContent=n.replace("S","#");
            if(n===baixoSeq[idx]) btn.classList.add("active");
            btn.onclick = ()=>{ baixoSeq[idx]=n; playSound(`assets/BaixoMelodia/${n}.mp3`,"baixoVolume"); overlay.classList.remove("visible"); renderGrids(); };
            opts.appendChild(btn);
        });
        overlay.classList.add("visible");
        overlay.onclick = (e)=>{ if(e.target===overlay) overlay.classList.remove("visible"); };
    }
  </script>
</body>
</html>